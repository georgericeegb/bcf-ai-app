<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BCF.ai - Renewable Energy Project Analyzer</title>

    <!-- User Info Display -->
    <div class="user-info" style="position: absolute; top: 10px; right: 20px; z-index: 1000;">
        <span>Welcome, {{ current_user }}!</span>
        <a href="/logout" class="btn btn-sm btn-outline-secondary ms-2">Logout</a>
    </div>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* ==============================================
           STREAMLINED PARCEL ANALYSIS APPLICATION STYLES
           ============================================== */
        
        /* Base Styles */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
        }
        
        /* Layout Components */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 20px 120px 20px;
        }
        
        .page-title {
            color: #2c3e50;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .page-subtitle {
            color: #7f8c8d;
            font-size: 16px;
            margin-bottom: 30px;
        }
        
        /* Buttons - Consolidated */
        .btn, .action-btn, .analyze-suitability-btn, .outreach-btn {
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn:hover, .action-btn:hover, .analyze-suitability-btn:hover, .outreach-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .btn:disabled, .action-btn:disabled, .analyze-suitability-btn:disabled, .outreach-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
            background: #ccc !important;
        }
        
        /* Button Variants */
        .btn-primary, .action-btn.primary, .analyze-suitability-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }
        
        .btn-primary:hover, .action-btn.primary:hover, .analyze-suitability-btn:hover {
            background: linear-gradient(135deg, #219a52, #27ae60);
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
        }
        
        .btn-secondary, .action-btn.secondary {
            background: linear-gradient(135deg, #3498db, #5dade2);
            color: white;
        }
        
        .btn-secondary:hover, .action-btn.secondary:hover {
            background: linear-gradient(135deg, #2980b9, #3498db);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.4);
        }
        
        .btn-outline-success:hover {
            background: linear-gradient(135deg, #198754 0%, #20c997 100%);
            border-color: #198754;
        }
        
        .btn-outline-primary:hover {
            background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);
            border-color: #0d6efd;
        }
        
        .btn-outline-danger:hover {
            background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
            border-color: #dc3545;
        }
        
        /* Forms - Consolidated */
        .form-control, .form-select, .filter-input, .control-select {
            padding: 12px 15px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .form-control:focus, .form-select:focus, .filter-input:focus, .control-select:focus {
            outline: none;
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        
        .form-control:disabled, .form-select:disabled {
            background-color: #f8f9fa;
            border-color: #dee2e6;
            opacity: 0.65;
        }
        
        /* Cards and Containers - Consolidated */
        .card, .county-card, .analysis-section, .variable-card, .workflow-step, .tier-card, .criteria-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 1px solid #e0e6ed;
            margin: 10px 0;
        }
        
        .card:hover, .county-card:hover, .tier-card:hover, .criteria-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .card.selected, .county-card.selected, .tier-card.selected, .criteria-card.selected {
            border-color: #0d6efd;
            border-width: 2px;
            background: linear-gradient(135deg, rgba(13, 110, 253, 0.05) 0%, rgba(13, 110, 253, 0.1) 100%);
        }
        
        /* Tables - Consolidated */
        .table {
            font-size: 0.9rem;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 0;
        }
        
        .table thead th, .parcel-table thead th {
            background: linear-gradient(135deg, #343a40 0%, #495057 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.8rem;
            padding: 15px 10px;
            border: none;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .table tbody tr, .parcel-table tbody tr {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .table tbody tr:hover, .parcel-table tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.05);
            transform: translateX(2px);
        }
        
        .table tbody tr.selected, .parcel-table tbody tr.selected {
            background-color: rgba(25, 135, 84, 0.1);
            border-left: 4px solid #198754;
        }
        
        /* Ensure table has proper width for horizontal scroll */
        .parcel-table {
            width: 100%;
            margin-bottom: 0;
            min-width: 1000px; /* Force horizontal scroll when needed */
        }

        /* Table Categories */
        .table-excellent, .category-excellent { background-color: rgba(25, 135, 84, 0.1); border-left: 4px solid #198754; }
        .table-good, .category-good { background-color: rgba(13, 110, 253, 0.1); border-left: 4px solid #0d6efd; }
        .table-fair, .category-fair { background-color: rgba(255, 193, 7, 0.1); border-left: 4px solid #ffc107; }
        .table-poor, .category-poor { background-color: rgba(220, 53, 69, 0.1); border-left: 4px solid #dc3545; }
        
        /* Checkboxes */
        .parcel-checkbox, #select-all-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .parcel-checkbox:checked, #select-all-checkbox:checked {
            background-color: #198754;
            border-color: #198754;
        }
        
        .parcel-checkbox:hover, #select-all-checkbox:hover {
            transform: scale(1.1);
        }
        
        /* Statistics and Metrics - Consolidated */
        .stat-item, .summary-stat, .metric-item {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #0d6efd;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .stat-item:hover, .summary-stat:hover, .clickable-stat:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .stat-value, .stat-number {
            display: block;
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .stat-label {
            display: block;
            font-size: 13px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
        }
        
        /* Color variants for stats */
        .stat-excellent .stat-number, .stat-excellent .stat-value { color: #198754; }
        .stat-good .stat-number, .stat-good .stat-value { color: #0d6efd; }
        .stat-fair .stat-number, .stat-fair .stat-value { color: #ffc107; }
        .stat-poor .stat-number, .stat-poor .stat-value { color: #dc3545; }
        .stat-success .stat-number, .stat-success .stat-value { color: #198754; }
        
        /* Grid Layouts - Consolidated */
        .summary-stats, .summary-grid, .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .county-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .tier-options, .research-criteria-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        /* Badges and Labels - Consolidated */
        .badge, .score-badge {
            font-size: 0.8rem;
            padding: 6px 10px;
            border-radius: 15px;
            font-weight: 600;
        }
        
        .badge.score-excellent, .score-excellent { background: #198754; color: white; }
        .badge.score-good, .score-good { background: #0d6efd; color: white; }
        .badge.score-fair, .score-fair { background: #ffc107; color: black; }
        .badge.score-poor, .score-poor { background: #dc3545; color: white; }
        
        /* Strength tags */
        .strength-tag, .criteria-tag {
            background: #e8f5e8;
            color: #27ae60;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .criteria-tag {
            background: #0d6efd;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 14px;
        }
        
        /* Modals - Consolidated */
        .modal-dialog {
            max-width: 800px;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
            color: white;
            border-radius: 0.375rem 0.375rem 0 0;
        }
        
        .modal-title {
            font-weight: 600;
        }
        
        .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        
        .modal-content {
            border: none;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        /* Alerts - Consolidated */
        .alert {
            border-radius: 10px;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .alert-success {
            background: linear-gradient(135deg, #d1edff 0%, #e8f7e8 100%);
            color: #0f5132;
            border-left: 4px solid #198754;
        }
        
        .alert-danger {
            background: linear-gradient(135deg, #f8d7da 0%, #ffeaa7 100%);
            color: #842029;
            border-left: 4px solid #dc3545;
        }
        
        /* Loading and Progress - Consolidated */
        .analysis-progress {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
            z-index: 1000;
            min-width: 300px;
        }
        
        .analysis-progress::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: -1;
            backdrop-filter: blur(2px);
        }
        
        .progress-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #0d6efd;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Analysis Steps */
        .analysis-steps .step {
            padding: 8px 0;
            color: #6c757d;
            transition: color 0.3s ease;
        }
        
        .analysis-steps .step.active {
            color: #0d6efd;
            font-weight: 600;
        }
        
        .analysis-steps .step.completed {
            color: #198754;
        }
        
        .analysis-steps .step.error {
            color: #dc3545;
        }
        
        /* Sticky Action Bar */
        .sticky-action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-top: 3px solid #3498db;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            padding: 15px 20px;
            transition: transform 0.3s ease;
            min-height: 80px;
        }
        
        .action-bar-content {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            min-height: 50px;
        }
        
        .county-selection-info {
            color: white;
        }
        
        .county-selection-info h5 {
            color: #ecf0f1;
            margin-bottom: 5px;
        }
        
        .county-selection-info .text-muted {
            color: #bdc3c7 !important;
        }
        
        .county-selection-dropdown select {
            min-width: 280px;
            padding: 12px 16px;
            border-radius: 8px;
            border: 2px solid #34495e;
            background: white;
            font-size: 14px;
            font-weight: 500;
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        /* Filter Controls */
        .filter-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* Selection Controls */
        .selection-controls {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .selection-controls h6 {
            color: #495057;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        /* Transmission Data Styling */
        .transmission-distance {
            font-weight: 600;
        }
        
        .transmission-distance .text-success { color: #198754 !important; }
        .transmission-distance .text-primary { color: #0d6efd !important; }
        .transmission-distance .text-warning { color: #000 !important; }
        .transmission-distance .text-secondary { color: #6c757d !important; }
        
        .transmission-voltage {
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        .voltage-high { background-color: #dc3545; color: white; }
        .voltage-medium { background-color: #fd7e14; color: white; }
        .voltage-low { background-color: #6f42c1; color: white; }
        .voltage-none { background-color: #e9ecef; color: #6c757d; }
        
        /* Clickable Stats */
        .clickable-stat {
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .clickable-stat:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            background: linear-gradient(135deg, #fff 0%, #f0f8ff 100%);
        }
        
        .clickable-stat.active {
            background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(13, 110, 253, 0.4);
        }
        
        .clickable-stat.active .stat-value {
            color: white !important;
        }
        
        .clickable-stat.active .stat-label {
            color: rgba(255, 255, 255, 0.9);
        }
        
        /* Animations */
        @keyframes slideInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Force enable the analysis interface */
        .parcel-analysis-container {
            opacity: 1 !important;
            pointer-events: auto !important;
        }

        .parcel-analysis-container * {
            pointer-events: auto !important;
        }

        /* Remove any disabled overlays */
        .analysis-completed {
            display: none !important;
        }

        /* Fix scrollbar conflict with browser scrollbar */
        .parcel-table-container {
            position: relative;
            max-height: 60vh;
            margin-bottom: 20px;
            margin-right: 20px; /* Key fix: space from browser scrollbar */
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: white;
            width: calc(100% - 25px); /* Compensate for right margin */
            box-sizing: border-box;
        }

        .parcel-table-container .table-responsive {
            max-height: 60vh;
            overflow-y: auto;
            overflow-x: auto;
            width: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .table tbody tr {
            cursor: pointer !important;
            pointer-events: auto !important;
        }

        /* Fix button states */
        .btn:not(.btn:disabled) {
            opacity: 1 !important;
            pointer-events: auto !important;
            cursor: pointer !important;
        }

        .selection-controls {
            animation: slideInDown 0.5s ease-out;
        }
        
        .hero-logo {
            animation: fadeInUp 1s ease-out;
        }
        
        /* Utility Classes */
        .hidden { display: none !important; }
        .text-gradient {
            background: linear-gradient(45deg, #007bff, #28a745);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Make table scrollbar more prominent */
        .table-responsive::-webkit-scrollbar {
            width: 16px;
            height: 16px;
        }

        .table-responsive::-webkit-scrollbar-track {
            background: #e9ecef;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .table-responsive::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #007bff, #0056b3);
            border-radius: 8px;
            border: 2px solid #e9ecef;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #0056b3, #004085);
        }

        .table-responsive::-webkit-scrollbar-corner {
            background: #e9ecef;
        }

        /* Alternative: Use a container with better scrollbar positioning */
        .parcel-table-container {
            position: relative;
            max-height: 60vh;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: white;
        }

        .parcel-table-container .table-responsive {
            max-height: 60vh;
            overflow-y: auto;
            overflow-x: auto;
            width: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* Ensure scrollbar is accessible */
            scrollbar-width: thin;
            scrollbar-color: #6c757d #f8f9fa;
        }

        /* Responsive Design - Simplified Breakpoints */
        @media (max-width: 768px) {
            /* Mobile Layout Adjustments */
            .main-content {
                padding: 15px 15px 160px 15px;
            }
            
            .county-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-stats, .summary-grid, .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .tier-options, .research-criteria-grid {
                grid-template-columns: 1fr;
            }
            
            /* Action Bar Mobile */
            .action-bar-content {
                grid-template-columns: 1fr;
                text-align: center;
                gap: 10px;
            }
            
            .county-selection-dropdown select {
                min-width: auto;
                width: 100%;
                margin: 10px 0;
            }
            
            .action-buttons {
                justify-content: center;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .action-btn, .btn {
                min-width: 110px;
                font-size: 13px;
                padding: 8px 12px;
            }
            
            /* Table Mobile */
            .table th:nth-child(n+6), .table td:nth-child(n+6),
            .parcel-table th:nth-child(n+6), .parcel-table td:nth-child(n+6) {
                display: none;
            }
            
            /* Form Mobile */
            .filter-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-input {
                width: 100%;
            }
            
            /* Modal Mobile */
            .modal-dialog {
                margin: 10px;
                max-width: none;
            }
            
            /* Progress Mobile */
            .analysis-progress {
                padding: 30px 20px;
                min-width: 280px;
            }
            
            /* Stats Mobile */
            .stat-value, .stat-number {
                font-size: 24px;
            }
        }
        
        @media (max-width: 480px) {
            /* Small Mobile Adjustments */
            .summary-stats, .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
                width: 100%;
            }
            
            .action-btn, .btn {
                min-width: auto;
                width: 100%;
                margin: 2px 0;
            }
            
            .main-content {
                padding: 10px 10px 200px 10px;
            }
            
            .stat-item, .summary-stat {
                padding: 15px;
            }
        }
        
        /* Print Styles */
        @media print {
            .analysis-progress, .btn, .modal, .sticky-action-bar {
                display: none !important;
            }
            
            .table {
                font-size: 10px;
            }
            
            .stat-item {
                break-inside: avoid;
            }
            
            .main-content {
                padding-bottom: 20px !important;
            }
        }
        
        /* Accessibility */
        .parcel-checkbox:focus, #select-all-checkbox:focus,
        .btn:focus, .form-select:focus, .form-range:focus {
            outline: 2px solid #0d6efd;
            outline-offset: 2px;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        
        /* High Contrast Support */
        @media (prefers-contrast: high) {
            .btn, .card, .table {
                border: 2px solid;
            }
            
            .stat-item {
                border: 2px solid #000;
            }
        }
        
        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        .clickable-filter {
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .clickable-filter:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .active-filter {
            background: linear-gradient(135deg, #0d6efd, #0056b3) !important;
            color: white !important;
            box-shadow: 0 4px 15px rgba(13, 110, 253, 0.4) !important;
        }

        .active-filter .stat-number,
        .active-filter .stat-label {
            color: white !important;
        }

        .active-filter::before {
            content: '✓';
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>

    <!-- New modular JavaScript files -->
    <script src="/static/js/parcel-scoring.js"></script>
    <script src="/static/js/individual-ai-analysis.js"></script>
</head>
<body>
    <!-- BCF.ai Landing Screen -->
    <div id="start-screen" class="workflow-step active">
        <div class="container-fluid">
            <div class="row justify-content-center">
                <div class="col-lg-8">

                    <!-- BCF.ai Header -->
                    <div class="text-center mb-5">
                        <div class="hero-logo mb-4">
                            <h1 class="display-4 fw-bold text-primary">
                                <span class="text-gradient">BCF.ai</span>
                            </h1>
                            <p class="lead text-muted">AI-Powered Renewable Energy Land Discovery</p>
                        </div>

                        <div class="hero-description">
                            <h2 class="h4 mb-3">Find the Best Land for Your Renewable Energy Projects</h2>
                            <p class="fs-5 text-secondary mb-4">
                                BCF.ai uses artificial intelligence to analyze markets, identify optimal locations,
                                and find landowners ready for renewable energy development.
                            </p>

                            <div class="row g-4 mb-5">
                                <div class="col-md-4">
                                    <div class="feature-card h-100 p-4 bg-light rounded-3">
                                        <div class="feature-icon mb-3">🤖</div>
                                        <h5>AI Market Analysis</h5>
                                        <p class="small text-muted">Smart county rankings based on renewable energy friendliness</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="feature-card h-100 p-4 bg-light rounded-3">
                                        <div class="feature-icon mb-3">🎯</div>
                                        <h5>Targeted Outreach</h5>
                                        <p class="small text-muted">Find and contact the right landowners with ML-enhanced scoring</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="feature-card h-100 p-4 bg-light rounded-3">
                                        <div class="feature-icon mb-3">📊</div>
                                        <h5>Outreach Integration</h5>
                                        <p class="small text-muted">Seamless workflow from analysis to outreach management</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- State Selection ONLY -->
                    <div class="state-selection-container">
                        <div class="card border-primary shadow-sm">
                            <div class="card-body p-5">
                                <div class="text-center mb-4">
                                    <h3 class="card-title mb-3">🗺️ Choose Your Target State</h3>
                                    <p class="text-muted">Select a state to begin AI-powered market analysis and county rankings</p>
                                </div>

                                <form id="state-selection-form">
                                    <div class="row justify-content-center">
                                        <div class="col-md-8">
                                            <div class="mb-4">
                                                <label for="target-state" class="form-label fw-bold">Target State</label>
                                                <select class="form-select form-select-lg" id="target-state" required>
                                                    <option value="">Select a state...</option>
                                                    <option value="AL">Alabama</option>
                                                    <option value="AZ">Arizona</option>
                                                    <option value="AR">Arkansas</option>
                                                    <option value="CA">California</option>
                                                    <option value="CO">Colorado</option>
                                                    <option value="FL">Florida</option>
                                                    <option value="GA">Georgia</option>
                                                    <option value="IL">Illinois</option>
                                                    <option value="IN">Indiana</option>
                                                    <option value="IA">Iowa</option>
                                                    <option value="KS">Kansas</option>
                                                    <option value="KY">Kentucky</option>
                                                    <option value="LA">Louisiana</option>
                                                    <option value="MI">Michigan</option>
                                                    <option value="MN">Minnesota</option>
                                                    <option value="MS">Mississippi</option>
                                                    <option value="MO">Missouri</option>
                                                    <option value="NE">Nebraska</option>
                                                    <option value="NV">Nevada</option>
                                                    <option value="NM">New Mexico</option>
                                                    <option value="NY">New York</option>
                                                    <option value="NC">North Carolina</option>
                                                    <option value="ND">North Dakota</option>
                                                    <option value="OH">Ohio</option>
                                                    <option value="OK">Oklahoma</option>
                                                    <option value="PA">Pennsylvania</option>
                                                    <option value="SC">South Carolina</option>
                                                    <option value="SD">South Dakota</option>
                                                    <option value="TN">Tennessee</option>
                                                    <option value="TX">Texas</option>
                                                    <option value="UT">Utah</option>
                                                    <option value="VA">Virginia</option>
                                                    <option value="WV">West Virginia</option>
                                                    <option value="WI">Wisconsin</option>
                                                    <option value="WY">Wyoming</option>
                                                </select>
                                            </div>

                                            <div class="mb-4">
                                                <label for="project-type-start" class="form-label fw-bold">Project Type</label>
                                                <select class="form-select form-select-lg" id="project-type-start" required>
                                                    <option value="">Select project type...</option>
                                                    <option value="solar">Solar Energy</option>
                                                    <option value="wind">Wind Energy</option>
                                                    <option value="battery">Battery Storage</option>
                                                    <option value="mixed">Mixed Renewable</option>
                                                </select>
                                            </div>

                                            <div class="text-center">
                                                <button type="submit" class="btn btn-primary btn-lg px-5" id="analyze-state-btn">
                                                    <span class="btn-text">🚀 Analyze State</span>
                                                    <span class="spinner-border spinner-border-sm d-none ms-2" role="status"></span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- County Rankings Screen -->
    <div id="county-rankings-screen" class="workflow-step" style="display: none;">
        <!-- Main Content -->
        <div class="main-content">
            <h1 class="page-title">
                <span id="state-name-display">State</span> County Rankings
            </h1>
            <p class="page-subtitle">AI-powered analysis of renewable energy development potential</p>

            <!-- Summary Statistics (Clickable) -->
            <div class="summary-stats">
                <div class="stat-item clickable-stat" data-filter="all" onclick="window.bcf && window.bcf.filterByCategory('all')">
                    <span class="stat-value" id="total-counties">-</span>
                    <span class="stat-label">Total Counties</span>
                </div>
                <div class="stat-item clickable-stat" data-filter="excellent" onclick="window.bcf.filterByCategory('excellent')">
                    <span class="stat-value text-success" id="excellent-counties">-</span>
                    <span class="stat-label">Excellent (85+)</span>
                </div>
                <div class="stat-item clickable-stat" data-filter="good" onclick="window.bcf && window.bcf.filterByCategory('good')">
                    <span class="stat-value text-primary" id="good-counties">-</span>
                    <span class="stat-label">Good (70-84)</span>
                </div>
                <div class="stat-item clickable-stat" data-filter="fair" onclick="window.bcf && window.bcf.filterByCategory('fair')">
                    <span class="stat-value text-warning" id="fair-counties">-</span>
                    <span class="stat-label">Fair (55-69)</span>
                </div>
                <div class="stat-item clickable-stat" data-filter="activity" onclick="window.bcf && window.bcf.filterByCategory('activity')">
                    <span class="stat-value text-info" id="with-activity">-</span>
                    <span class="stat-label">With Past Activity</span>
                </div>
            </div>

            <!-- Filter Controls (Simplified) -->
            <div class="filter-controls">
                <input type="text" class="filter-input" id="county-search" placeholder="Search counties..." onkeyup="window.bcf && window.bcf.filterCounties()">
                
                <select class="filter-select" id="counties-per-page" onchange="window.bcf && window.bcf.updatePagination()">
                    <option value="12">12 per page</option>
                    <option value="24" selected>24 per page</option>
                    <option value="48">48 per page</option>
                    <option value="100">100 per page</option>
                </select>
                
                <button class="btn btn-outline-secondary" onclick="window.bcf && window.bcf.clearFilters()">Clear Filters</button>
                
                <div class="filter-status">
                    <span style="color: #7f8c8d;">
                        Showing <span id="visible-count">0</span> of <span id="total-count">0</span> counties
                        <span id="active-filter-label" style="margin-left: 10px; font-weight: bold; color: #0d6efd;"></span>
                    </span>
                </div>
            </div>

            <!-- Scrollable County List -->
            <div class="scrollable-content">
                <div class="county-grid" id="county-grid">
                    <!-- County cards will be populated here -->
                </div>
            </div>

            <!-- Pagination Controls -->
            <div class="pagination-controls" id="pagination-controls">
                <!-- Pagination will be generated here -->
            </div>
        </div>

        <!-- Sticky County Selection Actions -->
        <div class="sticky-action-bar">
            <div class="action-bar-content">
                <div class="county-selection-info">
                    <h5 class="mb-1">
                        <i class="fas fa-crosshairs me-2"></i>
                        <span id="selected-county-name">Select a county to proceed</span>
                    </h5>
                    <p class="mb-0 text-muted" id="selected-county-details">Choose from the ranked counties above</p>
                </div>
                
                <div class="county-selection-dropdown">
                    <select class="form-select" id="target-county">
                        <option value="">Select a county...</option>
                    </select>
                </div>
                
                <div class="action-buttons">
                    <button type="button" class="action-btn primary" id="find-parcels-btn-alt" disabled>
                        <i class="fas fa-search me-2"></i>Find Parcels
                    </button>
                    <button type="button" class="action-btn secondary" id="research-areas-btn-alt" disabled>
                        <i class="fas fa-brain me-2"></i>Research Area
                    </button>
                    <button type="button" class="action-btn tertiary" id="existing-files-btn-alt" disabled>
                        <i class="fas fa-folder-open me-2"></i>Use Existing Files
                    </button>
                </div>
            </div>
        </div>
    </div>


<script>
// BCF.AI WORKFLOW - COMPLETE ENHANCED VERSION WITH ALL FUNCTIONALITY

console.log('Script starting...');

// Declare bcf in global scope first
let bcf = null;

// Define global helper functions first
window.toggleSelectAll = function(isChecked) {
    if (!window.bcf) return;

    const checkboxes = document.querySelectorAll('input[data-parcel-index]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = isChecked;
        const index = parseInt(checkbox.dataset.parcelIndex);
        if (isChecked) {
            window.bcf.selectedParcels.add(index);
        } else {
            window.bcf.selectedParcels.delete(index);
        }
    });
    updateSelectionCount();
};

window.handleParcelCheckbox = function(index, isChecked) {
    if (!window.bcf) return;

    if (isChecked) {
        window.bcf.selectedParcels.add(index);
    } else {
        window.bcf.selectedParcels.delete(index);
    }
    updateSelectionCount();
};

// Add this to your JavaScript file handling the technical analysis
function showAnalysisProgress(message = "Running Technical Analysis") {
    // Hide any existing progress indicators first
    hideAllProgressIndicators();
    
    // Show single progress modal
    const progressModal = document.getElementById('analysisProgressModal');
    if (progressModal) {
        const messageElement = progressModal.querySelector('.progress-message');
        if (messageElement) {
            messageElement.textContent = message;
        }
        
        // Update sub-message for different phases
        const subMessageElement = progressModal.querySelector('.progress-sub-message');
        if (subMessageElement) {
            subMessageElement.textContent = "Analyzing slope and transmission data...";
        }
        
        // Show the modal
        progressModal.style.display = 'flex';
    }
}

function hideAllProgressIndicators() {
    // Hide all possible progress indicators
    const indicators = [
        'analysisProgressModal',
        'loadingSpinner', 
        'progressModal',
        'technicalAnalysisProgress'
    ];
    
    indicators.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.style.display = 'none';
        }
    });
    
    // Also hide any elements with progress-related classes
    document.querySelectorAll('.progress-indicator, .loading-spinner, .analysis-progress').forEach(el => {
        el.style.display = 'none';
    });
}

function updateAnalysisProgress(phase, message) {
    const progressModal = document.getElementById('analysisProgressModal');
    if (progressModal) {
        const subMessageElement = progressModal.querySelector('.progress-sub-message');
        if (subMessageElement) {
            switch(phase) {
                case 'slope':
                    subMessageElement.textContent = "Running slope analysis...";
                    break;
                case 'transmission':
                    subMessageElement.textContent = "Running transmission analysis...";
                    break;
                case 'processing':
                    subMessageElement.textContent = "Processing results...";
                    break;
                default:
                    subMessageElement.textContent = message || "Processing...";
            }
        }
    }
}

// Update your existing analysis function
async function runTechnicalAnalysis(filePath, countyName, state) {
    try {
        // Show single progress indicator
        showAnalysisProgress("Running Technical Analysis");
        
        const response = await fetch(`${API_BASE_URL}/api/analysis/analyze-existing-file-quick`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                file_path: filePath,
                county_name: countyName,
                state: state,
                project_type: 'solar'
            })
        });

        const result = await response.json();
        
        // Hide progress indicator
        hideAllProgressIndicators();
        
        if (result.status === 'success') {
            displayAnalysisResults(result);
        } else {
            showErrorMessage(`Technical analysis failed: ${result.message}`);
        }
        
    } catch (error) {
        // Always hide progress indicators on error
        hideAllProgressIndicators();
        console.error('Analysis error:', error);
        showErrorMessage(`Analysis failed: ${error.message}`);
    }
}

function updateSelectionCount() {
    if (!window.bcf) return;

    const count = window.bcf.selectedParcels.size;
    const countElements = document.querySelectorAll('#selection-count, #outreach-count');
    countElements.forEach(el => el.textContent = count);

    const outreachBtn = document.getElementById('initiate-outreach-btn');
    if (outreachBtn) {
        outreachBtn.disabled = count === 0;
    }
}

// Wait for modules to be available
function waitForModules(callback) {
    if (window.ParcelScoring && window.IndividualParcelAI) {
        callback();
    } else {
        console.log('Waiting for modules to load...');
        setTimeout(() => waitForModules(callback), 100);
    }
}

try {
    console.log('Defining BCFWorkflow class...');

    class BCFWorkflow {
        constructor() {
            console.log('BCFWorkflow constructor called');
            this.currentState = null;
            this.currentProjectType = null;
            this.currentStateAnalysis = null;
            this.currentCountyActivity = {};
            this.currentPage = 1;
            this.countiesPerPage = 24;
            this.allCounties = [];
            this.filteredCounties = [];
            this.currentCategoryFilter = null;
            this.aiAnalysisCompleted = false;
            this.originalParcelData = null;
            this.currentAnalysis = null;
            this.enrichedParcelData = null;
            this.currentSuitabilityResults = null;
            this.selectedParcels = new Set();
            this.allParcels = [];

            // Prevent accidental page navigation during modal operations
            window.addEventListener('beforeunload', (e) => {
                if (this.isProcessingFileAnalysis) {
                    e.preventDefault();
                    e.returnValue = 'Analysis in progress. Are you sure you want to leave?';
                }
            });

            console.log('BCFWorkflow constructor completed');
        }

        initializeModules() {
            console.log('Initializing modules...');
            
            // Initialize ParcelScoring module
            if (window.ParcelScoring) {
                this.parcelScorer = new ParcelScoring('solar');
                console.log('✅ ParcelScoring module initialized');
            } else {
                console.error('❌ ParcelScoring module not available');
                this.parcelScorer = null;
            }
            
            // Initialize IndividualParcelAI module
            if (window.IndividualParcelAI) {
                this.aiAnalyzer = new IndividualParcelAI('', 'solar', '', '');
                console.log('✅ IndividualParcelAI module initialized');
                console.log('AI Analyzer created:', this.aiAnalyzer);
            } else {
                console.error('❌ IndividualParcelAI module not available');
                this.aiAnalyzer = null;
            }
        }

        // Add methods that use the modules
        calculateParcelScore(parcel) {
            if (!this.parcelScorer) {
                console.warn('ParcelScoring not available, using fallback');
                return this.fallbackParcelScore(parcel);
            }
            
            const category = this.parcelScorer.calculateParcelCategory(parcel);
            
            // Convert category to numeric score
            const scoreMap = {
                'Excellent': 90,
                'Good': 75,
                'Fair': 60,
                'Poor': 40
            };
            
            return scoreMap[category] || 50;
        }
        
        fallbackParcelScore(parcel) {
            // Simple fallback scoring
            let score = 50;
            
            const slope = parseFloat(parcel.avg_slope_degrees || 0);
            const txDistance = parseFloat(parcel.tx_distance_miles || 999);
            const acres = parseFloat(parcel.acreage_calc || parcel.acreage || 0);
            
            // Score adjustments
            if (slope <= 5) score += 20;
            else if (slope <= 15) score += 10;
            else if (slope > 25) score -= 20;
            
            if (txDistance <= 1) score += 15;
            else if (txDistance <= 5) score += 5;
            else if (txDistance > 10) score -= 15;
            
            if (acres >= 50) score += 15;
            else if (acres >= 20) score += 10;
            else if (acres < 5) score -= 10;
            
            return Math.max(0, Math.min(100, Math.round(score)));
        }
        
        determineParcelCategory(parcel) {
            if (!this.parcelScorer) {
                const score = this.fallbackParcelScore(parcel);
                if (score >= 85) return 'Excellent';
                if (score >= 70) return 'Good';
                if (score >= 55) return 'Fair';
                return 'Poor';
            }
            
            return this.parcelScorer.calculateParcelCategory(parcel);
        }
        
        getParcelScore(parcel) {
            // Try multiple field names for score
            return parcel.suitability_score || 
                   parcel.combined_score || 
                   parcel.score || 
                   this.calculateParcelScore(parcel);
        }
        
        determineRecommendation(parcel) {
            if (!this.parcelScorer) {
                const category = this.determineParcelCategory(parcel);
                return category === 'Excellent' || category === 'Good';
            }
            
            return this.parcelScorer.isRecommendedForOutreach(parcel);
        }
        
        // Enhanced method to run individual AI analysis
        async runIndividualAIAnalysis(parcelIndex) {
            console.log('=== INDIVIDUAL AI ANALYSIS DEBUG ===');
            console.log('Parcel index:', parcelIndex);
            console.log('All parcels available:', !!this.allParcels);
            console.log('AI Analyzer available:', !!this.aiAnalyzer);
            console.log('AI Analyzer type:', typeof this.aiAnalyzer);
            
            if (!this.allParcels || parcelIndex >= this.allParcels.length) {
                console.error('❌ Invalid parcel index or no parcels available');
                alert('Invalid parcel selection');
                return;
            }
            
            const parcel = this.allParcels[parcelIndex];
            console.log('✅ Parcel data retrieved:', {
                owner: parcel.owner,
                acres: parcel.acreage_calc || parcel.acreage,
                slope: parcel.avg_slope_degrees,
                tx_distance: parcel.tx_distance_miles
            });
            
            // Check if AI analyzer is available
            if (!this.aiAnalyzer) {
                console.warn('⚠️ IndividualParcelAI not available, checking if module exists...');
                
                // Try to reinitialize if module became available
                if (window.IndividualParcelAI) {
                    console.log('🔄 Attempting to reinitialize IndividualParcelAI...');
                    this.aiAnalyzer = new IndividualParcelAI('', this.currentProjectType || 'solar', this.currentState || '', this.currentAnalysis?.county || '');
                }
                
                if (!this.aiAnalyzer) {
                    console.log('❌ Still no AI analyzer, using basic fallback');
                    this.showBasicParcelAnalysis(parcel);
                    return;
                }
            }
            
            // Update AI analyzer context
            console.log('🔄 Updating AI analyzer context...');
            this.aiAnalyzer.currentState = this.currentState;
            this.aiAnalyzer.currentCounty = this.currentAnalysis?.county || '';
            this.aiAnalyzer.projectType = this.currentProjectType || 'solar';
            
            console.log('✅ AI Analyzer context updated:', {
                state: this.aiAnalyzer.currentState,
                county: this.aiAnalyzer.currentCounty,
                projectType: this.aiAnalyzer.projectType
            });
            
            // Run the enhanced analysis
            try {
                console.log('🚀 Starting enhanced AI analysis...');
                
                await this.aiAnalyzer.analyzeParcel(
                    parcel,
                    (content, title) => {
                        console.log('📋 Displaying modal with title:', title);
                        this.showGenericModal(content, title);
                    },
                    (message) => {
                        console.log('⏳ Showing loading:', message);
                        this.showLoadingModal(message);
                    },
                    () => {
                        console.log('✅ Hiding loading modal');
                        this.hideLoadingModal();
                    }
                );
                
                console.log('✅ Enhanced AI analysis completed successfully');
                
            } catch (error) {
                console.error('💥 Enhanced AI analysis error:', error);
                this.hideLoadingModal();
                
                // Show error but still display basic analysis
                console.log('📋 Falling back to basic analysis due to error');
                this.showBasicParcelAnalysis(parcel);
            }
            
            console.log('=== END INDIVIDUAL AI ANALYSIS DEBUG ===');
        }

        debugModuleAvailability() {
            console.log('=== MODULE AVAILABILITY DEBUG ===');
            console.log('Window.ParcelScoring:', typeof window.ParcelScoring);
            console.log('Window.IndividualParcelAI:', typeof window.IndividualParcelAI);
            console.log('This.parcelScorer:', typeof this.parcelScorer);
            console.log('This.aiAnalyzer:', typeof this.aiAnalyzer);
            
            if (window.IndividualParcelAI) {
                console.log('✅ IndividualParcelAI class is available');
                try {
                    const testAnalyzer = new IndividualParcelAI();
                    console.log('✅ Can create IndividualParcelAI instance');
                } catch (e) {
                    console.error('❌ Cannot create IndividualParcelAI instance:', e);
                }
            } else {
                console.error('❌ IndividualParcelAI class not found in window');
            }
            console.log('=== END MODULE AVAILABILITY DEBUG ===');
        }

        // Also add this helper method to format transmission data better
        formatTransmissionData(parcel) {
            // Check multiple possible field names for transmission data
            const distanceFields = ['tx_distance_miles', 'transmission_distance', 'tx_nearest_distance_miles'];
            const voltageFields = ['tx_voltage_kv', 'transmission_voltage', 'tx_nearest_voltage_kv'];
            
            let distance = null;
            let voltage = null;
            
            // Find distance value
            for (const field of distanceFields) {
                const value = parseFloat(parcel[field]);
                if (!isNaN(value) && value > 0) {
                    distance = value;
                    break;
                }
            }
            
            // Find voltage value  
            for (const field of voltageFields) {
                const value = parseFloat(parcel[field]);
                if (!isNaN(value) && value > 0) {
                    voltage = value;
                    break;
                }
            }
            
            return {
                distance: distance ? `${distance.toFixed(2)} mi` : 'N/A',
                voltage: voltage ? `${Math.round(voltage)} kV` : 'N/A'
            };
        }

        showBasicParcelAnalysis(parcel) {
            const score = this.getParcelScore(parcel);
            const category = this.determineParcelCategory(parcel);
            
            const modalContent = `
                <div class="parcel-analysis-basic">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h5>Parcel Information</h5>
                            <p><strong>Owner:</strong> ${parcel.owner || 'N/A'}</p>
                            <p><strong>Acres:</strong> ${Math.round(parseFloat(parcel.acreage_calc || parcel.acreage || 0))}</p>
                            <p><strong>Parcel ID:</strong> ${parcel.parcel_id || 'N/A'}</p>
                        </div>
                        <div class="col-md-6">
                            <h5>Technical Data</h5>
                            <p><strong>Score:</strong> ${score}/100</p>
                            <p><strong>Category:</strong> <span class="badge ${this.getCategoryBadgeClass(category)}">${category}</span></p>
                            <p><strong>Slope:</strong> ${parseFloat(parcel.avg_slope_degrees || 0).toFixed(1)}°</p>
                            <p><strong>TX Distance:</strong> ${parseFloat(parcel.tx_distance_miles || 0).toFixed(2)} mi</p>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <p><strong>Note:</strong> This is basic technical analysis. Enhanced AI analysis is being implemented.</p>
                    </div>
                </div>
            `;
            
            this.showGenericModal(modalContent, `Parcel Analysis: ${parcel.owner || 'Unknown'}`);
        }
        
        getCategoryBadgeClass(category) {
            const classes = {
                'Excellent': 'bg-success',
                'Good': 'bg-primary',
                'Fair': 'bg-warning text-dark',
                'Poor': 'bg-danger'
            };
            return classes[category] || 'bg-secondary';
        }
        
        showGenericModal(content, title) {
            const modalHtml = `
                <div class="modal fade" id="genericModal" tabindex="-1">
                    <div class="modal-dialog modal-xl"> <!-- Changed to modal-xl for more space -->
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">${title}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body" style="max-height: 75vh; overflow-y: auto; padding: 20px;">
                                ${content}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="window.bcf.downloadAIAnalysis('${title}')">
                                    <i class="fas fa-download me-2"></i>Download Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal
            const existingModal = document.getElementById('genericModal');
            if (existingModal) existingModal.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('genericModal'));
            modal.show();
            
            modal._element.addEventListener('hidden.bs.modal', () => {
                document.getElementById('genericModal').remove();
            });
        }

        // Add method to download AI analysis as text file
        downloadAIAnalysis(title) {
            // Try multiple selectors to find analysis content
            let analysisContent = null;
            
            // Try different possible selectors
            const selectors = [
                '.ai-analysis-content',
                '.modal-body pre',
                '.detailed-analysis',
                '#genericModal .modal-body',
                '.analysis-content'
            ];
            
            for (const selector of selectors) {
                const element = document.querySelector(selector);
                if (element) {
                    analysisContent = element.textContent || element.innerHTML;
                    if (analysisContent.trim().length > 0) {
                        break;
                    }
                }
            }
            
            if (!analysisContent || analysisContent.trim().length === 0) {
                // If no content found, show error message with more context
                alert('No analysis content available for download. This may be because:\n\n' +
                    '• The AI analysis failed to complete\n' +
                    '• The analysis modal was closed before content loaded\n' +
                    '• There was an API error\n\n' +
                    'Please try running the analysis again.');
                return;
            }
            
            // Create comprehensive report content
            const reportContent = `AI PARCEL ANALYSIS REPORT
        =========================

        Title: ${title}
        Generated: ${new Date().toLocaleString()}
        Analysis Type: Individual Parcel Assessment

        ANALYSIS CONTENT
        ================

        ${analysisContent}

        METHODOLOGY
        ===========

        This analysis was generated using AI to assess:
        - Development suitability and potential
        - Market conditions and opportunities  
        - Risk factors and considerations
        - Strategic recommendations

        DISCLAIMER
        ==========

        This report is for informational purposes only and should be used in conjunction 
        with professional due diligence. Market conditions may change rapidly, and all 
        recommendations should be verified with current data and local expertise.

        ---
        Report generated by BCF.ai Renewable Energy Analysis Platform
        © ${new Date().getFullYear()} - All rights reserved
            `;
            
            try {
                const blob = new Blob([reportContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${title.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().slice(0, 10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showNotification('Analysis report downloaded successfully!', 'success');
            } catch (error) {
                console.error('Download error:', error);
                alert('Failed to download report: ' + error.message);
            }
        }

        // Update project type in modules when it changes
        updateProjectType(projectType) {
            this.currentProjectType = projectType;
            
            if (this.parcelScorer) {
                this.parcelScorer = new ParcelScoring(projectType);
                console.log('✅ ParcelScorer updated for project type:', projectType);
            }
            
            if (this.aiAnalyzer) {
                this.aiAnalyzer.projectType = projectType;
                console.log('✅ AI Analyzer updated for project type:', projectType);
            }
        }

        // Add a test method you can call from the console
        testIndividualAI() {
            console.log('Testing Individual AI Analysis...');
            this.debugModuleAvailability();
            
            if (this.allParcels && this.allParcels.length > 0) {
                console.log('Testing with first parcel...');
                this.runIndividualAIAnalysis(0);
            } else {
                console.log('No parcels available for testing');
            }
        }
        // Add this method to your BCFWorkflow class
        async debugAIConnectivity() {
            try {
                console.log('🔍 Testing AI connectivity...');

                const response = await fetch('/api/test-ai-connectivity');
                const result = await response.json();

                console.log('🔍 AI Connectivity Test Results:');
                console.table(result.connectivity_test);

                if (!result.connectivity_test.anthropic_key_configured) {
                    console.error('❌ ANTHROPIC_API_KEY is not configured!');
                    alert('ANTHROPIC_API_KEY is not configured in your environment variables. Please add it to your .env file.');
                } else if (!result.connectivity_test.ai_service_functional) {
                    console.error('❌ AI Service is not functional:', result.connectivity_test.ai_service_error);
                    alert(`AI Service error: ${result.connectivity_test.ai_service_error}`);
                } else {
                    console.log('✅ AI service appears to be working correctly');
                }

                return result;

            } catch (error) {
                console.error('💥 AI connectivity test failed:', error);
                alert(`Connectivity test failed: ${error.message}`);
                return null;
            }
        }

        async analyzeSearchResults() {
            console.log('Starting parcel analysis...');

            // Get the search results table data
            const parcelRows = document.querySelectorAll('table tbody tr');
            const parcelData = [];

            parcelRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 4) {
                    parcelData.push({
                        owner: cells[0]?.textContent?.trim() || 'Unknown',
                        acreage: cells[1]?.textContent?.trim() || '0',
                        parcel_id: cells[2]?.textContent?.trim() || 'Unknown',
                        address: cells[3]?.textContent?.trim() || 'N/A'
                    });
                }
            });

            if (parcelData.length === 0) {
                alert('No parcel data found to analyze');
                return;
            }

            // Show loading state
            const analyzeBtn = document.querySelector('[onclick*="analyzeSearchResults"]');
            if (analyzeBtn) {
                analyzeBtn.disabled = true;
                analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
            }

            try {
                const response = await fetch('/api/analyze-search-results', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        parcel_data: parcelData,
                        county_name: this.currentAnalysis?.county || 'Unknown',
                        state: this.currentState || 'Unknown',
                        project_type: this.currentProjectType || 'solar',
                        search_id: Date.now().toString()
                    })
                });

                const result = await response.json();

                if (result.success) {
                    this.showAnalysisResults(result.analysis_results);
                    alert(`Analysis completed for ${parcelData.length} parcels!`);
                } else {
                    alert(`Analysis failed: ${result.error}`);
                }

            } catch (error) {
                console.error('Analysis error:', error);
                alert(`Analysis failed: ${error.message}`);
            } finally {
                // Restore button
                if (analyzeBtn) {
                    analyzeBtn.disabled = false;
                    analyzeBtn.innerHTML = '<i class="fas fa-brain"></i> Analyze with AI';
                }
            }
        }

        downloadParcelFile(blobName, fileType) {
            console.log(`Downloading ${fileType} file: ${blobName}`);

            try {
                // Create download link using the Flask route
                const link = document.createElement('a');
                link.href = `/api/analysis/download-parcel-file?blob_name=${encodeURIComponent(blobName)}&file_type=${fileType}`;
                
                // Set download attribute with a user-friendly filename
                const timestamp = new Date().toISOString().slice(0, 10);
                link.download = `parcel_data_${timestamp}.${fileType}`;

                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                this.showNotification(`${fileType.toUpperCase()} download started!`, 'success');

            } catch (error) {
                console.error('Download error:', error);
                this.showNotification(`Download failed: ${error.message}`, 'error');
            }
        }

        showAnalysisResults(analysisResults) {
            console.log('Showing analysis results:', analysisResults);

            // Create simple results modal
            const modalHtml = `
                <div id="analysisModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                     background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 10px; max-width: 800px; max-height: 80vh; overflow-y: auto;">
                        <h3>Analysis Results</h3>
                        <div style="margin: 20px 0;">
                            <p><strong>Total Parcels:</strong> ${analysisResults.summary?.total_parcels || 0}</p>
                            <p><strong>Average Score:</strong> ${analysisResults.summary?.average_score || 'N/A'}</p>
                            <p><strong>Recommended for Outreach:</strong> ${analysisResults.summary?.recommended_for_outreach || 0}</p>
                        </div>
                        <div style="text-align: right;">
                            <button onclick="document.getElementById('analysisModal').remove()"
                                    style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px;">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // In your form submission or initial setup:
        startAnalysis() {
            const state = document.getElementById('state-select').value;
            const projectType = document.getElementById('project-type-select').value;

            // Validate inputs
            if (!state || !projectType) {
                alert('Please select both state and project type');
                return;
            }

            // Store immediately
            this.currentState = state;
            this.currentProjectType = projectType;

            console.log('Starting analysis with:', { state, projectType });

            // Proceed with analysis
            this.analyzeState(state, projectType);
        }

        proceedToAreaResearch(countyFips, countyName, activity) {
            console.log(`Proceeding to area research for ${countyName}`);

            // Show research options dialog
            this.showResearchOptionsDialog(countyFips, countyName, activity);
        }

        showResearchOptionsDialog(countyFips, countyName, activity) {
            const modalHtml = `
                <div class="modal fade" id="researchOptionsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Research Options: ${countyName} County</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-${activity.has_activity ? '6' : '12'}">
                                        <div class="card h-100 border-success">
                                            <div class="card-body text-center">
                                                <div class="mb-3">
                                                    <i class="fas fa-brain fa-3x text-success"></i>
                                                </div>
                                                <h5 class="card-title">AI Market Analysis</h5>
                                                <p class="card-text">Get AI-powered insights on market conditions, development potential, regulatory environment, and strategic recommendations for ${countyName} County.</p>
                                                <button class="btn btn-success" onclick="window.bcf.runAIMarketAnalysis('${countyFips}', '${countyName}'); bootstrap.Modal.getInstance(document.getElementById('researchOptionsModal')).hide();">
                                                    <i class="fas fa-chart-line me-2"></i>Analyze Market with AI
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    ${activity.has_activity ? `
                                        <div class="col-md-6">
                                            <div class="card h-100 border-warning">
                                                <div class="card-body text-center">
                                                    <div class="mb-3">
                                                        <i class="fas fa-folder-open fa-3x text-warning"></i>
                                                    </div>
                                                    <h5 class="card-title">Use Existing Data</h5>
                                                    <p class="card-text">This county has ${activity.folder_count} existing project files. Review and analyze previous parcel data to save time and costs.</p>
                                                    <button class="btn btn-warning" onclick="window.bcf.showExistingDataFiles('${countyFips}', '${countyName}'); bootstrap.Modal.getInstance(document.getElementById('researchOptionsModal')).hide();">
                                                        <i class="fas fa-folder-open me-2"></i>Browse Existing Files
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    ` : `
                                        <div class="col-md-12">
                                            <div class="alert alert-info mt-3">
                                                <h6><i class="fas fa-info-circle me-2"></i>No Existing Data Found</h6>
                                                <p class="mb-0">This county has no previous project data. Use the "Find Parcels" button from the main screen to search for land parcels, or run AI analysis to understand market conditions first.</p>
                                            </div>
                                        </div>
                                    `}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <small class="text-muted me-auto">Use "Find Parcels" button on the main screen to search for land parcels</small>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('researchOptionsModal'));
            modal.show();

            modal._element.addEventListener('hidden.bs.modal', () => {
                document.getElementById('researchOptionsModal').remove();
            });
        }

        async analyzeStateCounties(state, projectType) {
            try {
                this.currentState = state;
                this.currentProjectType = projectType;
                this.updateProjectType(projectType); // Update modules
                
                console.log(`🚀 Starting analysis for ${state} - ${projectType}`);


                // Update UI immediately
                const analyzeBtn = document.getElementById('analyze-state-btn');
                const btnText = analyzeBtn.querySelector('.btn-text');
                const spinner = analyzeBtn.querySelector('.spinner-border');

                if (btnText) btnText.textContent = 'Analyzing...';
                if (spinner) spinner.classList.remove('d-none');
                analyzeBtn.disabled = true;

                // Add detailed logging
                console.log('Making API request to /api/analysis/analyze-state-counties');

                const response = await fetch('/api/analysis/analyze-state-counties', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    },
                    body: JSON.stringify({
                        state: state,
                        project_type: projectType,
                        analysis_type: 'comprehensive'
                    })
                });

                console.log('API Response status:', response.status, response.statusText);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error Response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}\n${errorText}`);
                }

                const result = await response.json();
                console.log('✅ API Response received:', result);

                // DETAILED DEBUGGING
                if (result.analysis && result.analysis.counties) {
                    console.log('📊 Counties analysis:');
                    console.log('- Total counties:', result.analysis.counties.length);
                    console.log('- First 3 counties:', result.analysis.counties.slice(0, 3));
                    
                    // Check for name diversity
                    const names = result.analysis.counties.map(c => c.name);
                    const uniqueNames = new Set(names);
                    console.log(`- Unique names: ${uniqueNames.size} / ${names.length}`);
                    
                    if (uniqueNames.size < 5) {
                        console.warn('⚠️  Very few unique county names detected!');
                        console.log('All names:', names.slice(0, 10));
                    }
                }

                if (!result.success) {
                    throw new Error(result.error || 'API returned success=false');
                }

                if (!result.analysis || !result.analysis.counties) {
                    throw new Error('Invalid API response structure');
                }

                if (result.analysis.counties.length === 0) {
                    throw new Error(`No counties found for ${this.getStateName(state)}`);
                }

                console.log(`✅ Analysis successful: ${result.analysis.counties.length} counties loaded`);

                // Store and display results
                this.currentStateAnalysis = result.analysis;
                await this.loadCountyActivity(state);
                this.displayCountyRankings(result.analysis.counties, state, projectType);
                this.showCountyRankingsScreen();

                console.log('✅ County rankings displayed successfully');

            } catch (error) {
                console.error('💥 State analysis error:', error);
                alert(`Analysis failed: ${error.message}`);
            }
        }

        async loadCountyActivity(state) {
            try {
                console.log(`Loading county activity for ${state}`);

                const response = await fetch(`/api/analysis/check-county-activity/${state}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        this.currentCountyActivity = result.county_activity || {};
                        console.log(`Loaded activity data for ${Object.keys(this.currentCountyActivity).length} counties`);
                    }
                } else {
                    console.warn('Could not load county activity data');
                    this.currentCountyActivity = {};
                }
            } catch (error) {
                console.error('Error loading county activity:', error);
                this.currentCountyActivity = {};
            }
        }

        // Fixed displayCountyRankings method to handle all counties properly
        displayCountyRankings(counties, state, projectType) {
            console.log('🗺️  === DISPLAYING COUNTY RANKINGS ===');
            console.log('Counties received:', counties.length);
            console.log('State:', state, 'Project:', projectType);
            
            if (!counties || counties.length === 0) {
                console.error('❌ No counties data received');
                alert('No county data received from analysis. Please try again.');
                return;
            }

            // Detailed county data inspection
            console.log('First county sample:', counties[0]);
            console.log('County name fields available:', {
                name: counties[0].name,
                county_name: counties[0].county_name,
                county: counties[0].county
            });

            // Check for diversity in names
            const allNames = counties.map(c => c.name || c.county_name || c.county || 'Unknown');
            const uniqueNames = new Set(allNames);
            
            if (uniqueNames.size < counties.length / 2) {
                console.warn('⚠️  Possible duplicate county names detected');
                console.log('Sample names:', allNames.slice(0, 10));
            }

            // Store data
            this.allCounties = counties;
            this.filteredCounties = [];
            this.currentPage = 1;
            this.countiesPerPage = 24;
            this.currentCategoryFilter = null;

            // Update UI elements
            console.log('🔄 Updating UI elements...');
            
            const stateNameElement = document.getElementById('state-name-display');
            if (stateNameElement) {
                stateNameElement.textContent = this.getStateName(state);
                console.log('✅ State name updated');
            }

            // Update summary stats
            this.updateCountySummaryStats(counties);
            console.log('✅ Summary stats updated');

            // Initialize pagination and display
            this.updatePagination();
            console.log('✅ Pagination updated');

            // Initialize search
            this.initializeCountySearch();
            console.log('✅ Search initialized');

            // Populate dropdown
            this.populateCountyDropdown(counties, this.currentCountyActivity || {});
            console.log('✅ Dropdown populated');

            // Initialize dropdown handler
            this.initializeCountyDropdown();
            console.log('✅ Dropdown handler initialized');

            console.log('✅ === COUNTY RANKINGS DISPLAY COMPLETE ===');

            console.log('🔍 Testing activity filter...');
            setTimeout(() => {
                if (this.debugActivityFilter) {
                    this.debugActivityFilter();
                }
            }, 1000);
        }

        updateCountySummaryStats(counties) {
            const excellentCount = counties.filter(c => c.score >= 85).length;
            const goodCount = counties.filter(c => c.score >= 70 && c.score < 85).length;
            const fairCount = counties.filter(c => c.score >= 55 && c.score < 70).length;
            const withDataCount = Object.values(this.currentCountyActivity || {}).filter(c => c.has_activity).length;

            // Update the summary cards with proper totals
            const summaryElements = {
                'total-counties': counties.length,
                'excellent-counties': excellentCount,
                'good-counties': goodCount,
                'fair-counties': fairCount,
                'with-activity': withDataCount
            };

            Object.entries(summaryElements).forEach(([id, count]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = count;
                }
            });

            // Also update the total count for filtering display
            const totalCountEl = document.getElementById('total-count');
            if (totalCountEl) totalCountEl.textContent = counties.length;
            
            const visibleCountEl = document.getElementById('visible-count');
            if (visibleCountEl) visibleCountEl.textContent = counties.length;

            console.log('Summary stats updated:', summaryElements);
        }

        filterByCategory(category) {
            console.log(`Filtering by category: ${category}`);
            
            // Update visual state of summary boxes
            this.updateCategoryFilterUI(category);
            
            // Set the current filter
            this.currentCategoryFilter = category;
            
            // Apply the filter
            this.filterCounties();
            
            // Update filter status label
            this.updateFilterStatusLabel(category);
        }

        initializeCategoryFilters() {
            document.querySelectorAll('.clickable-stat').forEach(stat => {
                const filterType = stat.dataset.filter;
                if (filterType) {
                    stat.onclick = () => this.filterByCategory(filterType);
                }
            });
            console.log('Category filter handlers initialized');
        }

        // Update the visual state of the summary stat boxes
        updateCategoryFilterUI(activeCategory) {
            // Remove active class from all stat items
            document.querySelectorAll('.clickable-stat').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked item (except for 'all')
            if (activeCategory !== 'all') {
                const activeItem = document.querySelector(`[data-filter="${activeCategory}"]`);
                if (activeItem) {
                    activeItem.classList.add('active');
                }
            }
        }

        // Update the filter status label
        updateFilterStatusLabel(category) {
            const filterLabel = document.getElementById('active-filter-label');
            if (!filterLabel) return;
            
            const labels = {
                'all': '',
                'excellent': '• Excellent Counties (85+)',
                'good': '• Good Counties (70-84)', 
                'fair': '• Fair Counties (55-69)',
                'activity': '• Counties with Past Activity'
            };
            
            filterLabel.textContent = labels[category] || '';
        }

        filterCounties() {
            const searchTerm = document.getElementById('county-search')?.value.toLowerCase() || '';
            
            // Start with all counties
            let countiesToFilter = [...this.allCounties];
            
            // Apply filters
            this.filteredCounties = countiesToFilter.filter(county => {
                // Text search filter
                const matchesSearch = !searchTerm || county.name.toLowerCase().includes(searchTerm);
                
                // Category filter based on clicked summary box
                let matchesCategory = true;
                if (this.currentCategoryFilter && this.currentCategoryFilter !== 'all') {
                    switch(this.currentCategoryFilter) {
                        case 'excellent':
                            matchesCategory = county.score >= 85;
                            break;
                        case 'good':
                            matchesCategory = county.score >= 70 && county.score < 85;
                            break;
                        case 'fair':
                            matchesCategory = county.score >= 55 && county.score < 70;
                            break;
                        case 'activity':
                            // FIXED: Better activity lookup logic
                            const hasActivity = this.checkCountyActivity(county.name);
                            console.log(`Checking activity for ${county.name}:`, hasActivity);
                            matchesCategory = hasActivity;
                            break;
                        default:
                            matchesCategory = true;
                    }
                }
                
                return matchesSearch && matchesCategory;
            });

            // Reset to first page and update pagination
            this.currentPage = 1;
            this.updatePagination();

            // Update visible count
            const visibleCountEl = document.getElementById('visible-count');
            const totalCountEl = document.getElementById('total-count');
            
            if (visibleCountEl) {
                visibleCountEl.textContent = this.filteredCounties.length;
            }
            
            if (totalCountEl) {
                totalCountEl.textContent = this.allCounties.length;
            }
            
            console.log(`Filtered ${this.filteredCounties.length} counties for category: ${this.currentCategoryFilter}`);
        }

        // Add helper method to check county activity
        checkCountyActivity(countyName) {
            if (!this.currentCountyActivity) {
                console.log('No activity data loaded');
                return false;
            }
            
            // Check if this county has activity
            const activity = this.currentCountyActivity[countyName];
            console.log(`Activity data for ${countyName}:`, activity);
            
            return activity && activity.has_activity === true;
        }

        // Fix the loadCountyActivity method to ensure data is stored correctly
        async loadCountyActivity(state) {
            try {
                console.log(`Loading county activity for ${state}`);

                const response = await fetch(`/api/analysis/check-county-activity/${state}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        this.currentCountyActivity = result.county_activity || {};
                        console.log(`Loaded activity data:`, this.currentCountyActivity);
                        console.log(`Counties with activity: ${Object.keys(this.currentCountyActivity).filter(k => this.currentCountyActivity[k].has_activity)}`);
                    } else {
                        console.warn('County activity API returned success=false');
                        this.currentCountyActivity = {};
                    }
                } else {
                    console.warn('Could not load county activity data - HTTP error');
                    this.currentCountyActivity = {};
                }
            } catch (error) {
                console.error('Error loading county activity:', error);
                this.currentCountyActivity = {};
            }
        }

        // Debug function - add this to test filtering
        debugActivityFilter() {
            console.log('=== ACTIVITY FILTER DEBUG ===');
            console.log('Current activity data:', this.currentCountyActivity);
            console.log('All counties:', this.allCounties.map(c => c.name));
            
            // Test each county
            this.allCounties.forEach(county => {
                const hasActivity = this.checkCountyActivity(county.name);
                if (hasActivity) {
                    console.log(`✅ ${county.name} has activity`);
                }
            });
            console.log('=============================');
        }

        updatePagination() {
            const countiesPerPageSelect = document.getElementById('counties-per-page');
            const paginationControls = document.getElementById('pagination-controls');

            if (!countiesPerPageSelect || !this.allCounties) return;

            this.countiesPerPage = parseInt(countiesPerPageSelect.value);
            
            // FIXED: Better logic for which counties to show
            const countiesToShow = (this.filteredCounties.length > 0 || this.currentCategoryFilter) ? 
                                this.filteredCounties : this.allCounties;
            
            const totalPages = Math.ceil(countiesToShow.length / this.countiesPerPage);

            // Update pagination controls
            let paginationHTML = '';

            if (totalPages > 1) {
                // Previous button
                paginationHTML += `<button class="pagination-btn ${this.currentPage === 1 ? 'disabled' : ''}"
                                    onclick="window.bcf.goToPage(${this.currentPage - 1})" ${this.currentPage === 1 ? 'disabled' : ''}>
                                    Previous
                                </button>`;

                // Page numbers (show 5 pages max)
                const startPage = Math.max(1, this.currentPage - 2);
                const endPage = Math.min(totalPages, startPage + 4);

                for (let i = startPage; i <= endPage; i++) {
                    paginationHTML += `<button class="pagination-btn ${i === this.currentPage ? 'active' : ''}"
                                        onclick="window.bcf.goToPage(${i})">
                                        ${i}
                                    </button>`;
                }

                // Next button
                paginationHTML += `<button class="pagination-btn ${this.currentPage === totalPages ? 'disabled' : ''}"
                                    onclick="window.bcf.goToPage(${this.currentPage + 1})" ${this.currentPage === totalPages ? 'disabled' : ''}>
                                    Next
                                </button>`;
            }

            if (paginationControls) {
                paginationControls.innerHTML = paginationHTML;
            }

            // Update table content
            this.displayCountyCards();
            
            // FIXED: Update counts properly
            const visibleCountEl = document.getElementById('visible-count');
            const totalCountEl = document.getElementById('total-count');
            
            if (visibleCountEl) {
                visibleCountEl.textContent = countiesToShow.length;
            }
            if (totalCountEl) {
                totalCountEl.textContent = this.allCounties.length;
            }
        }

        goToPage(pageNumber) {
            const countiesToShow = this.filteredCounties.length > 0 ? this.filteredCounties : this.allCounties;
            const totalPages = Math.ceil(countiesToShow.length / this.countiesPerPage);
            if (pageNumber >= 1 && pageNumber <= totalPages) {
                this.currentPage = pageNumber;
                this.updatePagination();
            }
        }

        displayCountyCards() {
            const countiesToShow = (this.filteredCounties.length > 0 || this.currentCategoryFilter) ? 
                                    this.filteredCounties : this.allCounties;
            
            const startIndex = (this.currentPage - 1) * this.countiesPerPage;
            const endIndex = Math.min(startIndex + this.countiesPerPage, countiesToShow.length);
            const currentCounties = countiesToShow.slice(startIndex, endIndex);

            const countyGrid = document.getElementById('county-grid');
            if (!countyGrid) return;

            let html = '';
            currentCounties.forEach((county, pageIndex) => {
                const globalRank = startIndex + pageIndex + 1;
                
                // FIXED: Use actual activity data instead of hardcoded lookup
                const activity = this.currentCountyActivity[county.name] || { has_activity: false, folder_count: 0 };

                const countyName = county.name || 'Unknown County';
                
                let scoreClass = '';
                if (county.score >= 85) scoreClass = 'score-excellent';
                else if (county.score >= 70) scoreClass = 'score-good';
                else if (county.score >= 55) scoreClass = 'score-fair';
                else scoreClass = 'score-poor';

                const strengths = this.generateCountyStrengths(county);

                html += `
                    <div class="county-card" onclick="window.bcf.selectCounty('${county.fips}', '${countyName}')">
                        <div class="county-header">
                            <div class="county-info">
                                <div class="county-name">${countyName}</div>
                                <div class="county-details">
                                    Population: ${(county.population || 0).toLocaleString()}
                                    • ${county.rural_indicator ? 'Rural' : 'Urban'} Area
                                </div>
                            </div>
                            <div class="county-score">
                                <div class="score-circle ${scoreClass}">
                                    ${county.score}
                                </div>
                                <div class="score-label">AI Score</div>
                            </div>
                        </div>

                        <div class="metrics-grid">
                            <div class="metric-item">
                                <div class="metric-label">Grid</div>
                                <div class="metric-value">${county.factor_scores?.transmission || 75}</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Terrain</div>
                                <div class="metric-value">${county.factor_scores?.topography || 80}</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Policy</div>
                                <div class="metric-value">${county.factor_scores?.regulatory || 70}</div>
                            </div>
                        </div>

                        <div class="county-bottom">
                            <div class="strengths-list">
                                ${strengths.map(s => `<span class="strength-tag">${s}</span>`).join('')}
                            </div>
                            <div class="status-column">
                                <div class="development-potential potential-${(county.development_potential || 'medium').toLowerCase()}">
                                    ${county.development_potential || 'Moderate'} Potential
                                </div>
                                <div class="past-activity ${activity.has_activity ? 'has-activity' : ''}">
                                    ${activity.has_activity ? `${activity.folder_count} files` : 'New market'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            countyGrid.innerHTML = html;
        }

        exportAnalysisReport(countyName) {
            // Get the current analysis content
            const analysisContent = document.querySelector('.ai-analysis-content')?.textContent || 'Analysis content not available';

            const reportContent = `AI MARKET ANALYSIS REPORT
        Generated: ${new Date().toLocaleString()}
        Location: ${countyName} County, ${this.getStateName(this.currentState)}
        Project Type: ${this.currentProjectType.toUpperCase()} Energy Development

        ${analysisContent}

        ---
        Report generated by BCF.ai renewable energy analysis platform
        For questions or detailed analysis, contact your BCF.ai administrator
        `;

            // Download as text file
            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AI_Market_Analysis_${countyName}_${this.currentState}_${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            this.showNotification(`Analysis report exported: ${countyName} County`, 'success');
        }

        enableParcelSearchInterface() {
            // Remove any disabled classes
            const searchScreen = document.getElementById('parcel-search-screen');
            if (searchScreen) {
                searchScreen.classList.remove('analysis-completed');
                searchScreen.style.opacity = '1';
                searchScreen.style.pointerEvents = 'auto';

                // Enable all form elements
                const inputs = searchScreen.querySelectorAll('input, select, button');
                inputs.forEach(element => {
                    element.disabled = false;
                    element.style.opacity = '1';
                    element.style.pointerEvents = 'auto';
                });

                console.log('Parcel search interface enabled');
            }
        }

        proceedToParcelSearchFromAI(countyFips, countyName) {
            console.log(`Proceeding to parcel search from AI analysis: ${countyName}`);
            console.log('=== PARCEL SEARCH TRANSITION DEBUG ===');
            console.log('Current State:', this.currentState);
            console.log('Current Project Type:', this.currentProjectType);
            console.log('County Name:', countyName);
            console.log('County FIPS:', countyFips);
            console.log('AI Analysis Completed Flag:', this.aiAnalysisCompleted);
            console.log('=====================================');

            // Ensure we have the required state
            if (!this.currentState || !this.currentProjectType) {
                console.error('Missing current state or project type');
                alert('Session information missing. Please go back to county selection.');
                return;
            }

            // Set up the analysis object properly
            this.currentAnalysis = {
                state: this.currentState,
                county: countyName,
                county_id: countyFips,
                project_type: this.currentProjectType,
                location: `${countyName}, ${this.getStateName(this.currentState)}`,
                analysis_level: 'county',
                has_past_activity: false, // Coming from AI analysis, not from existing data
                activity_data: { has_activity: false }
            };

            console.log('Analysis object set:', this.currentAnalysis);

            // Clear any disabled states
            this.aiAnalysisCompleted = false;

            // Hide current screens
            document.getElementById('county-rankings-screen').style.display = 'none';

            // Remove any existing analysis containers
            const existingContainer = document.getElementById('parcel-analysis-container');
            if (existingContainer) {
                existingContainer.remove();
            }

            // Show the parcel search interface
            this.showParcelSearchInterface();
        }

        displayAIMarketAnalysisResults(analysis, countyName, analysisType) {
            console.log('🧠 Displaying AI analysis results for:', countyName);
            console.log('📄 Analysis content length:', analysis?.length || 'undefined');

            // Remove any existing modal first
            const existingModal = document.getElementById('aiMarketAnalysisModal');
            if (existingModal) {
                console.log('🗑️ Removing existing modal');
                existingModal.remove();
            }

            // Get county FIPS for the proceed button
            const selectedCountyOption = document.querySelector('#target-county option:checked');
            const countyFips = selectedCountyOption ? selectedCountyOption.value : countyName;

            const modalHtml = `
                <div id="aiMarketAnalysisModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    z-index: 99999;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                ">
                    <div style="
                        background: white;
                        border-radius: 12px;
                        width: 85%;
                        max-width: 900px;
                        max-height: 85vh;
                        overflow: hidden;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.4);
                    ">
                        <div style="
                            background: linear-gradient(135deg, #198754, #20c997);
                            color: white;
                            padding: 20px 30px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <div>
                                <h3 style="margin: 0; font-size: 1.5rem;">🧠 AI Market Analysis</h3>
                                <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 1.1rem;">${countyName} County</p>
                            </div>
                            <button onclick="document.getElementById('aiMarketAnalysisModal').remove();" style="
                                background: none;
                                border: none;
                                color: white;
                                font-size: 32px;
                                cursor: pointer;
                                padding: 0;
                                line-height: 1;
                                width: 40px;
                                height: 40px;
                                border-radius: 50%;
                                transition: background 0.2s;
                            " onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='none'">&times;</button>
                        </div>
                        <div style="
                            padding: 30px;
                            max-height: 60vh;
                            overflow-y: auto;
                        ">
                            <div style="margin-bottom: 25px;">
                                <span style="
                                    background: linear-gradient(135deg, #0d6efd, #6610f2);
                                    color: white;
                                    padding: 8px 16px;
                                    border-radius: 20px;
                                    font-size: 0.9rem;
                                    font-weight: 600;
                                ">${analysisType}</span>
                            </div>
                            <div style="
                                background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                                border: 1px solid #dee2e6;
                                border-radius: 12px;
                                padding: 30px;
                            ">
                                <pre style="
                                    white-space: pre-wrap;
                                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                                    line-height: 1.7;
                                    margin: 0;
                                    font-size: 15px;
                                    color: #2c3e50;
                                ">${analysis}</pre>
                            </div>
                        </div>
                        <div style="
                            padding: 20px 30px;
                            border-top: 1px solid #dee2e6;
                            background: #f8f9fa;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <small style="color: #6c757d;">
                                Generated: ${new Date().toLocaleString()}
                            </small>
                            <div style="display: flex; gap: 15px;">
                                <button onclick="document.getElementById('aiMarketAnalysisModal').remove();" style="
                                    background: #6c757d;
                                    color: white;
                                    border: none;
                                    padding: 12px 24px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    transition: all 0.2s;
                                " onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">Close</button>
                                <button onclick="
                                    console.log('Proceeding to parcel search for ${countyName}...');
                                    if (window.bcf && window.bcf.proceedToParcelSearchFromAI) {
                                        window.bcf.proceedToParcelSearchFromAI('${countyFips}', '${countyName}');
                                    }
                                    document.getElementById('aiMarketAnalysisModal').remove();
                                " style="
                                    background: linear-gradient(135deg, #198754, #20c997);
                                    color: white;
                                    border: none;
                                    padding: 12px 24px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    transition: all 0.2s;
                                " onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">🔍 Find Parcels</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            console.log('➕ Adding modal to DOM');
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            console.log('✅ Modal should now be visible');
            return true;
        }

        downloadCurrentAnalysis() {
            try {
                if (!this.currentAnalysisData) {
                    alert('No analysis data available to download');
                    return;
                }

                const { content, county, type, state, projectType, timestamp } = this.currentAnalysisData;
                
                const reportContent = `AI MARKET ANALYSIS REPORT
        ========================

        County: ${county}
        State: ${this.getStateName(state)}
        Analysis Type: ${type}
        Project Type: ${projectType?.toUpperCase()} Energy Development
        Generated: ${timestamp}

        ANALYSIS SUMMARY
        ================

        ${content}

        METHODOLOGY
        ===========

        This analysis was generated using advanced AI algorithms that considered:
        • Market conditions and economic factors
        • Resource quality and availability  
        • Regulatory environment and policies
        • Infrastructure and grid connectivity
        • Competitive landscape analysis
        • Risk assessment and mitigation strategies

        DISCLAIMER
        ==========

        This report is for informational purposes only and should be used in conjunction 
        with professional due diligence. Market conditions may change rapidly, and all 
        recommendations should be verified with current data and local expertise.

        ---
        Report generated by BCF.ai Renewable Energy Analysis Platform
        © ${new Date().getFullYear()} - All rights reserved
                `;

                // Download as text file
                const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `AI_Market_Analysis_${county}_${state}_${new Date().toISOString().slice(0, 10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                this.showNotification(`AI Market Analysis report downloaded for ${county}`, 'success');

            } catch (error) {
                console.error('Download error:', error);
                this.showNotification('Failed to download report', 'error');
            }
        }

        generateCountyStrengths(county) {
            const strengths = [];

            if (county.factor_scores?.transmission >= 80) strengths.push('Strong Grid');
            if (county.factor_scores?.topography >= 80) strengths.push('Flat Terrain');
            if (county.factor_scores?.regulatory >= 75) strengths.push('Good Policy');
            if (county.rural_indicator) strengths.push('Rural');
            if (county.population && county.population < 50000) strengths.push('Low Density');

            // Add default strengths if none found
            if (strengths.length === 0) {
                strengths.push('Standard', 'Available');
            }

            return strengths.slice(0, 3); // Limit to 3
        }

        populateCountyDropdown(counties, countyActivity) {
            const countySelect = document.getElementById('target-county');
            if (!countySelect) return;

            countySelect.innerHTML = '<option value="">Select a county...</option>';

            counties.forEach((county, index) => {
                const activity = countyActivity[county.fips] || countyActivity[county.name] || { has_activity: false };
                const indicators = [];

                if (index < 10) indicators.push('TOP 10');
                if (activity.has_activity) indicators.push('HAS DATA');
                if (county.rural_indicator) indicators.push('RURAL');
                if (county.score >= 80) indicators.push('HIGH SCORE');

                const indicatorText = indicators.length > 0 ? ` [${indicators.join(', ')}]` : '';

                const option = document.createElement('option');
                option.value = county.fips || county.name;
                option.textContent = `${county.name} (#${index + 1} - ${county.score}/100)${indicatorText}`;
                option.dataset.countyName = county.name;
                option.dataset.hasActivity = activity.has_activity;
                option.dataset.score = county.score;

                countySelect.appendChild(option);
            });
        }

        // Add search initialization method
        initializeCountySearch() {
            const searchInput = document.getElementById('county-search');
            if (searchInput) {
                // Add debounced search for better performance
                let searchTimeout;
                searchInput.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => this.filterCounties(), 300);
                });
            }
        }

        clearFilters() {
            // Clear text search
            const searchInput = document.getElementById('county-search');
            if (searchInput) searchInput.value = '';
            
            // Clear category filter
            this.currentCategoryFilter = null;
            
            // Reset visual state
            document.querySelectorAll('.clickable-stat').forEach(item => {
                item.classList.remove('active');
            });
            
            // Clear filter status label
            this.updateFilterStatusLabel('all');
            
            // Reset filtered counties
            this.filteredCounties = [];
            this.currentPage = 1;
            this.updatePagination();
            
            // Update counts to show all counties
            const visibleCountEl = document.getElementById('visible-count');
            const totalCountEl = document.getElementById('total-count');
            
            if (visibleCountEl) visibleCountEl.textContent = this.allCounties.length;
            if (totalCountEl) totalCountEl.textContent = this.allCounties.length;
        }

        // Add method to handle dropdown changes
        initializeCountyDropdown() {
            const countySelect = document.getElementById('target-county');
            if (countySelect) {
                countySelect.addEventListener('change', function() {
                    const selectedValue = this.value;
                    const selectedOption = this.options[this.selectedIndex];
                    
                    if (selectedValue && selectedOption) {
                        const countyName = selectedOption.dataset.countyName;
                        if (countyName && window.bcf) {
                            window.bcf.selectCounty(selectedValue, countyName);
                        }
                    } else {
                        // Reset sticky bar when no selection
                        const selectedNameEl = document.getElementById('selected-county-name');
                        const selectedDetailsEl = document.getElementById('selected-county-details');
                        
                        if (selectedNameEl) {
                            selectedNameEl.innerHTML = '<i class="fas fa-crosshairs me-2"></i>Select a county to proceed';
                        }
                        
                        if (selectedDetailsEl) {
                            selectedDetailsEl.textContent = 'Choose from the ranked counties above';
                        }
                        
                        // Disable buttons
                        ['find-parcels-btn-alt', 'research-areas-btn-alt', 'existing-files-btn-alt'].forEach(btnId => {
                            const btn = document.getElementById(btnId);
                            if (btn) btn.disabled = true;
                        });
                    }
                });
            }
        }

        selectCounty(countyFips, countyName) {
            console.log(`County selected: ${countyName} (FIPS: ${countyFips})`);

            const activity = this.currentCountyActivity[countyFips] || this.currentCountyActivity[countyName] || { has_activity: false };

            // Update dropdown
            const countySelect = document.getElementById('target-county');
            if (countySelect) countySelect.value = countyFips;

            // Update sticky bar info
            const selectedNameEl = document.getElementById('selected-county-name');
            const selectedDetailsEl = document.getElementById('selected-county-details');
            
            if (selectedNameEl) {
                selectedNameEl.innerHTML = `<i class="fas fa-crosshairs me-2"></i>${countyName} County Selected`;
            }
            
            if (selectedDetailsEl) {
                const activityText = activity.has_activity ? 
                    `Has ${activity.folder_count || 'previous'} project files • Past activity found` : 
                    'New market opportunity • No previous activity';
                selectedDetailsEl.textContent = activityText;
            }

            // FIXED: Ensure button handlers are properly bound with proper parameters
            const findBtn = document.getElementById('find-parcels-btn-alt');
            const researchBtn = document.getElementById('research-areas-btn-alt');
            const existingBtn = document.getElementById('existing-files-btn-alt');

            if (findBtn) {
                findBtn.disabled = false;
                // Remove any existing event listeners and add new one
                findBtn.onclick = null;
                findBtn.onclick = () => {
                    console.log('Find Parcels clicked for:', countyName);
                    this.proceedToParcelSearch(countyFips, countyName, activity);
                };
            }

            if (researchBtn) {
                researchBtn.disabled = false;
                researchBtn.onclick = null;
                researchBtn.onclick = () => {
                    console.log('Research Areas clicked for:', countyName);
                    this.runAIMarketAnalysis(countyFips, countyName);
                };
            }

            if (existingBtn) {
                existingBtn.disabled = false;
                existingBtn.onclick = null;
                existingBtn.onclick = () => {
                    console.log('Existing Files clicked for:', countyName);
                    // Call the debug version
                    this.debugButtonClick(countyFips, countyName);
                };
            }

            // Highlight selected card
            document.querySelectorAll('.county-card').forEach(card => card.classList.remove('selected'));
            
            const selectedCard = Array.from(document.querySelectorAll('.county-card')).find(card => 
                card.textContent.includes(countyName)
            );
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }

            this.showCountySelectionNotification(countyName, activity);
        }

        showCountySelectionNotification(countyName, activity) {
            document.querySelectorAll('.county-selection-notification').forEach(n => n.remove());

            const notification = document.createElement('div');
            notification.className = 'alert alert-dismissible fade show position-fixed county-selection-notification';
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 350px; max-width: 500px;';

            if (activity.has_activity) {
                notification.classList.add('alert-success');
                notification.innerHTML = `
                    <div class="d-flex align-items-start">
                        <div class="me-3 fs-4">✅</div>
                        <div class="flex-grow-1">
                            <h6 class="alert-heading mb-2">Past Project Activity Found!</h6>
                            <p class="mb-2"><strong>County:</strong> ${countyName}</p>
                            <p class="mb-2"><strong>Project Folders:</strong> ${activity.folder_count} found in Cloud Storage</p>
                            ${activity.latest_activity ? `<p class="mb-2"><strong>Last Activity:</strong> ${new Date(activity.latest_activity).toLocaleDateString()}</p>` : ''}
                            <hr class="my-2">
                            <small class="text-success">
                                <strong>Advantage:</strong> You have existing data and relationships in this county!
                                <br>Choose your next step below.
                            </small>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
            } else {
                notification.classList.add('alert-info');
                notification.innerHTML = `
                    <div class="d-flex align-items-start">
                        <div class="me-3 fs-4">🆕</div>
                        <div class="flex-grow-1">
                            <h6 class="alert-heading mb-2">New Market Opportunity</h6>
                            <p class="mb-2"><strong>County:</strong> ${countyName}</p>
                            <p class="mb-2"><strong>Status:</strong> No past project activity found</p>
                            <hr class="my-2">
                            <small class="text-info">
                                <strong>Fresh Start:</strong> This represents a new market area with no prior outreach.
                                <br>Choose your next step below.
                            </small>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
            }

            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 8000);
        }

        proceedToParcelSearch(countyFips, countyName, activity) {
            try {
                console.log(`Proceeding to parcel search for ${countyName} (FIPS: ${countyFips})`);

                if (!this.currentState || !this.currentProjectType) {
                    console.error('Missing current state or project type');
                    alert('Session information missing. Please go back to county selection.');
                    return;
                }

                this.currentAnalysis = {
                    state: this.currentState,
                    county: countyName,
                    county_id: countyFips,
                    project_type: this.currentProjectType,
                    location: `${countyName}, ${this.getStateName(this.currentState)}`,
                    analysis_level: 'county',
                    has_past_activity: activity.has_activity,
                    activity_data: activity
                };

                console.log('Analysis object set:', this.currentAnalysis);

                document.getElementById('county-rankings-screen').style.display = 'none';
                this.showParcelSearchInterface();

            } catch (error) {
                console.error('Error in proceedToParcelSearch:', error);
                alert(`Error: ${error.message}`);
            }
        }

        // Header button handlers
        proceedToParcelSearchFromHeader() {
            const countySelect = document.getElementById('target-county');
            const selectedValue = countySelect?.value;
            const selectedOption = countySelect?.options[countySelect.selectedIndex];

            if (!selectedValue || !selectedOption) {
                alert('Please select a county first');
                return;
            }

            const countyName = selectedOption.dataset.countyName;
            const hasActivity = selectedOption.dataset.hasActivity === 'true';

            this.proceedToParcelSearch(selectedValue, countyName, { has_activity: hasActivity });
        }

        proceedToAreaResearchFromHeader() {
            const countySelect = document.getElementById('target-county');
            const selectedValue = countySelect?.value;
            const selectedOption = countySelect?.options[countySelect.selectedIndex];

            if (!selectedValue || !selectedOption) {
                alert('Please select a county first');
                return;
            }

            const countyName = selectedOption.dataset.countyName;
            const hasActivity = selectedOption.dataset.hasActivity === 'true';

            this.proceedToAreaResearch(selectedValue, countyName, { has_activity: hasActivity });
        }

        showCountyRankingsScreen() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('county-rankings-screen').style.display = 'block';
        }

        getStateName(stateCode) {
            const stateNames = {
                'AL': 'Alabama', 'AZ': 'Arizona', 'AR': 'Arkansas', 'CA': 'California',
                'CO': 'Colorado', 'FL': 'Florida', 'GA': 'Georgia', 'IL': 'Illinois',
                'IN': 'Indiana', 'IA': 'Iowa', 'KS': 'Kansas', 'KY': 'Kentucky',
                'LA': 'Louisiana', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi',
                'MO': 'Missouri', 'NE': 'Nebraska', 'NV': 'Nevada', 'NM': 'New Mexico',
                'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota',
                'OH': 'Ohio', 'OK': 'Oklahoma', 'PA': 'Pennsylvania', 'SC': 'South Carolina',
                'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah',
                'VA': 'Virginia', 'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming'
            };
            return stateNames[stateCode] || stateCode;
        }

        showParcelSearchInterface() {
            console.log('Showing parcel search interface for:', this.currentAnalysis.location);

            // Hide county rankings screen
            document.getElementById('county-rankings-screen').style.display = 'none';

            // Create parcel search interface
            const searchInterfaceHtml = `
                <div id="parcel-search-screen" class="workflow-step">
                    <div class="container-fluid">
                        <!-- Header -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white">
                                        <h3 class="mb-0">
                                            <i class="fas fa-search me-2"></i>
                                            Parcel Search: ${this.currentAnalysis.location}
                                        </h3>
                                    </div>
                                    <div class="card-body">
                                        <div class="row align-items-center">
                                            <div class="col-md-6">
                                                <p class="mb-0">
                                                    <strong>Project Type:</strong> ${this.currentProjectType}<br>
                                                    <strong>Analysis Level:</strong> ${this.currentAnalysis.analysis_level}
                                                </p>
                                            </div>
                                            <div class="col-md-6 text-end">
                                                ${this.currentAnalysis.has_past_activity ?
                                                    '<span class="badge bg-success fs-6">Has Previous Activity</span>' :
                                                    '<span class="badge bg-info fs-6">New Market</span>'
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Search Criteria Form -->
                        <div class="row">
                            <div class="col-lg-8">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Search Criteria</h5>
                                    </div>
                                    <div class="card-body">
                                        <form id="parcel-search-form">
                                            <!-- Acreage Filters -->
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">Minimum Acres</label>
                                                    <input type="number" class="form-control" id="acreage-min"
                                                           placeholder="e.g. 10" step="0.1" min="0">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Maximum Acres</label>
                                                    <input type="number" class="form-control" id="acreage-max"
                                                           placeholder="e.g. 500" step="0.1" min="0">
                                                </div>
                                            </div>

                                            <!-- Owner Search -->
                                            <div class="mb-3">
                                                <label class="form-label">Owner Name (Optional)</label>
                                                <input type="text" class="form-control" id="owner-search"
                                                       placeholder="Search by landowner name">
                                                <small class="form-text text-muted">
                                                    Leave blank to search all owners
                                                </small>
                                            </div>

                                            <!-- Parcel ID Search -->
                                            <div class="mb-3">
                                                <label class="form-label">Parcel ID (Optional)</label>
                                                <input type="text" class="form-control" id="parcel-id-search"
                                                       placeholder="Search by specific parcel ID">
                                            </div>

                                            <!-- Search Actions -->
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <button type="button" class="btn btn-outline-info w-100"
                                                            id="preview-search-btn">
                                                        <i class="fas fa-eye me-2"></i>Preview Count
                                                    </button>
                                                </div>
                                                <div class="col-md-6">
                                                    <button type="submit" class="btn btn-success w-100"
                                                            id="execute-search-btn" disabled>
                                                        <i class="fas fa-search me-2"></i>
                                                        <span class="btn-text">Search Parcels</span>
                                                        <span class="spinner-border spinner-border-sm d-none ms-2"></span>
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>

                            <!-- Search Guidelines -->
                            <div class="col-lg-4">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0">Search Guidelines</h6>
                                    </div>
                                    <div class="card-body">
                                        <h6>Recommended Criteria:</h6>
                                        <ul class="small mb-3">
                                            <li><strong>Solar:</strong> 5-200 acres</li>
                                            <li><strong>Wind:</strong> 50-1000 acres</li>
                                            <li><strong>Battery:</strong> 1-50 acres</li>
                                        </ul>

                                        <h6>Tips:</h6>
                                        <ul class="small mb-0">
                                            <li>Start with broader criteria</li>
                                            <li>Use Preview to check count</li>
                                            <li>Owner search is case-insensitive</li>
                                            <li>Leave fields blank for wider search</li>
                                        </ul>
                                    </div>
                                </div>

                                <!-- Search Status -->
                                <div class="card border-warning mt-3" id="search-status-card" style="display: none;">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0">Search Status</h6>
                                    </div>
                                    <div class="card-body" id="search-status-content">
                                        <!-- Status updates will appear here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Search Results Area -->
                        <div class="row mt-4" id="search-results-area" style="display: none;">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0">
                                            <i class="fas fa-map me-2"></i>
                                            Search Results
                                        </h5>
                                    </div>
                                    <div class="card-body" id="search-results-content">
                                        <!-- Results will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Back Navigation -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <button class="btn btn-outline-secondary" onclick="window.bcf.backToCountySelection()">
                                    <i class="fas fa-arrow-left me-2"></i>
                                    Back to County Selection
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Insert the search interface
            const existingScreen = document.getElementById('parcel-search-screen');
            if (existingScreen) {
                existingScreen.remove();
            }

            document.body.insertAdjacentHTML('beforeend', searchInterfaceHtml);

            // Initialize form handlers
            this.initializeParcelSearchHandlers();

            // Set default criteria based on project type
            this.setDefaultSearchCriteria();
        }

        initializeParcelSearchHandlers() {
            // Preview button handler
            document.getElementById('preview-search-btn').addEventListener('click', () => {
                this.previewParcelSearch();
            });

            // Search form handler
            document.getElementById('parcel-search-form').addEventListener('submit', (e) => {
                e.preventDefault();
                this.executeParcelSearch();
            });

            // Enable search button when criteria is entered
            const inputs = ['acreage-min', 'acreage-max', 'owner-search', 'parcel-id-search'];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('input', () => {
                    this.validateSearchCriteria();
                });
            });
        }

        setDefaultSearchCriteria() {
            const defaults = {
                'solar': { min: 5, max: 200 },
                'wind': { min: 50, max: 1000 },
                'battery': { min: 1, max: 50 },
                'mixed': { min: 5, max: 500 }
            };

            const projectDefaults = defaults[this.currentProjectType] || defaults['mixed'];

            document.getElementById('acreage-min').value = projectDefaults.min;
            document.getElementById('acreage-max').value = projectDefaults.max;

            this.validateSearchCriteria();
        }

        validateSearchCriteria() {
            const minAcres = document.getElementById('acreage-min').value;
            const maxAcres = document.getElementById('acreage-max').value;
            const owner = document.getElementById('owner-search').value;
            const parcelId = document.getElementById('parcel-id-search').value;

            // Enable search if we have at least one criteria
            const hasMinAcres = minAcres && parseFloat(minAcres) > 0;
            const hasMaxAcres = maxAcres && parseFloat(maxAcres) > 0;
            const hasOwner = owner.trim().length > 0;
            const hasParcelId = parcelId.trim().length > 0;

            const searchBtn = document.getElementById('execute-search-btn');
            searchBtn.disabled = !(hasMinAcres || hasMaxAcres || hasOwner || hasParcelId);
        }

        async previewParcelSearch() {
            try {
                const criteria = this.getSearchCriteria();

                this.showSearchStatus('Getting count preview...', 'info');

                const response = await fetch('/api/analysis/preview-parcel-search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        county_id: this.currentAnalysis.county_id,
                        county_name: this.currentAnalysis.county,
                        state: this.currentState,
                        ...criteria
                    })
                });

                const result = await response.json();

                if (result.success) {
                    this.showSearchStatus(
                        `Preview: Found approximately ${result.record_count} parcels matching your criteria`,
                        'success'
                    );
                } else {
                    this.showSearchStatus(`Result: ${result.message}`, 'error');
                }

            } catch (error) {
                console.error('Preview error:', error);
                this.showSearchStatus(`Preview error: ${error.message}`, 'error');
            }
        }

        async executeParcelSearch() {
            try {
                const criteria = this.getSearchCriteria();

                // Update button state
                const searchBtn = document.getElementById('execute-search-btn');
                const btnText = searchBtn.querySelector('.btn-text');
                const spinner = searchBtn.querySelector('.spinner-border');

                btnText.textContent = 'Searching...';
                spinner.classList.remove('d-none');
                searchBtn.disabled = true;

                this.showSearchStatus('Executing parcel search with ReportAll API...', 'info');

                const response = await fetch('/api/analysis/execute-parcel-search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        county_id: this.currentAnalysis.county_id,
                        county_name: this.currentAnalysis.county,
                        state: this.currentState,
                        project_type: this.currentProjectType,
                        user_id: 'current_user',
                        ...criteria
                    })
                });

                const result = await response.json();

                if (result.success) {
                    this.showSearchStatus(
                        `Success! Found ${result.record_count} parcels. Files saved to cloud storage.`,
                        'success'
                    );

                    // Show results with real data
                    this.displayParcelSearchResults(result);
                } else {
                    this.showSearchStatus(`Search failed: ${result.error}`, 'error');
                    
                    // Log more details for debugging
                    console.error('Parcel search API error:', result);
                }

            } catch (error) {
                console.error('Search error:', error);
                this.showSearchStatus(`Search error: ${error.message}`, 'error');
            } finally {
                // Reset button state
                const searchBtn = document.getElementById('execute-search-btn');
                const btnText = searchBtn.querySelector('.btn-text');
                const spinner = searchBtn.querySelector('.spinner-border');

                btnText.textContent = 'Search Parcels';
                spinner.classList.add('d-none');
                this.validateSearchCriteria(); // Re-enable based on criteria
            }
        }

        getSearchCriteria() {
            return {
                calc_acreage_min: document.getElementById('acreage-min').value || null,
                calc_acreage_max: document.getElementById('acreage-max').value || null,
                owner: document.getElementById('owner-search').value || null,
                parcel_id: document.getElementById('parcel-id-search').value || null
            };
        }

        showSearchStatus(message, type) {
            const statusCard = document.getElementById('search-status-card');
            const statusContent = document.getElementById('search-status-content');

            statusCard.style.display = 'block';

            const alertClass = {
                'info': 'alert-info',
                'success': 'alert-success',
                'error': 'alert-danger'
            }[type] || 'alert-info';

            statusContent.innerHTML = `
                <div class="alert ${alertClass} mb-0">
                    ${message}
                </div>
            `;
        }

        displayParcelSearchResults(result) {
            const resultsArea = document.getElementById('search-results-area');
            const resultsContent = document.getElementById('search-results-content');

            resultsArea.style.display = 'block';

            const recordCount = result.record_count || 0;
            const processingTime = result.processing_time || 'Unknown';
            const searchId = result.search_id || 'Unknown';
            const csvBlobName = result.csv_blob_name || '';
            const gpkgBlobName = result.gpkg_blob_name || '';
            
            resultsContent.innerHTML = `
                <div class="row mb-3">
                    <div class="col-md-8">
                        <h5>Search Complete</h5>
                        <p class="mb-0">
                            Found <strong>${recordCount}</strong> parcels in
                            <strong>${result.county_name}, ${result.state_abbr}</strong>
                        </p>
                        <small class="text-muted">
                            Processing time: ${processingTime}s |
                            Search ID: ${searchId}
                        </small>
                    </div>
                    <div class="col-md-4 text-end">
                        ${recordCount > 0 ? `
                            <button class="btn btn-warning me-2" onclick="window.bcf.runTechnicalAnalysis('${searchId}')">
                                <i class="fas fa-cogs me-2"></i>Analyze Parcels
                            </button>
                            <div class="btn-group">
                                <button class="btn btn-outline-success" onclick="window.bcf.downloadParcelFile('${csvBlobName}', 'csv')">
                                    <i class="fas fa-download me-1"></i>CSV
                                </button>
                                <button class="btn btn-outline-primary" onclick="window.bcf.downloadParcelFile('${gpkgBlobName}', 'gpkg')">
                                    <i class="fas fa-download me-1"></i>GPKG
                                </button>
                            </div>
                        ` : `
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                No parcels found matching your criteria. Try adjusting your search parameters.
                            </div>
                        `}
                    </div>
                </div>

                ${recordCount > 0 && result.parcel_data && result.parcel_data.length > 0 ? `
                    <!-- Quick Preview of Real Results -->
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Owner</th>
                                    <th>Acres</th>
                                    <th>Parcel ID</th>
                                    <th>Address</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.parcel_data.map(parcel => `
                                    <tr>
                                        <td>${parcel.owner_name || parcel.owner || 'N/A'}</td>
                                        <td>${parcel.acreage || parcel.calculated_acreage || 'N/A'}</td>
                                        <td>${parcel.parcel_id || parcel.apn || 'N/A'}</td>
                                        <td>${parcel.situs_address || parcel.address || 'N/A'}</td>
                                    </tr>
                                `).join('')}
                                ${result.parcel_data.length < recordCount ? `
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">
                                            ... and ${recordCount - result.parcel_data.length} more parcels (download files for complete data)
                                        </td>
                                    </tr>
                                ` : ''}
                            </tbody>
                        </table>
                    </div>
                ` : ''}
                
                <div class="alert alert-info mt-3">
                    <h6><i class="fas fa-info-circle me-2"></i>Next Steps</h6>
                    <p class="mb-0">
                        <strong>Analyze Parcels:</strong> Run slope and transmission analysis to assess development suitability<br>
                        <strong>Download Files:</strong> Get raw search results for external analysis
                    </p>
                </div>
            `;

            // Store the search results for further processing
            this.currentSearchResults = result;

            // Scroll to results
            resultsArea.scrollIntoView({ behavior: 'smooth' });
        }

        async runTechnicalAnalysis(searchId) {
            try {
                console.log('Starting technical analysis for search:', searchId);
                
                // Show loading
                this.showLoadingModal('Running Technical Analysis (Slope + Transmission)...');
                
                // For now, this is a placeholder since we need to implement
                // the search-to-analysis pipeline
                setTimeout(() => {
                    this.hideLoadingModal();
                    alert('Technical analysis is being prepared. For now, use "Use Existing Files" to analyze previously searched parcels.');
                }, 2000);
                
            } catch (error) {
                this.hideLoadingModal();
                console.error('Technical analysis error:', error);
                this.showNotification('Technical analysis failed', 'error');
            }
        }


        async runAIMarketAnalysis(countyFips, countyName) {
            try {
                console.log('🚀 Starting AI Market Analysis for', countyName, 'FIPS:', countyFips);

                if (!this.currentState || !this.currentProjectType) {
                    throw new Error('Missing required state or project type information');
                }

                // FIXED: Use simple text message instead of HTML with spinner
                this.showLoadingModal(`Running AI Market Analysis for ${countyName} County...`);

                const response = await fetch('/api/analysis/county-market-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        county_fips: countyFips,
                        county_name: countyName,
                        state: this.currentState,
                        project_type: this.currentProjectType
                    })
                });

                this.hideLoadingModal();

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('✅ API Response received:', result);

                if (!result.success) {
                    throw new Error(result.error || 'AI analysis failed');
                }

                if (!result.analysis) {
                    throw new Error('No analysis content in response');
                }

                this.displayAIMarketAnalysisResults(
                    result.analysis,
                    countyName,
                    result.analysis_type || 'AI-Powered Market Analysis'
                );

            } catch (error) {
                this.hideLoadingModal();
                console.error('💥 AI Market Analysis error:', error);
                alert(`AI analysis failed: ${error.message}`);
            }
        }

        async showExistingDataFiles(countyFips, countyName) {
            console.log('🔍 DEBUG: showExistingDataFiles called');
            console.log('📊 Parameters:', { countyFips, countyName });
            console.log('📋 Current analysis:', this.currentAnalysis);
            console.log('🏛️ Current state:', this.currentState);
            
            try {
                // FIXED: Ensure current analysis is set with correct county name
                if (!this.currentAnalysis) {
                    console.log('⚠️ No current analysis, creating one...');
                    this.currentAnalysis = {
                        county: countyName,
                        state: this.currentState,
                        location: `${countyName}, ${this.getStateName(this.currentState)}`
                    };
                } else {
                    // Update existing analysis with correct county
                    this.currentAnalysis.county = countyName;
                    this.currentAnalysis.location = `${countyName}, ${this.getStateName(this.currentState)}`;
                }
                
                console.log('📈 Updated analysis:', this.currentAnalysis);

                this.showLoadingModal('Loading existing files...');

                const stateAbbr = this.currentState;
                console.log('📡 Making API call with:', { state: stateAbbr, county: countyName, county_fips: countyFips });

                const response = await fetch('/api/analysis/get-existing-files', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        state: stateAbbr,
                        county: countyName,
                        county_fips: countyFips
                    })
                });

                console.log('📡 API Response status:', response.status);

                this.hideLoadingModal();

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ API Error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('📊 API Result:', result);

                if (!result.success) {
                    throw new Error(result.error || 'Failed to load existing files');
                }

                console.log('✅ Files loaded successfully, showing modal...');
                // Show files in modal
                this.displayExistingFilesModal(countyName, result.files, result.folder_path);

            } catch (error) {
                console.error('💥 Error in showExistingDataFiles:', error);
                this.hideLoadingModal();
                alert(`Failed to load existing files: ${error.message}`);
            }
        }

        // Also add this improved displayExistingFilesModal method
        displayExistingFilesModal(countyName, files, folderPath) {
            console.log('🖼️ Displaying modal for:', countyName);
            console.log('📁 Files:', files);
            console.log('📂 Folder path:', folderPath);
            
            const modalHtml = `
                <div class="modal fade" id="existingFilesModal" tabindex="-1" data-bs-backdrop="static">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-folder-open me-2"></i>
                                    Existing Files: ${countyName} County
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${files.length === 0 ? 
                                    this.createNoFilesContent(countyName) : 
                                    this.createFilesListContent(files, folderPath)
                                }
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                ${files.length > 0 ? `
                                    <button type="button" class="btn btn-success" onclick="window.bcf.proceedWithExistingData('${countyName}')">
                                        <i class="fas fa-play me-2"></i>Use Selected File
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove any existing modal
            const existingModal = document.getElementById('existingFilesModal');
            if (existingModal) {
                console.log('🗑️ Removing existing modal');
                existingModal.remove();
            }

            console.log('➕ Adding modal to DOM');
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Store file data for later use
            const modalElement = document.getElementById('existingFilesModal');
            modalElement.dataset.filesData = JSON.stringify(files);
            
            console.log('🎭 Showing modal');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();

            // Clean up on close
            modal._element.addEventListener('hidden.bs.modal', () => {
                console.log('🧹 Cleaning up modal');
                document.getElementById('existingFilesModal').remove();
            });
            
            console.log('✅ Modal should now be visible');
        }

        // Add this debug version of the button click handler
        debugButtonClick(countyFips, countyName) {
            console.log('🖱️ Button clicked!');
            console.log('📊 Button parameters:', { countyFips, countyName });
            
            // Test if the method exists
            if (typeof this.showExistingDataFiles === 'function') {
                console.log('✅ showExistingDataFiles method exists');
                this.showExistingDataFiles(countyFips, countyName);
            } else {
                console.error('❌ showExistingDataFiles method not found!');
            }
        }

        showLoadingModal(message) {
            const loadingHtml = `
                <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-body text-center py-4">
                                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <h5>${typeof message === 'string' ? message : 'Processing...'}</h5>
                                <p class="text-muted mb-0">Please wait...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal first
            const existingModal = document.getElementById('loadingModal');
            if (existingModal) existingModal.remove();

            document.body.insertAdjacentHTML('beforeend', loadingHtml);
            const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
            modal.show();
        }

        // Fix 2: Add PDF download function
        downloadAIReportAsPDF(countyName, analysisContent, analysisType) {
            try {
                // Create comprehensive report content
                const reportContent = `
        AI MARKET ANALYSIS REPORT
        ========================

        County: ${countyName}
        Analysis Type: ${analysisType || 'AI-Powered Market Analysis'}
        Generated: ${new Date().toLocaleString()}
        State: ${this.getStateName(this.currentState)}
        Project Type: ${this.currentProjectType?.toUpperCase()} Energy Development

        ANALYSIS SUMMARY
        ================

        ${analysisContent}

        METHODOLOGY
        ===========

        This analysis was generated using advanced AI algorithms that considered:
        • Market conditions and economic factors
        • Resource quality and availability  
        • Regulatory environment and policies
        • Infrastructure and grid connectivity
        • Competitive landscape analysis
        • Risk assessment and mitigation strategies

        DISCLAIMER
        ==========

        This report is for informational purposes only and should be used in conjunction 
        with professional due diligence. Market conditions may change rapidly, and all 
        recommendations should be verified with current data and local expertise.

        ---
        Report generated by BCF.ai Renewable Energy Analysis Platform
        © ${new Date().getFullYear()} - All rights reserved
                `;

                // For now, download as text file (PDF generation requires additional library)
                const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `AI_Market_Analysis_${countyName}_${this.currentState}_${new Date().toISOString().slice(0, 10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                this.showNotification(`AI Market Analysis report downloaded for ${countyName}`, 'success');

            } catch (error) {
                console.error('Download error:', error);
                this.showNotification('Failed to download report', 'error');
            }
        }

        createFilesListContent(files, folderPath) {
            // Filter to only show CSV files
            const csvFiles = files.filter(file => file.name.toLowerCase().endsWith('.csv'));
            
            if (csvFiles.length === 0) {
                return `
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>No CSV Files Found</h6>
                        <p class="mb-0">Only CSV files are supported for analysis. No CSV files found in this folder.</p>
                    </div>
                `;
            }

            return `
                <div class="alert alert-success mb-3">
                    <h6><i class="fas fa-folder-open me-2"></i>CSV Files Found</h6>
                    <p class="mb-0">Found ${csvFiles.length} CSV files in <code>${folderPath}</code></p>
                </div>

                <div class="row">
                    ${csvFiles.map((file, index) => `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="selectedFile" 
                                            value="${index}" id="file${index}">
                                        <label class="form-check-label" for="file${index}">
                                            <h6 class="mb-1">${file.name}</h6>
                                        </label>
                                    </div>
                                    <div class="file-details mt-2">
                                        <small class="text-muted">
                                            <i class="fas fa-calendar me-1"></i>
                                            Modified: ${new Date(file.updated || file.created).toLocaleDateString()}
                                        </small><br>
                                        <small class="text-muted">
                                            <i class="fas fa-hdd me-1"></i>
                                            Size: ${this.formatFileSize(file.size)}
                                        </small>
                                    </div>
                                    <div class="file-actions mt-2">
                                        <button class="btn btn-sm btn-outline-info me-1" 
                                                onclick="window.bcf.previewFile('${file.path}', '${file.name}')">
                                            <i class="fas fa-eye me-1"></i>Preview
                                        </button>
                                        <button class="btn btn-sm btn-outline-success" 
                                                onclick="window.bcf.analyzeExistingFile('${file.path}', '${file.name}', '${this.currentAnalysis?.county || 'Unknown'}')">
                                            <i class="fas fa-cogs me-1"></i>Analyze
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="alert alert-info mt-3">
                    <h6><i class="fas fa-info-circle me-2"></i>CSV File Analysis</h6>
                    <ul class="mb-0">
                        <li><strong>Preview:</strong> View the first 10 rows of data</li>
                        <li><strong>Analyze:</strong> Run slope and transmission analysis</li>
                        <li><strong>Format:</strong> Only CSV files are shown for compatibility</li>
                    </ul>
                </div>
            `;
        }

        createNoFilesContent(countyName) {
            return `
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>No Existing Files Found</h6>
                    <p class="mb-2">No previous project files found for ${countyName} County.</p>
                    <p class="mb-0">This represents a new market opportunity with no prior data.</p>
                </div>

                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-search fa-3x text-primary mb-3"></i>
                        <h5>Start Fresh Parcel Search</h5>
                        <p class="text-muted mb-3">
                            Begin by searching for land parcels in ${countyName} County using 
                            our advanced search criteria.
                        </p>
                        <button class="btn btn-primary" onclick="
                            bootstrap.Modal.getInstance(document.getElementById('existingFilesModal')).hide();
                            window.bcf.proceedToParcelSearch('${countyName}', '${countyName}', {has_activity: false});
                        ">
                            <i class="fas fa-search me-2"></i>Search for Parcels
                        </button>
                    </div>
                </div>

                <div class="alert alert-info mt-3">
                    <h6><i class="fas fa-lightbulb me-2"></i>Next Steps</h6>
                    <p class="mb-0">
                        Use the "Find Parcels" button on the main screen to start your land search, 
                        or run AI Market Analysis to understand local development conditions first.
                    </p>
                </div>
            `;
        }

        formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // Also add this helper method for the proceedWithExistingData functionality
        proceedWithExistingData(countyName) {
            const selectedFile = document.querySelector('input[name="selectedFile"]:checked');
            if (!selectedFile) {
                alert('Please select a file first');
                return;
            }

            const fileIndex = parseInt(selectedFile.value);
            
            // Get the file data from the modal
            const modalElement = document.getElementById('existingFilesModal');
            const fileData = JSON.parse(modalElement.dataset.filesData || '[]');
            
            if (!fileData[fileIndex]) {
                alert('File data not found');
                return;
            }

            const selectedFileData = fileData[fileIndex];
            
            console.log(`Proceeding with existing data for ${countyName}:`, selectedFileData);

            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('existingFilesModal'));
            if (modal) modal.hide();

            // Show loading and start analysis
            this.showLoadingModal('Loading existing file for analysis...');
            
            // Call the analyze existing file method
            this.analyzeExistingFile(selectedFileData.path, selectedFileData.name, countyName);
        }

        displayAIMarketAnalysisResults(analysis, countyName, analysisType) {
            console.log('🧠 Displaying AI analysis results for:', countyName);
            
            // Store the analysis data for download (avoids string escaping issues)
            this.currentAnalysisData = {
                content: analysis,
                county: countyName,
                type: analysisType,
                state: this.currentState,
                projectType: this.currentProjectType,
                timestamp: new Date().toLocaleString()
            };

            // Remove any existing modal first
            const existingModal = document.getElementById('aiMarketAnalysisModal');
            if (existingModal) {
                console.log('🗑️ Removing existing modal');
                existingModal.remove();
            }

            // Get county FIPS for the proceed button
            const selectedCountyOption = document.querySelector('#target-county option:checked');
            const countyFips = selectedCountyOption ? selectedCountyOption.value : countyName;

            const modalHtml = `
                <div id="aiMarketAnalysisModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    z-index: 99999;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                ">
                    <div style="
                        background: white;
                        border-radius: 12px;
                        width: 85%;
                        max-width: 900px;
                        max-height: 85vh;
                        overflow: hidden;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.4);
                    ">
                        <div style="
                            background: linear-gradient(135deg, #198754, #20c997);
                            color: white;
                            padding: 20px 30px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <div>
                                <h3 style="margin: 0; font-size: 1.5rem;">🧠 AI Market Analysis</h3>
                                <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 1.1rem;">${countyName} County</p>
                            </div>
                            <button onclick="document.getElementById('aiMarketAnalysisModal').remove();" style="
                                background: none;
                                border: none;
                                color: white;
                                font-size: 32px;
                                cursor: pointer;
                                padding: 0;
                                line-height: 1;
                                width: 40px;
                                height: 40px;
                                border-radius: 50%;
                                transition: background 0.2s;
                            " onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='none'">&times;</button>
                        </div>
                        <div style="
                            padding: 30px;
                            max-height: 60vh;
                            overflow-y: auto;
                        ">
                            <div style="margin-bottom: 25px;">
                                <span style="
                                    background: linear-gradient(135deg, #0d6efd, #6610f2);
                                    color: white;
                                    padding: 8px 16px;
                                    border-radius: 20px;
                                    font-size: 0.9rem;
                                    font-weight: 600;
                                ">${analysisType}</span>
                            </div>
                            <div style="
                                background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                                border: 1px solid #dee2e6;
                                border-radius: 12px;
                                padding: 30px;
                            ">
                                <pre style="
                                    white-space: pre-wrap;
                                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                                    line-height: 1.7;
                                    margin: 0;
                                    font-size: 15px;
                                    color: #2c3e50;
                                ">${analysis}</pre>
                            </div>
                        </div>
                        <div style="
                            padding: 20px 30px;
                            border-top: 1px solid #dee2e6;
                            background: #f8f9fa;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <small style="color: #6c757d;">
                                Generated: ${new Date().toLocaleString()}
                            </small>
                            <div style="display: flex; gap: 15px;">
                                <button onclick="document.getElementById('aiMarketAnalysisModal').remove();" style="
                                    background: #6c757d;
                                    color: white;
                                    border: none;
                                    padding: 12px 24px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    transition: all 0.2s;
                                " onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">Close</button>
                                
                                <button onclick="window.bcf.downloadCurrentAnalysis()" style="
                                    background: linear-gradient(135deg, #dc3545, #c82333);
                                    color: white;
                                    border: none;
                                    padding: 12px 24px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    transition: all 0.2s;
                                " onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">📄 Download Report</button>
                                
                                <button onclick="
                                    console.log('Proceeding to parcel search for ${countyName}...');
                                    if (window.bcf && window.bcf.proceedToParcelSearchFromAI) {
                                        window.bcf.proceedToParcelSearchFromAI('${countyFips}', '${countyName}');
                                    }
                                    document.getElementById('aiMarketAnalysisModal').remove();
                                " style="
                                    background: linear-gradient(135deg, #198754, #20c997);
                                    color: white;
                                    border: none;
                                    padding: 12px 24px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    transition: all 0.2s;
                                " onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">🔍 Find Parcels</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            console.log('➕ Adding modal to DOM');
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            console.log('✅ Modal should now be visible');
            return true;
        }

        hideLoadingModal() {
            const loadingModal = document.getElementById('loadingModal');
            if (loadingModal) {
                const modal = bootstrap.Modal.getInstance(loadingModal);
                if (modal) {
                    modal.hide();
                }
                setTimeout(() => {
                    if (loadingModal.parentNode) {
                        loadingModal.remove();
                    }
                }, 300);
            }
        }

        async previewFile(filePath, fileName) {
            try {
                console.log('Previewing CSV file:', filePath, fileName);
                
                // Validate file type
                if (!fileName.toLowerCase().endsWith('.csv')) {
                    alert('Only CSV files can be previewed');
                    return;
                }
                
                this.showLoadingModal('Loading CSV file preview...');

                const response = await fetch('/api/analysis/preview-file', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_path: filePath
                    })
                });

                this.hideLoadingModal();

                // Check if response is OK
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Preview response error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const errorText = await response.text();
                    console.error('Non-JSON response:', errorText);
                    throw new Error('Server returned non-JSON response');
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'File preview failed');
                }

                // Display the preview modal
                this.displayFilePreviewModal(fileName, result);

            } catch (error) {
                this.hideLoadingModal();
                console.error('File preview error:', error);
                
                let errorMessage = 'Failed to preview file';
                if (error.message.includes('JSON.parse')) {
                    errorMessage = 'Server returned invalid response format';
                } else if (error.message.includes('HTTP 500')) {
                    errorMessage = 'Server error - check if file is a valid CSV';
                } else {
                    errorMessage = error.message;
                }
                
                alert(`Preview failed: ${errorMessage}`);
            }
        }

        displayFilePreviewModal(fileName, previewData) {
            const { headers, preview_rows, total_rows, showing_rows } = previewData;

            // Create table HTML with better column widths and scrolling
            const tableHeaders = headers.map(h => `<th style="min-width: 140px; max-width: 200px; word-wrap: break-word;">${h}</th>`).join('');
            const tableRows = preview_rows.map(row => {
                const cells = headers.map(h => {
                    const value = row[h] || '';
                    const displayValue = value.toString().length > 35 ? 
                        value.toString().substring(0, 32) + '...' : value.toString();
                    return `<td style="min-width: 140px; max-width: 200px; word-wrap: break-word; padding: 8px;" title="${value}">${displayValue}</td>`;
                }).join('');
                return `<tr>${cells}</tr>`;
            }).join('');

            const modalHtml = `
                <div class="modal fade" id="filePreviewModal" tabindex="-1" data-bs-backdrop="static">
                    <div class="modal-dialog modal-xxl" style="max-width: 95vw;">
                        <div class="modal-content">
                            <div class="modal-header bg-info text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-eye me-2"></i>
                                    CSV Preview: ${fileName}
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body" style="max-height: 75vh; padding: 20px;">
                                <div class="mb-3">
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-info-circle me-2"></i>File Summary</h6>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <strong>Total Rows:</strong> ${total_rows.toLocaleString()}
                                            </div>
                                            <div class="col-md-4">
                                                <strong>Showing:</strong> ${showing_rows} rows
                                            </div>
                                            <div class="col-md-4">
                                                <strong>Columns:</strong> ${headers.length}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- FIXED: Container with both horizontal and vertical scrolling -->
                                <div style="
                                    max-height: 60vh; 
                                    overflow: auto; 
                                    border: 1px solid #dee2e6; 
                                    border-radius: 8px;
                                    background: white;
                                ">
                                    <table class="table table-striped table-bordered mb-0" style="
                                        width: auto; 
                                        min-width: 100%;
                                        font-size: 13px;
                                        white-space: nowrap;
                                    ">
                                        <thead class="table-dark sticky-top">
                                            <tr>${tableHeaders}</tr>
                                        </thead>
                                        <tbody>
                                            ${tableRows}
                                        </tbody>
                                    </table>
                                </div>

                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Tip: Scroll horizontally to see all columns, hover over truncated values to see full content
                                    </small>
                                </div>

                                ${showing_rows < total_rows ? `
                                    <div class="alert alert-warning mt-3">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        Showing first ${showing_rows} of ${total_rows.toLocaleString()} total rows.
                                        Download the file to see all data.
                                    </div>
                                ` : ''}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-success" onclick="window.bcf.downloadFile('${previewData.file_path}', '${fileName}')">
                                    <i class="fas fa-download me-2"></i>Download Full File
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal and add new one
            const existingModal = document.getElementById('filePreviewModal');
            if (existingModal) existingModal.remove();

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('filePreviewModal'));
            modal.show();

            // Clean up on close
            modal._element.addEventListener('hidden.bs.modal', () => {
                document.getElementById('filePreviewModal').remove();
            });
        }

        async analyzeExistingFile(filePath, fileName, countyName) {
            try {
                console.log(`Starting technical analysis: ${fileName}`);

                // FIXED: Set the current analysis with proper county name BEFORE the API call
                this.currentAnalysis = {
                    county: countyName,
                    state: this.currentState,
                    location: `${countyName}, ${this.getStateName(this.currentState)}`,
                    project_type: this.currentProjectType
                };

                // Close existing modal
                const existingModal = bootstrap.Modal.getInstance(document.getElementById('existingFilesModal'));
                if (existingModal) existingModal.hide();

                this.showLoadingModal(`Running Technical Analysis...`);

                const response = await fetch('/api/analysis/analyze-existing-file-quick', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_path: filePath,
                        county_name: countyName,        // Make sure this is the actual county name
                        state: this.currentState,
                        project_type: this.currentProjectType
                    })
                });
                this.hideLoadingModal();

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.status !== 'success') {
                    throw new Error(result.message || 'Analysis failed');
                }

                // Store and display results
                this.currentSuitabilityResults = result.analysis_results;
                this.showTechnicalAnalysisResults(result.analysis_results, fileName);

                this.showNotification(
                    `Technical analysis completed! ${result.parcel_count} parcels analyzed.`,
                    'success'
                );

            } catch (error) {
                this.hideLoadingModal();
                console.error('Technical analysis error:', error);
                alert(`Technical analysis failed: ${error.message}`);
            }
        }

        showTechnicalAnalysisResults(analysisResults, sourceFileName) {
            console.log('Showing technical analysis results:', analysisResults);

            // Hide any existing modals
            this.hideLoadingModal();

            // Store the results
            this.currentSuitabilityResults = analysisResults;

            // FIXED: Use the correct method name
            this.displayTechnicalAnalysisResults(analysisResults, sourceFileName);
        }

        // Also add this alias method for backward compatibility
        displayTechnicalAnalysisTable(analysisResults, sourceFileName) {
            // Redirect to the correct method
            return this.displayTechnicalAnalysisResults(analysisResults, sourceFileName);
        }

        // Make sure this method exists (from the previous scoring fix)
        displayTechnicalAnalysisResults(analysisResults, sourceFileName) {
            const { parcels_table, summary, analysis_metadata } = analysisResults;

            // Ensure all parcels have calculated scores
            if (parcels_table) {
                parcels_table.forEach(parcel => {
                    if (!parcel.suitability_score && !parcel.combined_score) {
                        parcel.suitability_score = this.calculateParcelScore(parcel);
                        parcel.suitability_category = this.determineParcelCategory(parcel);
                    }
                });
            }

            // Debug parcel data
            this.debugParcelData(parcels_table);

            // Create the main container with enhanced scoring display
            const containerHtml = `
                <div class="parcel-analysis-container" id="parcel-analysis-container">
                    <!-- Analysis Header -->
                    <div class="analysis-summary">
                        <div class="row align-items-center mb-3">
                            <div class="col-md-8">
                                <h3><i class="fas fa-cogs me-2"></i>Technical Analysis Results</h3>
                                <p class="mb-0">
                                    <strong>Source:</strong> ${sourceFileName}<br>
                                    <strong>Location:</strong> ${summary.location}<br>
                                    <strong>Scoring:</strong> ${analysis_metadata.scoring_method || 'Enhanced AI Scoring'}
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-outline-primary" onclick="window.bcf.recalculateAllScores()">
                                    <i class="fas fa-calculator me-2"></i>Recalculate Scores
                                </button>
                            </div>
                        </div>

                        <!-- Enhanced Summary Grid -->
                        <div class="summary-grid">
                            <div class="summary-stat clickable-filter" data-filter-type="all" onclick="window.bcf.filterParcelsByCategory('all')">
                                <span class="stat-number" data-stat="total_parcels">${summary.total_parcels}</span>
                                <span class="stat-label">Total Parcels</span>
                            </div>
                            <div class="summary-stat stat-excellent clickable-filter" data-filter-type="excellent" onclick="window.bcf.filterParcelsByCategory('excellent')">
                                <span class="stat-number" data-stat="excellent">${summary.excellent}</span>
                                <span class="stat-label">Excellent (85+)</span>
                            </div>
                            <div class="summary-stat stat-good clickable-filter" data-filter-type="good" onclick="window.bcf.filterParcelsByCategory('good')">
                                <span class="stat-number" data-stat="good">${summary.good}</span>
                                <span class="stat-label">Good (70-84)</span>
                            </div>
                            <div class="summary-stat stat-fair clickable-filter" data-filter-type="fair" onclick="window.bcf.filterParcelsByCategory('fair')">
                                <span class="stat-number" data-stat="fair">${summary.fair}</span>
                                <span class="stat-label">Fair (55-69)</span>
                            </div>
                            <div class="summary-stat stat-poor clickable-filter" data-filter-type="poor" onclick="window.bcf.filterParcelsByCategory('poor')">
                                <span class="stat-number" data-stat="poor">${summary.poor}</span>
                                <span class="stat-label">Poor (<55)</span>
                            </div>
                            <div class="summary-stat clickable-filter" data-filter-type="recommended" onclick="window.bcf.filterParcelsByCategory('recommended')">
                                <span class="stat-number" data-stat="recommended_for_outreach">${summary.recommended_for_outreach}</span>
                                <span class="stat-label">Recommended</span>
                            </div>
                        </div>                     
                        <!-- Technical Analysis Details -->
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <div class="card text-center border-success">
                                    <div class="card-body">
                                        <h5 class="text-success">${summary.slope_suitable || 'Calculating...'}</h5>
                                        <p class="mb-0">Suitable Slope</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center border-info">
                                    <div class="card-body">
                                        <h5 class="text-info">${summary.transmission_nearby || 'Calculating...'}</h5>
                                        <p class="mb-0">Near Transmission</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center border-warning">
                                    <div class="card-body">
                                        <h5 class="text-warning" data-stat="recommended_for_outreach">${summary.recommended_for_outreach}</h5>
                                        <p class="mb-0">Recommended</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Selection Controls -->
                    <div class="selection-controls" id="selection-controls">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6><i class="fas fa-hand-pointer me-2"></i>Parcel Selection</h6>
                                <div class="btn-group me-3" role="group">
                                    <button type="button" class="btn btn-outline-success btn-sm" onclick="window.bcf.selectRecommended()">
                                        <i class="fas fa-star me-1"></i>Select Recommended (<span data-stat="recommended_for_outreach">${summary.recommended_for_outreach}</span>)
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="window.bcf.selectAll()">
                                        <i class="fas fa-check-square me-1"></i>Select All
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="window.bcf.clearSelection()">
                                        <i class="fas fa-square me-1"></i>Clear All
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="selection-summary">
                                    <span class="fw-bold text-success" id="selection-count">0</span>
                                    <span class="text-muted"> parcels selected</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Parcel Table -->
                    <div class="parcel-table-container">
                        <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                            <table class="table table-hover parcel-table" id="parcel-table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">
                                            <input type="checkbox" class="form-check-input" id="select-all-checkbox"
                                                onchange="toggleSelectAll(this.checked)">
                                        </th>
                                        <th>Score <small>(0-100)</small></th>
                                        <th>Owner</th>
                                        <th>Acres</th>
                                        <th>Slope (°)</th>
                                        <th>TX Dist (mi)</th>
                                        <th>TX Voltage (kV)</th>
                                        <th>Category</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${this.generateParcelRows(parcels_table)}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- FIXED: Action Buttons - Removed AI Analysis button -->
                    <div class="action-buttons">
                        <button class="outreach-btn" id="initiate-outreach-btn" onclick="window.bcf.initiateOutreach()" disabled>
                            <i class="fas fa-rocket me-2"></i>Initiate Outreach (<span id="outreach-count">0</span> parcels)
                        </button>
                        <button class="btn btn-outline-info" onclick="window.bcf.exportParcelData()">
                            <i class="fas fa-download me-2"></i>Export Data
                        </button>
                        <button class="btn btn-outline-secondary" onclick="window.bcf.backToCountySelection()">
                            <i class="fas fa-arrow-left me-2"></i>Back to Counties
                        </button>
                        <button class="btn btn-outline-danger" onclick="window.bcf.startOver()">
                            <i class="fas fa-redo me-2"></i>Start Over
                        </button>
                    </div>
                </div>
            `;

            // Insert the analysis interface
            const existingContainer = document.getElementById('parcel-analysis-container');
            if (existingContainer) {
                existingContainer.remove();
            }

            const countyScreen = document.getElementById('county-rankings-screen');
            if (countyScreen) {
                countyScreen.insertAdjacentHTML('afterend', containerHtml);
                countyScreen.style.display = 'none';
            } else {
                document.body.insertAdjacentHTML('beforeend', containerHtml);
            }

            // Initialize selection state
            this.selectedParcels = new Set();
            this.allParcels = parcels_table;

            // Initialize category filters
            this.initializeCategoryFilters();
            this.selectedParcels = new Set();

            // Auto-select recommended parcels
            this.selectRecommended();
            this.recalculateAndUpdateSummaryStats();

            // Scroll to results
            document.getElementById('parcel-analysis-container').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });

            console.log('Technical analysis results displayed with enhanced scoring');
        }

        
        filterParcelsByCategory(category) {
            console.log(`Filtering parcels by category: ${category}`);
            
            // Remove active class from all filter buttons
            document.querySelectorAll('.clickable-filter').forEach(el => {
                el.classList.remove('active-filter');
            });
            
            // Add active class to clicked filter
            const activeFilter = document.querySelector(`[data-filter-type="${category}"]`);
            if (activeFilter) {
                activeFilter.classList.add('active-filter');
            }
            
            // Show/hide table rows based on category
            const rows = document.querySelectorAll('#parcel-table tbody tr[data-parcel-index]');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const index = parseInt(row.dataset.parcelIndex);
                const parcel = this.allParcels[index];
                
                if (!parcel) return;
                
                const parcelCategory = this.determineParcelCategory(parcel);
                let shouldShow = false;
                
                switch(category) {
                    case 'all':
                        shouldShow = true;
                        break;
                    case 'excellent':
                        shouldShow = parcelCategory === 'Excellent';
                        break;
                    case 'good':
                        shouldShow = parcelCategory === 'Good';
                        break;
                    case 'fair':
                        shouldShow = parcelCategory === 'Fair';
                        break;
                    case 'poor':
                        shouldShow = parcelCategory === 'Poor';
                        break;
                    case 'recommended':
                        shouldShow = this.determineRecommendation(parcel);
                        break;
                }
                
                if (shouldShow) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            this.showNotification(`Filtered to ${visibleCount} ${category} parcels`, 'info');
        } 

        showAnalysisResults(analysisResults, sourceFileName) {
            console.log('Showing parcel analysis results:', analysisResults);

            // Hide any existing modals
            this.hideLoadingModal();

            // Store the results
            this.currentSuitabilityResults = analysisResults;

            // Create the parcel analysis interface
            this.displayParcelAnalysisTable(analysisResults, sourceFileName);
        }

        // Refresh the parcel table with updated data
        refreshParcelTable() {
            const tableBody = document.querySelector('#parcel-table tbody');
            if (tableBody && this.allParcels) {
                tableBody.innerHTML = this.generateParcelRows(this.allParcels);
                console.log('Parcel table refreshed');
            }
        }

        // Update summary statistics
        updateParcelSummaryStats() {
            if (!this.allParcels || this.allParcels.length === 0) return;
            
            const stats = {
                total: this.allParcels.length,
                excellent: 0,
                good: 0,
                fair: 0,
                poor: 0,
                recommended: 0,
                totalScore: 0
            };
            
            this.allParcels.forEach(parcel => {
                const score = this.calculateParcelScore(parcel);
                const category = this.determineParcelCategory(parcel);
                
                stats.totalScore += score;
                
                switch(category) {
                    case 'Excellent': stats.excellent++; break;
                    case 'Good': stats.good++; break;
                    case 'Fair': stats.fair++; break;
                    default: stats.poor++; break;
                }
                
                if (this.determineRecommendation(parcel)) {
                    stats.recommended++;
                }
            });
            
            const avgScore = Math.round(stats.totalScore / stats.total);
            
            // Update summary display elements
            const summaryElements = {
                'total_parcels': stats.total,
                'excellent': stats.excellent,
                'good': stats.good,
                'fair': stats.fair,
                'poor': stats.poor,
                'recommended_for_outreach': stats.recommended,
                'average_score': avgScore
            };
            
            // Update summary section if it exists
            Object.entries(summaryElements).forEach(([key, value]) => {
                const elements = document.querySelectorAll(`[data-stat="${key}"], .${key}, #${key}`);
                elements.forEach(el => {
                    if (el) el.textContent = value;
                });
            });
            
            console.log('Summary statistics updated:', stats);
        }

        // Enhanced display methods with better formatting

        async runAIAnalysis() {
            if (this.selectedParcels.size === 0) {
                alert('Please select at least one parcel for AI analysis');
                return;
            }

            const selectedParcelData = Array.from(this.selectedParcels).map(index => this.allParcels[index]);

            try {
                this.showLoadingModal('Running AI Analysis on selected parcels...');
                
                // Placeholder for now - this would be your enhanced AI analysis
                setTimeout(() => {
                    this.hideLoadingModal();
                    alert(`AI analysis would run on ${this.selectedParcels.size} selected parcels. This feature is being developed.`);
                }, 2000);
                
            } catch (error) {
                this.hideLoadingModal();
                console.error('AI analysis error:', error);
                alert(`AI analysis failed: ${error.message}`);
            }
        }


        displayParcelAnalysisTable(analysisResults, sourceFileName) {
            const { parcels_table, summary, analysis_metadata } = analysisResults;

            // DEBUG: Check what we actually received
            this.debugParcelData(parcels_table);

            // Create the main container
            const containerHtml = `
                <div class="parcel-analysis-container" id="parcel-analysis-container">
                    <!-- Summary Statistics -->
                    <div class="analysis-summary">
                        <h3><i class="fas fa-chart-bar me-2"></i>Parcel Analysis Results</h3>
                        <p class="mb-3">
                            <strong>Source:</strong> ${sourceFileName}<br>
                            <strong>Location:</strong> ${summary.location}<br>
                            <strong>Analysis:</strong> ${analysis_metadata.scoring_method}
                        </p>

                        <div class="summary-grid">
                            <div class="summary-stat clickable-filter" data-filter-type="all">
                                <span class="stat-number" data-stat="total_parcels">${summary.total_parcels}</span>
                                <span class="stat-label">Total Parcels</span>
                            </div>
                            <div class="summary-stat stat-excellent clickable-filter" data-filter-type="excellent">
                                <span class="stat-number" data-stat="excellent">${summary.excellent}</span>
                                <span class="stat-label">Excellent (85+)</span>
                            </div>
                            <div class="summary-stat stat-good clickable-filter" data-filter-type="good">
                                <span class="stat-number" data-stat="good">${summary.good}</span>
                                <span class="stat-label">Good (70-84)</span>
                            </div>
                            <div class="summary-stat stat-fair clickable-filter" data-filter-type="fair">
                                <span class="stat-number" data-stat="fair">${summary.fair}</span>
                                <span class="stat-label">Fair (55-69)</span>
                            </div>
                            <div class="summary-stat stat-poor clickable-filter" data-filter-type="poor">
                                <span class="stat-number" data-stat="poor">${summary.poor}</span>
                                <span class="stat-label">Poor (<55)</span>
                            </div>
                            <div class="summary-stat clickable-filter" data-filter-type="recommended">
                                <span class="stat-number" data-stat="recommended_for_outreach">${summary.recommended_for_outreach}</span>
                                <span class="stat-label">Recommended</span>
                            </div>
                        </div>

                    <!-- Selection Controls -->
                    <div class="selection-controls" id="selection-controls">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6><i class="fas fa-hand-pointer me-2"></i>Parcel Selection</h6>
                                <div class="btn-group me-3" role="group">
                                    <button type="button" class="btn btn-outline-success btn-sm" onclick="window.bcf.selectRecommended()">
                                        <i class="fas fa-star me-1"></i>Select Recommended (${summary.recommended_for_outreach})
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="window.bcf.selectAll()">
                                        <i class="fas fa-check-square me-1"></i>Select All
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="window.bcf.clearSelection()">
                                        <i class="fas fa-square me-1"></i>Clear All
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="selection-summary">
                                    <span class="fw-bold text-success" id="selection-count">0</span>
                                    <span class="text-muted"> parcels selected</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Parcel Table -->
                    <div class="parcel-table-container">
                        <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                            <table class="table table-hover parcel-table" id="parcel-table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">
                                            <input type="checkbox" class="form-check-input" id="select-all-checkbox"
                                                   onchange="toggleSelectAll(this.checked)">
                                        </th>
                                        <th>Score</th>
                                        <th>Owner</th>
                                        <th>Acres</th>
                                        <th>Slope (°)</th>
                                        <th>TX Dist (mi)</th>
                                        <th>TX Voltage (kV)</th>
                                        <th>Category</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${this.generateParcelRows(parcels_table)}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button class="outreach-btn" id="initiate-outreach-btn" onclick="window.bcf.initiateOutreach()" disabled>
                            <i class="fas fa-rocket me-2"></i>Initiate Outreach (<span id="outreach-count">0</span> parcels)
                        </button>
                        <button class="btn btn-outline-info" onclick="window.bcf.exportParcelData()">
                            <i class="fas fa-download me-2"></i>Export Data
                        </button>
                        <button class="btn btn-outline-secondary" onclick="window.bcf.backToCountySelection()">
                            <i class="fas fa-arrow-left me-2"></i>Back to Counties
                        </button>
                    </div>
                </div>
            `;

            // Find where to insert this (likely replacing existing results)
            const existingContainer = document.getElementById('parcel-analysis-container');
            if (existingContainer) {
                existingContainer.remove();
            }

            // Insert after county rankings screen
            const countyScreen = document.getElementById('county-rankings-screen');
            if (countyScreen) {
                countyScreen.insertAdjacentHTML('afterend', containerHtml);
                countyScreen.style.display = 'none';
            } else {
                document.body.insertAdjacentHTML('beforeend', containerHtml);
            }

            // Initialize selection state
            this.selectedParcels = new Set();
            this.allParcels = parcels_table;

            // Auto-select recommended parcels
            this.selectRecommended();

            // Scroll to results
            document.getElementById('parcel-analysis-container').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }


        generateParcelRows(parcels) {
            if (!parcels || parcels.length === 0) {
                return '<tr><td colspan="9" class="text-center text-muted">No parcel data available</td></tr>';
            }

            return parcels.map((parcel, index) => {
                const score = this.getParcelScore(parcel);
                const category = this.determineParcelCategory(parcel);
                const categoryClass = `category-${category.toLowerCase()}`;
                const scoreClass = `score-${category.toLowerCase()}`;

                // Format data with better fallbacks and NaN handling
                const owner = parcel.owner || parcel.mail_name || 'Unknown Owner';
                const acres = Math.round(parseFloat(parcel.acreage_calc || parcel.acreage || parcel.acres || 0));
                
                // FIXED: Better slope handling
                const slopeValue = parseFloat(parcel.avg_slope_degrees || 0);
                const slope = isNaN(slopeValue) ? 'N/A' : `${slopeValue.toFixed(1)}°`;
                
                // FIXED: Better transmission distance handling
                const txDistValue = parcel.tx_distance_miles;
                let txDist;
                if (txDistValue === null || txDistValue === undefined || isNaN(parseFloat(txDistValue))) {
                    txDist = 'Outside buffer';
                } else {
                    const distVal = parseFloat(txDistValue);
                    txDist = `${distVal.toFixed(2)} mi`;
                }
                
                // FIXED: Better transmission voltage handling
                const txVoltValue = parcel.tx_voltage_kv;
                let txVolt;
                if (txVoltValue === null || txVoltValue === undefined || isNaN(parseFloat(txVoltValue))) {
                    txVolt = 'N/A';
                } else {
                    txVolt = `${Math.round(parseFloat(txVoltValue))} kV`;
                }

                return `
                    <tr class="${categoryClass}" data-parcel-index="${index}">
                        <td>
                            <input type="checkbox" class="form-check-input parcel-checkbox"
                                data-parcel-index="${index}"
                                onchange="handleParcelCheckbox(${index}, this.checked)">
                        </td>
                        <td><span class="score-badge ${scoreClass}">${score}</span></td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                            <div class="fw-bold" title="${owner}">${owner.length > 25 ? owner.substring(0, 22) + '...' : owner}</div>
                            <small class="text-muted">${parcel.parcel_id || 'N/A'}</small>
                        </td>
                        <td><strong>${acres}</strong></td>
                        <td>${slope}</td>
                        <td>${txDist}</td>
                        <td>${txVolt}</td>
                        <td><span class="badge ${scoreClass}">${category}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="window.bcf.runIndividualAIAnalysis(${index})"
                                    title="Run detailed analysis">
                                <i class="fas fa-brain me-1"></i>AI
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Add method to debug parcel data structure
        debugParcelData(parcels) {
            console.log('🔍 Debugging parcel data structure:');
            if (!parcels || parcels.length === 0) {
                console.log('❌ No parcels data available');
                return;
            }
            
            console.log(`📊 Total parcels: ${parcels.length}`);
            console.log('📝 First parcel fields:', Object.keys(parcels[0]));
            console.log('🎯 First parcel sample:', parcels[0]);
            
            // Test scoring on first parcel
            if (this.parcelScorer) {
                const category = this.parcelScorer.calculateParcelCategory(parcels[0]);
                const isRecommended = this.parcelScorer.isRecommendedForOutreach(parcels[0]);
                console.log(`✅ ParcelScoring test result: ${category}, Recommended: ${isRecommended}`);
            } else {
                console.log('❌ ParcelScoring not available for testing');
            }
            
            // Check for slope data
            const slopeFields = ['avg_slope_degrees', 'slope_degrees', 'slope'];
            const foundSlopeField = slopeFields.find(field => parcels[0][field] !== undefined);
            console.log(`🏔️ Slope data field: ${foundSlopeField || 'None found'}`);
            
            // Check for transmission data  
            const txFields = ['tx_distance_miles', 'transmission_distance', 'tx_voltage_kv'];
            const foundTxFields = txFields.filter(field => parcels[0][field] !== undefined);
            console.log(`⚡ Transmission fields: ${foundTxFields.length ? foundTxFields.join(', ') : 'None found'}`);
        }

        // Selection Management Methods
        toggleParcelSelection(index, event) {
            if (event.target.type === 'checkbox') return; // Don't toggle if clicking checkbox directly

            const checkbox = document.querySelector(`[data-parcel-index="${index}"]`);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                this.handleCheckboxChange(index, checkbox.checked);
            }
        }

        handleCheckboxChange(index, isChecked) {
            const row = document.querySelector(`tr[data-parcel-index="${index}"]`);

            if (isChecked) {
                this.selectedParcels.add(index);
                if (row) row.classList.add('selected');
            } else {
                this.selectedParcels.delete(index);
                if (row) row.classList.remove('selected');
            }

            this.updateSelectionUI();
        }

        isRecommendedForOutreach(parcel) {
    if (!this.parcelScorer) {
        // Fallback logic
        const category = this.determineParcelCategory(parcel);
        return category === 'Excellent' || category === 'Good';
    }
    
    return this.parcelScorer.isRecommendedForOutreach(parcel);
}

        recalculateAndUpdateSummaryStats() {
            if (!this.allParcels || this.allParcels.length === 0) return;
            
            const stats = {
                total: this.allParcels.length,
                excellent: 0,
                good: 0,
                fair: 0,
                poor: 0,
                recommended: 0,
                totalScore: 0
            };
            
            this.allParcels.forEach(parcel => {
                const score = this.getParcelScore(parcel);
                const category = this.determineParcelCategory(parcel);
                
                stats.totalScore += score;
                
                // Count by category
                switch(category) {
                    case 'Excellent': stats.excellent++; break;
                    case 'Good': stats.good++; break;
                    case 'Fair': stats.fair++; break;
                    default: stats.poor++; break;
                }
                
                // Count recommended
                if (this.determineRecommendation(parcel)) {
                    stats.recommended++;
                }
            });
            
            const avgScore = Math.round(stats.totalScore / stats.total);
            
            // Update ALL summary display elements
            const updates = {
                'total_parcels': stats.total,
                'excellent': stats.excellent,
                'good': stats.good,
                'fair': stats.fair,
                'poor': stats.poor,
                'recommended_for_outreach': stats.recommended,
                'average_score': avgScore
            };
            
            // Update summary section elements
            Object.entries(updates).forEach(([key, value]) => {
                // Update by data-stat attribute
                document.querySelectorAll(`[data-stat="${key}"]`).forEach(el => {
                    if (el) el.textContent = value;
                });
                
                // Update by ID
                const idElement = document.getElementById(key);
                if (idElement) idElement.textContent = value;
                
                // Update by class
                document.querySelectorAll(`.${key}`).forEach(el => {
                    if (el) el.textContent = value;
                });
            });
            
            console.log('Summary statistics recalculated:', stats);
        }

        // Also add this method for better integration
        recalculateAllScores() {
            if (!this.allParcels || this.allParcels.length === 0) {
                console.warn('No parcels to recalculate');
                return;
            }
            
            console.log('Recalculating scores for all parcels...');
            
            // Update each parcel with fresh scores
            this.allParcels.forEach(parcel => {
                parcel.suitability_score = this.calculateParcelScore(parcel);
                parcel.suitability_category = this.determineParcelCategory(parcel);
                parcel.recommended_for_outreach = this.isRecommendedForOutreach(parcel);
            });
            
            // Refresh the display
            this.refreshParcelTable();
            this.updateParcelSummaryStats();
            
            this.showNotification('Parcel scores recalculated successfully!', 'success');
        }

        // Add this method to handle the selection methods properly
        selectRecommended() {
            if (!this.allParcels || this.allParcels.length === 0) {
                console.warn('No parcels available for selection');
                return;
            }
            
            this.clearSelection();
            let count = 0;
            
            this.allParcels.forEach((parcel, index) => {
                const isRecommended = this.isRecommendedForOutreach(parcel);
                
                if (isRecommended) {
                    const checkbox = document.querySelector(`[data-parcel-index="${index}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        this.selectedParcels.add(index);
                        count++;
                    }
                }
            });
            
            this.updateSelectionUI();
            console.log(`Selected ${count} recommended parcels`);
            
            if (count === 0) {
                this.showNotification('No parcels meet recommendation criteria', 'warning');
            } else {
                this.showNotification(`Selected ${count} recommended parcels`, 'success');
            }
        }

        selectAll() {
            if (!this.allParcels || this.allParcels.length === 0) return;
            
            this.selectedParcels.clear();
            this.allParcels.forEach((parcel, index) => {
                this.selectedParcels.add(index);
            });
            
            this.updateSelectionUI();
            this.showNotification(`Selected all ${this.allParcels.length} parcels`, 'success');
        }

        clearSelection() {
            this.selectedParcels.clear();
            this.updateSelectionUI();
        }


        syncIndividualCheckboxes() {
        document.querySelectorAll('.parcel-checkbox').forEach((checkbox) => {
            const parcelIndex = parseInt(checkbox.dataset.parcelIndex);
            if (!isNaN(parcelIndex)) {
                checkbox.checked = this.selectedParcels.has(parcelIndex);
            }
        });
    }

    updateRowVisualStates() {
        document.querySelectorAll('tr[data-parcel-index]').forEach((row) => {
            const parcelIndex = parseInt(row.dataset.parcelIndex);
            if (!isNaN(parcelIndex)) {
                if (this.selectedParcels.has(parcelIndex)) {
                    row.classList.add('selected');
                } else {
                    row.classList.remove('selected');
                }
            }
        });
    }

        updateSelectionUI() {
            if (!this.selectedParcels) {
                this.selectedParcels = new Set();
            }
            
            const selectedCount = this.selectedParcels.size;
            const totalCount = this.allParcels ? this.allParcels.length : 0;

            // Update count displays
            ['selection-count', 'outreach-count', 'ai-analysis-count'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = selectedCount;
            });

            // Update button states
            ['initiate-outreach-btn', 'ai-analysis-btn'].forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.disabled = selectedCount === 0;
                }
            });

            // Update select-all checkbox
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            if (selectAllCheckbox && totalCount > 0) {
                if (selectedCount === 0) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                } else if (selectedCount === totalCount) {
                    selectAllCheckbox.checked = true;
                    selectAllCheckbox.indeterminate = false;
                } else {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = true;
                }
            }

            // Sync individual checkboxes
            this.syncIndividualCheckboxes();
            this.updateRowVisualStates();
        }

        startOver() {
            // Confirm with user
            const confirmation = confirm(
                'Start over from the beginning?\n\n' +
                'This will clear all current analysis data and selections.\n' +
                'Are you sure you want to continue?'
            );
            
            if (!confirmation) return;
            
            console.log('Starting over - resetting application state');
            
            // Clear all state
            this.currentState = null;
            this.currentProjectType = null;
            this.currentStateAnalysis = null;
            this.currentCountyActivity = {};
            this.currentAnalysis = null;
            this.currentSuitabilityResults = null;
            this.selectedParcels = new Set();
            this.allParcels = [];
            this.allCounties = [];
            this.filteredCounties = [];
            this.currentPage = 1;
            this.currentCategoryFilter = null;
            this.aiAnalysisCompleted = false;
            this.originalParcelData = null;
            this.enrichedParcelData = null;
            
            // Hide all screens
            const screens = [
                'county-rankings-screen',
                'parcel-search-screen',
                'parcel-analysis-container'
            ];
            
            screens.forEach(screenId => {
                const screen = document.getElementById(screenId);
                if (screen) {
                    screen.style.display = 'none';
                    if (screenId === 'parcel-analysis-container') {
                        screen.remove(); // Completely remove analysis container
                    }
                }
            });
            
            // Reset the start screen form
            const stateSelect = document.getElementById('target-state');
            const projectTypeSelect = document.getElementById('project-type-start');
            
            if (stateSelect) stateSelect.value = '';
            if (projectTypeSelect) projectTypeSelect.value = '';
            
            // Show start screen
            const startScreen = document.getElementById('start-screen');
            if (startScreen) {
                startScreen.style.display = 'block';
            }
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            this.showNotification('Application reset - starting fresh!', 'success');
            
            console.log('Application reset complete');
        }

        async initiateOutreach() {
            if (this.selectedParcels.size === 0) {
                alert('Please select at least one parcel for outreach');
                return;
            }

            // Get selected parcel data
            const selectedParcelData = Array.from(this.selectedParcels).map(index => this.allParcels[index]);

            // Show confirmation dialog
            const confirmation = confirm(
                `Export ${this.selectedParcels.size} selected parcels to Monday.com CRM?\n\n` +
                `Location: ${this.currentAnalysis?.location || 'Unknown'}\n` +
                `Project Type: ${this.currentProjectType || 'Unknown'}\n\n` +
                `This will create a new group in your Monday.com board with all parcel data.`
            );

            if (!confirmation) return;

            try {
                this.showLoadingModal('Exporting parcels to Monday.com CRM...');

                const response = await fetch('/api/crm/export-to-crm', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        parcels: selectedParcelData,
                        project_type: this.currentProjectType || 'solar',
                        location: this.currentAnalysis?.location || 'Unknown Location'
                    })
                });

                const result = await response.json();
                this.hideLoadingModal();

                if (result.success) {
                    // Show detailed success message
                    const successMessage = `
                        ✅ Successfully exported to Monday.com CRM!
                        
                        📊 Export Summary:
                        • Total Parcels: ${result.total_parcels}
                        • Successfully Exported: ${result.successful_exports}
                        • Failed: ${result.failed_exports}
                        • Group Name: ${result.group_name}
                        
                        🎯 Critical Fields Success Rates:
                        • Slope Data: ${result.critical_field_rates?.slope_rate || 'N/A'}
                        • Transmission Distance: ${result.critical_field_rates?.distance_rate || 'N/A'}
                        • Transmission Voltage: ${result.critical_field_rates?.voltage_rate || 'N/A'}
                        
                        The parcels are now available in your Monday.com board for outreach!
                    `;
                    
                    this.showCRMExportSuccessModal(result);
                    
                    // Clear selection after successful export
                    this.clearSelection();
                    
                } else {
                    throw new Error(result.error || 'CRM export failed');
                }

            } catch (error) {
                this.hideLoadingModal();
                console.error('CRM export error:', error);
                
                const errorMessage = `
                    ❌ CRM Export Failed
                    
                    Error: ${error.message}
                    
                    Please check:
                    • Monday.com API credentials are configured
                    • MONDAY_API_KEY environment variable is set
                    • MONDAY_BOARD_ID environment variable is set
                    • Network connection is stable
                    
                    Contact support if the issue persists.
                `;
                
                alert(errorMessage);
            }
        }

        // Add this helper method to show detailed success modal
        showCRMExportSuccessModal(result) {
            const modalHtml = `
                <div class="modal fade" id="crmSuccessModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-check-circle me-2"></i>
                                    CRM Export Successful
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-success">
                                    <h6><i class="fas fa-rocket me-2"></i>Parcels Exported to Monday.com</h6>
                                    <p class="mb-0">Your selected parcels have been successfully added to your CRM for outreach management.</p>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h3 class="text-success">${result.successful_exports}</h3>
                                                <p class="mb-0 text-muted">Exported</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h3 class="text-danger">${result.failed_exports}</h3>
                                                <p class="mb-0 text-muted">Failed</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h3 class="text-primary">${result.total_parcels}</h3>
                                                <p class="mb-0 text-muted">Total</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <h6>Critical Fields Success Rates:</h6>
                                <ul>
                                    <li><strong>Slope Data:</strong> ${result.critical_field_rates?.slope_rate || 'N/A'}</li>
                                    <li><strong>Transmission Distance:</strong> ${result.critical_field_rates?.distance_rate || 'N/A'}</li>
                                    <li><strong>Transmission Voltage:</strong> ${result.critical_field_rates?.voltage_rate || 'N/A'}</li>
                                </ul>
                                
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle me-2"></i>Monday.com Group Created</h6>
                                    <p class="mb-1"><strong>Group Name:</strong> ${result.group_name}</p>
                                    <p class="mb-0"><strong>Group ID:</strong> ${result.group_id}</p>
                                </div>
                                
                                <p class="text-muted mb-0">
                                    <small>Log in to your Monday.com board to view and manage the exported parcels.</small>
                                </p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-success" onclick="window.open('https://monday.com', '_blank')">
                                    <i class="fas fa-external-link-alt me-2"></i>Open Monday.com
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal
            const existingModal = document.getElementById('crmSuccessModal');
            if (existingModal) existingModal.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('crmSuccessModal'));
            modal.show();
            
            modal._element.addEventListener('hidden.bs.modal', () => {
                document.getElementById('crmSuccessModal').remove();
            });
        }

        exportIndividualReport(parcelId) {
            // Generate a simple report for the individual parcel
            const parcel = this.allParcels.find(p => p.parcel_id === parcelId);
            if (!parcel) return;

            const reportContent = `Parcel Analysis Report
Generated: ${new Date().toLocaleDateString()}

Parcel Information:
- ID: ${parcel.parcel_id}
- Owner: ${parcel.owner}
- Size: ${parcel.acreage} acres
- Suitability Score: ${parcel.suitability_score}/100
- Category: ${parcel.suitability_category}

Technical Metrics:
- Average Slope: ${parcel.avg_slope}°
- Transmission Distance: ${parcel.tx_distance} miles
- Transmission Voltage: ${parcel.tx_voltage} kV

Recommendation: ${parcel.recommended_for_outreach ? 'Recommended for outreach' : 'Not currently recommended'}
            `;

            // Download as text file
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `parcel_report_${parcelId}_${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            this.showNotification('Individual parcel report exported', 'success');
        }

        addParcelToSelection(index) {
            const checkbox = document.querySelector(`[data-parcel-index="${index}"]`);
            if (checkbox && !checkbox.checked) {
                checkbox.checked = true;
                this.handleCheckboxChange(index, true);
                this.showNotification('Parcel added to selection', 'success');
            }

            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('parcelDetailModal'));
            if (modal) modal.hide();
        }

        exportParcelData() {
            if (!this.allParcels || this.allParcels.length === 0) {
                alert('No parcel data to export');
                return;
            }

            // Create CSV export
            const headers = ['parcel_id', 'owner', 'acreage', 'avg_slope', 'tx_distance', 'tx_voltage', 'suitability_score', 'suitability_category', 'recommended_for_outreach'];

            let csvContent = headers.join(',') + '\n';

            this.allParcels.forEach(parcel => {
                const row = headers.map(header => {
                    let value = parcel[header] || '';
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        value = '"' + value.replace(/"/g, '""') + '"';
                    }
                    return value;
                });
                csvContent += row.join(',') + '\n';
            });

            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `parcel_analysis_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            this.showNotification('Parcel data exported successfully!', 'success');
        }

        backToCountySelection() {
            const analysisContainer = document.getElementById('parcel-analysis-container');
            const countyScreen = document.getElementById('county-rankings-screen');

            if (analysisContainer) analysisContainer.style.display = 'none';
            if (countyScreen) countyScreen.style.display = 'block';
        }

        async downloadFile(filePath, fileName) {
            try {
                console.log(`Downloading file: ${fileName}`);
                
                // Show loading notification
                this.showNotification('Preparing download...', 'info');
                
                // FIXED: Use the correct URL with /analysis/ prefix
                const downloadUrl = `/api/analysis/download-file?path=${encodeURIComponent(filePath)}`;
                
                // Create download link
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = fileName;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Show success message
                this.showNotification(`Download started: ${fileName}`, 'success');
                
            } catch (error) {
                console.error('Download error:', error);
                this.showNotification(`Download failed: ${error.message}`, 'error');
            }
        }

        proceedWithExistingData(countyName) {
            const selectedFile = document.querySelector('input[name="selectedFile"]:checked');
            if (!selectedFile) {
                alert('Please select a file first');
                return;
            }

            const fileIndex = parseInt(selectedFile.value);
            console.log(`Proceeding with existing data for ${countyName}, file index: ${fileIndex}`);

            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('existingFilesModal'));
            if (modal) modal.hide();

            // Show success message
            this.showNotification(`Loading existing data for ${countyName}...`, 'info');

            // Here you would load the selected file and proceed to analysis
            // For now, show a placeholder
            setTimeout(() => {
                alert(`This would load the selected file and proceed to parcel analysis.\n\nFile selected: ${fileIndex}\nCounty: ${countyName}\n\nNext: Load CSV data and show analysis interface.`);
            }, 1500);
        }

        hideLoadingModal() {
            const loadingModal = document.getElementById('loadingModal');
            if (loadingModal) {
                const modal = bootstrap.Modal.getInstance(loadingModal);
                if (modal) {
                    modal.hide();
                }
                setTimeout(() => {
                    if (loadingModal.parentNode) {
                        loadingModal.remove();
                    }
                    // ADDED: Clean up any leftover backdrops
                    document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                        backdrop.remove();
                    });
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                }, 300);
            }
        }

        // Add clickable filter functionality to summary badges
        initializeSummaryBadgeFilters() {
            // Make summary stats clickable for filtering
            document.querySelectorAll('[data-stat]').forEach(statElement => {
                const statType = statElement.closest('.summary-stat, .stat-item').dataset.filterType;
                if (statType) {
                    statElement.closest('.summary-stat, .stat-item').style.cursor = 'pointer';
                    statElement.closest('.summary-stat, .stat-item').onclick = () => {
                        this.filterParcelsByCategory(statType);
                    };
                }
            });
        }

        filterParcelsByCategory(category) {
            console.log(`Filtering parcels by category: ${category}`);
            
            // Remove active class from all filter buttons
            document.querySelectorAll('.summary-stat, .stat-item').forEach(el => {
                el.classList.remove('active-filter');
            });
            
            // Add active class to clicked filter
            const activeFilter = document.querySelector(`[data-filter-type="${category}"]`);
            if (activeFilter) {
                activeFilter.classList.add('active-filter');
            }
            
            // Show/hide table rows based on category
            const rows = document.querySelectorAll('#parcel-table tbody tr[data-parcel-index]');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const index = parseInt(row.dataset.parcelIndex);
                const parcel = this.allParcels[index];
                const parcelCategory = this.determineParcelCategory(parcel);
                
                let shouldShow = false;
                
                switch(category) {
                    case 'all':
                        shouldShow = true;
                        break;
                    case 'excellent':
                        shouldShow = parcelCategory === 'Excellent';
                        break;
                    case 'good':
                        shouldShow = parcelCategory === 'Good';
                        break;
                    case 'fair':
                        shouldShow = parcelCategory === 'Fair';
                        break;
                    case 'poor':
                        shouldShow = parcelCategory === 'Poor';
                        break;
                    case 'recommended':
                        shouldShow = this.determineRecommendation(parcel);
                        break;
                }
                
                if (shouldShow) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Update visible count display
            const filterStatus = document.getElementById('filter-status');
            if (filterStatus) {
                filterStatus.textContent = `Showing ${visibleCount} of ${this.allParcels.length} parcels`;
            }
            
            this.showNotification(`Filtered to ${visibleCount} ${category} parcels`, 'info');
        }

        showNotification(message, type = 'info') {
            // Remove existing notifications
            document.querySelectorAll('.notification-toast').forEach(n => n.remove());

            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'warning': 'alert-warning',
                'info': 'alert-info'
            }[type] || 'alert-info';

            const notification = document.createElement('div');
            notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed notification-toast`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 350px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(notification);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
    }

    console.log('BCFWorkflow class defined successfully');

    function initBCF() {
        console.log('🚀 Initializing BCF Workflow...');
        
        try {
            bcf = new BCFWorkflow();
            window.bcf = bcf;
            console.log('✅ BCF instance created');

            const form = document.getElementById('state-selection-form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('📋 Form submission triggered');

                    const state = document.getElementById('target-state').value;
                    const projectType = document.getElementById('project-type-start').value;

                    console.log('Form data:', { state, projectType });

                    if (!state || !projectType) {
                        console.error('❌ Missing form data');
                        alert('Please select both state and project type');
                        return;
                    }

                    bcf.currentState = state;
                    bcf.currentProjectType = projectType;

                    console.log('✅ Form data stored, calling analyzeStateCounties...');
                    
                    bcf.analyzeStateCounties(state, projectType)
                        .then(() => {
                            console.log('✅ Analysis completed successfully');
                        })
                        .catch(error => {
                            console.error('❌ Analysis failed:', error);
                        });
                });
                console.log('✅ Form handler attached');
            } else {
                console.error('❌ Form element not found');
            }

            console.log('Form handler attached to:', form);
            console.log('Current bcf instance:', window.bcf);

        } catch (error) {
            console.error('💥 Error creating BCF instance:', error);
            alert(`Initialization error: ${error.message}`);
        }
    }

    // Wait for modules to load, then initialize
    waitForModules(() => {
        console.log('✅ All modules loaded, initializing BCF...');
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initBCF);
        } else {
            initBCF();
        }
    });

} catch (classError) {
    console.error('Error defining BCFWorkflow class:', classError);
    console.error('Class definition error stack:', classError.stack);
    alert('JavaScript class definition error: ' + classError.message);
}

console.log('Script completed');
</script>
</body>
</html>