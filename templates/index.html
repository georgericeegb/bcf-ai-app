<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Renewable Energy Project Analyzer</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .analysis-section { margin: 20px 0; }
        .variable-card { margin: 10px 0; }
        .loading { display: none; }
        .results { margin-top: 20px; }

        /* Enhanced Workflow CSS */
        .workflow-step {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn-option {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .btn-option:hover {
            border-color: #0d6efd;
            background: #f8f9fa;
        }

        .btn-option.selected {
            border-color: #0d6efd;
            background: #0d6efd;
            color: white;
        }

        .tier-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .tier-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .tier-card:hover {
            border-color: #0d6efd;
        }

        .tier-card.selected {
            border-color: #0d6efd;
            background: #f8f9fa;
        }

        .criteria-selection {
            display: grid;
            gap: 10px;
            margin-bottom: 20px;
        }

        .criteria-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .criteria-card:hover {
            border-color: #198754;
        }

        .criteria-card.selected {
            border-color: #198754;
            background: #f8fff8;
        }

        .selection-indicator {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .criteria-card.selected .selection-indicator {
            background: #198754;
            color: white;
        }

        .step-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .criteria-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .criteria-tag {
            background: #0d6efd;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 14px;
        }

        /* County loading styles */
        #county-loading {
            display: flex;
            align-items: center;
        }

        .form-label {
            font-weight: 600;
            color: #495057;
        }

        .form-select:disabled,
        .form-control:disabled {
            background-color: #f8f9fa;
            border-color: #dee2e6;
            opacity: 0.65;
        }

        /* Location selection improvements */
        .location-selection .mb-3 {
            position: relative;
        }

        .location-selection .form-select,
        .location-selection .form-control {
            transition: all 0.3s ease;
        }

        .location-selection .form-select:focus,
        .location-selection .form-control:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }

        /* File Download/Preview Styling */
        .file-actions {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .file-actions .btn {
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .file-actions .btn i {
            font-size: 1.2em;
        }

        .file-actions .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .file-type-label {
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-group .dropdown-menu {
            min-width: 200px;
        }

        .btn-group .dropdown-menu .dropdown-item {
            padding: 10px 16px;
            transition: all 0.2s ease;
        }

        .btn-group .dropdown-menu .dropdown-item:hover {
            background-color: #f8f9fa;
            transform: translateX(4px);
        }

        /* Analysis Results Container */
        .suitability-results-container {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Summary Statistics */
        .suitability-summary h3 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 24px;
            font-weight: 600;
            text-align: center;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #3498db;
        }

        .stat-value {
            display: block;
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            display: block;
            font-size: 14px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Button Styles */
        .analyze-suitability-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71) !important;
            color: white !important;
            border: none !important;
            padding: 12px 24px !important;
            border-radius: 6px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            font-size: 16px !important;
            width: 100% !important;
        }

        .analyze-suitability-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #219a52, #27ae60) !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3) !important;
        }

        .analyze-suitability-btn:disabled {
            background: #bdc3c7 !important;
            cursor: not-allowed !important;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Progress Indicator */
        .analysis-progress {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            text-align: center;
            z-index: 1000;
        }

        .analysis-progress::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: -1;
        }

        .progress-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .analysis-progress p {
            margin: 0;
            color: #2c3e50;
            font-weight: 500;
        }

        /* Notification Styles */
        .notification {
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .tier-options {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .step-actions {
                flex-direction: column;
                gap: 10px;
            }

            .location-selection {
                padding: 0 10px;
            }

            .criteria-tags {
                justify-content: center;
            }

            .file-actions .row > div {
                margin-bottom: 10px;
            }

            .file-actions .btn {
                min-height: 45px;
                font-size: 0.9em;
            }

            .suitability-results-container {
                margin: 20px 10px;
                padding: 15px;
            }

            .summary-stats {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .stat-value {
                font-size: 24px;
            }
        }

        /* Print Styles */
        @media print {
            .analysis-progress,
            .notification {
                display: none !important;
            }
        }

        /* Suitability Results Styling */
        .suitability-results-container {
            margin-top: 30px;
            animation: slideInUp 0.5s ease-out;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Summary Statistics Enhanced */
        .suitability-summary {
            margin-bottom: 30px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-item {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #0d6efd;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-value {
            display: block;
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .stat-label {
            display: block;
            font-size: 13px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
        }

        /* Table Enhancements */
        #suitability-table {
            font-size: 0.9rem;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #suitability-table thead th {
            background: linear-gradient(135deg, #343a40 0%, #495057 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.8rem;
            padding: 15px 10px;
            border: none;
        }

        #suitability-table tbody tr {
            transition: all 0.2s ease;
        }

        #suitability-table tbody tr:hover {
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .table-success {
            background-color: rgba(25, 135, 84, 0.1) !important;
            border-left: 4px solid #198754;
        }

        .table-warning {
            background-color: rgba(255, 193, 7, 0.1) !important;
            border-left: 4px solid #ffc107;
        }

        /* Badge Styling */
        .badge {
            font-size: 0.8rem;
            padding: 6px 10px;
            border-radius: 15px;
            font-weight: 600;
        }

        /* Filter Controls */
        .form-range {
            background: linear-gradient(to right, #e9ecef 0%, #0d6efd 0%);
        }

        .form-range::-webkit-slider-thumb {
            background: #0d6efd;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .form-range::-moz-range-thumb {
            background: #0d6efd;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Progress Indicator Enhanced */
        .analysis-progress {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
            z-index: 1000;
            min-width: 300px;
        }

        .analysis-progress::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: -1;
            backdrop-filter: blur(2px);
        }

        .progress-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #0d6efd;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .analysis-progress p {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-weight: 600;
            font-size: 18px;
        }

        .analysis-progress small {
            color: #6c757d;
            font-size: 14px;
        }

        /* Modal Enhancements */
        .modal-dialog {
            max-width: 800px;
        }

        .modal-header {
            background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
            color: white;
            border-radius: 0.375rem 0.375rem 0 0;
        }

        .modal-title {
            font-weight: 600;
        }

        .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }

        /* Button Improvements */
        .btn {
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-sm {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }

        /* Alert Enhancements */
        .alert {
            border-radius: 10px;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .alert-success {
            background: linear-gradient(135deg, #d1edff 0%, #e8f7e8 100%);
            color: #0f5132;
            border-left: 4px solid #198754;
        }

        .alert-danger {
            background: linear-gradient(135deg, #f8d7da 0%, #ffeaa7 100%);
            color: #842029;
            border-left: 4px solid #dc3545;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stat-value {
                font-size: 24px;
            }

            #suitability-table {
                font-size: 0.8rem;
            }

            #suitability-table th,
            #suitability-table td {
                padding: 8px 5px;
            }

            .analysis-progress {
                padding: 30px 20px;
                min-width: 280px;
            }

            .modal-dialog {
                margin: 10px;
                max-width: none;
            }
        }

        @media (max-width: 576px) {
            .summary-stats {
                grid-template-columns: 1fr;
            }

            .stat-item {
                padding: 15px;
            }

            .table-responsive {
                border-radius: 8px;
            }

            #suitability-table th:nth-child(n+6),
            #suitability-table td:nth-child(n+6) {
                display: none;
            }
        }

        /* Loading States */
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Accessibility Improvements */
        .badge:focus,
        .btn:focus,
        .form-select:focus,
        .form-range:focus {
            outline: 2px solid #0d6efd;
            outline-offset: 2px;
        }

        /* Print Styles */
        @media print {
            .analysis-progress,
            .btn,
            .modal {
                display: none !important;
            }

            .table {
                font-size: 10px;
            }

            .stat-item {
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">🌱 Renewable Energy Project Analyzer</h1>

        <!-- Enhanced Workflow Container -->
        <div id="workflow-container">
            <!-- Dynamic content will be injected here -->
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Initializing analysis workflow...</p>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loading" class="text-center loading">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>AI is analyzing your project...</p>
        </div>

        <!-- Variable Recommendations -->
        <div id="recommendationsSection" class="card analysis-section" style="display: none;">
            <div class="card-header">
                <h3>Recommended Critical Variables</h3>
            </div>
            <div class="card-body">
                <div id="variablesList"></div>
                <div class="mt-3">
                    <button class="btn btn-success" onclick="runComprehensiveAnalysis()">
                        Run Comprehensive Analysis
                    </button>
                </div>
            </div>
        </div>

        <!-- Analysis Results -->
        <div id="analysisResults" class="card analysis-section" style="display: none;">
            <div class="card-header">
                <h3>Analysis Results</h3>
            </div>
            <div class="card-body">
                <div id="analysisContent"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
<script>
// COMPLETE OPTIMIZED WORKFLOW WITH PREVIEW/DOWNLOAD FUNCTIONALITY

let currentVariables = {};
let projectConfig = {};

class ProjectWorkflow {
    constructor() {
        this.selectedProjectType = null;
        this.selectedTier = null;
        this.selectedCriteria = [];
        this.selectedLocation = null;
        this.tierInfo = null;
        this.currentAnalysis = null;
        this.currentParcelResults = null;
        // Explicitly bind the ML analysis method
        this.analyzeParcelSuitability = this.analyzeParcelSuitability.bind(this);
        console.log('✅ analyzeParcelSuitability method bound to workflow');
    }

    async initialize() {
        try {
            const response = await fetch('/api/tier-info');
            const data = await response.json();
            if (data.success) {
                this.tierInfo = data.tier_info;
                this.renderStep1();
            }
        } catch (error) {
            console.error('Failed to load tier info:', error);
            document.getElementById('workflow-container').innerHTML =
                '<div class="alert alert-danger">Failed to load. Please refresh.</div>';
        }
    }

    renderStep1() {
        const container = document.getElementById('workflow-container');
        container.innerHTML = `
            <div class="card analysis-section">
                <div class="card-header"><h3>Step 1: Project Configuration</h3></div>
                <div class="card-body workflow-step">
                    <div class="mb-3">
                        <label><strong>Project Type:</strong></label>
                        <div class="button-group">
                            <button class="btn-option ${this.selectedProjectType === 'solar' ? 'selected' : ''}"
                                    onclick="workflow.selectProjectType('solar')">
                                ☀️ Solar Project
                            </button>
                            <button class="btn-option ${this.selectedProjectType === 'wind' ? 'selected' : ''}"
                                    onclick="workflow.selectProjectType('wind')">
                                💨 Wind Project
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label><strong>Analysis Tier:</strong></label>
                        <div class="tier-options">
                            ${Object.entries(this.tierInfo).map(([tier, info]) => `
                                <div class="tier-card ${this.selectedTier === tier ? 'selected' : ''}"
                                     onclick="workflow.selectTier('${tier}')">
                                    <h5>${tier.charAt(0).toUpperCase() + tier.slice(1)} Level</h5>
                                    <small>${info.description}</small>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <button class="btn btn-primary"
                            onclick="workflow.proceedToStep2()"
                            ${!this.selectedProjectType || !this.selectedTier ? 'disabled' : ''}>
                        Proceed to Criteria Selection
                    </button>
                </div>
            </div>
        `;
    }

    selectProjectType(type) {
        this.selectedProjectType = type;
        this.renderStep1();
    }

    selectTier(tier) {
        this.selectedTier = tier;
        this.renderStep1();
    }

    proceedToStep2() {
        if (!this.selectedProjectType || !this.selectedTier) return;
        this.renderStep2();
    }

    renderStep2() {
        const tierInfo = this.tierInfo[this.selectedTier];
        const container = document.getElementById('workflow-container');

        container.innerHTML = `
            <div class="card analysis-section">
                <div class="card-header"><h3>Step 2: Select Analysis Focus Areas</h3></div>
                <div class="card-body workflow-step">
                    <p>Choose criteria for your ${this.selectedProjectType} project analysis:</p>

                    <div class="criteria-selection">
                        ${tierInfo.criteria.map((criteria, index) => `
                            <div class="criteria-card ${this.selectedCriteria.includes(index) ? 'selected' : ''}"
                                 onclick="workflow.toggleCriteria(${index})">
                                <div>
                                    <h6>${criteria.split(' - ')[0]}</h6>
                                    <small>${criteria.split(' - ')[1] || ''}</small>
                                </div>
                                <div class="selection-indicator">
                                    ${this.selectedCriteria.includes(index) ? '✓' : '+'}
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="step-actions">
                        <button class="btn btn-secondary" onclick="workflow.renderStep1()">← Back</button>
                        <button class="btn btn-primary"
                                onclick="workflow.proceedToStep3()"
                                ${this.selectedCriteria.length === 0 ? 'disabled' : ''}>
                            Continue (${this.selectedCriteria.length} selected)
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    toggleCriteria(index) {
        if (this.selectedCriteria.includes(index)) {
            this.selectedCriteria = this.selectedCriteria.filter(i => i !== index);
        } else {
            this.selectedCriteria.push(index);
        }
        this.renderStep2();
    }

    proceedToStep3() {
        if (this.selectedCriteria.length === 0) return;
        this.renderStep3();
    }

    renderStep3() {
        const container = document.getElementById('workflow-container');
        let locationHTML = '';

        if (this.selectedTier === 'state') {
            locationHTML = `
                <div class="mb-3">
                    <label for="state-select" class="form-label">Select State:</label>
                    <select id="state-select" class="form-select" onchange="workflow.selectLocation()">
                        <option value="">Choose a state...</option>
                        ${this.getStateOptions()}
                    </select>
                </div>
            `;
        } else if (this.selectedTier === 'county') {
            locationHTML = `
                <div class="mb-3">
                    <label for="state-select" class="form-label">1. Select State:</label>
                    <select id="state-select" class="form-select" onchange="workflow.loadCountiesForState()">
                        <option value="">Choose a state...</option>
                        ${this.getStateOptions()}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="county-select" class="form-label">2. Select County:</label>
                    <select id="county-select" class="form-select" onchange="workflow.selectLocation()" disabled>
                        <option value="">First select a state...</option>
                    </select>
                    <div id="county-loading" class="mt-2" style="display: none;">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading counties...</span>
                        </div>
                        <small class="text-muted ms-2">Loading counties...</small>
                    </div>
                </div>
            `;
        } else {
            locationHTML = `
                <div class="mb-3">
                    <label for="state-select" class="form-label">1. Select State:</label>
                    <select id="state-select" class="form-select" onchange="workflow.loadCountiesForState()">
                        <option value="">Choose a state...</option>
                        ${this.getStateOptions()}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="county-select" class="form-label">2. Select County:</label>
                    <select id="county-select" class="form-select" onchange="workflow.enableCityInput()" disabled>
                        <option value="">First select a state...</option>
                    </select>
                    <div id="county-loading" class="mt-2" style="display: none;">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading counties...</span>
                        </div>
                        <small class="text-muted ms-2">Loading counties...</small>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="city-input" class="form-label">3. Enter City or Address:</label>
                    <input type="text" id="city-input" class="form-control"
                           placeholder="Enter city, town, or specific address..."
                           onchange="workflow.selectLocation()" disabled>
                    <small class="text-muted">Be as specific as possible for local analysis</small>
                </div>
            `;
        }

        container.innerHTML = `
            <div class="card analysis-section">
                <div class="card-header">
                    <h3>Step 3: Select Location</h3>
                    <small class="text-muted">
                        ${this.selectedTier === 'state' ? 'Choose the state for market analysis' :
                          this.selectedTier === 'county' ? 'Choose the specific county for site identification' :
                          'Choose the specific location for project development'}
                    </small>
                </div>
                <div class="card-body workflow-step location-selection">
                    <p><strong>Analysis Level:</strong> ${this.selectedTier.charAt(0).toUpperCase() + this.selectedTier.slice(1)} Level</p>

                    ${locationHTML}

                    <div class="mb-3">
                        <strong>Selected Focus Areas:</strong>
                        <div class="criteria-tags mt-2">
                            ${this.selectedCriteria.map(index => {
                                const criteria = this.tierInfo[this.selectedTier].criteria[index];
                                return `<span class="criteria-tag">${criteria.split(' - ')[0]}</span>`;
                            }).join('')}
                        </div>
                    </div>

                    <div class="step-actions">
                        <button class="btn btn-secondary" onclick="workflow.renderStep2()">← Back</button>
                        <button class="btn btn-success"
                                onclick="workflow.generateAnalysis()"
                                ${!this.selectedLocation ? 'disabled' : ''}>
                            Generate AI Analysis
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // Add this method to test the ML analysis manually
    testMLAnalysis() {
        console.log('🧪 MANUAL ML ANALYSIS TEST');

        if (!this.currentParcelResults || !this.currentParcelResults.parcel_data) {
            console.error('❌ No parcel data available for test');
            alert('No parcel data available. Please complete a parcel search first.');
            return;
        }

        console.log('✅ Parcel data available:', this.currentParcelResults.parcel_data.length, 'parcels');

        // Call the analysis method directly
        try {
            this.analyzeParcelSuitability();
        } catch (error) {
            console.error('❌ Manual test failed:', error);
            alert('Manual test failed: ' + error.message);
        }
    }

    getStateOptions() {
        const states = [
            'Arizona', 'California', 'Colorado', 'Florida', 'Illinois',
            'Iowa', 'Kansas', 'Nevada', 'New Mexico', 'New York',
            'Ohio', 'Pennsylvania', 'Texas', 'Utah', 'Wyoming'
        ];
        return states.map(state => `<option value="${state}">${state}</option>`).join('');
    }

    async loadCountiesForState() {
        const stateSelect = document.getElementById('state-select');
        const countySelect = document.getElementById('county-select');
        const cityInput = document.getElementById('city-input');
        const loadingDiv = document.getElementById('county-loading');

        const selectedState = stateSelect.value;

        if (!selectedState) {
            countySelect.innerHTML = '<option value="">First select a state...</option>';
            countySelect.disabled = true;
            if (cityInput) {
                cityInput.disabled = true;
                cityInput.value = '';
            }
            this.selectedLocation = null;
            this.updateButtonState();
            return;
        }

        loadingDiv.style.display = 'block';
        countySelect.disabled = true;
        countySelect.innerHTML = '<option value="">Loading counties...</option>';

        try {
            const response = await fetch(`/api/counties/${selectedState}`);
            const data = await response.json();

            if (data.success && data.counties.length > 0) {
                countySelect.innerHTML = `
                    <option value="">Choose a county...</option>
                    ${data.counties.map(county => `<option value="${county}">${county}</option>`).join('')}
                `;
                countySelect.disabled = false;
            } else {
                countySelect.innerHTML = '<option value="">No counties available</option>';
            }
        } catch (error) {
            console.error('Error loading counties:', error);
            countySelect.innerHTML = '<option value="">Error loading counties</option>';
        } finally {
            loadingDiv.style.display = 'none';
        }

        this.selectedLocation = null;
        this.updateButtonState();
    }

    enableCityInput() {
        const stateSelect = document.getElementById('state-select');
        const countySelect = document.getElementById('county-select');
        const cityInput = document.getElementById('city-input');

        if (stateSelect.value && countySelect.value) {
            cityInput.disabled = false;
            cityInput.focus();
        } else {
            cityInput.disabled = true;
            cityInput.value = '';
        }

        if (this.selectedTier === 'county') {
            this.selectLocation();
        }
    }

    selectLocation() {
        const stateSelect = document.getElementById('state-select');
        const countySelect = document.getElementById('county-select');
        const cityInput = document.getElementById('city-input');

        const state = stateSelect ? stateSelect.value : '';
        const county = countySelect ? countySelect.value : '';
        const city = cityInput ? cityInput.value.trim() : '';

        if (this.selectedTier === 'state') {
            this.selectedLocation = state || null;
        } else if (this.selectedTier === 'county') {
            this.selectedLocation = (state && county) ? `${county}, ${state}` : null;
        } else {
            this.selectedLocation = (state && county && city) ? `${city}, ${county}, ${state}` : null;
        }

        this.updateButtonState();
        console.log('Selected location:', this.selectedLocation);
    }

    updateButtonState() {
        const generateButton = document.querySelector('button[onclick="workflow.generateAnalysis()"]');
        if (generateButton) {
            if (this.selectedLocation) {
                generateButton.disabled = false;
                generateButton.classList.remove('disabled');
            } else {
                generateButton.disabled = true;
                generateButton.classList.add('disabled');
            }
        }
    }

    async generateAnalysis() {
        if (!this.selectedLocation) {
            alert('Please select a location first');
            return;
        }

        showLoading();
        try {
            const selectedCriteriaText = this.selectedCriteria.map(index =>
                this.tierInfo[this.selectedTier].criteria[index]
            );

            console.log('Sending analysis request:', {
                project_type: this.selectedProjectType,
                analysis_level: this.selectedTier,
                location: this.selectedLocation,
                selected_criteria: selectedCriteriaText
            });

            const response = await fetch('/api/analyze-focus-areas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    project_type: this.selectedProjectType,
                    analysis_level: this.selectedTier,
                    location: this.selectedLocation,
                    selected_criteria: selectedCriteriaText
                })
            });

            const data = await response.json();

            if (data.success) {
                console.log('Analysis received:', data.analysis);
                this.displayFocusAreaAnalysis(data.analysis);
            } else {
                alert('Analysis Error: ' + data.error);
            }
        } catch (error) {
            console.error('Analysis failed:', error);
            alert('Analysis Error: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    displayFocusAreaAnalysis(analysis) {
        const container = document.getElementById('workflow-container');

        if (analysis.error) {
            container.innerHTML = `
                <div class="card analysis-section">
                    <div class="card-header"><h3>Analysis Error</h3></div>
                    <div class="card-body">
                        <div class="alert alert-danger">${analysis.error}</div>
                        <button class="btn btn-secondary" onclick="workflow.renderStep3()">← Back to Location Selection</button>
                    </div>
                </div>
            `;
            return;
        }

        const reportDate = new Date();
        const dateOptions = {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            timeZoneName: 'short'
        };
        const formattedDate = reportDate.toLocaleDateString('en-US', dateOptions);

        let html = `
            <div class="card analysis-section">
                <div class="card-header">
                    <h3>📊 Focus Area Analysis: ${analysis.location}</h3>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">${analysis.project_type.charAt(0).toUpperCase() + analysis.project_type.slice(1)} Project • ${analysis.analysis_level.charAt(0).toUpperCase() + analysis.analysis_level.slice(1)} Level</small>
                        <small class="text-muted"><strong>Report Generated:</strong> ${formattedDate}</small>
                    </div>
                </div>
                <div class="card-body">
        `;

        // Overall Assessment
        if (analysis.overall_assessment) {
            const assessment = analysis.overall_assessment;
            const scoreColor = assessment.viability_score >= 7 ? 'success' : assessment.viability_score >= 5 ? 'warning' : 'danger';

            html += `
                <div class="alert alert-${scoreColor} mb-4">
                    <h5>Overall Assessment</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <strong>Viability Score:</strong> ${assessment.viability_score}/10
                        </div>
                        <div class="col-md-4">
                            <strong>Confidence:</strong> ${assessment.confidence_level}
                        </div>
                        <div class="col-md-4">
                            <strong>Recommendation:</strong> ${assessment.key_recommendation}
                        </div>
                    </div>
                </div>
            `;
        }

        // Focus Area Analysis Cards
        if (analysis.focus_area_analysis && analysis.focus_area_analysis.length > 0) {
            html += `<h5>Focus Area Analysis</h5><div class="row">`;

            analysis.focus_area_analysis.forEach((area, index) => {
                const scoreColor = area.score >= 7 ? 'success' : area.score >= 5 ? 'warning' : 'danger';
                const statusBadge = area.status === 'Strong' ? 'success' : area.status === 'Moderate' ? 'warning' : 'danger';

                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">${area.focus_area}</h6>
                                <div>
                                    <span class="badge bg-${statusBadge}">${area.status}</span>
                                    <span class="badge bg-${scoreColor} ms-1">${area.score}/10</span>
                                </div>
                            </div>
                            <div class="card-body">
                                ${area.strengths && area.strengths.length > 0 ? `
                                    <h6 class="text-success">✓ Strengths</h6>
                                    <ul class="small mb-2">
                                        ${area.strengths.map(strength => `<li>${strength}</li>`).join('')}
                                    </ul>
                                ` : ''}

                                ${area.challenges && area.challenges.length > 0 ? `
                                    <h6 class="text-warning">⚠ Challenges</h6>
                                    <ul class="small mb-2">
                                        ${area.challenges.map(challenge => `<li>${challenge}</li>`).join('')}
                                    </ul>
                                ` : ''}

                                ${area.opportunities && area.opportunities.length > 0 ? `
                                    <h6 class="text-info">🚀 Opportunities</h6>
                                    <ul class="small mb-2">
                                        ${area.opportunities.map(opp => `<li>${opp}</li>`).join('')}
                                    </ul>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `</div>`;
        }

        // Action Buttons Section
        html += `
                <div class="mt-4">
                    <div class="card">
                        <div class="card-header">
                            <h6>🚀 Next Steps</h6>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted mb-3">Continue your renewable energy project development:</p>

                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <button class="btn btn-primary w-100" onclick="workflow.proceedToParcelSearch()">
                                        🗺️ Find Available Parcels
                                        <br><small>Search for suitable land parcels in ${analysis.location}</small>
                                    </button>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <button class="btn btn-info w-100" onclick="workflow.exportReport()">
                                        📄 Export Report
                                        <br><small>Download analysis results</small>
                                    </button>
                                </div>
                            </div>

                            <hr class="my-3">

                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <button class="btn btn-secondary w-100" onclick="workflow.renderStep1()">
                                        🔄 New Analysis
                                    </button>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <button class="btn btn-outline-primary w-100" onclick="workflow.renderStep3()">
                                        ← Modify Location
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        `;

        container.innerHTML = html;
        this.currentAnalysis = analysis;

        // Scroll to results
        container.scrollIntoView({ behavior: 'smooth' });
    }

    async proceedToParcelSearch() {
        if (!this.currentAnalysis) {
            alert('No analysis data available');
            return;
        }

        showLoading();
        try {
            this.showParcelSearchInterface();
        } catch (error) {
            console.error('Error loading parcel search:', error);
            alert('Error loading parcel search interface');
        } finally {
            hideLoading();
        }
    }

    showParcelSearchInterface() {
        const container = document.getElementById('workflow-container');
        const needsCountySelection = this.currentAnalysis.analysis_level === 'state';

        let currentCounty = '';
        if (!needsCountySelection) {
            if (this.currentAnalysis.analysis_level === 'county' && this.currentAnalysis.location.includes(',')) {
                currentCounty = this.currentAnalysis.location.split(',')[0].trim();
            } else if (this.currentAnalysis.analysis_level === 'local' && this.currentAnalysis.location.includes(',')) {
                const parts = this.currentAnalysis.location.split(',');
                if (parts.length >= 2) {
                    currentCounty = parts[1].trim();
                }
            }
        }

        const defaultMinAcreage = this.currentAnalysis.project_type === 'wind' ? 50 : 10;
        const defaultMaxAcreage = this.currentAnalysis.project_type === 'wind' ? 5000 : 1000;

        let html = `
            <div class="card analysis-section">
                <div class="card-header">
                    <h3>🗺️ Parcel Search: ${this.currentAnalysis.location}</h3>
                    <small class="text-muted">Find available land parcels for ${this.currentAnalysis.project_type} development</small>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h5>Search Parameters</h5>

                            <div class="alert alert-info">
                                <strong>Search Requirements:</strong> You must provide at least one search criteria below (minimum acreage, owner name, or parcel ID).
                            </div>

                            ${needsCountySelection ? `
                                <div class="mb-3">
                                    <label for="county-select" class="form-label">County Selection *</label>
                                    <select id="county-select" class="form-select" onchange="workflow.validateParcelForm()">
                                        <option value="">Choose a county in ${this.currentAnalysis.location}...</option>
                                    </select>
                                    <div id="county-loading" class="mt-2" style="display: none;">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Loading counties...</span>
                                        </div>
                                        <small class="text-muted ms-2">Loading counties...</small>
                                    </div>
                                    <small class="text-muted">County is required for parcel search</small>
                                </div>
                            ` : `
                                <div class="mb-3">
                                    <label class="form-label">Selected County</label>
                                    <input type="text" class="form-control" value="${currentCounty}" readonly>
                                    <small class="text-muted">County from your analysis selection</small>
                                </div>
                            `}

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="min-acreage" class="form-label">Minimum Acreage</label>
                                        <input type="number" id="min-acreage" class="form-control"
                                               placeholder="e.g., ${defaultMinAcreage}" min="1" max="10000"
                                               oninput="workflow.validateParcelForm()">
                                        <small class="text-muted">Recommended minimum for ${this.currentAnalysis.project_type}: ${defaultMinAcreage} acres</small>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="max-acreage" class="form-label">Maximum Acreage</label>
                                        <input type="number" id="max-acreage" class="form-control"
                                               placeholder="Leave blank for no limit" min="1" max="50000"
                                               oninput="workflow.validateParcelForm()">
                                        <small class="text-muted">Typical range for ${this.currentAnalysis.project_type}: up to ${defaultMaxAcreage} acres</small>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="owner-name" class="form-label">Owner Name</label>
                                        <input type="text" id="owner-name" class="form-control"
                                               placeholder="e.g., SMITH, JOHNSON, LLC, TRUST"
                                               oninput="workflow.validateParcelForm()">
                                        <small class="text-muted">Full or partial owner name. Common names return many results.</small>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="parcel-id" class="form-label">Parcel ID</label>
                                        <input type="text" id="parcel-id" class="form-control"
                                               placeholder="e.g., 123-456-789"
                                               oninput="workflow.validateParcelForm()">
                                        <small class="text-muted">Exact parcel identification number from county records</small>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Project Type</label>
                                <input type="text" class="form-control" value="${this.currentAnalysis.project_type.charAt(0).toUpperCase() + this.currentAnalysis.project_type.slice(1)}" readonly>
                                <small class="text-muted">Based on your analysis configuration</small>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <h5>Search Information</h5>

                            <div class="card">
                                <div class="card-body">
                                    <h6>Data Source</h6>
                                    <p class="small mb-2"><strong>Provider:</strong> ReportAll USA</p>
                                    <p class="small mb-2"><strong>Coverage:</strong> US nationwide county-level parcel data</p>
                                    <p class="small mb-0"><strong>Updates:</strong> Monthly</p>
                                </div>
                            </div>

                            <div class="mt-3">
                                <h6>What you'll get:</h6>
                                <ul class="small">
                                    <li>Parcel boundaries (GeoPackage format)</li>
                                    <li>Property ownership information</li>
                                    <li>Acreage calculations</li>
                                    <li>Parcel identification numbers</li>
                                    <li>Geographic coordinates</li>
                                    <li>CSV data for analysis</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <button class="btn btn-info me-2" id="preview-btn" onclick="workflow.previewParcelSearch()" disabled>
                                👁️ Preview Count
                            </button>
                            <small class="text-muted">See how many parcels match your criteria</small>
                        </div>

                        <div>
                            <button class="btn btn-secondary me-2" onclick="workflow.displayFocusAreaAnalysis(workflow.currentAnalysis)">← Back</button>
                            <button class="btn btn-primary" id="search-btn" onclick="workflow.executeParcelSearch()" disabled>
                                🗺️ Search Parcels
                            </button>
                        </div>
                    </div>

                    <div id="parcel-search-results" class="mt-4" style="display: none;">
                        <!-- Results will be displayed here -->
                    </div>
                </div>
            </div>
        `;

        container.innerHTML = html;

        if (needsCountySelection) {
            this.loadCountiesForParcelSearch();
        } else {
            this.validateParcelForm();
        }
    }

    async loadCountiesForParcelSearch() {
        const countySelect = document.getElementById('county-select');
        const loadingDiv = document.getElementById('county-loading');

        if (!countySelect || !loadingDiv) {
            console.error('County select elements not found');
            return;
        }

        const stateName = this.currentAnalysis.location;

        loadingDiv.style.display = 'block';
        countySelect.disabled = true;

        try {
            const response = await fetch(`/api/counties/${stateName}`);
            const data = await response.json();

            if (data.success && data.counties && data.counties.length > 0) {
                countySelect.innerHTML = `
                    <option value="">Choose a county in ${stateName}...</option>
                    ${data.counties.map(county => `<option value="${county}">${county}</option>`).join('')}
                `;
                countySelect.disabled = false;
            } else {
                countySelect.innerHTML = '<option value="">No counties available for this state</option>';
                console.error('No counties found for state:', stateName);
            }
        } catch (error) {
            console.error('Error loading counties:', error);
            countySelect.innerHTML = '<option value="">Error loading counties</option>';
        } finally {
            loadingDiv.style.display = 'none';
        }
    }

    validateParcelForm() {
        const countySelect = document.getElementById('county-select');
        const minAcreage = document.getElementById('min-acreage');
        const ownerName = document.getElementById('owner-name');
        const parcelId = document.getElementById('parcel-id');
        const previewBtn = document.getElementById('preview-btn');
        const searchBtn = document.getElementById('search-btn');

        const needsCountySelection = this.currentAnalysis.analysis_level === 'state';
        const countySelected = !needsCountySelection || (countySelect && countySelect.value);

        const hasMinAcreage = minAcreage && minAcreage.value.trim();
        const hasOwnerName = ownerName && ownerName.value.trim();
        const hasParcelId = parcelId && parcelId.value.trim();

        const hasSearchCriteria = hasMinAcreage || hasOwnerName || hasParcelId;
        const formValid = countySelected && hasSearchCriteria;

        if (previewBtn) {
            previewBtn.disabled = !formValid;
        }

        if (searchBtn) {
            searchBtn.disabled = !formValid;
        }

        return formValid;
    }

    getParcelSearchParameters() {
        const countySelect = document.getElementById('county-select');
        const minAcreage = document.getElementById('min-acreage');
        const maxAcreage = document.getElementById('max-acreage');
        const ownerName = document.getElementById('owner-name');
        const parcelId = document.getElementById('parcel-id');

        let params = {
            location: this.currentAnalysis.location,
            project_type: this.currentAnalysis.project_type,
            analysis_level: this.currentAnalysis.analysis_level
        };

        if (this.currentAnalysis.analysis_level === 'state' && countySelect && countySelect.value) {
            params.selected_county = countySelect.value;
        }

        if (minAcreage && minAcreage.value.trim()) {
            params.min_acreage = minAcreage.value.trim();
        }
        if (maxAcreage && maxAcreage.value.trim()) {
            params.max_acreage = maxAcreage.value.trim();
        }
        if (ownerName && ownerName.value.trim()) {
            params.owner = ownerName.value.trim();
        }
        if (parcelId && parcelId.value.trim()) {
            params.parcel_id = parcelId.value.trim();
        }

        return params;
    }

    async previewParcelSearch() {
        if (!this.validateParcelForm()) {
            alert('Please select a county and provide at least one search criteria (minimum acreage, owner name, or parcel ID)');
            return;
        }

        const searchParams = this.getParcelSearchParameters();
        const resultsDiv = document.getElementById('parcel-search-results');

        showLoading();
        resultsDiv.style.display = 'none';

        try {
            const response = await fetch('/api/parcel-search/execute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(searchParams)
            });

            // Add this check before parsing JSON
            const responseText = await response.text();
            console.log('Raw response:', responseText); // Debug log

            let data;
            try {
                data = JSON.parse(responseText);
            } catch (parseError) {
                console.error('JSON parse error:', parseError);
                console.error('Response text:', responseText);
                throw new Error('Invalid response format from server');
            }

            if (data.success) {
                this.displayParcelSearchResults(data);
                    } else {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h6>Preview Error</h6>
                        <p>${data.error}</p>
                    </div>
                `;
                resultsDiv.style.display = 'block';
            }

        } catch (error) {
            resultsDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h6>Preview Error</h6>
                    <p>Failed to preview search: ${error.message}</p>
                </div>
            `;
            resultsDiv.style.display = 'block';
        } finally {
            hideLoading();
        }
    }

    async executeParcelSearch() {
        if (!this.validateParcelForm()) {
            alert('Please select a county and provide at least one search criteria (minimum acreage, owner name, or parcel ID)');
            return;
        }

        const searchParams = this.getParcelSearchParameters();
        const resultsDiv = document.getElementById('parcel-search-results');

        const criteria = [];
        if (searchParams.min_acreage) criteria.push(`Minimum: ${searchParams.min_acreage} acres`);
        if (searchParams.max_acreage) criteria.push(`Maximum: ${searchParams.max_acreage} acres`);
        if (searchParams.owner) criteria.push(`Owner: "${searchParams.owner}"`);
        if (searchParams.parcel_id) criteria.push(`Parcel ID: "${searchParams.parcel_id}"`);

        const county = searchParams.selected_county || this.currentAnalysis.location.split(',')[0];
        const confirmMessage = `Search for parcels in ${county}?\n\nSearch criteria: ${criteria.join(', ')}\n\nThis may take 1-2 minutes for large areas.`;

        if (!confirm(confirmMessage)) {
            return;
        }

        showLoading();
        resultsDiv.style.display = 'none';

        try {
            const response = await fetch('/api/parcel-search/execute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(searchParams)
            });

            const data = await response.json();

            if (data.success) {
                this.displayParcelSearchResults(data);
            } else {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h6>Search Error</h6>
                        <p>${data.error}</p>
                        ${data.details ? `<pre class="small mt-2">${JSON.stringify(data.details, null, 2)}</pre>` : ''}
                    </div>
                `;
                resultsDiv.style.display = 'block';
            }

        } catch (error) {
            resultsDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h6>Search Error</h6>
                    <p>Failed to execute search: ${error.message}</p>
                </div>
            `;
            resultsDiv.style.display = 'block';
        } finally {
            hideLoading();
        }
    }

    displayParcelSearchResults(data) {
        const resultsDiv = document.getElementById('parcel-search-results');

        const resultDate = new Date().toLocaleDateString('en-US', {
            year: 'numeric', month: 'long', day: 'numeric',
            hour: '2-digit', minute: '2-digit'
        });

        // Fix: Ensure record_count is properly extracted
        const recordCount = data.record_count || data.parcel_count || (data.parcel_data ? data.parcel_data.length : 0);

        // Create download section with proper URL construction
        let downloadSection = '';

        if (recordCount > 0) {
            downloadSection = `
                <div class="file-actions">
                    <h6>📁 Download Options</h6>

                    <!-- CSV File -->
                    <div class="mb-3">
                        <div class="file-type-label">📊 CSV Format</div>
                        <p class="small text-muted mb-2">Spreadsheet format - opens in Excel, Google Sheets</p>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <button class="btn btn-info w-100" onclick="workflow.previewFile('${data.csv_file_path || data.file_path}', 'csv')">
                                    <i class="fas fa-eye me-2"></i>Preview CSV Data
                                </button>
                            </div>
                            <div class="col-md-6 mb-2">
                                <button class="btn btn-success w-100" onclick="workflow.downloadFile('${data.csv_file_path || data.file_path}')">
                                    <i class="fas fa-download me-2"></i>Download CSV
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- GeoPackage File -->
                    ${data.file_path ? `
                    <div class="mb-3">
                        <div class="file-type-label">🗺️ GeoPackage Format</div>
                        <p class="small text-muted mb-2">GIS format with spatial data - opens in QGIS, ArcGIS</p>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <button class="btn btn-outline-info w-100" onclick="workflow.previewFile('${data.file_path}', 'gpkg')">
                                    <i class="fas fa-map me-2"></i>Preview Spatial Data
                                </button>
                            </div>
                            <div class="col-md-6 mb-2">
                                <button class="btn btn-primary w-100" onclick="workflow.downloadFile('${data.file_path}')">
                                    <i class="fas fa-download me-2"></i>Download GPKG
                                </button>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <div class="mt-3 p-2 bg-light rounded">
                        <small class="text-muted">
                            <strong>Storage:</strong> Google Cloud Storage •
                            <strong>Location:</strong> ${data.bucket_path || 'Cloud Storage'} •
                            <strong>Processing Time:</strong> ${data.processing_time || 'N/A'}s
                        </small>
                    </div>
                </div>
            `;
        }

        let html = `
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">🗺️ Parcel Search Results</h5>
                    <small class="text-muted"><strong>Generated:</strong> ${resultDate}</small>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="alert alert-success">
                                <h6>✅ Search Completed</h6>
                                <p><strong>Found:</strong> ${recordCount} suitable parcels</p>
                                <p><strong>Location:</strong> ${data.county_name || 'Unknown'}, ${data.state_abbr || 'Unknown'}</p>
                                <p><strong>Processing Time:</strong> ${data.processing_time || 'N/A'} seconds</p>
                                <p><strong>Storage:</strong> Google Cloud Storage</p>
                            </div>

                            ${downloadSection}
                        </div>

                        <div class="col-md-4">
                            <h6>📋 Recommended Next Steps</h6>
                            <ul class="small">
                                ${this.generateNextStepsForCount(recordCount, data.search_type || 'general').map(step => `<li>${step}</li>`).join('')}
                            </ul>

                            <div class="mt-3">
                                <h6>🛠️ Tools for Analysis</h6>
                                <ul class="small">
                                    <li><strong>Excel/Google Sheets:</strong> Open CSV file for basic analysis</li>
                                    <li><strong>QGIS:</strong> Use GeoPackage for spatial analysis</li>
                                    <li><strong>Python/R:</strong> Advanced data analysis and modeling</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <div class="row">
                        <div class="col-md-6">
                            <button id="analyze-suitability-btn" class="analyze-suitability-btn" ${recordCount === 0 ? 'disabled' : ''}>
                                🔬 Analyze Parcel Suitability
                            </button>
                            <small class="text-muted d-block mt-2">Get AI analysis of parcel characteristics for renewable energy</small>
                               <button class="btn btn-info btn-sm" onclick="workflow.testOutreachTracking()">
                                   🧪 Test BigQuery Tracking
                               </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-info w-100" onclick="workflow.generateSiteReport('${data.search_id || 'none'}')" ${recordCount === 0 ? 'disabled' : ''}>
                                📊 Generate Site Report
                            </button>
                            <small class="text-muted d-block mt-2">Create comprehensive development feasibility report</small>
                        </div>
                    </div>
                </div>
            </div>
        `;

        resultsDiv.innerHTML = html;
        resultsDiv.style.display = 'block';

        // Store search results for later use
        this.currentParcelResults = data;

        // Store globally for easy access
        window.currentParcelSearchResults = data;

        // Attach the suitability analysis button handler
        if (recordCount > 0) {
            this.attachSuitabilityButtonHandler();
        }

        console.log('Parcel search results displayed, data stored:', data);
    }
    // File handling methods
    previewFile(filePath, fileType) {
        if (!filePath) {
            alert('File path not available');
            return;
        }

        // Construct preview URL
        const encodedPath = encodeURIComponent(filePath);
        const previewUrl = `/preview/${encodedPath}`;

        // Open in new tab
        window.open(previewUrl, '_blank');

        console.log('Opening preview for:', filePath);
    }

    downloadFile(filePath) {
        if (!filePath) {
            alert('File path not available');
            return;
        }

        // Show confirmation for large files
        if (this.currentParcelResults && this.currentParcelResults.record_count > 10000) {
            if (!confirm(`This file contains ${this.currentParcelResults.record_count.toLocaleString()} records and may be large. Continue with download?`)) {
                return;
            }
        }

        // Construct download URL
        const encodedPath = encodeURIComponent(filePath);
        const downloadUrl = `/download/${encodedPath}`;

        // Create temporary link and click it
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.target = '_blank';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        console.log('Downloading file:', filePath);
    }

    generateNextStepsForCount(count, searchType) {
        if (count === 0) {
            if (searchType === 'parcel_id') {
                return [
                    "Verify the parcel ID is correct and formatted properly",
                    "Check if the parcel exists in this county",
                    "Try searching by owner name instead"
                ];
            } else if (searchType === 'owner') {
                return [
                    "Try variations of the owner name (with/without suffixes)",
                    "Search for partial names or common abbreviations",
                    "Consider expanding search to adjacent counties"
                ];
            } else {
                return [
                    "Consider expanding search to adjacent counties",
                    "Review minimum acreage requirements - may be too restrictive",
                    "Try searching by owner names in the area"
                ];
            }
        } else if (count < 5) {
            return [
                "Prioritize parcels with best grid proximity and access",
                "Conduct preliminary site visits for all candidates",
                "Begin outreach to property owners for development interest"
            ];
        } else if (count < 25) {
            return [
                "Filter parcels by proximity to transmission infrastructure",
                "Use GIS analysis to screen for environmental constraints",
                "Develop scoring matrix for parcel prioritization"
            ];
        } else {
            return [
                "Apply additional filtering criteria (zoning, slopes, etc.)",
                "Use automated screening tools for large parcel sets",
                "Consider batch analysis for regional development strategy"
            ];
        }
    }

    attachSuitabilityButtonHandler() {
        console.log('🔗 Attaching suitability button handler...');

        setTimeout(() => {
            const analyzeButton = document.getElementById('analyze-suitability-btn');
            console.log('Button found for attachment:', !!analyzeButton);

            if (analyzeButton) {
                // Remove any existing event listeners
                analyzeButton.removeEventListener('click', this.analyzeParcelSuitability.bind(this));
                analyzeButton.onclick = null; // Clear any onclick handlers

                // Add new event listener
                const boundHandler = this.analyzeParcelSuitability.bind(this);
                analyzeButton.addEventListener('click', boundHandler);

                console.log('✅ ML analysis button handler attached successfully');

                // Also add onclick as backup
                analyzeButton.onclick = (e) => {
                    e.preventDefault();
                    console.log('🖱️ Button clicked via onclick handler');
                    this.analyzeParcelSuitability();
                };

                // Test the button
                console.log('Button ready for testing. Click state:', {
                    disabled: analyzeButton.disabled,
                    textContent: analyzeButton.textContent,
                    hasEventListener: true
                });

            } else {
                console.error('❌ Analyze suitability button not found in DOM');
            }
        }, 500); // Increased delay to ensure DOM is ready
    }

    // Add these helper methods
    showMLParcelDetails(parcelId) {
        const parcel = this.currentMLResults.parcels.find(p => p.parcel_id === parcelId);
        if (!parcel) return;

        const analysis = parcel.suitability_analysis;

        const modalHtml = `
            <div class="modal fade" id="mlParcelDetailsModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">🧠 ML Analysis: ${parcel.parcel_id}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Basic Information</h6>
                                    <p><strong>Parcel ID:</strong> ${parcel.parcel_id}</p>
                                    <p><strong>Owner:</strong> ${parcel.owner}</p>
                                    <p><strong>Acreage:</strong> ${parseFloat(parcel.acreage || 0).toFixed(1)} acres</p>
                                    <p><strong>Location:</strong> ${parcel.county}, ${parcel.state_abbr}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6>ML Analysis Scores</h6>
                                    <p><strong>ML Score:</strong> ${analysis.ml_score || 'N/A'}/100</p>
                                    <p><strong>Traditional Score:</strong> ${analysis.traditional_score || 'N/A'}/100</p>
                                    <p><strong>Combined Score:</strong> ${analysis.overall_score || 'N/A'}/100</p>
                                    <p><strong>Confidence:</strong> ${analysis.confidence_level || 'Medium'}</p>
                                    <p><strong>Recommendation:</strong> ${analysis.is_suitable ? '✓ Recommended' : '✗ Not Recommended'}</p>
                                </div>
                            </div>
                            <hr>
                            <h6>Analysis Notes</h6>
                            <p>${analysis.analysis_notes || 'No additional notes available.'}</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-info" onclick="workflow.rateParcel('${parcel.parcel_id}')">
                                Provide Feedback
                            </button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const modal = new bootstrap.Modal(document.getElementById('mlParcelDetailsModal'));
        modal.show();
    }

    async rateParcel(parcelId) {
        const parcel = this.currentMLResults.parcels.find(p => p.parcel_id === parcelId);
        if (!parcel) return;

        const analysis = parcel.suitability_analysis;
        const rating = prompt(`Rate this parcel recommendation (1-100):

    Parcel: ${parcel.parcel_id}
    Owner: ${parcel.owner}
    ML Score: ${analysis.ml_score || 'N/A'}
    Combined Score: ${analysis.overall_score || 'N/A'}

    Your rating (1-100):`);

        if (rating && !isNaN(rating) && rating >= 1 && rating <= 100) {
            try {
                const response = await fetch('/api/parcel/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        parcel_id: parcelId,
                        user_rating: parseInt(rating),
                        feedback_type: rating > 70 ? 'interested' : 'not_interested',
                        notes: `User rating: ${rating}/100 for ML score: ${analysis.ml_score}`
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert(`✅ Feedback saved! Your rating will help improve future ML recommendations.`);
                } else {
                    alert(`❌ Failed to save feedback: ${result.error}`);
                }
            } catch (error) {
                alert(`❌ Error saving feedback: ${error.message}`);
            }
        }
    }

    exportMLRecommendations() {
        if (!this.currentMLResults) {
            alert('No ML results to export');
            return;
        }

        const parcels = this.currentMLResults.parcels;
        const headers = ['Parcel ID', 'Owner', 'Acres', 'ML Score', 'Traditional Score', 'Combined Score', 'ML Recommended', 'Analysis Notes'];

        let csvContent = headers.join(',') + '\n';
        parcels.forEach(parcel => {
            const analysis = parcel.suitability_analysis;
            const row = [
                parcel.parcel_id,
                `"${parcel.owner}"`,
                parseFloat(parcel.acreage || 0).toFixed(1),
                analysis.ml_score || 'N/A',
                analysis.traditional_score || 'N/A',
                analysis.overall_score || 'N/A',
                analysis.is_suitable ? 'Yes' : 'No',
                `"${analysis.analysis_notes || ''}"`
            ];
            csvContent += row.join(',') + '\n';
        });

        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ml_parcel_recommendations_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }

    provideFeedback() {
        alert('Use the "Rate" button next to each parcel to provide individual feedback, or select multiple parcels and use batch feedback (coming soon).');
    }

    async analyzeParcelSuitability() {
        console.log('🚀 ANALYZE PARCEL SUITABILITY CALLED');

        const button = document.getElementById('analyze-suitability-btn');
        const originalText = button.textContent;

        try {
            button.disabled = true;
            button.textContent = '🧠 Running ML Analysis...';
            this.showAnalysisProgress();

            let parcelData = this.currentParcelResults?.parcel_data || [];
            console.log('📊 Request data preparation:', {
                parcelCount: parcelData.length,
                sampleParcel: parcelData[0],
                projectType: this.currentAnalysis?.project_type
            });

            const requestData = {
                parcels: parcelData,
                search_results: this.currentParcelResults,
                project_type: this.currentAnalysis?.project_type || 'solar',
                analysis_type: 'ml_enhanced'
            };

            console.log('📤 Sending ML request:', requestData);

            const response = await fetch('/api/parcel/analyze_suitability_with_ml', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            });

            console.log('📥 Response received:', {
                status: response.status,
                ok: response.ok,
                headers: Object.fromEntries(response.headers.entries())
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('❌ HTTP Error:', errorText);
                throw new Error(`Analysis failed: HTTP ${response.status} - ${errorText}`);
            }

            const result = await response.json();
            console.log('📋 COMPLETE RESPONSE OBJECT:', result);
            console.log('📋 Response keys:', Object.keys(result));
            console.log('📋 Response status:', result.status);
            console.log('📋 Response data:', result.data);

            if (result.status === 'success') {
                console.log('✅ Success path - checking data structure...');

                if (result.data) {
                    console.log('📊 Data object keys:', Object.keys(result.data));
                    console.log('📊 Total parcels:', result.data.total_parcels);
                    console.log('📊 Suitable parcels:', result.data.suitable_parcels);
                    console.log('📊 Parcels array:', result.data.parcels);
                    console.log('📊 Parcels array length:', result.data.parcels?.length);
                    console.log('📊 First parcel sample:', result.data.parcels?.[0]);

                    if (result.data.parcels && result.data.parcels.length > 0) {
                        console.log('🎯 About to call displayMLSuitabilityResults...');

                        // Check if the method exists
                        if (typeof this.displayMLSuitabilityResults === 'function') {
                            console.log('✅ Display method exists, calling it...');
                            this.displayMLSuitabilityResults(result.data);
                            console.log('✅ Display method called successfully');
                        } else {
                            console.error('❌ Display method does not exist!');
                            console.log('Available methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(this)));
                            alert('Display method missing! Check console.');
                        }
                    } else {
                        console.error('❌ No parcels in response data');
                        alert('No parcels returned from analysis');
                    }
                } else {
                    console.error('❌ No data object in response');
                    alert('Invalid response format - missing data');
                }
            } else {
                console.error('❌ Analysis failed:', result.error || 'Unknown error');
                throw new Error(result.error || 'ML analysis failed');
            }

        } catch (error) {
            console.error('❌ ML analysis exception:', error);
            console.error('❌ Error stack:', error.stack);
            this.showErrorMessage(`ML Analysis failed: ${error.message}`);
        } finally {
            button.disabled = false;
            button.textContent = originalText;
            this.hideAnalysisProgress();
            console.log('🏁 Analysis method completed');
        }
    }

    showAnalysisProgress() {
        // Create progress overlay
        const progressHtml = `
            <div class="analysis-progress" id="analysis-progress">
                <div class="progress-spinner"></div>
                <p>Analyzing parcel suitability...</p>
                <small>Running slope and transmission analysis</small>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', progressHtml);
    }

    hideAnalysisProgress() {
        const progressEl = document.getElementById('analysis-progress');
        if (progressEl) {
            progressEl.remove();
        }
    }

    displaySuitabilityResults(data) {
        console.log('displaySuitabilityResults received data:', data);
        console.log('data.parcels:', data.parcels);
        console.log('Is data.parcels an array?', Array.isArray(data.parcels));

        const container = document.getElementById('workflow-container');

        const resultDate = new Date().toLocaleDateString('en-US', {
            year: 'numeric', month: 'long', day: 'numeric',
            hour: '2-digit', minute: '2-digit'
        });

        // Create the results display
        const html = `
            <div class="suitability-results-container">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4>🔬 Parcel Suitability Analysis Results</h4>
                        <small class="text-muted">Generated: ${resultDate}</small>
                    </div>
                    <div class="card-body">

                        <!-- Summary Statistics -->
                        <div class="suitability-summary">
                            <h5>📊 Analysis Summary</h5>
                            <div class="summary-stats">
                                <div class="stat-item">
                                    <span class="stat-value">${data.total_parcels}</span>
                                    <span class="stat-label">Total Parcels</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-value">${data.suitable_parcels}</span>
                                    <span class="stat-label">Suitable Parcels</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-value">${Math.round((data.suitable_parcels / data.total_parcels) * 100)}%</span>
                                    <span class="stat-label">Suitability Rate</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-value">${data.analysis_parameters.slope_threshold}°</span>
                                    <span class="stat-label">Max Slope</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-value">${data.analysis_parameters.transmission_buffer} mi</span>
                                    <span class="stat-label">Transmission Buffer</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-value">${data.analysis_parameters.voltage_range}</span>
                                    <span class="stat-label">Voltage Range</span>
                                </div>
                            </div>
                        </div>

                        <!-- Filter Controls -->
                        <div class="mb-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="suitability-filter" class="form-label">Filter by Suitability:</label>
                                    <select id="suitability-filter" class="form-select" onchange="workflow.filterSuitabilityResults()">
                                        <option value="all">All Parcels</option>
                                        <option value="suitable">Suitable Only</option>
                                        <option value="unsuitable">Unsuitable Only</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="score-filter" class="form-label">Minimum Score:</label>
                                    <input type="range" id="score-filter" class="form-range" min="0" max="100" value="0"
                                           oninput="workflow.updateScoreFilter(this.value)">
                                    <small class="text-muted">Score: <span id="score-value">0</span>+</small>
                                </div>
                            </div>
                        </div>

                        <!-- Results Table -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="suitability-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th>
                                            <input type="checkbox" class="form-check-input" id="select-all-parcels"
                                                   onchange="workflow.toggleSelectAll()"> Select
                                        </th>
                                        <th>Parcel ID</th>
                                        <th>Acres</th>
                                        <th>Owner</th>
                                        <th>Suitability</th>
                                        <th>Overall Score</th>
                                        <th>Slope</th>
                                        <th>Transmission</th>
                                        <th>Notes</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="suitability-table-body">
                                    ${this.generateSuitabilityTableRows(data.parcels || [])}
                                </tbody>
                            </table>
                        </div>

                        <!-- Export Options with Selection Actions -->
                        <div class="row mt-4">
                            <div class="col-md-12 mb-3">
                                <div class="alert alert-info">
                                    <span id="selection-count">0</span> parcels selected
                                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="workflow.selectSuitableParcels()">
                                        Select All Suitable
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="workflow.clearSelection()">
                                        Clear Selection
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-2">
                            <div class="col-md-3">
                                <button class="btn btn-warning w-100" id="initiate-outreach-btn"
                                        onclick="workflow.initiateOutreach()" disabled>
                                    📧 Initiate Outreach
                                    <br><small>Contact selected property owners</small>
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-success w-100" onclick="workflow.exportSuitableParcelsList()">
                                    📋 Export Suitable Parcels
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-info w-100" onclick="workflow.exportFullSuitabilityReport()">
                                    📊 Export Full Report
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-secondary w-100" onclick="workflow.startOver()">
                                    🔄 Start Over
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        container.innerHTML = html;

        // Store results for filtering and export
        this.currentSuitabilityResults = data;

        // Scroll to results
        container.scrollIntoView({ behavior: 'smooth' });
    }

    toggleSelectAll() {
        const selectAllCheckbox = document.getElementById('select-all-parcels');
        const parcelCheckboxes = document.querySelectorAll('.parcel-checkbox');

        parcelCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });

        this.updateSelectionCount();
    }

    selectSuitableParcels() {
        // Select all parcels marked as suitable
        const suitableRows = document.querySelectorAll('.table-success .parcel-checkbox');
        suitableRows.forEach(checkbox => {
            checkbox.checked = true;
        });
        this.updateSelectionCount();
    }

    clearSelection() {
        const allCheckboxes = document.querySelectorAll('.parcel-checkbox, #select-all-parcels');
        allCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        this.updateSelectionCount();
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    startOver() {
        if (confirm('Are you sure you want to start over? This will clear your current analysis.')) {
            // Reset the workflow to step 1
            this.selectedProjectType = null;
            this.selectedTier = null;
            this.selectedCriteria = [];
            this.selectedLocation = null;
            this.currentAnalysis = null;
            this.currentParcelResults = null;
            this.currentSuitabilityResults = null;

            // Render step 1
            this.renderStep1();
        }
    }

    async initiateOutreach() {
        const selectedCheckboxes = document.querySelectorAll('.parcel-checkbox:checked');

        if (selectedCheckboxes.length === 0) {
            alert('Please select at least one parcel for outreach.');
            return;
        }

        // Collect selected parcel information with full analysis data
        const selectedParcels = [];

        selectedCheckboxes.forEach(checkbox => {
            const parcelId = checkbox.value;
            // Find the full parcel data from currentSuitabilityResults
            const fullParcel = this.currentSuitabilityResults.parcels.find(p => p.parcel_id === parcelId);
            if (fullParcel) {
                selectedParcels.push(fullParcel);
            }
        });

        if (selectedParcels.length === 0) {
            alert('Could not find parcel data for selected items.');
            return;
        }

        // Confirm export
        const confirmMessage = `Export ${selectedParcels.length} selected parcels to Monday.com CRM?\n\nThis will create a new group with today's date and add all selected property owners for outreach.`;

        if (!confirm(confirmMessage)) {
            return;
        }

        // Show progress
        this.showCRMExportProgress();

        try {
            const response = await fetch('/api/export-to-crm', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    selected_parcels: selectedParcels,
                    project_type: this.currentAnalysis.project_type,
                    location: this.currentAnalysis.location
                })
            });

            const result = await response.json();

            if (result.success) {
                this.showCRMExportResults(result);
            } else {
                this.showCRMExportError(result.error);
            }

        } catch (error) {
            console.error('CRM export error:', error);
            this.showCRMExportError(`Export failed: ${error.message}`);
        } finally {
            this.hideCRMExportProgress();
        }
    }

    showCRMExportProgress() {
        const progressHtml = `
            <div class="analysis-progress" id="crm-export-progress">
                <div class="progress-spinner"></div>
                <p>Exporting to Monday.com CRM...</p>
                <small>Creating group and adding property owners</small>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', progressHtml);
    }

    hideCRMExportProgress() {
        const progressEl = document.getElementById('crm-export-progress');
        if (progressEl) {
            progressEl.remove();
        }
    }

    showCRMExportResults(result) {
        const detailsHtml = result.export_details.map(detail =>
            `<tr class="${detail.status === 'success' ? 'table-success' : 'table-danger'}">
                <td>${detail.parcel_id}</td>
                <td>${detail.owner}</td>
                <td>${detail.status === 'success' ? '✓ Success' : '✗ Failed'}</td>
            </tr>`
        ).join('');

        const modalHtml = `
            <div class="modal fade" id="crmExportModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title">📧 CRM Export Complete</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-success">
                                <h6>Export Summary</h6>
                                <p><strong>Group Created:</strong> ${result.group_name}</p>
                                <p><strong>Successfully Exported:</strong> ${result.successful_exports} parcels</p>
                                ${result.failed_exports > 0 ? `<p><strong>Failed:</strong> ${result.failed_exports} parcels</p>` : ''}
                            </div>

                            <h6>Export Details</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Parcel ID</th>
                                            <th>Owner</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${detailsHtml}
                                    </tbody>
                                </table>
                            </div>

                            <div class="mt-3">
                                <p class="small text-muted">
                                    <strong>Next Steps:</strong> Log into your Monday.com account to begin outreach to property owners.
                                    The new group "${result.group_name}" contains all exported parcels with suitability scores.
                                </p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal if present
        const existingModal = document.getElementById('crmExportModal');
        if (existingModal) {
            existingModal.remove();
        }

        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const modal = new bootstrap.Modal(document.getElementById('crmExportModal'));
        modal.show();
    }

    showCRMExportError(error) {
        const modalHtml = `
            <div class="modal fade" id="crmErrorModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">❌ CRM Export Failed</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-danger">
                                <h6>Export Error</h6>
                                <p>${error}</p>
                            </div>

                            <h6>Possible Solutions:</h6>
                            <ul class="small">
                                <li>Check your Monday.com API credentials in the .env file</li>
                                <li>Verify your Board ID is correct</li>
                                <li>Ensure you have write permissions to the board</li>
                                <li>Check your internet connection</li>
                            </ul>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="workflow.testCRMConnection()">Test Connection</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const modal = new bootstrap.Modal(document.getElementById('crmErrorModal'));
        modal.show();
    }

    async testCRMConnection() {
        try {
            const response = await fetch('/api/crm/test-connection');
            const result = await response.json();

            if (result.success) {
                alert(`✅ CRM Connection Successful!\n\nConnected as: ${result.user.name}\nEmail: ${result.user.email}`);
            } else {
                alert(`❌ CRM Connection Failed:\n\n${result.error}`);
            }
        } catch (error) {
            alert(`❌ Connection Test Failed:\n\n${error.message}`);
        }
    }

generateSuitabilityTableRows(parcels) {
    if (!Array.isArray(parcels)) {
        console.error('generateSuitabilityTableRows: parcels is not an array:', parcels);
        return '<tr><td colspan="10" class="text-center text-danger">Error: Invalid parcel data format</td></tr>';
    }

    return parcels.map(parcel => {
        const analysis = parcel.suitability_analysis;
        const suitabilityBadge = analysis.is_suitable ?
            '<span class="badge bg-success">✓ Suitable</span>' :
            '<span class="badge bg-danger">✗ Not Suitable</span>';

        const scoreBadge = this.getScoreBadge(analysis.overall_score);
        const slopeInfo = this.formatSlopeInfo(analysis);
        const transmissionInfo = this.formatTransmissionInfo(analysis);

        return `
            <tr class="${analysis.is_suitable ? 'table-success' : 'table-warning'}">
                <td>
                    <input type="checkbox" class="form-check-input parcel-checkbox"
                           value="${parcel.parcel_id}"
                           data-owner="${this.escapeHtml(parcel.owner || 'Unknown')}"
                           data-acres="${parseFloat(parcel.acreage || parcel.acres || 0).toFixed(1)}">
                </td>
                <td><strong>${parcel.parcel_id}</strong></td>
                <td>${parseFloat(parcel.acreage || parcel.acres || 0).toFixed(1)}</td>
                <td>${this.truncateText(parcel.owner || 'Unknown', 20)}</td>
                <td>${suitabilityBadge}</td>
                <td>${scoreBadge}</td>
                <td>${slopeInfo}</td>
                <td>${transmissionInfo}</td>
                <td><small>${this.truncateText(analysis.analysis_notes, 50)}</small></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="workflow.showParcelDetails('${parcel.parcel_id}')">
                        Details
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

    getScoreBadge(score) {
        if (score >= 80) return `<span class="badge bg-success">${score}</span>`;
        if (score >= 60) return `<span class="badge bg-warning">${score}</span>`;
        return `<span class="badge bg-danger">${score}</span>`;
    }

formatSlopeInfo(analysis) {
    const slope = analysis.slope_degrees;
    const suitable = analysis.slope_suitable;

    if (slope === 'Unknown' || slope === 'NaN' || !slope) {
        return '<small class="text-muted">Unkn</small>';
    }

    const slopeValue = parseFloat(slope);

    if (isNaN(slopeValue)) {
        return '<small class="text-muted">Unkn</small>';
    }

    const color = suitable ? 'text-success' : 'text-danger';
    const icon = suitable ? '✓' : '✗';

    return `<span class="${color}">${icon} ${slopeValue.toFixed(1)}°</span>`;
}

formatTransmissionInfo(analysis) {
    const distance = analysis.transmission_distance;
    const voltage = analysis.transmission_voltage;
    const suitable = analysis.transmission_suitable;

    if (distance === 'Unknown' || distance === 'NaN' || !distance) {
        return '<small class="text-muted">Unkn</small>';
    }

    const distValue = parseFloat(distance);
    const voltValue = parseFloat(voltage);

    // Check for NaN values and replace with "Unkn"
    if (isNaN(distValue) || isNaN(voltValue)) {
        return '<small class="text-muted">Unkn</small>';
    }

    const color = suitable ? 'text-success' : 'text-danger';
    const icon = suitable ? '✓' : '✗';

    return `<span class="${color}">${icon} ${distValue.toFixed(2)} mi<br><small>${voltValue.toFixed(0)} kV</small></span>`;
}

    truncateText(text, maxLength) {
        if (!text) return '';
        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }

    filterSuitabilityResults() {
        const filter = document.getElementById('suitability-filter').value;
        const tableBody = document.getElementById('suitability-table-body');

        if (!this.currentSuitabilityResults) return;

        let filteredParcels = this.currentSuitabilityResults.parcels;

        if (filter === 'suitable') {
            filteredParcels = filteredParcels.filter(p => p.suitability_analysis.is_suitable);
        } else if (filter === 'unsuitable') {
            filteredParcels = filteredParcels.filter(p => !p.suitability_analysis.is_suitable);
        }

        tableBody.innerHTML = this.generateSuitabilityTableRows(filteredParcels);
    }

    updateScoreFilter(value) {
        document.getElementById('score-value').textContent = value;

        if (!this.currentSuitabilityResults) return;

        const tableBody = document.getElementById('suitability-table-body');
        const suitabilityFilter = document.getElementById('suitability-filter').value;

        let filteredParcels = this.currentSuitabilityResults.parcels;

        // Apply suitability filter first
        if (suitabilityFilter === 'suitable') {
            filteredParcels = filteredParcels.filter(p => p.suitability_analysis.is_suitable);
        } else if (suitabilityFilter === 'unsuitable') {
            filteredParcels = filteredParcels.filter(p => !p.suitability_analysis.is_suitable);
        }

        // Apply score filter
        filteredParcels = filteredParcels.filter(p => p.suitability_analysis.overall_score >= parseFloat(value));

        tableBody.innerHTML = this.generateSuitabilityTableRows(filteredParcels);
    }

    showParcelDetails(parcelId) {
        const parcel = this.currentSuitabilityResults.parcels.find(p => p.parcel_id === parcelId);

        if (!parcel) {
            alert('Parcel details not found');
            return;
        }

        const analysis = parcel.suitability_analysis;

        const detailsHtml = `
            <div class="modal fade" id="parcelDetailsModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Parcel Details: ${parcel.parcel_id}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Basic Information</h6>
                                    <p><strong>Parcel ID:</strong> ${parcel.parcel_id}</p>
                                    <p><strong>Owner:</strong> ${parcel.owner}</p>
                                    <p><strong>Acreage:</strong> ${parseFloat(parcel.acreage || parcel.acres || 0).toFixed(1)} acres</p>
                                    <p><strong>Location:</strong> ${parcel.county || 'Unknown'}, ${parcel.state_abbr || 'Unknown'}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6>Suitability Analysis</h6>
                                    <p><strong>Overall Score:</strong> ${analysis.overall_score}/100</p>
                                    <p><strong>Slope Score:</strong> ${analysis.slope_score}/100 (${analysis.slope_degrees}°)</p>
                                    <p><strong>Transmission Score:</strong> ${analysis.transmission_score}/100</p>
                                    <p><strong>Distance to Transmission:</strong> ${analysis.transmission_distance} miles</p>
                                    <p><strong>Transmission Voltage:</strong> ${analysis.transmission_voltage} kV</p>
                                </div>
                            </div>
                            <hr>
                            <h6>Analysis Notes</h6>
                            <p>${analysis.analysis_notes}</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal if present
        const existingModal = document.getElementById('parcelDetailsModal');
        if (existingModal) {
            existingModal.remove();
        }

        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', detailsHtml);

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('parcelDetailsModal'));
        modal.show();
    }

    displayMLSuitabilityResults(data) {
        console.log('🖥️ displayMLSuitabilityResults called with:', data);

        const container = document.getElementById('workflow-container');

        const resultDate = new Date().toLocaleDateString('en-US', {
            year: 'numeric', month: 'long', day: 'numeric',
            hour: '2-digit', minute: '2-digit'
        });

        const html = `
            <div class="suitability-results-container">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4>🧠 ML-Enhanced Parcel Analysis Results</h4>
                        <div>
                            <button class="btn btn-sm btn-outline-info me-2" onclick="workflow.showScoringMethodology()">
                                ❓ How Scores Work
                            </button>
                            <small class="text-muted">Generated: ${resultDate}</small>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Summary Statistics -->
                        <div class="suitability-summary">
                            <h5>📊 ML Analysis Summary</h5>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h3 class="text-primary">${data.total_parcels}</h3>
                                            <p class="card-text">Total Parcels</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h3 class="text-success">${data.suitable_parcels}</h3>
                                            <p class="card-text">ML Recommended</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h3 class="text-info">${Math.round((data.suitable_parcels / data.total_parcels) * 100)}%</h3>
                                            <p class="card-text">Recommendation Rate</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h3 class="text-warning">🤖+📊</h3>
                                            <p class="card-text">ML + Traditional</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Selection and Action Controls -->
                        <div class="row mt-4 mb-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="select-all-ml-parcels" onchange="workflow.toggleAllParcels(this.checked)">
                                    <label class="form-check-label" for="select-all-ml-parcels">
                                        <strong>Select All Recommended Parcels</strong>
                                    </label>
                                </div>
                                <small class="text-muted">Selected: <span id="selected-count">0</span> parcels</small>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-success btn-lg" id="initiate-outreach-btn" onclick="workflow.initiateMLOutreach()" disabled>
                                    📧 Initiate Outreach <span class="badge bg-light text-dark" id="outreach-count">0</span>
                                </button>
                            </div>
                        </div>

                        <!-- Enhanced Results Table -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-sm" id="ml-suitability-table">
                                // In the displayMLSuitabilityResults method, replace the table header section:
                                <thead class="table-dark">
                                    <tr>
                                        <th width="3%">
                                            <input type="checkbox" class="form-check-input" id="header-select-all" onchange="workflow.toggleAllParcels(this.checked)">
                                        </th>
                                        <th>Parcel ID</th>
                                        <th>Owner</th>
                                        <th>Acres</th>
                                        <th title="Slope in degrees - Lower is better">
                                            🏔️ Slope
                                        </th>
                                        <th title="Distance to transmission lines">
                                            ⚡ Transmission
                                        </th>
                                        <th title="AI/ML predicted score based on multiple factors">
                                            🤖 ML Score
                                        </th>
                                        <th title="Traditional analysis score (slope + transmission)">
                                            📊 Traditional
                                        </th>
                                        <th title="Combined score: 60% ML + 40% Traditional">
                                            🎯 Combined
                                        </th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                        <th width="15%" title="Select reason when excluding parcels from outreach">
                                            🚫 Why Not?
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${this.generateMLTableRows(data.parcels || [])}
                                </tbody>
                            </table>
                        </div>

                        <!-- Legend -->
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6>🏔️ Slope Legend:</h6>
                                <span class="badge bg-success me-1">≤5°</span> Excellent
                                <span class="badge bg-warning me-1 ms-2">5-15°</span> Good
                                <span class="badge bg-danger me-1 ms-2">>15°</span> Challenging
                            </div>
                            <div class="col-md-6">
                                <h6>⚡ Transmission Legend:</h6>
                                <span class="badge bg-success me-1">≤0.5mi</span> Very Close
                                <span class="badge bg-warning me-1 ms-2">0.5-1mi</span> Close
                                <span class="badge bg-danger me-1 ms-2">>1mi</span> Far
                            </div>
                        </div>

                        <!-- Back Button -->
                        <div class="mt-4">
                            <button class="btn btn-secondary" onclick="workflow.showParcelSearchInterface()">
                                ← Back to Parcel Search
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        container.innerHTML = html;
        this.currentMLResults = data;
        container.scrollIntoView({ behavior: 'smooth' });

        // Attach event listeners for checkboxes
        this.attachMLCheckboxListeners();

        console.log('✅ ML results displayed successfully');
    }

    generateMLTableRows(parcels) {
        if (!Array.isArray(parcels)) {
            return '<tr><td colspan="12" class="text-center text-danger">No parcel data available</td></tr>';
        }

        return parcels.map((parcel, index) => {
            const analysis = parcel.suitability_analysis || {};
            const mlAnalysis = parcel.ml_analysis || {};

            // Get scores with fallbacks
            const mlScore = mlAnalysis.predicted_score || 'N/A';
            const traditionalScore = analysis.traditional_score || analysis.overall_score || 'N/A';
            const combinedScore = analysis.overall_score || 'N/A';

            // Get slope and transmission info
            const slopeInfo = analysis.slope_degrees || parcel.slope_degrees || 'Unknown';
            const transmissionDistance = analysis.transmission_distance || parcel.transmission_distance || 'Unknown';
            const transmissionVoltage = analysis.transmission_voltage || parcel.transmission_voltage || 'Unknown';

            // Create badges
            const mlBadge = mlScore !== 'N/A' && mlScore >= 70 ?
                `<span class="badge bg-success">${mlScore}</span>` :
                mlScore !== 'N/A' ? `<span class="badge bg-warning">${mlScore}</span>` :
                `<span class="badge bg-secondary">N/A</span>`;

            const combinedBadge = combinedScore !== 'N/A' && combinedScore >= 70 ?
                `<span class="badge bg-primary">${combinedScore}</span>` :
                combinedScore !== 'N/A' ? `<span class="badge bg-secondary">${combinedScore}</span>` :
                `<span class="badge bg-secondary">N/A</span>`;

            // Enhanced slope badge with color coding
            let slopeBadge = `<span class="badge bg-secondary">${slopeInfo}</span>`;
            if (slopeInfo !== 'Unknown') {
                const slope = parseFloat(slopeInfo);
                if (slope <= 5) slopeBadge = `<span class="badge bg-success">${slope}°</span>`;
                else if (slope <= 15) slopeBadge = `<span class="badge bg-warning">${slope}°</span>`;
                else slopeBadge = `<span class="badge bg-danger">${slope}°</span>`;
            }

            // Enhanced transmission badge
            let transmissionBadge = `<span class="badge bg-secondary">Unknown</span>`;
            if (transmissionDistance !== 'Unknown') {
                const distance = parseFloat(transmissionDistance);
                const voltage = transmissionVoltage !== 'Unknown' ? `${transmissionVoltage}kV` : '';
                if (distance <= 0.5) transmissionBadge = `<span class="badge bg-success" title="${voltage}">${distance.toFixed(2)}mi</span>`;
                else if (distance <= 1.0) transmissionBadge = `<span class="badge bg-warning" title="${voltage}">${distance.toFixed(2)}mi</span>`;
                else transmissionBadge = `<span class="badge bg-danger" title="${voltage}">${distance.toFixed(2)}mi</span>`;
            }

            const isRecommended = analysis.is_suitable || false;
            const statusBadge = isRecommended ?
                '<span class="badge bg-success">✓ Recommended</span>' :
                '<span class="badge bg-danger">✗ Not Recommended</span>';

            // Determine primary disqualifying factor for pre-population
            const primaryReason = this.determinePrimaryDisqualifyingFactor(parcel);

            return `
                <tr class="${isRecommended ? 'table-success' : ''}" data-parcel-index="${index}" id="parcel-row-${index}">
                    <td>
                        <input type="checkbox" class="form-check-input ml-parcel-checkbox"
                               value="${parcel.parcel_id}"
                               data-parcel-index="${index}"
                               data-is-recommended="${isRecommended}"
                               ${isRecommended ? 'checked' : ''}
                               onchange="workflow.handleParcelSelection(${index})">
                    </td>
                    <td><strong>${parcel.parcel_id}</strong></td>
                    <td>${this.truncateText(parcel.owner || 'Unknown', 25)}</td>
                    <td>${parseFloat(parcel.acreage || parcel.acreage_calc || 0).toFixed(1)}</td>
                    <td>${slopeBadge}</td>
                    <td>${transmissionBadge}</td>
                    <td>${mlBadge}</td>
                    <td><span class="badge bg-info">${traditionalScore}</span></td>
                    <td>${combinedBadge}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="workflow.showMLParcelDetails('${parcel.parcel_id}')">
                            Details
                        </button>
                    </td>
                    <td>
                        <!-- Why Not? Dropdown -->
                        <select class="form-select form-select-sm why-not-dropdown"
                                id="why-not-${index}"
                                data-parcel-id="${parcel.parcel_id}"
                                data-parcel-index="${index}"
                                ${isRecommended ? 'disabled' : ''}
                                onchange="workflow.recordParcelExclusion(${index})"
                                style="min-width: 150px;">
                            <option value="">Select reason...</option>
                            ${this.createExclusionOptions(isRecommended, primaryReason)}
                        </select>
                    </td>
                </tr>
            `;
        }).join('');
    }

    determinePrimaryDisqualifyingFactor(parcel) {
        /**
         * Analyze parcel data to determine the primary reason it's not suitable
         */
        const analysis = parcel.suitability_analysis || {};
        const slope = parseFloat(analysis.slope_degrees || parcel.slope_degrees || 0);
        const transmissionDistance = parseFloat(analysis.transmission_distance || parcel.transmission_distance || 0);
        const acreage = parseFloat(parcel.acreage_calc || parcel.acreage || 0);
        const owner = String(parcel.owner || '').toUpperCase();
        const landUse = String(parcel.land_use_class || '').toUpperCase();
        const floodZone = String(parcel.fld_zone || '');

        // Priority order of disqualifying factors
        if (slope > 20) {
            return 'slope_too_steep';
        } else if (slope > 15) {
            return 'slope_challenging';
        } else if (transmissionDistance > 2.0) {
            return 'transmission_too_far';
        } else if (transmissionDistance > 1.0) {
            return 'transmission_distance';
        } else if (acreage < 10) {
            return 'parcel_too_small';
        } else if (owner.includes('CITY') || owner.includes('COUNTY') || owner.includes('STATE')) {
            return 'public_lands';
        } else if (landUse.includes('CONSERVATION') || landUse.includes('PARK')) {
            return 'conservation_area';
        } else if (floodZone && floodZone !== 'X' && floodZone !== 'null') {
            return 'flood_risk';
        }

        return 'multiple_factors';
    }

    createExclusionOptions(isRecommended, primaryReason) {
        /**
         * Create dropdown options for why parcels are excluded
         */
        let options = '';

        if (!isRecommended) {
            // For NOT recommended parcels - show analysis-based reasons
            const reasonMap = {
                'slope_too_steep': 'Slope too steep (>20°)',
                'slope_challenging': 'Slope challenging (15-20°)',
                'transmission_too_far': 'Transmission too far (>2mi)',
                'transmission_distance': 'Transmission distance concerns',
                'parcel_too_small': 'Parcel too small',
                'public_lands': 'Public/government lands',
                'conservation_area': 'Conservation/protected area',
                'flood_risk': 'Flood zone concerns',
                'multiple_factors': 'Multiple limiting factors'
            };

            // Pre-select the primary reason
            const primaryReasonText = reasonMap[primaryReason] || 'Analysis determined unsuitable';
            options += `<option value="${primaryReason}" selected>${primaryReasonText}</option>`;

            // Add other possible reasons
            Object.entries(reasonMap).forEach(([key, text]) => {
                if (key !== primaryReason) {
                    options += `<option value="${key}">${text}</option>`;
                }
            });

            // Add override option
            options += `<option value="override_analysis">Override - Include anyway</option>`;

        } else {
            // For RECOMMENDED parcels - user chooses why they're excluding
            options += `
                <option value="slope_concerns">Slope concerns</option>
                <option value="transmission_access">Transmission access</option>
                <option value="transmission_capacity">Transmission capacity issues</option>
                <option value="parcel_size_pref">Parcel size preference</option>
                <option value="parcel_configuration">Parcel configuration</option>
                <option value="flood_concerns">Flood concerns</option>
                <option value="environmental_buffer">Environmental buffer needed</option>
                <option value="owner_access_issues">Owner/access concerns</option>
                <option value="market_timing">Market timing</option>
                <option value="portfolio_balance">Portfolio balance</option>
                <option value="already_contacted">Already contacted owner</option>
                <option value="location_priority">Location not priority</option>
                <option value="risk_assessment">Risk too high</option>
                <option value="resource_constraints">Resource constraints</option>
                <option value="competitor_presence">Competitor presence</option>
            `;
        }

        return options;
    }

    handleParcelSelection(parcelIndex) {
        /**
         * Handle when a parcel checkbox is checked/unchecked
         */
        const checkbox = document.querySelector(`input[data-parcel-index="${parcelIndex}"]`);
        const dropdown = document.getElementById(`why-not-${parcelIndex}`);
        const row = document.getElementById(`parcel-row-${parcelIndex}`);

        if (checkbox && dropdown) {
            if (checkbox.checked) {
                // Parcel selected for outreach - disable dropdown and clear selection
                dropdown.disabled = true;
                dropdown.value = '';
                dropdown.style.opacity = '0.5';
                row.classList.add('table-primary');

            } else {
                // Parcel NOT selected - enable dropdown
                dropdown.disabled = false;
                dropdown.style.opacity = '1.0';
                row.classList.remove('table-primary');

                // If it's a recommended parcel, prompt user to select reason
                const isRecommended = checkbox.getAttribute('data-is-recommended') === 'true';
                if (isRecommended && !dropdown.value) {
                    setTimeout(() => {
                        dropdown.focus();
                        dropdown.style.borderColor = '#ffc107';
                        setTimeout(() => {
                            dropdown.style.borderColor = '';
                        }, 3000);
                    }, 100);
                }
            }
        }

        // Update selection count
        this.updateSelectionCount();
    }

    async recordParcelExclusion(parcelIndex) {
        /**
         * Record why a parcel is excluded from outreach
         */
        try {
            const dropdown = document.getElementById(`why-not-${parcelIndex}`);
            const parcelId = dropdown.getAttribute('data-parcel-id');
            const exclusionReason = dropdown.value;

            if (!exclusionReason) {
                return;
            }

            console.log(`📝 Recording exclusion: ${parcelId} - ${exclusionReason}`);

            // Get parcel data
            const parcel = this.currentMLResults.parcels[parcelIndex];
            const isRecommended = parcel.suitability_analysis?.is_suitable || parcel.is_suitable || false;

            // Special handling for override
            if (exclusionReason === 'override_analysis') {
                const confirmed = confirm(`Override analysis and include ${parcelId} in outreach?\n\nThis parcel was flagged as unsuitable by our analysis.`);
                if (confirmed) {
                    // Check the checkbox to include in outreach
                    const checkbox = document.querySelector(`input[data-parcel-index="${parcelIndex}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        this.handleParcelSelection(parcelIndex);
                    }
                    exclusionReason = 'analysis_override';
                } else {
                    dropdown.value = '';
                    return;
                }
            }

            // Prepare feedback data
            const feedbackData = {
                parcel_id: parcelId,
                exclusion_reason: exclusionReason,
                is_recommended: isRecommended,
                parcel_data: parcel,
                project_type: this.currentAnalysis?.project_type || 'solar',
                location: this.currentAnalysis?.location || 'Unknown',
                feedback_timestamp: new Date().toISOString()
            };

            // Send to backend
            const response = await fetch('/api/record-parcel-exclusion', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(feedbackData)
            });

            if (response.ok) {
                console.log(`✅ Exclusion recorded for parcel ${parcelId}`);

                // Visual feedback
                dropdown.style.borderColor = '#28a745';
                setTimeout(() => {
                    dropdown.style.borderColor = '';
                }, 2000);

            } else {
                console.error(`❌ Failed to record exclusion for parcel ${parcelId}`);
            }

        } catch (error) {
            console.error('❌ Error recording parcel exclusion:', error);
        }
    }

    updateSelectionCount() {
        /**
         * Update selection count and button states - ENHANCED
         */
        const checkboxes = document.querySelectorAll('.ml-parcel-checkbox:checked');
        const count = checkboxes.length;

        // Update count displays
        const selectedCountElement = document.getElementById('selected-count');
        const outreachCountElement = document.getElementById('outreach-count');

        if (selectedCountElement) selectedCountElement.textContent = count;
        if (outreachCountElement) outreachCountElement.textContent = count;

        // Enable/disable outreach button
        const outreachBtn = document.getElementById('initiate-outreach-btn');
        if (outreachBtn) {
            outreachBtn.disabled = count === 0;
        }

        // Update header checkbox states
        const allCheckboxes = document.querySelectorAll('.ml-parcel-checkbox');
        const headerCheckboxes = ['select-all-ml-parcels', 'header-select-all'];

        headerCheckboxes.forEach(id => {
            const headerCheckbox = document.getElementById(id);
            if (headerCheckbox) {
                headerCheckbox.checked = count === allCheckboxes.length && count > 0;
                headerCheckbox.indeterminate = count > 0 && count < allCheckboxes.length;
            }
        });

        // Update the "Select All Recommended Parcels" checkbox text and function
        const selectAllLabel = document.querySelector('label[for="select-all-ml-parcels"]');
        if (selectAllLabel) {
            const recommendedCount = document.querySelectorAll('.ml-parcel-checkbox[data-is-recommended="true"]').length;
            selectAllLabel.innerHTML = `<strong>Select All Recommended Parcels (${recommendedCount})</strong>`;
        }
    }

    createFeedbackOptions(isRecommended, primaryReason) {
        /**
         * Create dropdown options based on whether parcel is recommended and primary issue
         */
        let options = '';

        if (!isRecommended) {
            // For NOT recommended parcels - pre-populate with primary reason
            const reasonMap = {
                'slope_too_steep': 'Slope too steep (>20°)',
                'slope_challenging': 'Slope challenging (15-20°)',
                'transmission_too_far': 'Transmission too far (>2mi)',
                'transmission_distance': 'Transmission distance (1-2mi)',
                'parcel_too_small': 'Parcel too small (<10 acres)',
                'parcel_too_large': 'Parcel too large (>10,000 acres)',
                'public_lands': 'Public/government lands',
                'conservation_area': 'Conservation/protected area',
                'flood_risk': 'Flood zone concerns',
                'low_ml_confidence': 'Low AI confidence',
                'multiple_factors': 'Multiple limiting factors'
            };

            // Pre-select the primary reason
            const primaryReasonText = reasonMap[primaryReason] || 'Analysis determined unsuitable';
            options += `<option value="${primaryReason}" selected>${primaryReasonText}</option>`;

            // Add other possible reasons (not selected)
            Object.entries(reasonMap).forEach(([key, text]) => {
                if (key !== primaryReason) {
                    options += `<option value="${key}">${text}</option>`;
                }
            });

            // Add override option
            options += `<option value="override_analysis">Override - Actually interested</option>`;

        } else {
            // For RECOMMENDED parcels - user chooses why they didn't select
            options += `
                <option value="slope_preference">Slope concerns</option>
                <option value="transmission_access">Transmission access</option>
                <option value="transmission_capacity">Transmission capacity</option>
                <option value="parcel_size">Parcel size</option>
                <option value="parcel_configuration">Parcel configuration</option>
                <option value="flood_concerns">Flood concerns</option>
                <option value="conservation_buffer">Too close to conservation</option>
                <option value="public_lands_nearby">Near public lands</option>
                <option value="owner_concerns">Owner/access concerns</option>
                <option value="market_timing">Market timing</option>
                <option value="portfolio_balance">Portfolio balance</option>
                <option value="already_contacted">Already contacted</option>
                <option value="location_preference">Location preference</option>
                <option value="risk_assessment">Risk assessment</option>
            `;
        }

        return options;
    }

    async recordParcelFeedback(parcelIndex) {
        /**
         * Record feedback for a specific parcel
         */
        try {
            const selectElement = document.getElementById(`feedback-select-${parcelIndex}`);
            const customElement = document.getElementById(`feedback-custom-${parcelIndex}`);
            const parcelId = selectElement.getAttribute('data-parcel-id');

            const selectedReason = selectElement.value;
            const customReason = customElement.value.trim();

            if (!selectedReason && !customReason) {
                return; // No feedback provided yet
            }

            // Get parcel data
            const parcel = this.currentMLResults.parcels[parcelIndex];

            // Prepare feedback data
            const feedbackData = {
                parcel_id: parcelId,
                parcel_index: parcelIndex,
                selected_reason: selectedReason,
                custom_reason: customReason,
                parcel_data: parcel,
                project_type: this.currentAnalysis?.project_type || 'solar',
                location: this.currentAnalysis?.location || 'Unknown',
                is_recommended: parcel.suitability_analysis?.is_suitable || parcel.is_suitable || false,
                feedback_timestamp: new Date().toISOString()
            };

            console.log(`📝 Recording feedback for parcel ${parcelId}:`, feedbackData);

            // Send to backend
            const response = await fetch('/api/record-parcel-feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(feedbackData)
            });

            if (response.ok) {
                console.log(`✅ Feedback recorded for parcel ${parcelId}`);

                // Visual feedback
                selectElement.style.borderColor = '#28a745';
                setTimeout(() => {
                    selectElement.style.borderColor = '';
                }, 2000);

            } else {
                console.error(`❌ Failed to record feedback for parcel ${parcelId}`);
            }

        } catch (error) {
            console.error('❌ Error recording parcel feedback:', error);
        }
    }

    clearParcelFeedback(parcelIndex) {
        /**
         * Clear feedback when parcel is selected for outreach
         */
        const selectElement = document.getElementById(`feedback-select-${parcelIndex}`);
        const customElement = document.getElementById(`feedback-custom-${parcelIndex}`);

        if (selectElement) selectElement.value = '';
        if (customElement) customElement.value = '';
    }

    async initiateMLOutreach() {
        /**
         * SIMPLIFIED outreach without complex feedback modal
         */
        try {
            const selectedCheckboxes = document.querySelectorAll('.ml-parcel-checkbox:checked');

            if (selectedCheckboxes.length === 0) {
                alert('Please select at least one parcel for outreach.');
                return;
            }

            const selectedParcels = Array.from(selectedCheckboxes).map(cb => {
                const index = parseInt(cb.getAttribute('data-parcel-index'));
                return this.currentMLResults.parcels[index];
            });

            // Show loading state
            const outreachBtn = document.getElementById('initiate-outreach-btn');
            if (outreachBtn) {
                outreachBtn.disabled = true;
                outreachBtn.textContent = '⏳ Exporting to CRM...';
            }

            // Export to CRM
            const response = await fetch('/api/export-to-crm', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    selected_parcels: selectedParcels,
                    project_type: this.currentAnalysis?.project_type || 'solar',
                    location: this.currentAnalysis?.location || 'Unknown Location',
                    analysis_type: 'ml_enhanced'
                })
            });

            const result = await response.json();

            if (result.success) {
                alert(`✅ Successfully exported ${result.successful_exports} parcels to CRM!\n\nGroup: ${result.group_name}`);

                // Clear selections
                selectedCheckboxes.forEach(cb => cb.checked = false);
                this.updateSelectionCount();

                // Hide all feedback containers
                document.querySelectorAll('[id^="feedback-"]').forEach(container => {
                    container.style.display = 'none';
                });

            } else {
                throw new Error(result.error || 'CRM export failed');
            }

        } catch (error) {
            console.error('❌ CRM export error:', error);
            alert(`❌ CRM export failed: ${error.message}`);
        } finally {
            // Restore button
            const outreachBtn = document.getElementById('initiate-outreach-btn');
            if (outreachBtn) {
                outreachBtn.disabled = false;
                outreachBtn.textContent = '📧 Initiate Outreach';
            }
        }
    }

    showPostOutreachFeedback(feedbackData) {
        console.log('🤖 Showing post-outreach feedback with data:', feedbackData);

        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">🤖 Help Improve ML Recommendations</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Thanks for your selections! Quick feedback to improve our AI:</p>

                        ${feedbackData.notRecommendedSelected.length > 0 ? `
                        <div class="alert alert-info">
                            <strong>You selected ${feedbackData.notRecommendedSelected.length} parcels we didn't recommend.</strong>
                            <br>What made these appealing despite our analysis?
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-primary me-2" onclick="workflow.recordBatchFeedback('selected_non_recommended', 'owner_relationships')">Owner Relationships</button>
                                <button class="btn btn-sm btn-outline-primary me-2" onclick="workflow.recordBatchFeedback('selected_non_recommended', 'local_knowledge')">Local Knowledge</button>
                                <button class="btn btn-sm btn-outline-primary me-2" onclick="workflow.recordBatchFeedback('selected_non_recommended', 'strategic_location')">Strategic Location</button>
                                <button class="btn btn-sm btn-outline-primary" onclick="workflow.recordBatchFeedback('selected_non_recommended', 'other_factors')">Other Factors</button>
                            </div>
                        </div>
                        ` : ''}

                        ${feedbackData.highMLNotSelected.length > 0 ? `
                        <div class="alert alert-warning">
                            <strong>You didn't select ${Math.min(3, feedbackData.highMLNotSelected.length)} high-scoring parcels.</strong>
                            <br>What deterred you from these recommendations?
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-warning me-2" onclick="workflow.recordBatchFeedback('skipped_high_ml', 'owner_concerns')">Owner/Landowner Concerns</button>
                                <button class="btn btn-sm btn-outline-warning me-2" onclick="workflow.recordBatchFeedback('skipped_high_ml', 'location_issues')">Location Issues</button>
                                <button class="btn btn-sm btn-outline-warning me-2" onclick="workflow.recordBatchFeedback('skipped_high_ml', 'timing_constraints')">Timing/Market</button>
                                <button class="btn btn-sm btn-outline-warning" onclick="workflow.recordBatchFeedback('skipped_high_ml', 'technical_concerns')">Technical Concerns</button>
                            </div>
                        </div>
                        ` : ''}

                        ${feedbackData.notRecommendedSelected.length === 0 && feedbackData.highMLNotSelected.length === 0 ? `
                        <div class="alert alert-success">
                            <strong>Perfect! Your selections aligned well with our recommendations.</strong>
                            <br>No feedback needed - the ML model is working well for this dataset.
                        </div>
                        ` : ''}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Skip Feedback</button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // Force show modal
        try {
            const bootstrapModal = new bootstrap.Modal(modal, {
                backdrop: 'static',  // Prevent dismissal by clicking outside
                keyboard: true
            });
            bootstrapModal.show();

            console.log('✅ Modal should be visible now');

            // Store feedback data for use by buttons
            this.currentFeedbackData = feedbackData;

            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
                delete this.currentFeedbackData;
            });
        } catch (error) {
            console.error('❌ Error showing feedback modal:', error);
            // Fallback: simple alert
            if (feedbackData.notRecommendedSelected.length > 0) {
                setTimeout(() => {
                    alert(`Notice: You selected ${feedbackData.notRecommendedSelected.length} parcels we didn't recommend. This feedback helps improve our ML model!`);
                }, 1000);
            }
        }
    }

    showPostOutreachFeedbackDebug(feedbackData) {
        console.log('🤖 CREATING FEEDBACK MODAL with data:', feedbackData);
        console.log('🔍 DOM body children before:', document.body.children.length);

        // Force remove any existing modals first
        const existingModals = document.querySelectorAll('.feedback-modal');
        console.log('🗑️ Removing existing modals:', existingModals.length);
        existingModals.forEach(modal => modal.remove());

        // Create modal HTML
        const modalHtml = `
            <div class="modal fade feedback-modal" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true" style="z-index: 9999;">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="feedbackModalLabel">🤖 Help Improve ML Recommendations</h5>
                            <button type="button" class="btn-close btn-close-white" onclick="workflow.closeFeedbackModal()" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p class="lead">Thanks for your selections! Quick feedback to improve our AI:</p>

                            ${feedbackData.notRecommendedSelected.length > 0 ? `
                            <div class="alert alert-info border-start border-info border-4">
                                <h6 class="alert-heading">You selected ${feedbackData.notRecommendedSelected.length} parcels we didn't recommend</h6>
                                <p class="mb-2">What made these appealing despite our analysis showing concerns?</p>
                                <div class="d-flex flex-wrap gap-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="workflow.recordBatchFeedbackAndClose('selected_non_recommended', 'owner_relationships')">
                                        👥 Owner Relationships
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" onclick="workflow.recordBatchFeedbackAndClose('selected_non_recommended', 'local_knowledge')">
                                        🗺️ Local Knowledge
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" onclick="workflow.recordBatchFeedbackAndClose('selected_non_recommended', 'strategic_location')">
                                        📍 Strategic Location
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" onclick="workflow.recordBatchFeedbackAndClose('selected_non_recommended', 'market_timing')">
                                        ⏰ Market Timing
                                    </button>
                                </div>
                            </div>
                            ` : ''}

                            ${feedbackData.highMLNotSelected.length > 0 ? `
                            <div class="alert alert-warning border-start border-warning border-4">
                                <h6 class="alert-heading">You skipped ${feedbackData.highMLNotSelected.length} high-scoring parcels</h6>
                                <p class="mb-2">What deterred you from these AI recommendations?</p>
                                <div class="d-flex flex-wrap gap-2">
                                    <button class="btn btn-outline-warning btn-sm" onclick="workflow.recordBatchFeedbackAndClose('skipped_high_ml', 'owner_concerns')">
                                        👤 Owner/Access Concerns
                                    </button>
                                    <button class="btn btn-outline-warning btn-sm" onclick="workflow.recordBatchFeedbackAndClose('skipped_high_ml', 'location_issues')">
                                        📍 Location Issues
                                    </button>
                                    <button class="btn btn-outline-warning btn-sm" onclick="workflow.recordBatchFeedbackAndClose('skipped_high_ml', 'timing_constraints')">
                                        ⏰ Timing/Market Fit
                                    </button>
                                    <button class="btn btn-outline-warning btn-sm" onclick="workflow.recordBatchFeedbackAndClose('skipped_high_ml', 'technical_concerns')">
                                        ⚙️ Technical Concerns
                                    </button>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="workflow.closeFeedbackModal()">
                                Skip Feedback
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        console.log('📝 Modal HTML added to DOM');
        console.log('🔍 DOM body children after:', document.body.children.length);

        // Store feedback data
        this.currentFeedbackData = feedbackData;

        // Find the modal element
        const modalElement = document.getElementById('feedbackModal');
        console.log('🎯 Modal element found:', !!modalElement);

        if (!modalElement) {
            console.error('❌ Modal element not found after creation!');
            this.showSimpleFeedback(feedbackData);
            return;
        }

        // Check Bootstrap availability
        console.log('🔍 Bootstrap check:', typeof bootstrap);
        console.log('🔍 Window.bootstrap:', typeof window.bootstrap);

        // Try multiple ways to show the modal
        try {
            // Method 1: Try Bootstrap 5
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                console.log('✅ Using Bootstrap 5 Modal');
                const modal = new bootstrap.Modal(modalElement, {
                    backdrop: 'static',
                    keyboard: true,
                    focus: true
                });
                modal.show();
                console.log('✅ Bootstrap modal show() called');

            } else if (typeof window.bootstrap !== 'undefined' && window.bootstrap.Modal) {
                console.log('✅ Using window.bootstrap Modal');
                const modal = new window.bootstrap.Modal(modalElement);
                modal.show();

            } else if (typeof $ !== 'undefined' && $.fn.modal) {
                console.log('✅ Using jQuery Bootstrap Modal');
                $(modalElement).modal('show');

            } else {
                console.log('⚠️ No Bootstrap found, using manual display');
                this.showModalManually(modalElement);
            }

        } catch (error) {
            console.error('❌ Error showing modal:', error);
            this.showModalManually(modalElement);
        }
    }

    // Add these helper methods
    showModalManually(modalElement) {
        console.log('🔧 Showing modal manually...');

        // Create backdrop
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        backdrop.style.zIndex = '9998';
        document.body.appendChild(backdrop);

        // Show modal
        modalElement.style.display = 'block';
        modalElement.style.zIndex = '9999';
        modalElement.classList.add('show');
        modalElement.setAttribute('aria-hidden', 'false');

        // Add body class
        document.body.classList.add('modal-open');

        console.log('✅ Manual modal display complete');
    }

    closeFeedbackModal() {
        console.log('🗑️ Closing feedback modal...');

        const modal = document.getElementById('feedbackModal');
        const backdrop = document.querySelector('.modal-backdrop');

        if (modal) modal.remove();
        if (backdrop) backdrop.remove();

        document.body.classList.remove('modal-open');
        delete this.currentFeedbackData;

        console.log('✅ Modal closed');
    }

    showSimpleFeedback(feedbackData) {
        console.log('🔄 Falling back to simple feedback...');

        if (feedbackData.notRecommendedSelected.length > 0) {
            setTimeout(() => {
                const message = `You selected ${feedbackData.notRecommendedSelected.length} parcels we didn't recommend.\n\nWhat made these appealing?\n\n1. Owner relationships\n2. Local knowledge\n3. Strategic location\n4. Market timing\n\nClick 1-4 or Cancel to skip:`;

                const response = prompt(message);
                if (response && ['1','2','3','4'].includes(response)) {
                    const reasons = ['owner_relationships', 'local_knowledge', 'strategic_location', 'market_timing'];
                    this.recordBatchFeedback('selected_non_recommended', reasons[parseInt(response)-1]);
                    alert('Thanks! Your feedback will improve future recommendations. 🚀');
                }
            }, 1000);
        }
    }

    recordBatchFeedbackAndClose(feedbackType, reason) {
        console.log(`📝 Recording feedback: ${feedbackType} - ${reason}`);

        // Close modal
        this.closeFeedbackModal();

        // Record feedback
        this.recordBatchFeedback(feedbackType, reason);

        // Show thank you
        setTimeout(() => {
            alert('Thanks! Your feedback will improve future recommendations. 🚀');
        }, 500);
    }

    async recordBatchFeedback(feedbackType, reason) {
        try {
            console.log(`📝 Recording batch feedback: ${feedbackType} - ${reason}`);

            // Close the modal
            const modal = document.querySelector('.modal.show');
            if (modal) {
                const bootstrapModal = bootstrap.Modal.getInstance(modal);
                bootstrapModal.hide();
            }

            // Send feedback
            const response = await fetch('/api/record-batch-feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    feedback_type: feedbackType,
                    reason: reason,
                    feedback_data: this.currentFeedbackData,
                    project_type: this.currentAnalysis?.project_type || 'solar',
                    location: this.currentAnalysis?.location || 'Unknown'
                })
            });

            if (response.ok) {
                this.showSuccessMessage('Thanks! Your feedback will improve future recommendations.');
            }

        } catch (error) {
            console.error('❌ Error recording batch feedback:', error);
        }
    }

    // Add these methods to your ProjectWorkflow class:
    showScoringMethodology() {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">🧠 How ML Scores Are Calculated</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>🤖 ML Score (60% weight)</h6>
                                <p>AI model considers:</p>
                                <ul>
                                    <li><strong>Parcel Size:</strong> Larger parcels (50+ acres) score higher</li>
                                    <li><strong>Land Value:</strong> Lower cost land scores higher</li>
                                    <li><strong>Owner Type:</strong> Government/corporate owners preferred</li>
                                    <li><strong>Adjacent Land:</strong> Expansion potential bonus</li>
                                    <li><strong>Historical Patterns:</strong> Learns from successful outreach</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>📊 Traditional Score (40% weight)</h6>
                                <p>Engineering analysis based on:</p>
                                <ul>
                                    <li><strong>Slope Analysis:</strong> <15° preferred for development</li>
                                    <li><strong>Transmission Distance:</strong> <1 mile to existing lines</li>
                                    <li><strong>Voltage Requirements:</strong> 100-350kV preferred</li>
                                    <li><strong>Environmental Factors:</strong> Flood zones, wetlands</li>
                                </ul>
                            </div>
                        </div>
                        <hr>
                        <div class="alert alert-info">
                            <strong>🎯 Combined Score:</strong> Uses weighted average of ML (60%) + Traditional (40%) scores.
                            Parcels scoring >65 are recommended for outreach.
                        </div>
                        <div class="alert alert-warning">
                            <strong>📈 Continuous Learning:</strong> The ML model improves based on which parcels you select for outreach and rejection reasons.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();

        // Clean up when modal is hidden
        modal.addEventListener('hidden.bs.modal', () => {
            document.body.removeChild(modal);
        });
    }

    async recordRejectionReason(parcelId, reason) {
        try {
            console.log(`📝 Recording rejection: ${parcelId} - ${reason}`);

            // Find the parcel data
            const parcel = this.currentMLResults.parcels.find(p => p.parcel_id === parcelId);
            if (!parcel) {
                console.error('Parcel not found for rejection tracking');
                return;
            }

            // Send rejection feedback to backend
            const response = await fetch('/api/record-rejection', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    parcel_id: parcelId,
                    rejection_reason: reason,
                    parcel_data: parcel,
                    project_type: this.currentAnalysis?.project_type || 'solar',
                    location: this.currentAnalysis?.location || 'Unknown'
                })
            });

            if (response.ok) {
                const result = await response.json();
                console.log('✅ Rejection recorded:', result);

                // Show success feedback
                this.showSuccessMessage(`Feedback recorded: ${reason.replace('_', ' ')}`);

                // Optionally hide the rejected row or mark it as processed
                const row = document.querySelector(`tr[data-parcel-index]`);
                if (row) {
                    row.style.opacity = '0.6';
                    row.querySelector('.dropdown button').textContent = 'Feedback Sent';
                    row.querySelector('.dropdown button').disabled = true;
                }
            } else {
                throw new Error('Failed to record rejection');
            }

        } catch (error) {
            console.error('❌ Error recording rejection:', error);
            alert(`Failed to record feedback: ${error.message}`);
        }
    }

    async testOutreachTracking() {
        try {
            console.log('🧪 Testing outreach tracking...');

            const response = await fetch('/api/test-outreach-tracking', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    test_parcels: [
                        {
                            parcel_id: 'TEST_FRONTEND_001',
                            owner: 'Frontend Test Owner',
                            acreage_calc: 45.0,
                            ml_analysis: { predicted_score: 78.5 },
                            suitability_analysis: { overall_score: 82.0 }
                        }
                    ]
                })
            });

            const result = await response.json();
            console.log('🧪 Tracking test result:', result);

            if (result.success) {
                alert(`✅ BigQuery tracking test successful!\nTracked: ${result.message}\nRecent history: ${result.recent_history_count} events`);
            } else {
                alert(`❌ BigQuery tracking test failed: ${result.error}`);
            }

        } catch (error) {
            console.error('❌ Tracking test error:', error);
            alert(`❌ Tracking test failed: ${error.message}`);
        }
    }

    attachMLCheckboxListeners() {
        // Update selection count when individual checkboxes change
        const checkboxes = document.querySelectorAll('.ml-parcel-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                this.updateSelectionCount();
            });
        });
    }

    toggleAllParcels(checked) {
        const checkboxes = document.querySelectorAll('.ml-parcel-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = checked;
        });

        // Update both header checkboxes
        document.getElementById('select-all-ml-parcels').checked = checked;
        document.getElementById('header-select-all').checked = checked;

        this.updateSelectionCount();
    }

    // Add feedback collection method
    async rateParcels(parcelId) {
        const parcel = this.currentMLResults.parcels.find(p => p.parcel_id === parcelId);
        if (!parcel) return;

        const rating = prompt(`Rate this parcel (1-100):\n\nParcel: ${parcel.parcel_id}\nOwner: ${parcel.owner}\nML Score: ${parcel.suitability_analysis.ml_score}\n\nYour rating (1-100):`);

        if (rating && !isNaN(rating) && rating >= 1 && rating <= 100) {
            try {
                const response = await fetch('/api/parcel/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        parcel_id: parcelId,
                        user_rating: parseInt(rating),
                        feedback_type: rating > 70 ? 'interested' : 'not_interested',
                        notes: `User rating: ${rating}/100`
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert(`✅ Feedback saved! This will help improve future recommendations.`);
                } else {
                    alert(`❌ Failed to save feedback: ${result.error}`);
                }
            } catch (error) {
                alert(`❌ Error saving feedback: ${error.message}`);
            }
        }
    }

    exportSuitableParcelsList() {
        if (!this.currentSuitabilityResults) {
            alert('No suitability results to export');
            return;
        }

        const suitableParcels = this.currentSuitabilityResults.parcels.filter(p => p.suitability_analysis.is_suitable);

        if (suitableParcels.length === 0) {
            alert('No suitable parcels found to export');
            return;
        }

        // Create CSV content
        const headers = ['Parcel ID', 'Owner', 'Acres', 'Overall Score', 'Slope (degrees)', 'Transmission Distance (mi)', 'Transmission Voltage (kV)', 'Notes'];
        let csvContent = headers.join(',') + '\n';

        suitableParcels.forEach(parcel => {
            const analysis = parcel.suitability_analysis;
            const row = [
                parcel.parcel_id,
                `"${parcel.owner || 'Unknown'}"`,
                parseFloat(parcel.acreage || parcel.acres || 0).toFixed(1),
                analysis.overall_score,
                analysis.slope_degrees,
                analysis.transmission_distance,
                analysis.transmission_voltage,
                `"${analysis.analysis_notes}"`
            ];
            csvContent += row.join(',') + '\n';
        });

        // Download CSV
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `suitable_parcels_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }

    exportFullSuitabilityReport() {
        if (!this.currentSuitabilityResults) {
            alert('No suitability results to export');
            return;
        }

        // Create comprehensive CSV content
        const headers = [
            'Parcel ID', 'Owner', 'Acres', 'County', 'State', 'Overall Suitability', 'Overall Score',
            'Slope Score', 'Slope (degrees)', 'Slope Suitable', 'Transmission Score',
            'Transmission Distance (mi)', 'Transmission Voltage (kV)', 'Transmission Suitable',
            'Analysis Notes'
        ];
        let csvContent = headers.join(',') + '\n';

        this.currentSuitabilityResults.parcels.forEach(parcel => {
            const analysis = parcel.suitability_analysis;
            const row = [
                parcel.parcel_id,
                `"${parcel.owner || 'Unknown'}"`,
                parseFloat(parcel.acreage || parcel.acres || 0).toFixed(1),
                parcel.county || 'Unknown',
                parcel.state_abbr || 'Unknown',
                analysis.is_suitable ? 'Suitable' : 'Not Suitable',
                analysis.overall_score,
                analysis.slope_score,
                analysis.slope_degrees,
                analysis.slope_suitable ? 'Yes' : 'No',
                analysis.transmission_score,
                analysis.transmission_distance,
                analysis.transmission_voltage,
                analysis.transmission_suitable ? 'Yes' : 'No',
                `"${analysis.analysis_notes}"`
            ];
            csvContent += row.join(',') + '\n';
        });

        // Download CSV
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `parcel_suitability_report_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }

    showErrorMessage(message) {
        const container = document.getElementById('workflow-container');
        const errorHtml = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <h6>Analysis Error</h6>
                <p>${message}</p>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        container.insertAdjacentHTML('afterbegin', errorHtml);
    }

    exportReport() {
        if (!this.currentAnalysis) {
            alert('No analysis data to export');
            return;
        }

        let exportText = `RENEWABLE ENERGY PROJECT ANALYSIS REPORT\n`;
        exportText += `Generated: ${new Date().toLocaleDateString()}\n\n`;
        exportText += `Project: ${this.currentAnalysis.project_type.toUpperCase()} PROJECT\n`;
        exportText += `Location: ${this.currentAnalysis.location}\n`;
        exportText += `Analysis Level: ${this.currentAnalysis.analysis_level.toUpperCase()}\n\n`;

        if (this.currentAnalysis.overall_assessment) {
            exportText += `OVERALL ASSESSMENT\n`;
            exportText += `Viability Score: ${this.currentAnalysis.overall_assessment.viability_score}/10\n`;
            exportText += `Confidence: ${this.currentAnalysis.overall_assessment.confidence_level}\n`;
            exportText += `Recommendation: ${this.currentAnalysis.overall_assessment.key_recommendation}\n\n`;
        }

        const blob = new Blob([exportText], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `renewable_energy_analysis_${this.currentAnalysis.location.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }

    generateSiteReport(searchId) {
        alert('Site report generation will be implemented in the future. This will create comprehensive reports combining parcel data with renewable energy feasibility analysis.');
    }
}

// Initialize workflow
const workflow = new ProjectWorkflow();
document.addEventListener('DOMContentLoaded', () => workflow.initialize());

// Utility functions
function showLoading() {
    const loadingEl = document.getElementById('loading');
    if (loadingEl) {
        loadingEl.style.display = 'block';
    }
}

function hideLoading() {
    const loadingEl = document.getElementById('loading');
    if (loadingEl) {
        loadingEl.style.display = 'none';
    }
}

function updateVariable(name, value) {
    currentVariables[name] = value;
}

console.log('Optimized workflow with preview/download functionality loaded successfully!');
</script>
<script>
// Debug the analyze button
function debugAnalyzeButton() {
    console.log('🔍 DEBUGGING ANALYZE BUTTON');

    // Check if button exists
    const button = document.getElementById('analyze-suitability-btn');
    console.log('Button found:', !!button);

    if (button) {
        console.log('Button text:', button.textContent);
        console.log('Button disabled:', button.disabled);
        console.log('Button onclick:', button.onclick);
        console.log('Button event listeners:', getEventListeners ? getEventListeners(button) : 'Cannot check listeners');
    }

    // Check if workflow object exists
    console.log('Workflow object exists:', typeof workflow);
    console.log('Workflow methods available:', workflow ? Object.getOwnPropertyNames(Object.getPrototypeOf(workflow)) : 'No workflow');

    // Check if the method exists
    if (workflow && workflow.analyzeParcelSuitability) {
        console.log('analyzeParcelSuitability method exists:', typeof workflow.analyzeParcelSuitability);
    }

    // Check current parcel results
    console.log('Current parcel results available:', !!workflow?.currentParcelResults);
    console.log('Parcel data length:', workflow?.currentParcelResults?.parcel_data?.length || 0);
}

// Auto-run debug after page loads
setTimeout(debugAnalyzeButton, 3000);

// Add manual debug button
function addDebugButton() {
    const debugBtn = document.createElement('button');
    debugBtn.textContent = '🔍 Debug Button';
    debugBtn.style.cssText = 'position: fixed; top: 10px; right: 10px; z-index: 9999; background: red; color: white; border: none; padding: 5px 10px;';
    debugBtn.onclick = debugAnalyzeButton;
    document.body.appendChild(debugBtn);
}

setTimeout(addDebugButton, 1000);
</script>
</body>
</html>