<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BCF.ai - Renewable Energy Project Analyzer</title>

    <!-- User Info Display -->
    <div class="user-info" style="position: absolute; top: 10px; right: 20px; z-index: 1000;">
        <span>Welcome, {{ current_user }}!</span>
        <a href="/logout" class="btn btn-sm btn-outline-secondary ms-2">Logout</a>
    </div>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .analysis-section { margin: 20px 0; }
        .variable-card { margin: 10px 0; }
        .loading { display: none; }
        .results { margin-top: 20px; }

        /* Enhanced Workflow CSS */
        .workflow-step {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn-option {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .btn-option:hover {
            border-color: #0d6efd;
            background: #f8f9fa;
        }

        .btn-option.selected {
            border-color: #0d6efd;
            background: #0d6efd;
            color: white;
        }

        .tier-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .tier-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .tier-card:hover {
            border-color: #0d6efd;
        }

        .tier-card.selected {
            border-color: #0d6efd;
            background: #f8f9fa;
        }

        .criteria-selection {
            display: grid;
            gap: 10px;
            margin-bottom: 20px;
        }

        .criteria-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .criteria-card:hover {
            border-color: #198754;
        }

        .criteria-card.selected {
            border-color: #198754;
            background: #f8fff8;
        }

        .selection-indicator {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .criteria-card.selected .selection-indicator {
            background: #198754;
            color: white;
        }

        .step-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .criteria-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .criteria-tag {
            background: #0d6efd;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 14px;
        }

        /* County loading styles */
        #county-loading {
            display: flex;
            align-items: center;
        }

        .form-label {
            font-weight: 600;
            color: #495057;
        }

        .form-select:disabled,
        .form-control:disabled {
            background-color: #f8f9fa;
            border-color: #dee2e6;
            opacity: 0.65;
        }

        /* Location selection improvements */
        .location-selection .mb-3 {
            position: relative;
        }

        .location-selection .form-select,
        .location-selection .form-control {
            transition: all 0.3s ease;
        }

        .location-selection .form-select:focus,
        .location-selection .form-control:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }

        /* File Download/Preview Styling */
        .file-actions {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .file-actions .btn {
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .file-actions .btn i {
            font-size: 1.2em;
        }

        .file-actions .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .file-type-label {
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-group .dropdown-menu {
            min-width: 200px;
        }

        .btn-group .dropdown-menu .dropdown-item {
            padding: 10px 16px;
            transition: all 0.2s ease;
        }

        .btn-group .dropdown-menu .dropdown-item:hover {
            background-color: #f8f9fa;
            transform: translateX(4px);
        }

        /* Analysis Results Container */
        .suitability-results-container {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Summary Statistics */
        .suitability-summary h3 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 24px;
            font-weight: 600;
            text-align: center;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #3498db;
        }

        .stat-value {
            display: block;
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            display: block;
            font-size: 14px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Button Styles */
        .analyze-suitability-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71) !important;
            color: white !important;
            border: none !important;
            padding: 12px 24px !important;
            border-radius: 6px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            font-size: 16px !important;
            width: 100% !important;
        }

        .analyze-suitability-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #219a52, #27ae60) !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3) !important;
        }

        .analyze-suitability-btn:disabled {
            background: #bdc3c7 !important;
            cursor: not-allowed !important;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Progress Indicator */
        .analysis-progress {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            text-align: center;
            z-index: 1000;
        }

        .analysis-progress::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: -1;
        }

        .progress-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .analysis-progress p {
            margin: 0;
            color: #2c3e50;
            font-weight: 500;
        }

        /* Notification Styles */
        .notification {
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* NEW COUNTY CARD STYLES */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
        }

        /* Sticky Header with Controls */
        .controls-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .controls-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr auto auto;
            gap: 15px;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-label {
            color: white;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-select {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-select:focus {
            outline: none;
            background: white;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
        }

        .action-btn {
            padding: 12px 24px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .action-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .action-btn.research {
            background: #2196F3;
        }

        .action-btn.research:hover {
            background: #1976D2;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }

        .action-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Main Content Area */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .page-title {
            color: #2c3e50;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: #7f8c8d;
            font-size: 16px;
            margin-bottom: 30px;
        }

        /* Filter Controls */
        .filter-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-input {
            padding: 10px 15px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .filter-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-select {
            padding: 10px 15px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
        }

        /* County Cards - Compact Design */
        .county-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .county-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 1px solid #e0e6ed;
            cursor: pointer;
        }

        .county-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .county-card.selected {
            border-color: #0d6efd;
            border-width: 2px;
            background: linear-gradient(135deg, rgba(13, 110, 253, 0.05) 0%, rgba(13, 110, 253, 0.1) 100%);
        }

        .county-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .county-info {
            flex: 1;
        }

        .county-name {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .county-details {
            font-size: 12px;
            color: #7f8c8d;
            line-height: 1.4;
        }

        .county-score {
            text-align: center;
            min-width: 60px;
        }

        .score-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            color: white;
            margin-bottom: 4px;
        }

        .score-excellent { background: #27ae60; }
        .score-good { background: #3498db; }
        .score-fair { background: #f39c12; }
        .score-poor { background: #e74c3c; }

        .score-label {
            font-size: 10px;
            color: #7f8c8d;
            text-transform: uppercase;
        }

        /* Metrics Grid - Compact */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }

        .metric-item {
            text-align: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .metric-label {
            font-size: 10px;
            color: #7f8c8d;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
        }

        .metric-score {
            font-size: 12px;
            color: #7f8c8d;
        }

        /* Strengths and Status */
        .county-bottom {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px;
            align-items: start;
        }

        .strengths-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .strength-tag {
            background: #e8f5e8;
            color: #27ae60;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-column {
            text-align: right;
        }

        .development-potential {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .potential-high { color: #27ae60; }
        .potential-medium { color: #f39c12; }
        .potential-low { color: #e74c3c; }

        .past-activity {
            font-size: 11px;
            color: #7f8c8d;
        }

        .past-activity.has-activity {
            color: #27ae60;
            font-weight: 600;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .controls-container {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .county-grid {
                grid-template-columns: 1fr;
            }

            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .county-bottom {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .status-column {
                text-align: center;
                margin-top: 10px;
            }

            .tier-options {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .step-actions {
                flex-direction: column;
                gap: 10px;
            }

            .location-selection {
                padding: 0 10px;
            }

            .criteria-tags {
                justify-content: center;
            }

            .file-actions .row > div {
                margin-bottom: 10px;
            }

            .file-actions .btn {
                min-height: 45px;
                font-size: 0.9em;
            }

            .suitability-results-container {
                margin: 20px 10px;
                padding: 15px;
            }

            .summary-stats {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .stat-value {
                font-size: 24px;
            }
        }

        /* Scrollable Content */
        .scrollable-content {
            max-height: calc(100vh - 140px);
            overflow-y: auto;
            padding-right: 5px;
        }

        .scrollable-content::-webkit-scrollbar {
            width: 6px;
        }

        .scrollable-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .scrollable-content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .scrollable-content::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* Pagination */
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 30px 0;
        }

        .pagination-btn {
            padding: 8px 16px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #f8f9fa;
        }

        .pagination-btn.active {
            background: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Print Styles */
        @media print {
            .analysis-progress,
            .notification {
                display: none !important;
            }
        }

        /* Suitability Results Styling */
        .suitability-results-container {
            margin-top: 30px;
            animation: slideInUp 0.5s ease-out;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Summary Statistics Enhanced */
        .suitability-summary {
            margin-bottom: 30px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-item {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #0d6efd;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-value {
            display: block;
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .stat-label {
            display: block;
            font-size: 13px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
        }

        /* Table Enhancements */
        #suitability-table {
            font-size: 0.9rem;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #suitability-table thead th {
            background: linear-gradient(135deg, #343a40 0%, #495057 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.8rem;
            padding: 15px 10px;
            border: none;
        }

        #suitability-table tbody tr {
            transition: all 0.2s ease;
        }

        #suitability-table tbody tr:hover {
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .table-success {
            background-color: rgba(25, 135, 84, 0.1) !important;
            border-left: 4px solid #198754;
        }

        .table-warning {
            background-color: rgba(255, 193, 7, 0.1) !important;
            border-left: 4px solid #ffc107;
        }

        /* Badge Styling */
        .badge {
            font-size: 0.8rem;
            padding: 6px 10px;
            border-radius: 15px;
            font-weight: 600;
        }

        /* Filter Controls */
        .form-range {
            background: linear-gradient(to right, #e9ecef 0%, #0d6efd 0%);
        }

        .form-range::-webkit-slider-thumb {
            background: #0d6efd;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .form-range::-moz-range-thumb {
            background: #0d6efd;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Progress Indicator Enhanced */
        .analysis-progress {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
            z-index: 1000;
            min-width: 300px;
        }

        .analysis-progress::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: -1;
            backdrop-filter: blur(2px);
        }

        .progress-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #0d6efd;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .analysis-progress p {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-weight: 600;
            font-size: 18px;
        }

        .analysis-progress small {
            color: #6c757d;
            font-size: 14px;
        }

        /* Modal Enhancements */
        .modal-dialog {
            max-width: 800px;
        }

        .modal-header {
            background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
            color: white;
            border-radius: 0.375rem 0.375rem 0 0;
        }

        .modal-title {
            font-weight: 600;
        }

        .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }

        /* Button Improvements */
        .btn {
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-sm {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }

        /* Alert Enhancements */
        .alert {
            border-radius: 10px;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .alert-success {
            background: linear-gradient(135deg, #d1edff 0%, #e8f7e8 100%);
            color: #0f5132;
            border-left: 4px solid #198754;
        }

        .alert-danger {
            background: linear-gradient(135deg, #f8d7da 0%, #ffeaa7 100%);
            color: #842029;
            border-left: 4px solid #dc3545;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stat-value {
                font-size: 24px;
            }

            #suitability-table {
                font-size: 0.8rem;
            }

            #suitability-table th,
            #suitability-table td {
                padding: 8px 5px;
            }

            .analysis-progress {
                padding: 30px 20px;
                min-width: 280px;
            }

            .modal-dialog {
                margin: 10px;
                max-width: none;
            }
        }

        @media (max-width: 576px) {
            .summary-stats {
                grid-template-columns: 1fr;
            }

            .stat-item {
                padding: 15px;
            }

            .table-responsive {
                border-radius: 8px;
            }

            #suitability-table th:nth-child(n+6),
            #suitability-table td:nth-child(n+6) {
                display: none;
            }
        }

        /* Loading States */
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Accessibility Improvements */
        .badge:focus,
        .btn:focus,
        .form-select:focus,
        .form-range:focus {
            outline: 2px solid #0d6efd;
            outline-offset: 2px;
        }

        /* Print Styles */
        @media print {
            .analysis-progress,
            .btn,
            .modal {
                display: none !important;
            }

            .table {
                font-size: 10px;
            }

            .stat-item {
                break-inside: avoid;
            }
        }

        /* BCF.ai Branding */
        .text-gradient {
            background: linear-gradient(45deg, #007bff, #28a745);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero-logo {
            animation: fadeInUp 1s ease-out;
        }

        .feature-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid #e0e0e0;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .feature-icon {
            font-size: 2.5rem;
        }

        .county-ranking-card {
            transition: all 0.3s ease;
        }

        .county-ranking-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .ranking-badge {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .ranking-1 { background: linear-gradient(45deg, #FFD700, #FFA500); color: white; }
        .ranking-2 { background: linear-gradient(45deg, #C0C0C0, #A0A0A0); color: white; }
        .ranking-3 { background: linear-gradient(45deg, #CD7F32, #B8860B); color: white; }
        .ranking-other { background: linear-gradient(45deg, #6c757d, #495057); color: white; }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* County List Styling */
        .county-row {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .county-row:hover {
            background-color: rgba(0, 123, 255, 0.1) !important;
        }

        .county-row.table-primary {
            background-color: rgba(0, 123, 255, 0.2) !important;
            border-left: 4px solid #007bff;
        }

        .select-county-btn {
            transition: all 0.2s ease;
        }

        .select-county-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Activity badges */
        .badge {
            font-size: 0.75rem;
        }

        /* Ranking numbers */
        .table td:first-child {
            font-weight: bold;
            text-align: center;
        }

        /* Enhanced table styling */
        .table-responsive {
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .table thead th {
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
        }

        .research-criteria-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .research-criteria-card {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .research-criteria-card:hover {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }

        .research-criteria-card input:checked + label {
            color: #0d6efd;
        }

        .bg-light-success {
            background-color: #d1edff !important;
        }

        .card.border-success {
            border-color: #198754 !important;
        }

        .card-header[style*="cursor: pointer"]:hover {
            background-color: #c3e6cb !important;
        }

        #past-data-chevron {
            transition: transform 0.3s ease;
        }

        /* Suitability Analysis Enhancements */
        .table-excellent {
            background-color: rgba(25, 135, 84, 0.1) !important;
            border-left: 4px solid #198754;
        }

        .table-good {
            background-color: rgba(13, 110, 253, 0.1) !important;
            border-left: 4px solid #0d6efd;
        }

        .table-fair {
            background-color: rgba(255, 193, 7, 0.1) !important;
            border-left: 4px solid #ffc107;
        }

        .table-poor {
            background-color: rgba(220, 53, 69, 0.1) !important;
            border-left: 4px solid #dc3545;
        }

        .hidden {
            display: none !important;
        }

        /* Selection controls styling */
        #selection-controls {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #selection-controls h6 {
            color: #495057;
            font-weight: 600;
        }

        #selection-controls .btn-group .btn {
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        #selection-controls .btn-group .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        /* Checkbox styling */
        .parcel-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .parcel-checkbox:checked {
            background-color: #198754;
            border-color: #198754;
        }

        .parcel-checkbox:hover {
            transform: scale(1.1);
        }

        /* Select-all checkbox styling */
        #select-all-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        #select-all-checkbox:indeterminate {
            background-color: #ffc107;
            border-color: #ffc107;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3e%3cpath fill='none' stroke='%23fff' stroke-linecap='round' stroke-linejoin='round' stroke-width='3' d='M6 10h8'/%3e%3c/svg%3e");
        }

        /* Enhanced table row styling for selection */
        .table tbody tr {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .table tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.05);
            transform: translateX(2px);
            box-shadow: -3px 0 0 #007bff;
        }

        /* Selected row styling */
        .table tbody tr:has(.parcel-checkbox:checked) {
            background-color: rgba(25, 135, 84, 0.1);
            border-left: 4px solid #198754;
        }

        .table tbody tr:has(.parcel-checkbox:checked):hover {
            background-color: rgba(25, 135, 84, 0.15);
            box-shadow: -3px 0 0 #198754;
        }

        /* Selection summary styling */
        #selection-summary {
            padding: 15px;
            border-radius: 6px;
            background: white;
            border: 1px solid #e9ecef;
        }

        #selection-count {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        #selection-details {
            font-weight: 500;
        }

        /* Table footer enhancements */
        .card-footer {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-top: 1px solid #dee2e6;
        }

        #table-footer-summary {
            font-weight: 500;
        }

        /* Category badge enhancements */
        .table-excellent {
            background: linear-gradient(135deg, rgba(25, 135, 84, 0.08) 0%, rgba(25, 135, 84, 0.12) 100%);
            border-left: 4px solid #198754;
        }

        .table-good {
            background: linear-gradient(135deg, rgba(13, 110, 253, 0.08) 0%, rgba(13, 110, 253, 0.12) 100%);
            border-left: 4px solid #0d6efd;
        }

        .table-fair {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.08) 0%, rgba(255, 193, 7, 0.12) 100%);
            border-left: 4px solid #ffc107;
        }

        .table-poor {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.08) 0%, rgba(220, 53, 69, 0.12) 100%);
            border-left: 4px solid #dc3545;
        }

        /* Export button enhancements */
        #exportToCrmBtn {
            transition: all 0.3s ease;
            min-width: 200px;
        }

        #exportToCrmBtn:not(:disabled):hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        #exportToCrmBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Selection controls button animations */
        .btn-outline-success:hover {
            background: linear-gradient(135deg, #198754 0%, #20c997 100%);
            border-color: #198754;
            transform: translateY(-1px);
        }

        .btn-outline-primary:hover {
            background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);
            border-color: #0d6efd;
            transform: translateY(-1px);
        }

        .btn-outline-secondary:hover {
            background: linear-gradient(135deg, #6c757d 0%, #adb5bd 100%);
            border-color: #6c757d;
            transform: translateY(-1px);
        }

        .btn-outline-danger:hover {
            background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
            border-color: #dc3545;
            transform: translateY(-1px);
        }

        /* Modal enhancements for selection statistics */
        .modal-content {
            border: none;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            border-radius: 12px 12px 0 0;
            background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);
            color: white;
        }

        /* Responsive design for selection controls */
        @media (max-width: 768px) {
            #selection-controls .row {
                flex-direction: column;
                gap: 15px;
            }

            #selection-controls .btn-group {
                width: 100%;
            }

            #selection-controls .btn-group .btn {
                flex: 1;
                font-size: 0.8rem;
                padding: 8px 12px;
            }

            #selection-summary {
                text-align: center;
                margin-top: 15px;
            }

            #exportToCrmBtn {
                width: 100%;
                margin-top: 10px;
                margin-left: 0 !important;
            }
        }

        /* Accessibility improvements */
        .parcel-checkbox:focus,
        #select-all-checkbox:focus {
            outline: 2px solid #0d6efd;
            outline-offset: 2px;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }

        /* Loading state for export button */
        #exportToCrmBtn .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }

        /* Selection controls fade-in animation */
        #selection-controls {
            animation: slideInDown 0.5s ease-out;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Table row click interaction */
        .table tbody tr {
            user-select: none;
        }

        .table tbody tr:active {
            background-color: rgba(0, 123, 255, 0.1);
            transform: scale(0.995);
        }

        /* Disabled state styles */
        .analysis-completed .btn,
        .analysis-completed input,
        .analysis-completed select,
        .analysis-completed .county-row {
            opacity: 0.5 !important;
            pointer-events: none !important;
            cursor: not-allowed !important;
        }

        .analysis-completed-overlay {
            backdrop-filter: blur(1px);
        }

        /* Keep the analysis completed message above overlay */
        #analysis-completed-message {
            z-index: 10000 !important;
        }

        /* Ensure modal stays above everything */
        .modal {
            z-index: 10001 !important;
        }

        .modal-backdrop {
            z-index: 10000 !important;
        }

        /* Fix modal overflow issues */
        .existing-files-list {
            max-height: 60vh;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .file-name {
            word-break: break-word;
            line-height: 1.2;
        }

        .modal-xl {
            max-width: 95vw;
        }

        .modal-body {
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Ensure buttons don't overflow */
        .btn-group-vertical .btn {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Fix table responsiveness in preview */
        .table-responsive {
            max-height: 50vh;
            overflow: auto;
        }

        /* Better spacing for file items */
        .file-item .card-body {
            padding: 15px;
        }

        .file-item .row {
            align-items: center;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .modal-xl {
                max-width: 98vw;
                margin: 10px;
            }

            .file-item .col-md-2 {
                margin-top: 10px;
                text-align: center !important;
            }

            .btn-group-vertical {
                width: 100%;
            }
        }

        /* Prevent text wrapping in preview table for better readability */
        .table-responsive .table th,
        .table-responsive .table td {
            white-space: nowrap;
            min-width: 100px;
        }

        /* Allow specific columns to wrap if needed */
        .table-responsive .table th:first-child,
        .table-responsive .table td:first-child {
            white-space: normal;
            min-width: 80px;
        }

        /* Make the table scroll horizontally instead of wrapping */
        .table-responsive {
            overflow-x: auto;
            max-height: 50vh;
            overflow-y: auto;
        }

        /* Better column sizing for preview */
        .table-responsive .table {
            min-width: 800px; /* Force horizontal scroll for many columns */
        }

        /* Transmission Distance Styling */
        .transmission-distance {
            font-weight: 600;
        }

        .transmission-distance .text-success {
            color: #198754 !important;
        }

        .transmission-distance .text-primary {
            color: #0d6efd !important;
        }

        .transmission-distance .text-warning {
            color: #ffc107 !important;
            color: #000 !important; /* Override for readability */
        }

        .transmission-distance .text-secondary {
            color: #6c757d !important;
        }

        /* Transmission Voltage Styling */
        .transmission-voltage {
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .voltage-high {
            background-color: #dc3545;
            color: white;
        }

        .voltage-medium {
            background-color: #fd7e14;
            color: white;
        }

        .voltage-low {
            background-color: #6f42c1;
            color: white;
        }

        .voltage-none {
            background-color: #e9ecef;
            color: #6c757d;
        }

        /* Enhanced Loading Modal for Analysis Steps */
        .analysis-steps {
            text-align: left;
            margin: 20px 0;
        }

        .analysis-steps .step {
            padding: 8px 0;
            color: #6c757d;
            transition: color 0.3s ease;
        }

        .analysis-steps .step.active {
            color: #0d6efd;
            font-weight: 600;
        }

        .analysis-steps .step.completed {
            color: #198754;
        }

        .analysis-steps .step.error {
            color: #dc3545;
        }

        /* Enhanced Error Handling */
        .error-details {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Transmission Statistics in Summary */
        .transmission-stats {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .transmission-stats h6 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .transmission-stats .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }

        .transmission-stats .stat-value {
            font-weight: bold;
            color: #2e7d32;
        }

        /* Table header improvements for transmission columns */
        .parcel-table thead th:nth-child(6)::after {
            content: " 🔌";
        }

        .parcel-table thead th:nth-child(7)::after {
            content: " ⚡";
        }

        /* Responsive improvements for transmission data */
        @media (max-width: 768px) {
            .transmission-voltage,
            .transmission-distance {
                font-size: 0.8em;
            }

            /* Hide less critical columns on mobile */
            .parcel-table th:nth-child(n+6),
            .parcel-table td:nth-child(n+6) {
                display: none;
            }

            /* Show only essential columns on mobile */
            .parcel-table th:nth-child(1),
            .parcel-table th:nth-child(2),
            .parcel-table th:nth-child(3),
            .parcel-table th:nth-child(4),
            .parcel-table th:nth-child(8),
            .parcel-table td:nth-child(1),
            .parcel-table td:nth-child(2),
            .parcel-table td:nth-child(3),
            .parcel-table td:nth-child(4),
            .parcel-table td:nth-child(8) {
                display: table-cell;
            }
        }

        /* Loading progress improvements */
        .progress-bar-striped.progress-bar-animated {
            background-image: linear-gradient(45deg, rgba(255,255,255,.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,.15) 50%, rgba(255,255,255,.15) 75%, transparent 75%, transparent);
            background-size: 1rem 1rem;
        }

        /* Notification enhancements */
        .notification-toast {
            max-width: 450px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .notification-toast .alert-success {
            background: linear-gradient(135deg, #d1edff 0%, #e8f7e8 100%);
            border-left: 4px solid #198754;
        }

        .notification-toast .alert-danger {
            background: linear-gradient(135deg, #f8d7da 0%, #ffeaa7 100%);
            border-left: 4px solid #dc3545;
        }

        /* Table improvements for transmission data */
        .parcel-table tbody tr:hover .transmission-distance,
        .parcel-table tbody tr:hover .transmission-voltage {
            transform: scale(1.05);
            transition: transform 0.2s ease;
        }

    </style>
    <style>
    /* Parcel Analysis Table Styles */
    .parcel-analysis-container {
        margin-top: 30px;
        animation: slideInUp 0.5s ease-out;
        pointer-events: auto !important; /* Ensure interactivity */
        opacity: 1 !important; /* Remove any opacity overlays */
    }

    .parcel-analysis-container * {
        pointer-events: auto !important; /* Ensure all child elements are interactive */
    }

    /* Remove any disabled/grey overlay states */
    .parcel-analysis-container:not(.disabled) {
        filter: none !important;
        opacity: 1 !important;
    }

    .analysis-summary {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        pointer-events: auto !important;
    }

    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .summary-stat {
        text-align: center;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .stat-number {
        display: block;
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .stat-label {
        font-size: 12px;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-excellent .stat-number { color: #198754; }
    .stat-good .stat-number { color: #0d6efd; }
    .stat-fair .stat-number { color: #ffc107; }
    .stat-poor .stat-number { color: #dc3545; }
    .stat-success .stat-number { color: #198754; }

    /* Selection Controls */
    .selection-controls {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        pointer-events: auto !important;
    }

    .selection-controls h6 {
        color: #495057;
        font-weight: 600;
        margin-bottom: 15px;
    }

    .selection-controls .btn {
        pointer-events: auto !important;
        opacity: 1 !important;
    }

    .parcel-table-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        pointer-events: auto !important;
    }

    .parcel-table {
        margin-bottom: 0;
        pointer-events: auto !important;
    }

    .parcel-table thead th {
        background: linear-gradient(135deg, #343a40 0%, #495057 100%);
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.8rem;
        padding: 15px 10px;
        border: none;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .parcel-table tbody tr {
        transition: all 0.2s ease;
        cursor: pointer;
        pointer-events: auto !important;
        opacity: 1 !important;
    }

    .parcel-table tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05) !important;
        transform: translateX(2px);
    }

    .parcel-table tbody tr.selected {
        background-color: rgba(25, 135, 84, 0.1) !important;
        border-left: 4px solid #198754;
    }

    .parcel-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer !important;
        transition: all 0.2s ease;
        pointer-events: auto !important;
        opacity: 1 !important;
    }

    .parcel-checkbox:checked {
        background-color: #198754;
        border-color: #198754;
    }

    .category-excellent { background-color: rgba(25, 135, 84, 0.1); }
    .category-good { background-color: rgba(13, 110, 253, 0.1); }
    .category-fair { background-color: rgba(255, 193, 7, 0.1); }
    .category-poor { background-color: rgba(220, 53, 69, 0.1); }

    .score-badge {
        font-weight: bold;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.85rem;
    }

    .score-excellent { background: #198754; color: white; }
    .score-good { background: #0d6efd; color: white; }
    .score-fair { background: #ffc107; color: black; }
    .score-poor { background: #dc3545; color: white; }

    .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .outreach-btn {
        background: linear-gradient(135deg, #198754, #20c997);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 200px;
    }

    .outreach-btn:hover:not(:disabled) {
        background: linear-gradient(135deg, #157347, #0d9488);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(25, 135, 84, 0.3);
    }

    .outreach-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .ai-analyze-btn {
        background: linear-gradient(135deg, #6f42c1, #8b5cf6);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .ai-analyze-btn:hover {
        background: linear-gradient(135deg, #5a32a3, #7c3aed);
        transform: translateY(-1px);
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
        .summary-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .selection-controls {
            padding: 15px;
        }

        .parcel-table th:nth-child(n+6),
        .parcel-table td:nth-child(n+6) {
            display: none;
        }

        .action-buttons {
            flex-direction: column;
        }

        .analysis-steps .step {
            padding: 8px 0;
            color: #6c757d;
            transition: color 0.3s ease;
        }

        .analysis-steps .step.active {
            color: #0d6efd;
            font-weight: 600;
        }

        .analysis-steps .step.completed {
            color: #198754;
        }

        .analysis-steps .step.error {
            color: #dc3545;
        }
    }
    </style>

</head>
<body>
    <!-- BCF.ai Landing Screen -->
    <div id="start-screen" class="workflow-step active">
        <div class="container-fluid">
            <div class="row justify-content-center">
                <div class="col-lg-8">

                    <!-- BCF.ai Header -->
                    <div class="text-center mb-5">
                        <div class="hero-logo mb-4">
                            <h1 class="display-4 fw-bold text-primary">
                                <span class="text-gradient">BCF.ai</span>
                            </h1>
                            <p class="lead text-muted">AI-Powered Renewable Energy Land Discovery</p>
                        </div>

                        <div class="hero-description">
                            <h2 class="h4 mb-3">Find the Best Land for Your Renewable Energy Projects</h2>
                            <p class="fs-5 text-secondary mb-4">
                                BCF.ai uses artificial intelligence to analyze markets, identify optimal locations,
                                and find landowners ready for renewable energy development.
                            </p>

                            <div class="row g-4 mb-5">
                                <div class="col-md-4">
                                    <div class="feature-card h-100 p-4 bg-light rounded-3">
                                        <div class="feature-icon mb-3">🤖</div>
                                        <h5>AI Market Analysis</h5>
                                        <p class="small text-muted">Smart county rankings based on renewable energy friendliness</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="feature-card h-100 p-4 bg-light rounded-3">
                                        <div class="feature-icon mb-3">🎯</div>
                                        <h5>Targeted Outreach</h5>
                                        <p class="small text-muted">Find and contact the right landowners with ML-enhanced scoring</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="feature-card h-100 p-4 bg-light rounded-3">
                                        <div class="feature-icon mb-3">📊</div>
                                        <h5>Outreach Integration</h5>
                                        <p class="small text-muted">Seamless workflow from analysis to outreach management</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- State Selection ONLY -->
                    <div class="state-selection-container">
                        <div class="card border-primary shadow-sm">
                            <div class="card-body p-5">
                                <div class="text-center mb-4">
                                    <h3 class="card-title mb-3">🗺️ Choose Your Target State</h3>
                                    <p class="text-muted">Select a state to begin AI-powered market analysis and county rankings</p>
                                </div>

                                <form id="state-selection-form">
                                    <div class="row justify-content-center">
                                        <div class="col-md-8">
                                            <div class="mb-4">
                                                <label for="target-state" class="form-label fw-bold">Target State</label>
                                                <select class="form-select form-select-lg" id="target-state" required>
                                                    <option value="">Select a state...</option>
                                                    <option value="AL">Alabama</option>
                                                    <option value="AZ">Arizona</option>
                                                    <option value="AR">Arkansas</option>
                                                    <option value="CA">California</option>
                                                    <option value="CO">Colorado</option>
                                                    <option value="FL">Florida</option>
                                                    <option value="GA">Georgia</option>
                                                    <option value="IL">Illinois</option>
                                                    <option value="IN">Indiana</option>
                                                    <option value="IA">Iowa</option>
                                                    <option value="KS">Kansas</option>
                                                    <option value="KY">Kentucky</option>
                                                    <option value="LA">Louisiana</option>
                                                    <option value="MI">Michigan</option>
                                                    <option value="MN">Minnesota</option>
                                                    <option value="MS">Mississippi</option>
                                                    <option value="MO">Missouri</option>
                                                    <option value="NE">Nebraska</option>
                                                    <option value="NV">Nevada</option>
                                                    <option value="NM">New Mexico</option>
                                                    <option value="NY">New York</option>
                                                    <option value="NC">North Carolina</option>
                                                    <option value="ND">North Dakota</option>
                                                    <option value="OH">Ohio</option>
                                                    <option value="OK">Oklahoma</option>
                                                    <option value="PA">Pennsylvania</option>
                                                    <option value="SC">South Carolina</option>
                                                    <option value="SD">South Dakota</option>
                                                    <option value="TN">Tennessee</option>
                                                    <option value="TX">Texas</option>
                                                    <option value="UT">Utah</option>
                                                    <option value="VA">Virginia</option>
                                                    <option value="WV">West Virginia</option>
                                                    <option value="WI">Wisconsin</option>
                                                    <option value="WY">Wyoming</option>
                                                </select>
                                            </div>

                                            <div class="mb-4">
                                                <label for="project-type-start" class="form-label fw-bold">Project Type</label>
                                                <select class="form-select form-select-lg" id="project-type-start" required>
                                                    <option value="">Select project type...</option>
                                                    <option value="solar">Solar Energy</option>
                                                    <option value="wind">Wind Energy</option>
                                                    <option value="battery">Battery Storage</option>
                                                    <option value="mixed">Mixed Renewable</option>
                                                </select>
                                            </div>

                                            <div class="text-center">
                                                <button type="submit" class="btn btn-primary btn-lg px-5" id="analyze-state-btn">
                                                    <span class="btn-text">🚀 Analyze State</span>
                                                    <span class="spinner-border spinner-border-sm d-none ms-2" role="status"></span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- County Rankings Screen -->
    <div id="county-rankings-screen" class="workflow-step" style="display: none;">
        <!-- Sticky Header with Controls -->
        <div class="controls-header">
            <div class="controls-container">
                <div class="control-group">
                    <label class="control-label">State</label>
                    <select class="control-select" id="selected-state-display" disabled>
                        <option>Loading...</option>
                    </select>
                </div>

                <div class="control-group">
                    <label class="control-label">Project Type</label>
                    <select class="control-select" id="selected-project-display" disabled>
                        <option>Loading...</option>
                    </select>
                </div>

                <button class="action-btn" id="find-parcels-btn" disabled onclick="window.bcf && window.bcf.proceedToParcelSearchFromHeader()">Find Parcels</button>
                <button class="action-btn research" id="research-areas-btn" disabled onclick="window.bcf && window.bcf.proceedToAreaResearchFromHeader()">Research Area</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <h1 class="page-title">
                <span id="state-name-display">State</span> County Rankings
            </h1>
            <p class="page-subtitle">AI-powered analysis of renewable energy development potential</p>

            <!-- Summary Statistics -->
            <div class="summary-stats">
                <div class="stat-item">
                    <span class="stat-value" id="total-counties">-</span>
                    <span class="stat-label">Total Counties</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value text-success" id="excellent-counties">-</span>
                    <span class="stat-label">Excellent (85+)</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value text-primary" id="good-counties">-</span>
                    <span class="stat-label">Good (70-84)</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value text-warning" id="fair-counties">-</span>
                    <span class="stat-label">Fair (55-69)</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value text-info" id="with-activity">-</span>
                    <span class="stat-label">With Past Activity</span>
                </div>
            </div>

            <!-- Filter Controls -->
            <div class="filter-controls">
                <input type="text" class="filter-input" id="county-search" placeholder="Search counties..." onkeyup="window.bcf && window.bcf.filterCounties()">
                <select class="filter-select" id="score-filter" onchange="window.bcf && window.bcf.filterCounties()">
                    <option value="">All Scores</option>
                    <option value="85">85+ (Excellent)</option>
                    <option value="70">70+ (Good+)</option>
                    <option value="55">55+ (Fair+)</option>
                </select>
                <select class="filter-select" id="activity-filter" onchange="window.bcf && window.bcf.filterCounties()">
                    <option value="">All Counties</option>
                    <option value="yes">Has Past Activity</option>
                    <option value="no">New Markets</option>
                </select>
                <select class="filter-select" id="counties-per-page" onchange="window.bcf && window.bcf.updatePagination()">
                    <option value="12">12 per page</option>
                    <option value="24" selected>24 per page</option>
                    <option value="48">48 per page</option>
                </select>
                <button class="btn btn-outline-secondary" onclick="window.bcf && window.bcf.clearFilters()">Clear Filters</button>
                <span style="color: #7f8c8d;">Showing <span id="visible-count">0</span> of <span id="total-count">0</span> counties</span>
            </div>

            <!-- Scrollable County List -->
            <div class="scrollable-content">
                <div class="county-grid" id="county-grid">
                    <!-- County cards will be populated here -->
                </div>
            </div>

            <!-- Pagination Controls -->
            <div class="pagination-controls" id="pagination-controls">
                <!-- Pagination will be generated here -->
            </div>

            <!-- County Selection -->
            <div class="card mt-4">
                <div class="card-body">
                    <h4 class="card-title mb-3">🎯 Select Target County</h4>
                    <div class="row align-items-end">
                        <div class="col-md-8">
                            <label for="target-county" class="form-label">Choose County for Detailed Analysis</label>
                            <select class="form-select" id="target-county">
                                <option value="">Select a county...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <div class="btn-group w-100" role="group">
                                <button type="button" class="btn btn-success" id="find-parcels-btn-alt" disabled>
                                    🎯 Find Parcels
                                </button>
                                <button type="button" class="btn btn-primary" id="research-areas-btn-alt" disabled>
                                    🔬 Research Areas
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
<script>
// BCF.AI WORKFLOW - COMPLETE ENHANCED VERSION WITH ALL FUNCTIONALITY

console.log('Script starting...');

// Declare bcf in global scope first
let bcf = null;

// Define global helper functions first
window.toggleSelectAll = function(isChecked) {
    if (!window.bcf) return;

    const checkboxes = document.querySelectorAll('input[data-parcel-index]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = isChecked;
        const index = parseInt(checkbox.dataset.parcelIndex);
        if (isChecked) {
            window.bcf.selectedParcels.add(index);
        } else {
            window.bcf.selectedParcels.delete(index);
        }
    });
    updateSelectionCount();
};

window.handleParcelCheckbox = function(index, isChecked) {
    if (!window.bcf) return;

    if (isChecked) {
        window.bcf.selectedParcels.add(index);
    } else {
        window.bcf.selectedParcels.delete(index);
    }
    updateSelectionCount();
};

function updateSelectionCount() {
    if (!window.bcf) return;

    const count = window.bcf.selectedParcels.size;
    const countElements = document.querySelectorAll('#selection-count, #outreach-count');
    countElements.forEach(el => el.textContent = count);

    const outreachBtn = document.getElementById('initiate-outreach-btn');
    if (outreachBtn) {
        outreachBtn.disabled = count === 0;
    }
}

try {
    console.log('Defining BCFWorkflow class...');

    class BCFWorkflow {
        constructor() {
            console.log('BCFWorkflow constructor called');
            this.currentState = null;
            this.currentProjectType = null;
            this.currentStateAnalysis = null;
            this.currentCountyActivity = {};
            this.currentPage = 1;
            this.countiesPerPage = 24;
            this.allCounties = [];
            this.filteredCounties = [];
            this.aiAnalysisCompleted = false;
            this.originalParcelData = null;
            this.currentAnalysis = null;
            this.enrichedParcelData = null;
            this.currentSuitabilityResults = null;
            this.selectedParcels = new Set();
            this.allParcels = [];

            // Prevent accidental page navigation during modal operations
            window.addEventListener('beforeunload', (e) => {
                if (this.isProcessingFileAnalysis) {
                    e.preventDefault();
                    e.returnValue = 'Analysis in progress. Are you sure you want to leave?';
                }
            });

            console.log('BCFWorkflow constructor completed');
        }

        // Add this method to your BCFWorkflow class
        async debugAIConnectivity() {
            try {
                console.log('🔍 Testing AI connectivity...');

                const response = await fetch('/api/test-ai-connectivity');
                const result = await response.json();

                console.log('🔍 AI Connectivity Test Results:');
                console.table(result.connectivity_test);

                if (!result.connectivity_test.anthropic_key_configured) {
                    console.error('❌ ANTHROPIC_API_KEY is not configured!');
                    alert('ANTHROPIC_API_KEY is not configured in your environment variables. Please add it to your .env file.');
                } else if (!result.connectivity_test.ai_service_functional) {
                    console.error('❌ AI Service is not functional:', result.connectivity_test.ai_service_error);
                    alert(`AI Service error: ${result.connectivity_test.ai_service_error}`);
                } else {
                    console.log('✅ AI service appears to be working correctly');
                }

                return result;

            } catch (error) {
                console.error('💥 AI connectivity test failed:', error);
                alert(`Connectivity test failed: ${error.message}`);
                return null;
            }
        }

        debugTransmissionData(parcels) {
            console.log('=== TRANSMISSION DATA DEBUG ===');
            if (parcels && parcels.length > 0) {
                const sampleParcel = parcels[0];
                console.log('Sample parcel transmission fields:');
                console.log('tx_distance_miles:', sampleParcel.tx_distance_miles);
                console.log('tx_nearest_distance_miles:', sampleParcel.tx_nearest_distance_miles);
                console.log('tx_voltage_kv:', sampleParcel.tx_voltage_kv);
                console.log('tx_max_voltage_kv:', sampleParcel.tx_max_voltage_kv);
                console.log('All available fields:', Object.keys(sampleParcel));
            }
            console.log('==============================');
        }

        // In your form submission or initial setup:
        startAnalysis() {
            const state = document.getElementById('state-select').value;
            const projectType = document.getElementById('project-type-select').value;

            // Validate inputs
            if (!state || !projectType) {
                alert('Please select both state and project type');
                return;
            }

            // Store immediately
            this.currentState = state;
            this.currentProjectType = projectType;

            console.log('Starting analysis with:', { state, projectType });

            // Proceed with analysis
            this.analyzeState(state, projectType);
        }

        proceedToAreaResearch(countyFips, countyName, activity) {
            console.log(`Proceeding to area research for ${countyName}`);

            // Show research options dialog
            this.showResearchOptionsDialog(countyFips, countyName, activity);
        }

        showResearchOptionsDialog(countyFips, countyName, activity) {
            const modalHtml = `
                <div class="modal fade" id="researchOptionsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Research Options: ${countyName} County</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-${activity.has_activity ? '6' : '12'}">
                                        <div class="card h-100 border-success">
                                            <div class="card-body text-center">
                                                <div class="mb-3">
                                                    <i class="fas fa-brain fa-3x text-success"></i>
                                                </div>
                                                <h5 class="card-title">AI Market Analysis</h5>
                                                <p class="card-text">Get AI-powered insights on market conditions, development potential, regulatory environment, and strategic recommendations for ${countyName} County.</p>
                                                <button class="btn btn-success" onclick="window.bcf.runAIMarketAnalysis('${countyFips}', '${countyName}'); bootstrap.Modal.getInstance(document.getElementById('researchOptionsModal')).hide();">
                                                    <i class="fas fa-chart-line me-2"></i>Analyze Market with AI
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    ${activity.has_activity ? `
                                        <div class="col-md-6">
                                            <div class="card h-100 border-warning">
                                                <div class="card-body text-center">
                                                    <div class="mb-3">
                                                        <i class="fas fa-folder-open fa-3x text-warning"></i>
                                                    </div>
                                                    <h5 class="card-title">Use Existing Data</h5>
                                                    <p class="card-text">This county has ${activity.folder_count} existing project files. Review and analyze previous parcel data to save time and costs.</p>
                                                    <button class="btn btn-warning" onclick="window.bcf.showExistingDataFiles('${countyFips}', '${countyName}'); bootstrap.Modal.getInstance(document.getElementById('researchOptionsModal')).hide();">
                                                        <i class="fas fa-folder-open me-2"></i>Browse Existing Files
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    ` : `
                                        <div class="col-md-12">
                                            <div class="alert alert-info mt-3">
                                                <h6><i class="fas fa-info-circle me-2"></i>No Existing Data Found</h6>
                                                <p class="mb-0">This county has no previous project data. Use the "Find Parcels" button from the main screen to search for land parcels, or run AI analysis to understand market conditions first.</p>
                                            </div>
                                        </div>
                                    `}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <small class="text-muted me-auto">Use "Find Parcels" button on the main screen to search for land parcels</small>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('researchOptionsModal'));
            modal.show();

            modal._element.addEventListener('hidden.bs.modal', () => {
                document.getElementById('researchOptionsModal').remove();
            });
        }

        async analyzeStateCounties(state, projectType) {
            try {
                // Store the values immediately
                this.currentState = state;
                this.currentProjectType = projectType;

                console.log(`Starting analysis for ${state} - ${projectType}`);

                // Show loading state
                const analyzeBtn = document.getElementById('analyze-state-btn');
                const btnText = analyzeBtn.querySelector('.btn-text');
                const spinner = analyzeBtn.querySelector('.spinner-border');

                if (btnText) btnText.textContent = 'Analyzing...';
                if (spinner) spinner.classList.remove('d-none');
                analyzeBtn.disabled = true;

                // Make the API call
                const response = await fetch('/api/analyze-state-counties', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        state: state,
                        project_type: projectType,
                        analysis_type: 'comprehensive'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('API response:', result);

                if (!result.success) {
                    throw new Error(result.error || 'API returned success=false');
                }

                if (!result.analysis) {
                    throw new Error('API response missing analysis object');
                }

                // CRITICAL: Handle empty counties array
                if (!result.analysis.counties || result.analysis.counties.length === 0) {
                    console.warn('No counties returned from API');
                    alert(`No county data found for ${this.getStateName(state)}.\n\nThis could mean:\n• The backend analysis isn't populating county data\n• The state code "${state}" isn't recognized\n• There's an issue with your county analysis logic\n\nCheck your backend /api/analyze-state-counties endpoint.`);
                    return;
                }

                console.log(`✅ Analysis successful: ${result.analysis.counties.length} counties found`);

                this.currentStateAnalysis = result.analysis;

                // Load county activity data
                await this.loadCountyActivity(state);

                // Show county rankings
                this.displayCountyRankings(result.analysis.counties, state, projectType);
                this.showCountyRankingsScreen();

            } catch (error) {
                console.error('State analysis error:', error);
                alert(`Analysis failed: ${error.message}`);
            } finally {
                // Reset button state
                const analyzeBtn = document.getElementById('analyze-state-btn');
                const btnText = analyzeBtn.querySelector('.btn-text');
                const spinner = analyzeBtn.querySelector('.spinner-border');

                if (btnText) btnText.textContent = '🚀 Analyze State';
                if (spinner) spinner.classList.add('d-none');
                analyzeBtn.disabled = false;
            }
        }

        async loadCountyActivity(state) {
            try {
                console.log(`Loading county activity for ${state}`);

                const response = await fetch(`/api/check-county-activity/${state}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        this.currentCountyActivity = result.county_activity || {};
                        console.log(`Loaded activity data for ${Object.keys(this.currentCountyActivity).length} counties`);
                    }
                } else {
                    console.warn('Could not load county activity data');
                    this.currentCountyActivity = {};
                }
            } catch (error) {
                console.error('Error loading county activity:', error);
                this.currentCountyActivity = {};
            }
        }

        // Replace your existing displayCountyRankings method with this enhanced version
        displayCountyRankings(counties, state, projectType) {
            console.log('Displaying county rankings for:', counties.length, 'counties');

            // Store data for pagination
            this.allCounties = counties;
            this.currentPage = 1;
            this.countiesPerPage = 24; // Reasonable default

            // Update the display name
            const stateNameElement = document.getElementById('state-name-display');
            if (stateNameElement) {
                stateNameElement.textContent = this.getStateName(state);
            }

            // Update summary statistics
            this.updateCountySummaryStats(counties);

            // Initialize pagination and search
            this.updatePagination();
            this.initializeCountySearch();

            // Populate county dropdown
            this.populateCountyDropdown(counties, this.currentCountyActivity || {});

            // Show the screen
            this.showCountyRankingsScreen();
        }

        updateCountySummaryStats(counties) {
            const excellentCount = counties.filter(c => c.score >= 85).length;
            const goodCount = counties.filter(c => c.score >= 70 && c.score < 85).length;
            const fairCount = counties.filter(c => c.score >= 55 && c.score < 70).length;
            const withDataCount = Object.values(this.currentCountyActivity || {}).filter(c => c.has_activity).length;

            // Update the summary cards
            const summaryElements = {
                'total-counties': counties.length,
                'excellent-counties': excellentCount,
                'good-counties': goodCount,
                'fair-counties': fairCount,
                'with-activity': withDataCount
            };

            Object.entries(summaryElements).forEach(([id, count]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = count;
                }
            });

            console.log('Summary stats updated:', summaryElements);
        }

        // Enhanced filter method that works with pagination
        filterCounties() {
            const searchTerm = document.getElementById('county-search')?.value.toLowerCase() || '';
            const minScore = parseInt(document.getElementById('score-filter')?.value) || 0;
            const activityFilter = document.getElementById('activity-filter')?.value || '';

            // Filter the full counties list
            this.filteredCounties = this.allCounties.filter(county => {
                const matchesSearch = county.name.toLowerCase().includes(searchTerm);
                const matchesScore = county.score >= minScore;

                const activity = this.currentCountyActivity[county.fips] || { has_activity: false };
                const matchesActivity = !activityFilter ||
                    (activityFilter === 'yes' && activity.has_activity) ||
                    (activityFilter === 'no' && !activity.has_activity);

                return matchesSearch && matchesScore && matchesActivity;
            });

            // Reset to first page and update pagination
            this.currentPage = 1;
            this.updatePagination();

            // Update visible count
            document.getElementById('visible-count').textContent = this.filteredCounties.length;
        }

        updatePagination() {
            const countiesPerPageSelect = document.getElementById('counties-per-page');
            const paginationControls = document.getElementById('pagination-controls');

            if (!countiesPerPageSelect || !this.allCounties) return;

            this.countiesPerPage = parseInt(countiesPerPageSelect.value);
            const countiesToShow = this.filteredCounties.length > 0 ? this.filteredCounties : this.allCounties;
            const totalPages = Math.ceil(countiesToShow.length / this.countiesPerPage);

            // Update pagination controls
            let paginationHTML = '';

            if (totalPages > 1) {
                // Previous button
                paginationHTML += `<button class="pagination-btn ${this.currentPage === 1 ? 'disabled' : ''}"
                                    onclick="window.bcf.goToPage(${this.currentPage - 1})" ${this.currentPage === 1 ? 'disabled' : ''}>
                                    Previous
                                  </button>`;

                // Page numbers (show 5 pages max)
                const startPage = Math.max(1, this.currentPage - 2);
                const endPage = Math.min(totalPages, startPage + 4);

                for (let i = startPage; i <= endPage; i++) {
                    paginationHTML += `<button class="pagination-btn ${i === this.currentPage ? 'active' : ''}"
                                        onclick="window.bcf.goToPage(${i})">
                                        ${i}
                                      </button>`;
                }

                // Next button
                paginationHTML += `<button class="pagination-btn ${this.currentPage === totalPages ? 'disabled' : ''}"
                                    onclick="window.bcf.goToPage(${this.currentPage + 1})" ${this.currentPage === totalPages ? 'disabled' : ''}>
                                    Next
                                  </button>`;
            }

            if (paginationControls) {
                paginationControls.innerHTML = paginationHTML;
            }

            // Update table content
            this.displayCountyCards();
        }

        goToPage(pageNumber) {
            const countiesToShow = this.filteredCounties.length > 0 ? this.filteredCounties : this.allCounties;
            const totalPages = Math.ceil(countiesToShow.length / this.countiesPerPage);
            if (pageNumber >= 1 && pageNumber <= totalPages) {
                this.currentPage = pageNumber;
                this.updatePagination();
            }
        }

        displayCountyCards() {
            const countiesToShow = this.filteredCounties.length > 0 ? this.filteredCounties : this.allCounties;
            const startIndex = (this.currentPage - 1) * this.countiesPerPage;
            const endIndex = Math.min(startIndex + this.countiesPerPage, countiesToShow.length);
            const currentCounties = countiesToShow.slice(startIndex, endIndex);

            const countyGrid = document.getElementById('county-grid');
            if (!countyGrid) return;

            let html = '';
            currentCounties.forEach((county, pageIndex) => {
                const globalRank = startIndex + pageIndex + 1;
                const activity = this.currentCountyActivity[county.fips] || { has_activity: false, folder_count: 0 };

                // Determine score color
                let scoreClass = '';
                if (county.score >= 85) scoreClass = 'score-excellent';
                else if (county.score >= 70) scoreClass = 'score-good';
                else if (county.score >= 55) scoreClass = 'score-fair';
                else scoreClass = 'score-poor';

                // Generate strengths
                const strengths = this.generateCountyStrengths(county);

                html += `
                    <div class="county-card" onclick="window.bcf.selectCounty('${county.fips}', '${county.name}')">
                        <div class="county-header">
                            <div class="county-info">
                                <div class="county-name">${county.name}</div>
                                <div class="county-details">
                                    Population: ${(county.population || 0).toLocaleString()}
                                    • ${county.rural_indicator ? 'Rural' : 'Urban'} Area
                                </div>
                            </div>
                            <div class="county-score">
                                <div class="score-circle ${scoreClass}">
                                    ${county.score}
                                </div>
                                <div class="score-label">AI Score</div>
                            </div>
                        </div>

                        <div class="metrics-grid">
                            <div class="metric-item">
                                <div class="metric-label">Grid</div>
                                <div class="metric-value">${county.factor_scores?.transmission || 75}</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Terrain</div>
                                <div class="metric-value">${county.factor_scores?.topography || 80}</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Policy</div>
                                <div class="metric-value">${county.factor_scores?.regulatory || 70}</div>
                            </div>
                        </div>

                        <div class="county-bottom">
                            <div class="strengths-list">
                                ${strengths.map(s => `<span class="strength-tag">${s}</span>`).join('')}
                            </div>
                            <div class="status-column">
                                <div class="development-potential potential-${(county.development_potential || 'medium').toLowerCase()}">
                                    ${county.development_potential || 'Moderate'} Potential
                                </div>
                                <div class="past-activity ${activity.has_activity ? 'has-activity' : ''}">
                                    ${activity.has_activity ? `${activity.folder_count} projects` : 'New market'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            countyGrid.innerHTML = html;
        }

        exportAnalysisReport(countyName) {
            // Get the current analysis content
            const analysisContent = document.querySelector('.ai-analysis-content')?.textContent || 'Analysis content not available';

            const reportContent = `AI MARKET ANALYSIS REPORT
        Generated: ${new Date().toLocaleString()}
        Location: ${countyName} County, ${this.getStateName(this.currentState)}
        Project Type: ${this.currentProjectType.toUpperCase()} Energy Development

        ${analysisContent}

        ---
        Report generated by BCF.ai renewable energy analysis platform
        For questions or detailed analysis, contact your BCF.ai administrator
        `;

            // Download as text file
            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AI_Market_Analysis_${countyName}_${this.currentState}_${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            this.showNotification(`Analysis report exported: ${countyName} County`, 'success');
        }

        enableParcelSearchInterface() {
            // Remove any disabled classes
            const searchScreen = document.getElementById('parcel-search-screen');
            if (searchScreen) {
                searchScreen.classList.remove('analysis-completed');
                searchScreen.style.opacity = '1';
                searchScreen.style.pointerEvents = 'auto';

                // Enable all form elements
                const inputs = searchScreen.querySelectorAll('input, select, button');
                inputs.forEach(element => {
                    element.disabled = false;
                    element.style.opacity = '1';
                    element.style.pointerEvents = 'auto';
                });

                console.log('Parcel search interface enabled');
            }
        }

        proceedToParcelSearchFromAI(countyFips, countyName) {
            console.log(`Proceeding to parcel search from AI analysis: ${countyName}`);
            console.log('=== PARCEL SEARCH TRANSITION DEBUG ===');
            console.log('Current State:', this.currentState);
            console.log('Current Project Type:', this.currentProjectType);
            console.log('County Name:', countyName);
            console.log('County FIPS:', countyFips);
            console.log('AI Analysis Completed Flag:', this.aiAnalysisCompleted);
            console.log('=====================================');

            // Ensure we have the required state
            if (!this.currentState || !this.currentProjectType) {
                console.error('Missing current state or project type');
                alert('Session information missing. Please go back to county selection.');
                return;
            }

            // Set up the analysis object properly
            this.currentAnalysis = {
                state: this.currentState,
                county: countyName,
                county_id: countyFips,
                project_type: this.currentProjectType,
                location: `${countyName}, ${this.getStateName(this.currentState)}`,
                analysis_level: 'county',
                has_past_activity: false, // Coming from AI analysis, not from existing data
                activity_data: { has_activity: false }
            };

            console.log('Analysis object set:', this.currentAnalysis);

            // Clear any disabled states
            this.aiAnalysisCompleted = false;

            // Hide current screens
            document.getElementById('county-rankings-screen').style.display = 'none';

            // Remove any existing analysis containers
            const existingContainer = document.getElementById('parcel-analysis-container');
            if (existingContainer) {
                existingContainer.remove();
            }

            // Show the parcel search interface
            this.showParcelSearchInterface();
        }

        displayAIMarketAnalysisResults(analysis, countyName, analysisType) {
            console.log('🧠 Displaying AI analysis results for:', countyName);
            console.log('📄 Analysis content length:', analysis?.length || 'undefined');

            // Remove any existing modal first
            const existingModal = document.getElementById('aiMarketAnalysisModal');
            if (existingModal) {
                console.log('🗑️ Removing existing modal');
                existingModal.remove();
            }

            // Get county FIPS for the proceed button
            const selectedCountyOption = document.querySelector('#target-county option:checked');
            const countyFips = selectedCountyOption ? selectedCountyOption.value : countyName;

            const modalHtml = `
                <div id="aiMarketAnalysisModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    z-index: 99999;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                ">
                    <div style="
                        background: white;
                        border-radius: 12px;
                        width: 85%;
                        max-width: 900px;
                        max-height: 85vh;
                        overflow: hidden;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.4);
                    ">
                        <div style="
                            background: linear-gradient(135deg, #198754, #20c997);
                            color: white;
                            padding: 20px 30px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <div>
                                <h3 style="margin: 0; font-size: 1.5rem;">🧠 AI Market Analysis</h3>
                                <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 1.1rem;">${countyName} County</p>
                            </div>
                            <button onclick="document.getElementById('aiMarketAnalysisModal').remove();" style="
                                background: none;
                                border: none;
                                color: white;
                                font-size: 32px;
                                cursor: pointer;
                                padding: 0;
                                line-height: 1;
                                width: 40px;
                                height: 40px;
                                border-radius: 50%;
                                transition: background 0.2s;
                            " onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='none'">&times;</button>
                        </div>
                        <div style="
                            padding: 30px;
                            max-height: 60vh;
                            overflow-y: auto;
                        ">
                            <div style="margin-bottom: 25px;">
                                <span style="
                                    background: linear-gradient(135deg, #0d6efd, #6610f2);
                                    color: white;
                                    padding: 8px 16px;
                                    border-radius: 20px;
                                    font-size: 0.9rem;
                                    font-weight: 600;
                                ">${analysisType}</span>
                            </div>
                            <div style="
                                background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                                border: 1px solid #dee2e6;
                                border-radius: 12px;
                                padding: 30px;
                            ">
                                <pre style="
                                    white-space: pre-wrap;
                                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                                    line-height: 1.7;
                                    margin: 0;
                                    font-size: 15px;
                                    color: #2c3e50;
                                ">${analysis}</pre>
                            </div>
                        </div>
                        <div style="
                            padding: 20px 30px;
                            border-top: 1px solid #dee2e6;
                            background: #f8f9fa;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <small style="color: #6c757d;">
                                Generated: ${new Date().toLocaleString()}
                            </small>
                            <div style="display: flex; gap: 15px;">
                                <button onclick="document.getElementById('aiMarketAnalysisModal').remove();" style="
                                    background: #6c757d;
                                    color: white;
                                    border: none;
                                    padding: 12px 24px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    transition: all 0.2s;
                                " onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">Close</button>
                                <button onclick="
                                    console.log('Proceeding to parcel search for ${countyName}...');
                                    if (window.bcf && window.bcf.proceedToParcelSearchFromAI) {
                                        window.bcf.proceedToParcelSearchFromAI('${countyFips}', '${countyName}');
                                    }
                                    document.getElementById('aiMarketAnalysisModal').remove();
                                " style="
                                    background: linear-gradient(135deg, #198754, #20c997);
                                    color: white;
                                    border: none;
                                    padding: 12px 24px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    transition: all 0.2s;
                                " onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">🔍 Find Parcels</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            console.log('➕ Adding modal to DOM');
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            console.log('✅ Modal should now be visible');
            return true;
        }

        generateCountyStrengths(county) {
            const strengths = [];

            if (county.factor_scores?.transmission >= 80) strengths.push('Strong Grid');
            if (county.factor_scores?.topography >= 80) strengths.push('Flat Terrain');
            if (county.factor_scores?.regulatory >= 75) strengths.push('Good Policy');
            if (county.rural_indicator) strengths.push('Rural');
            if (county.population && county.population < 50000) strengths.push('Low Density');

            // Add default strengths if none found
            if (strengths.length === 0) {
                strengths.push('Standard', 'Available');
            }

            return strengths.slice(0, 3); // Limit to 3
        }

        populateCountyDropdown(counties, countyActivity) {
            const countySelect = document.getElementById('target-county');
            if (!countySelect) return;

            countySelect.innerHTML = '<option value="">Select a county...</option>';

            counties.forEach((county, index) => {
                const activity = countyActivity[county.fips] || countyActivity[county.name] || { has_activity: false };
                const indicators = [];

                if (index < 10) indicators.push('TOP 10');
                if (activity.has_activity) indicators.push('HAS DATA');
                if (county.rural_indicator) indicators.push('RURAL');
                if (county.score >= 80) indicators.push('HIGH SCORE');

                const indicatorText = indicators.length > 0 ? ` [${indicators.join(', ')}]` : '';

                const option = document.createElement('option');
                option.value = county.fips || county.name;
                option.textContent = `${county.name} (#${index + 1} - ${county.score}/100)${indicatorText}`;
                option.dataset.countyName = county.name;
                option.dataset.hasActivity = activity.has_activity;
                option.dataset.score = county.score;

                countySelect.appendChild(option);
            });
        }

        // Add search initialization method
        initializeCountySearch() {
            const searchInput = document.getElementById('county-search');
            if (searchInput) {
                // Add debounced search for better performance
                let searchTimeout;
                searchInput.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => this.filterCounties(), 300);
                });
            }
        }

        clearFilters() {
            document.getElementById('county-search').value = '';
            document.getElementById('score-filter').value = '';
            document.getElementById('activity-filter').value = '';
            this.filteredCounties = [];
            this.currentPage = 1;
            this.updatePagination();
            document.getElementById('visible-count').textContent = this.allCounties.length;
        }

        selectCounty(countyFips, countyName) {
            console.log(`County selected: ${countyName}`);

            // Check if AI analysis is completed
            if (this.aiAnalysisCompleted) {
                console.log('Screen disabled - AI analysis already completed');
                return;
            }

            const activity = this.currentCountyActivity[countyFips] || this.currentCountyActivity[countyName] || { has_activity: false };

            const countySelect = document.getElementById('target-county');
            if (countySelect) countySelect.value = countyFips;

            const findBtn = document.getElementById('find-parcels-btn-alt');
            const researchBtn = document.getElementById('research-areas-btn-alt');

            if (findBtn) {
                findBtn.disabled = false;
                findBtn.onclick = () => this.proceedToParcelSearch(countyFips, countyName, activity);
            }

            if (researchBtn) {
                researchBtn.disabled = false;
                researchBtn.onclick = () => this.proceedToAreaResearch(countyFips, countyName, activity);
            }

            // Highlight selected card
            document.querySelectorAll('.county-card').forEach(card => card.classList.remove('selected'));

            this.showCountySelectionNotification(countyName, activity);
        }

        showCountySelectionNotification(countyName, activity) {
            document.querySelectorAll('.county-selection-notification').forEach(n => n.remove());

            const notification = document.createElement('div');
            notification.className = 'alert alert-dismissible fade show position-fixed county-selection-notification';
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 350px; max-width: 500px;';

            if (activity.has_activity) {
                notification.classList.add('alert-success');
                notification.innerHTML = `
                    <div class="d-flex align-items-start">
                        <div class="me-3 fs-4">✅</div>
                        <div class="flex-grow-1">
                            <h6 class="alert-heading mb-2">Past Project Activity Found!</h6>
                            <p class="mb-2"><strong>County:</strong> ${countyName}</p>
                            <p class="mb-2"><strong>Project Folders:</strong> ${activity.folder_count} found in Cloud Storage</p>
                            ${activity.latest_activity ? `<p class="mb-2"><strong>Last Activity:</strong> ${new Date(activity.latest_activity).toLocaleDateString()}</p>` : ''}
                            <hr class="my-2">
                            <small class="text-success">
                                <strong>Advantage:</strong> You have existing data and relationships in this county!
                                <br>Choose your next step below.
                            </small>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
            } else {
                notification.classList.add('alert-info');
                notification.innerHTML = `
                    <div class="d-flex align-items-start">
                        <div class="me-3 fs-4">🆕</div>
                        <div class="flex-grow-1">
                            <h6 class="alert-heading mb-2">New Market Opportunity</h6>
                            <p class="mb-2"><strong>County:</strong> ${countyName}</p>
                            <p class="mb-2"><strong>Status:</strong> No past project activity found</p>
                            <hr class="my-2">
                            <small class="text-info">
                                <strong>Fresh Start:</strong> This represents a new market area with no prior outreach.
                                <br>Choose your next step below.
                            </small>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
            }

            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 8000);
        }

        proceedToParcelSearch(countyFips, countyName, activity) {
            console.log(`Proceeding to parcel search for ${countyName}`);

            this.currentAnalysis = {
                state: this.currentState,
                county: countyName,
                county_id: countyFips,
                project_type: this.currentProjectType,
                location: `${countyName}, ${this.getStateName(this.currentState)}`,
                analysis_level: 'county',
                has_past_activity: activity.has_activity,
                activity_data: activity
            };

            document.getElementById('county-rankings-screen').style.display = 'none';
            this.showParcelSearchInterface();
        }

        // Header button handlers
        proceedToParcelSearchFromHeader() {
            const countySelect = document.getElementById('target-county');
            const selectedValue = countySelect?.value;
            const selectedOption = countySelect?.options[countySelect.selectedIndex];

            if (!selectedValue || !selectedOption) {
                alert('Please select a county first');
                return;
            }

            const countyName = selectedOption.dataset.countyName;
            const hasActivity = selectedOption.dataset.hasActivity === 'true';

            this.proceedToParcelSearch(selectedValue, countyName, { has_activity: hasActivity });
        }

        proceedToAreaResearchFromHeader() {
            const countySelect = document.getElementById('target-county');
            const selectedValue = countySelect?.value;
            const selectedOption = countySelect?.options[countySelect.selectedIndex];

            if (!selectedValue || !selectedOption) {
                alert('Please select a county first');
                return;
            }

            const countyName = selectedOption.dataset.countyName;
            const hasActivity = selectedOption.dataset.hasActivity === 'true';

            this.proceedToAreaResearch(selectedValue, countyName, { has_activity: hasActivity });
        }

        showCountyRankingsScreen() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('county-rankings-screen').style.display = 'block';
        }

        getStateName(stateCode) {
            const stateNames = {
                'AL': 'Alabama', 'AZ': 'Arizona', 'AR': 'Arkansas', 'CA': 'California',
                'CO': 'Colorado', 'FL': 'Florida', 'GA': 'Georgia', 'IL': 'Illinois',
                'IN': 'Indiana', 'IA': 'Iowa', 'KS': 'Kansas', 'KY': 'Kentucky',
                'LA': 'Louisiana', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi',
                'MO': 'Missouri', 'NE': 'Nebraska', 'NV': 'Nevada', 'NM': 'New Mexico',
                'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota',
                'OH': 'Ohio', 'OK': 'Oklahoma', 'PA': 'Pennsylvania', 'SC': 'South Carolina',
                'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah',
                'VA': 'Virginia', 'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming'
            };
            return stateNames[stateCode] || stateCode;
        }

        showParcelSearchInterface() {
            console.log('Showing parcel search interface for:', this.currentAnalysis.location);

            // Hide county rankings screen
            document.getElementById('county-rankings-screen').style.display = 'none';

            // Create parcel search interface
            const searchInterfaceHtml = `
                <div id="parcel-search-screen" class="workflow-step">
                    <div class="container-fluid">
                        <!-- Header -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white">
                                        <h3 class="mb-0">
                                            <i class="fas fa-search me-2"></i>
                                            Parcel Search: ${this.currentAnalysis.location}
                                        </h3>
                                    </div>
                                    <div class="card-body">
                                        <div class="row align-items-center">
                                            <div class="col-md-6">
                                                <p class="mb-0">
                                                    <strong>Project Type:</strong> ${this.currentProjectType}<br>
                                                    <strong>Analysis Level:</strong> ${this.currentAnalysis.analysis_level}
                                                </p>
                                            </div>
                                            <div class="col-md-6 text-end">
                                                ${this.currentAnalysis.has_past_activity ?
                                                    '<span class="badge bg-success fs-6">Has Previous Activity</span>' :
                                                    '<span class="badge bg-info fs-6">New Market</span>'
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Search Criteria Form -->
                        <div class="row">
                            <div class="col-lg-8">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Search Criteria</h5>
                                    </div>
                                    <div class="card-body">
                                        <form id="parcel-search-form">
                                            <!-- Acreage Filters -->
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">Minimum Acres</label>
                                                    <input type="number" class="form-control" id="acreage-min"
                                                           placeholder="e.g. 10" step="0.1" min="0">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Maximum Acres</label>
                                                    <input type="number" class="form-control" id="acreage-max"
                                                           placeholder="e.g. 500" step="0.1" min="0">
                                                </div>
                                            </div>

                                            <!-- Owner Search -->
                                            <div class="mb-3">
                                                <label class="form-label">Owner Name (Optional)</label>
                                                <input type="text" class="form-control" id="owner-search"
                                                       placeholder="Search by landowner name">
                                                <small class="form-text text-muted">
                                                    Leave blank to search all owners
                                                </small>
                                            </div>

                                            <!-- Parcel ID Search -->
                                            <div class="mb-3">
                                                <label class="form-label">Parcel ID (Optional)</label>
                                                <input type="text" class="form-control" id="parcel-id-search"
                                                       placeholder="Search by specific parcel ID">
                                            </div>

                                            <!-- Search Actions -->
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <button type="button" class="btn btn-outline-info w-100"
                                                            id="preview-search-btn">
                                                        <i class="fas fa-eye me-2"></i>Preview Count
                                                    </button>
                                                </div>
                                                <div class="col-md-6">
                                                    <button type="submit" class="btn btn-success w-100"
                                                            id="execute-search-btn" disabled>
                                                        <i class="fas fa-search me-2"></i>
                                                        <span class="btn-text">Search Parcels</span>
                                                        <span class="spinner-border spinner-border-sm d-none ms-2"></span>
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>

                            <!-- Search Guidelines -->
                            <div class="col-lg-4">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0">Search Guidelines</h6>
                                    </div>
                                    <div class="card-body">
                                        <h6>Recommended Criteria:</h6>
                                        <ul class="small mb-3">
                                            <li><strong>Solar:</strong> 5-200 acres</li>
                                            <li><strong>Wind:</strong> 50-1000 acres</li>
                                            <li><strong>Battery:</strong> 1-50 acres</li>
                                        </ul>

                                        <h6>Tips:</h6>
                                        <ul class="small mb-0">
                                            <li>Start with broader criteria</li>
                                            <li>Use Preview to check count</li>
                                            <li>Owner search is case-insensitive</li>
                                            <li>Leave fields blank for wider search</li>
                                        </ul>
                                    </div>
                                </div>

                                <!-- Search Status -->
                                <div class="card border-warning mt-3" id="search-status-card" style="display: none;">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0">Search Status</h6>
                                    </div>
                                    <div class="card-body" id="search-status-content">
                                        <!-- Status updates will appear here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Search Results Area -->
                        <div class="row mt-4" id="search-results-area" style="display: none;">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0">
                                            <i class="fas fa-map me-2"></i>
                                            Search Results
                                        </h5>
                                    </div>
                                    <div class="card-body" id="search-results-content">
                                        <!-- Results will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Back Navigation -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <button class="btn btn-outline-secondary" onclick="window.bcf.backToCountySelection()">
                                    <i class="fas fa-arrow-left me-2"></i>
                                    Back to County Selection
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Insert the search interface
            const existingScreen = document.getElementById('parcel-search-screen');
            if (existingScreen) {
                existingScreen.remove();
            }

            document.body.insertAdjacentHTML('beforeend', searchInterfaceHtml);

            // Initialize form handlers
            this.initializeParcelSearchHandlers();

            // Set default criteria based on project type
            this.setDefaultSearchCriteria();
        }

        initializeParcelSearchHandlers() {
            // Preview button handler
            document.getElementById('preview-search-btn').addEventListener('click', () => {
                this.previewParcelSearch();
            });

            // Search form handler
            document.getElementById('parcel-search-form').addEventListener('submit', (e) => {
                e.preventDefault();
                this.executeParcelSearch();
            });

            // Enable search button when criteria is entered
            const inputs = ['acreage-min', 'acreage-max', 'owner-search', 'parcel-id-search'];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('input', () => {
                    this.validateSearchCriteria();
                });
            });
        }

        setDefaultSearchCriteria() {
            const defaults = {
                'solar': { min: 5, max: 200 },
                'wind': { min: 50, max: 1000 },
                'battery': { min: 1, max: 50 },
                'mixed': { min: 5, max: 500 }
            };

            const projectDefaults = defaults[this.currentProjectType] || defaults['mixed'];

            document.getElementById('acreage-min').value = projectDefaults.min;
            document.getElementById('acreage-max').value = projectDefaults.max;

            this.validateSearchCriteria();
        }

        validateSearchCriteria() {
            const minAcres = document.getElementById('acreage-min').value;
            const maxAcres = document.getElementById('acreage-max').value;
            const owner = document.getElementById('owner-search').value;
            const parcelId = document.getElementById('parcel-id-search').value;

            // Enable search if we have at least one criteria
            const hasMinAcres = minAcres && parseFloat(minAcres) > 0;
            const hasMaxAcres = maxAcres && parseFloat(maxAcres) > 0;
            const hasOwner = owner.trim().length > 0;
            const hasParcelId = parcelId.trim().length > 0;

            const searchBtn = document.getElementById('execute-search-btn');
            searchBtn.disabled = !(hasMinAcres || hasMaxAcres || hasOwner || hasParcelId);
        }

        async previewParcelSearch() {
            try {
                const criteria = this.getSearchCriteria();

                this.showSearchStatus('Getting count preview...', 'info');

                const response = await fetch('/api/preview-parcel-search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        county_id: this.currentAnalysis.county_id,
                        county_name: this.currentAnalysis.county,
                        state: this.currentState,
                        ...criteria
                    })
                });

                const result = await response.json();

                if (result.success) {
                    this.showSearchStatus(
                        `Preview: Found approximately ${result.record_count} parcels matching your criteria`,
                        'success'
                    );
                } else {
                    this.showSearchStatus(`Preview failed: ${result.message}`, 'error');
                }

            } catch (error) {
                console.error('Preview error:', error);
                this.showSearchStatus(`Preview error: ${error.message}`, 'error');
            }
        }

        async executeParcelSearch() {
            try {
                const criteria = this.getSearchCriteria();

                // Update button state
                const searchBtn = document.getElementById('execute-search-btn');
                const btnText = searchBtn.querySelector('.btn-text');
                const spinner = searchBtn.querySelector('.spinner-border');

                btnText.textContent = 'Searching...';
                spinner.classList.remove('d-none');
                searchBtn.disabled = true;

                this.showSearchStatus('Executing parcel search...', 'info');

                const response = await fetch('/api/execute-parcel-search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        county_id: this.currentAnalysis.county_id,
                        county_name: this.currentAnalysis.county,
                        state: this.currentState,
                        project_type: this.currentProjectType,
                        user_id: 'current_user', // You might want to get this from auth
                        ...criteria
                    })
                });

                const result = await response.json();

                if (result.success) {
                    this.showSearchStatus(
                        `Success! Found ${result.record_count} parcels. Files saved to cloud storage.`,
                        'success'
                    );

                    // Show results
                    this.displayParcelSearchResults(result);
                } else {
                    this.showSearchStatus(`Search failed: ${result.message}`, 'error');
                }

            } catch (error) {
                console.error('Search error:', error);
                this.showSearchStatus(`Search error: ${error.message}`, 'error');
            } finally {
                // Reset button state
                const searchBtn = document.getElementById('execute-search-btn');
                const btnText = searchBtn.querySelector('.btn-text');
                const spinner = searchBtn.querySelector('.spinner-border');

                btnText.textContent = 'Search Parcels';
                spinner.classList.add('d-none');
                this.validateSearchCriteria(); // Re-enable based on criteria
            }
        }

        getSearchCriteria() {
            return {
                calc_acreage_min: document.getElementById('acreage-min').value || null,
                calc_acreage_max: document.getElementById('acreage-max').value || null,
                owner: document.getElementById('owner-search').value || null,
                parcel_id: document.getElementById('parcel-id-search').value || null
            };
        }

        showSearchStatus(message, type) {
            const statusCard = document.getElementById('search-status-card');
            const statusContent = document.getElementById('search-status-content');

            statusCard.style.display = 'block';

            const alertClass = {
                'info': 'alert-info',
                'success': 'alert-success',
                'error': 'alert-danger'
            }[type] || 'alert-info';

            statusContent.innerHTML = `
                <div class="alert ${alertClass} mb-0">
                    ${message}
                </div>
            `;
        }

        displayParcelSearchResults(result) {
            const resultsArea = document.getElementById('search-results-area');
            const resultsContent = document.getElementById('search-results-content');

            resultsArea.style.display = 'block';

            resultsContent.innerHTML = `
                <div class="row mb-3">
                    <div class="col-md-8">
                        <h5>Search Complete</h5>
                        <p class="mb-0">
                            Found <strong>${result.record_count}</strong> parcels in
                            <strong>${result.county_name}, ${result.state_abbr}</strong>
                        </p>
                        <small class="text-muted">
                            Processing time: ${result.processing_time}s |
                            Search ID: ${result.search_id}
                        </small>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-primary me-2" onclick="window.bcf.analyzeSearchResults('${result.search_id}')">
                            <i class="fas fa-brain me-2"></i>Analyze with AI
                        </button>
                        <div class="btn-group">
                            <button class="btn btn-outline-success" onclick="window.bcf.downloadParcelFile('${result.csv_blob_name}', 'csv')">
                                <i class="fas fa-download me-1"></i>CSV
                            </button>
                            <button class="btn btn-outline-primary" onclick="window.bcf.downloadParcelFile('${result.gpkg_blob_name}', 'gpkg')">
                                <i class="fas fa-download me-1"></i>GPKG
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Quick Preview of Results -->
                ${result.parcel_data && result.parcel_data.length > 0 ? `
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Owner</th>
                                    <th>Acres</th>
                                    <th>Parcel ID</th>
                                    <th>Address</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.parcel_data.slice(0, 10).map(parcel => `
                                    <tr>
                                        <td>${parcel.owner || 'N/A'}</td>
                                        <td>${parcel.acreage || 'N/A'}</td>
                                        <td>${parcel.parcel_id || 'N/A'}</td>
                                        <td>${parcel.situs_address || 'N/A'}</td>
                                    </tr>
                                `).join('')}
                                ${result.parcel_data.length > 10 ? `
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">
                                            ... and ${result.parcel_data.length - 10} more parcels
                                        </td>
                                    </tr>
                                ` : ''}
                            </tbody>
                        </table>
                    </div>
                ` : ''}
            `;

            // Store the search results for further processing
            this.currentSearchResults = result;

            // Scroll to results
            resultsArea.scrollIntoView({ behavior: 'smooth' });
        }


        async runAIMarketAnalysis(countyFips, countyName) {
            try {
                console.log('🚀 Starting AI Market Analysis for', countyName);

                // Show loading modal
                this.showLoadingModal(`
                    <div class="text-center">
                        <div class="spinner-border text-primary mb-3" role="status"></div>
                        <h5>Running AI Market Analysis</h5>
                        <p class="text-muted">Analyzing ${countyName} County for ${this.currentProjectType} development...</p>
                        <div class="progress mb-3" style="height: 20px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                        </div>
                        <small class="text-muted">This may take 30-60 seconds</small>
                    </div>
                `);

                const response = await fetch('/api/county-market-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        county_fips: countyFips,
                        county_name: countyName,
                        state: this.currentState,
                        project_type: this.currentProjectType
                    })
                });

                this.hideLoadingModal();

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('✅ API Response received:', result);

                if (!result.success) {
                    throw new Error(result.error || 'AI analysis failed');
                }

                if (!result.analysis) {
                    throw new Error('No analysis content in response');
                }

                // NEW: Direct debug test of display function
                console.log('🔧 Testing displayAIMarketAnalysisResults function...');
                console.log('Function exists:', typeof this.displayAIMarketAnalysisResults);

                // Call the display function and capture return value
                console.log('🎭 Calling displayAIMarketAnalysisResults...');
                const displayResult = this.displayAIMarketAnalysisResults(
                    result.analysis,
                    countyName,
                    result.analysis_type || 'AI-Powered Market Analysis'
                );

                console.log('🎭 Display function returned:', displayResult);

                // Verify modal was added to DOM
                setTimeout(() => {
                    const modal = document.getElementById('aiMarketAnalysisModal');
                    console.log('🔍 Modal found in DOM:', !!modal);
                    if (modal) {
                        console.log('🎯 Modal styles:', modal.style.cssText);
                        console.log('🎯 Modal display:', window.getComputedStyle(modal).display);
                        console.log('🎯 Modal visibility:', window.getComputedStyle(modal).visibility);
                        console.log('🎯 Modal z-index:', window.getComputedStyle(modal).zIndex);
                    }
                }, 100);

            } catch (error) {
                this.hideLoadingModal();
                console.error('💥 AI Market Analysis error:', error);
                alert(`AI analysis failed: ${error.message}`);
            }
        }

        async showExistingDataFiles(countyFips, countyName) {
            try {
                console.log(`Loading existing files for ${countyName}`);

                // Show loading modal first
                this.showLoadingModal('Loading existing files...');

                // Get the state abbreviation
                const stateAbbr = this.currentState;

                const response = await fetch('/api/get-existing-files', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        state: stateAbbr,
                        county: countyName,
                        county_fips: countyFips
                    })
                });

                // Hide loading modal
                this.hideLoadingModal();

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to load existing files');
                }

                // Show files in modal
                this.displayExistingFilesModal(countyName, result.files, result.folder_path);

            } catch (error) {
                this.hideLoadingModal();
                console.error('Error loading existing files:', error);
                alert(`Failed to load existing files: ${error.message}`);
            }
        }

        displayExistingFilesModal(countyName, files, folderPath) {
            const modalHtml = `
                <div class="modal fade" id="existingFilesModal" tabindex="-1" data-bs-backdrop="static">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-folder-open me-2"></i>
                                    Existing Files: ${countyName} County
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${files.length === 0 ? this.createNoFilesContent(countyName) : this.createFilesListContent(files, folderPath)}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                ${files.length > 0 ? `
                                    <button type="button" class="btn btn-success" onclick="window.bcf.proceedWithExistingData('${countyName}')">
                                        <i class="fas fa-play me-2"></i>Use Selected File
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove any existing modal
            const existingModal = document.getElementById('existingFilesModal');
            if (existingModal) existingModal.remove();

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('existingFilesModal'));
            modal.show();

            // Clean up on close
            modal._element.addEventListener('hidden.bs.modal', () => {
                document.getElementById('existingFilesModal').remove();
            });
        }

        createNoFilesContent(countyName) {
            return `
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-folder-open fa-4x text-muted"></i>
                    </div>
                    <h4 class="text-muted mb-3">No Existing Files Found</h4>
                    <p class="text-muted mb-4">
                        No previous parcel search files were found for ${countyName} County.
                        This represents a fresh market opportunity.
                    </p>
                    <div class="alert alert-info">
                        <h6><i class="fas fa-lightbulb me-2"></i>Next Steps</h6>
                        <ul class="list-unstyled mb-0 text-start">
                            <li><i class="fas fa-search me-2"></i>Use "Find Parcels" to search for land parcels</li>
                            <li><i class="fas fa-brain me-2"></i>Run AI Market Analysis to understand the area</li>
                            <li><i class="fas fa-map me-2"></i>Research county characteristics and opportunities</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        createFilesListContent(files, folderPath) {
            const filesHtml = files.map((file, index) => `
                <div class="card mb-3 file-item" data-file-index="${index}">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-1 text-center">
                                <input type="radio" name="selectedFile" value="${index}" class="form-check-input"
                                       ${index === 0 ? 'checked' : ''}>
                            </div>
                            <div class="col-md-5">
                                <h6 class="card-title mb-1">
                                    <i class="fas fa-file-csv text-success me-2"></i>
                                    <span class="file-name">${file.name}</span>
                                </h6>
                                <small class="text-muted">
                                    ${file.search_criteria || 'Parcel search results'}
                                </small>
                            </div>
                            <div class="col-md-2 text-center">
                                <span class="badge bg-primary fs-6">
                                    ${file.parcel_count} parcels
                                </span>
                            </div>
                            <div class="col-md-2 text-center">
                                <small class="text-muted">
                                    ${file.size ? this.formatFileSize(file.size) : 'Unknown size'}
                                </small>
                                <br>
                                <small class="text-muted">
                                    ${file.created ? new Date(file.created).toLocaleDateString() : 'Unknown date'}
                                </small>
                            </div>
                            <div class="col-md-2 text-center">
                                <div class="btn-group-vertical d-grid gap-1" role="group">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-primary"
                                                onclick="window.bcf.previewFile('${file.path}', '${file.name}')"
                                                title="Preview file contents">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-success"
                                                onclick="window.bcf.downloadFile('${file.path}', '${file.name}')"
                                                title="Download file">
                                            <i class="fas fa-download"></i>
                                        </button>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-warning w-100"
                                            onclick="window.bcf.analyzeExistingFile('${file.path}', '${file.name}', '${this.currentAnalysis?.county || 'Unknown'}')"
                                            title="Run AI analysis on this file">
                                        <i class="fas fa-brain me-1"></i>Analyze
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            return `
                <div class="mb-3">
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle me-2"></i>Found ${files.length} Existing File${files.length !== 1 ? 's' : ''}</h6>
                        <p class="mb-0">Previous parcel search results are available for this county.
                           Select a file to preview, analyze with AI, or download.</p>
                    </div>
                </div>

                <div class="existing-files-list" style="max-height: 60vh; overflow-y: auto;">
                    ${filesHtml}
                </div>

                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Files are stored in: <code style="word-break: break-all;">${folderPath}</code>
                    </small>
                </div>
            `;
        }

        formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        showLoadingModal(message) {
            const loadingHtml = `
                <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-body text-center py-4">
                                <div class="spinner-border text-primary mb-3" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <h5>${message}</h5>
                                <p class="text-muted mb-0">Please wait...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', loadingHtml);
            const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
            modal.show();
        }

        hideLoadingModal() {
            const loadingModal = document.getElementById('loadingModal');
            if (loadingModal) {
                const modal = bootstrap.Modal.getInstance(loadingModal);
                if (modal) {
                    modal.hide();
                }
                setTimeout(() => {
                    if (loadingModal.parentNode) {
                        loadingModal.remove();
                    }
                }, 300);
            }
        }

        async previewFile(filePath, fileName) {
            try {
                console.log(`Previewing file: ${fileName}`);

                this.showLoadingModal('Loading file preview...');

                const response = await fetch('/api/preview-file', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_path: filePath
                    })
                });

                this.hideLoadingModal();

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Preview failed');
                }

                // Show preview modal
                this.displayFilePreviewModal(fileName, result);

            } catch (error) {
                this.hideLoadingModal();
                console.error('Preview error:', error);
                alert(`Failed to preview file: ${error.message}`);
            }
        }

        displayFilePreviewModal(fileName, previewData) {
            const { headers, preview_rows, total_rows, showing_rows } = previewData;

            // Create table HTML
            const tableHeaders = headers.map(h => `<th>${h}</th>`).join('');
            const tableRows = preview_rows.map(row => {
                const cells = headers.map(h => `<td>${row[h] || ''}</td>`).join('');
                return `<tr>${cells}</tr>`;
            }).join('');

            const modalHtml = `
                <div class="modal fade" id="filePreviewModal" tabindex="-1" data-bs-backdrop="static">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header bg-info text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-eye me-2"></i>
                                    File Preview: ${fileName}
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                                <div class="mb-3">
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-info-circle me-2"></i>File Summary</h6>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <strong>Total Rows:</strong> ${total_rows.toLocaleString()}
                                            </div>
                                            <div class="col-md-4">
                                                <strong>Showing:</strong> ${showing_rows} rows
                                            </div>
                                            <div class="col-md-4">
                                                <strong>Columns:</strong> ${headers.length}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="table-responsive">
                                    <table class="table table-striped table-sm">
                                        <thead class="table-dark">
                                            <tr>${tableHeaders}</tr>
                                        </thead>
                                        <tbody>
                                            ${tableRows}
                                        </tbody>
                                    </table>
                                </div>

                                ${showing_rows < total_rows ? `
                                    <div class="alert alert-warning mt-3">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        Showing first ${showing_rows} of ${total_rows.toLocaleString()} total rows.
                                        Download the file to see all data.
                                    </div>
                                ` : ''}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-success" onclick="window.bcf.downloadFile('${previewData.file_path}', '${fileName}')">
                                    <i class="fas fa-download me-2"></i>Download Full File
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal and add new one
            const existingModal = document.getElementById('filePreviewModal');
            if (existingModal) existingModal.remove();

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('filePreviewModal'));
            modal.show();

            // Clean up on close
            modal._element.addEventListener('hidden.bs.modal', () => {
                document.getElementById('filePreviewModal').remove();
            });
        }

        async analyzeExistingFile(filePath, fileName, countyName) {
            try {
                console.log(`Analyzing existing file: ${fileName}`);

                // Close the existing files modal first
                const existingModal = bootstrap.Modal.getInstance(document.getElementById('existingFilesModal'));
                if (existingModal) existingModal.hide();

                // Show detailed loading modal
                this.showLoadingModal(`
                    <div class="text-center">
                        <div class="spinner-border text-primary mb-3" role="status"></div>
                        <h5>Analyzing Parcel Data with AI</h5>
                        <div class="progress mb-3" style="height: 20px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 style="width: 100%"></div>
                        </div>
                        <div class="analysis-steps">
                            <div class="step active" id="step-slope">
                                <i class="fas fa-mountain me-2"></i>Running slope analysis...
                            </div>
                            <div class="step" id="step-transmission">
                                <i class="fas fa-bolt me-2"></i>Analyzing transmission lines...
                            </div>
                            <div class="step" id="step-scoring">
                                <i class="fas fa-calculator me-2"></i>Calculating suitability scores...
                            </div>
                        </div>
                        <small class="text-muted">This may take 2-3 minutes for large files</small>
                    </div>
                `);

                const response = await fetch('/api/analyze-existing-file-bq', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_path: filePath,
                        county_name: countyName,
                        state: this.currentState,
                        project_type: this.currentProjectType
                    })
                });

                this.hideLoadingModal();

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Analysis failed');
                }

                // Store analysis results
                this.currentSuitabilityResults = result.analysis_results;
                this.originalParcelData = result.analysis_results.enhanced_parcels;

                // Show success notification with details
                const hasTransmission = result.transmission_analysis?.status === 'success';
                const transmissionNote = hasTransmission
                    ? `Includes transmission line analysis within 2-mile buffer.`
                    : `Slope analysis only - transmission analysis unavailable.`;

                this.showNotification(`
                    Analysis completed! ${result.parcel_count} parcels analyzed from ${fileName}.
                    <br><small>${transmissionNote}</small>
                `, 'success');

                // Show the analysis results
                this.showAnalysisResults(result.analysis_results, fileName);

            } catch (error) {
                this.hideLoadingModal();
                console.error('Analysis error:', error);

                // Enhanced error message
                let errorMessage = `Failed to analyze file: ${error.message}`;

                if (error.message.includes('HTTP 500')) {
                    errorMessage += `\n\nThis might be due to:\n• Large file size requiring more processing time\n• Transmission line data unavailable\n• Temporary server overload\n\nTry again in a few minutes or contact support.`;
                } else if (error.message.includes('timeout')) {
                    errorMessage += `\n\nFile analysis timed out. This usually happens with very large files.\nTry analyzing a smaller subset or contact support for assistance.`;
                }

                alert(errorMessage);
            }
        }

        showAnalysisResults(analysisResults, sourceFileName) {
            console.log('Showing parcel analysis results:', analysisResults);

            // Hide any existing modals
            this.hideLoadingModal();

            // Store the results
            this.currentSuitabilityResults = analysisResults;

            // Create the parcel analysis interface
            this.displayParcelAnalysisTable(analysisResults, sourceFileName);
        }

        displayParcelAnalysisTable(analysisResults, sourceFileName) {
            const { parcels_table, summary, analysis_metadata } = analysisResults;

            // DEBUG: Check what we actually received
            this.debugParcelData(parcels_table);

            // Create the main container
            const containerHtml = `
                <div class="parcel-analysis-container" id="parcel-analysis-container">
                    <!-- Summary Statistics -->
                    <div class="analysis-summary">
                        <h3><i class="fas fa-chart-bar me-2"></i>Parcel Analysis Results</h3>
                        <p class="mb-3">
                            <strong>Source:</strong> ${sourceFileName}<br>
                            <strong>Location:</strong> ${summary.location}<br>
                            <strong>Analysis:</strong> ${analysis_metadata.scoring_method}
                        </p>

                        <div class="summary-grid">
                            <div class="summary-stat">
                                <span class="stat-number">${summary.total_parcels}</span>
                                <span class="stat-label">Total Parcels</span>
                            </div>
                            <div class="summary-stat stat-excellent">
                                <span class="stat-number">${summary.excellent}</span>
                                <span class="stat-label">Excellent</span>
                            </div>
                            <div class="summary-stat stat-good">
                                <span class="stat-number">${summary.good}</span>
                                <span class="stat-label">Good</span>
                            </div>
                            <div class="summary-stat stat-fair">
                                <span class="stat-number">${summary.fair}</span>
                                <span class="stat-label">Fair</span>
                            </div>
                            <div class="summary-stat stat-poor">
                                <span class="stat-number">${summary.poor}</span>
                                <span class="stat-label">Poor</span>
                            </div>
                            <div class="summary-stat">
                                <span class="stat-number">${summary.average_score}</span>
                                <span class="stat-label">Avg Score</span>
                            </div>
                        </div>
                    </div>

                    <!-- Selection Controls -->
                    <div class="selection-controls" id="selection-controls">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6><i class="fas fa-hand-pointer me-2"></i>Parcel Selection</h6>
                                <div class="btn-group me-3" role="group">
                                    <button type="button" class="btn btn-outline-success btn-sm" onclick="window.bcf.selectRecommended()">
                                        <i class="fas fa-star me-1"></i>Select Recommended (${summary.recommended_for_outreach})
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="window.bcf.selectAll()">
                                        <i class="fas fa-check-square me-1"></i>Select All
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="window.bcf.clearSelection()">
                                        <i class="fas fa-square me-1"></i>Clear All
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="selection-summary">
                                    <span class="fw-bold text-success" id="selection-count">0</span>
                                    <span class="text-muted"> parcels selected</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Parcel Table -->
                    <div class="parcel-table-container">
                        <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                            <table class="table table-hover parcel-table" id="parcel-table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">
                                            <input type="checkbox" class="form-check-input" id="select-all-checkbox"
                                                   onchange="toggleSelectAll(this.checked)">
                                        </th>
                                        <th>Score</th>
                                        <th>Owner</th>
                                        <th>Acres</th>
                                        <th>Slope (°)</th>
                                        <th>TX Dist (mi)</th>
                                        <th>TX Voltage (kV)</th>
                                        <th>Category</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${this.generateParcelRows(parcels_table)}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button class="outreach-btn" id="initiate-outreach-btn" onclick="window.bcf.initiateOutreach()" disabled>
                            <i class="fas fa-rocket me-2"></i>Initiate Outreach (<span id="outreach-count">0</span> parcels)
                        </button>
                        <button class="btn btn-outline-info" onclick="window.bcf.exportParcelData()">
                            <i class="fas fa-download me-2"></i>Export Data
                        </button>
                        <button class="btn btn-outline-secondary" onclick="window.bcf.backToCountySelection()">
                            <i class="fas fa-arrow-left me-2"></i>Back to Counties
                        </button>
                    </div>
                </div>
            `;

            // Find where to insert this (likely replacing existing results)
            const existingContainer = document.getElementById('parcel-analysis-container');
            if (existingContainer) {
                existingContainer.remove();
            }

            // Insert after county rankings screen
            const countyScreen = document.getElementById('county-rankings-screen');
            if (countyScreen) {
                countyScreen.insertAdjacentHTML('afterend', containerHtml);
                countyScreen.style.display = 'none';
            } else {
                document.body.insertAdjacentHTML('beforeend', containerHtml);
            }

            // Initialize selection state
            this.selectedParcels = new Set();
            this.allParcels = parcels_table;

            // Auto-select recommended parcels
            this.selectRecommended();

            // Scroll to results
            document.getElementById('parcel-analysis-container').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }

        formatSlope(slope) {
            if (slope === null || slope === undefined || slope === 'undefined' || slope === 15.0) {
                return '<span class="text-muted">Pending</span>';
            }

            const numSlope = parseFloat(slope);
            if (isNaN(numSlope)) {
                return '<span class="text-muted">Pending</span>';
            }

            return `${numSlope.toFixed(1)}°`;
        }

        generateParcelRows(parcels) {
            if (parcels.length > 0) {
                console.log('=== PARCEL FIELD DEBUG ===');
                console.log('Available fields:', Object.keys(parcels[0]));
                console.log('Sample parcel data:', parcels[0]);
                console.log('========================');
            }

            return parcels.map((parcel, index) => {
                const categoryClass = `category-${parcel.suitability_category.toLowerCase()}`;
                const scoreClass = `score-${parcel.suitability_category.toLowerCase()}`;

                // FIXED: Properly map transmission fields with multiple fallback options
                const txDistanceRaw = parcel.tx_distance_miles ||
                                     parcel.tx_nearest_distance_miles ||
                                     parcel.tx_nearest_distance ||
                                     parcel.transmission_distance ||
                                     null;

                const txVoltageRaw = parcel.tx_voltage_kv ||
                                    parcel.tx_max_voltage_kv ||
                                    parcel.tx_max_voltage ||
                                    parcel.transmission_voltage ||
                                    null;

                // FIXED: Use the formatting functions
                const txDistance = this.formatTransmissionDistance(txDistanceRaw);
                const txVoltage = this.formatTransmissionVoltage(txVoltageRaw);

                return `
                    <tr class="${categoryClass}" data-parcel-index="${index}">
                        <td>
                            <input type="checkbox" class="form-check-input parcel-checkbox"
                                   data-parcel-index="${index}"
                                   ${parcel.recommended_for_outreach ? 'checked' : ''}
                                   onchange="handleParcelCheckbox(${index}, this.checked)">
                        </td>
                        <td onclick="window.bcf.toggleParcelSelection(${index}, event)">
                            <span class="score-badge ${scoreClass}">${parcel.suitability_score}</span>
                        </td>
                        <td onclick="window.bcf.toggleParcelSelection(${index}, event)">
                            <div class="fw-bold">${parcel.owner}</div>
                            <small class="text-muted">${parcel.parcel_id}</small>
                        </td>
                        <td onclick="window.bcf.toggleParcelSelection(${index}, event)">
                            <strong>${parcel.acreage}</strong>
                        </td>
                        <td onclick="window.bcf.toggleParcelSelection(${index}, event)">
                            ${this.formatSlope(parcel.slope_degrees || parcel.avg_slope_degrees || parcel.avg_slope)}
                        </td>
                        <td onclick="window.bcf.toggleParcelSelection(${index}, event)">
                            ${txDistance}
                        </td>
                        <td onclick="window.bcf.toggleParcelSelection(${index}, event)">
                            <span class="transmission-voltage ${this.getVoltageClass(txVoltageRaw)}">
                                ${txVoltage}
                            </span>
                        </td>
                        <td onclick="window.bcf.toggleParcelSelection(${index}, event)">
                            <span class="badge ${scoreClass}">${parcel.suitability_category}</span>
                        </td>
                        <td onclick="event.stopPropagation();">
                            <button class="ai-analyze-btn" onclick="window.bcf.runIndividualAIAnalysis(${index})"
                                    title="Run detailed AI analysis">
                                <i class="fas fa-brain me-1"></i>AI
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Add these helper methods to your BCFWorkflow class
        formatTransmissionDistance(distance) {
            // Handle null, undefined, or invalid values
            if (distance === null || distance === undefined || distance === 'No Data' || distance === 'undefined') {
                return '<span class="text-muted">Outside Buffer</span>';
            }

            const numDistance = parseFloat(distance);
            if (isNaN(numDistance) || numDistance >= 999) {
                return '<span class="text-muted">Outside Buffer</span>';
            }

            // Format valid distances with color coding
            if (numDistance === 0) {
                return '<span class="text-success fw-bold">Intersects</span>';
            } else if (numDistance <= 0.25) {
                return '<span class="text-success">' + numDistance.toFixed(2) + ' mi</span>';
            } else if (numDistance <= 0.5) {
                return '<span class="text-primary">' + numDistance.toFixed(2) + ' mi</span>';
            } else if (numDistance <= 1.0) {
                return '<span class="text-warning">' + numDistance.toFixed(2) + ' mi</span>';
            } else if (numDistance <= 3.0) {
                return '<span class="text-secondary">' + numDistance.toFixed(2) + ' mi</span>';
            } else {
                return '<span class="text-muted">Outside Buffer</span>';
            }
        }

        formatTransmissionVoltage(voltage) {
            // Handle null, undefined, or invalid values
            if (voltage === null || voltage === undefined || voltage === 'No Data' || voltage === 'undefined') {
                return '<span class="text-muted">Outside Buffer</span>';
            }

            const numVoltage = parseFloat(voltage);
            if (isNaN(numVoltage) || numVoltage === 0) {
                return '<span class="text-muted">Outside Buffer</span>';
            }

            // Format valid voltages
            return Math.round(numVoltage) + 'kV';
        }

        getVoltageClass(voltage) {
            const numVoltage = parseFloat(voltage);
            if (isNaN(numVoltage) || numVoltage === 0) {
                return 'voltage-none';
            } else if (numVoltage >= 345) {
                return 'voltage-high';
            } else if (numVoltage >= 138) {
                return 'voltage-medium';
            } else {
                return 'voltage-low';
            }
        }

        // Selection Management Methods
        toggleParcelSelection(index, event) {
            if (event.target.type === 'checkbox') return; // Don't toggle if clicking checkbox directly

            const checkbox = document.querySelector(`[data-parcel-index="${index}"]`);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                this.handleCheckboxChange(index, checkbox.checked);
            }
        }

        handleCheckboxChange(index, isChecked) {
            const row = document.querySelector(`tr[data-parcel-index="${index}"]`);

            if (isChecked) {
                this.selectedParcels.add(index);
                if (row) row.classList.add('selected');
            } else {
                this.selectedParcels.delete(index);
                if (row) row.classList.remove('selected');
            }

            this.updateSelectionUI();
        }

        selectRecommended() {
            this.clearSelection();
            this.allParcels.forEach((parcel, index) => {
                if (parcel.recommended_for_outreach) {
                    const checkbox = document.querySelector(`[data-parcel-index="${index}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        this.handleCheckboxChange(index, true);
                    }
                }
            });
        }

        selectAll() {
            this.allParcels.forEach((parcel, index) => {
                const checkbox = document.querySelector(`[data-parcel-index="${index}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                    this.handleCheckboxChange(index, true);
                }
            });
        }

        clearSelection() {
            this.selectedParcels.clear();
            document.querySelectorAll('.parcel-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.querySelectorAll('tr[data-parcel-index]').forEach(row => {
                row.classList.remove('selected');
            });
            this.updateSelectionUI();
        }

        updateSelectionUI() {
            const selectedCount = this.selectedParcels.size;
            const totalCount = this.allParcels.length;

            // Update selection count
            document.getElementById('selection-count').textContent = selectedCount;
            document.getElementById('outreach-count').textContent = selectedCount;

            // Update outreach button
            const outreachBtn = document.getElementById('initiate-outreach-btn');
            if (outreachBtn) {
                outreachBtn.disabled = selectedCount === 0;
            }

            // Update select-all checkbox state
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            if (selectAllCheckbox) {
                if (selectedCount === 0) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                } else if (selectedCount === totalCount) {
                    selectAllCheckbox.checked = true;
                    selectAllCheckbox.indeterminate = false;
                } else {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = true;
                }
            }
        }

        async initiateOutreach() {
            if (this.selectedParcels.size === 0) {
                alert('Please select at least one parcel for outreach');
                return;
            }

            const selectedParcelData = Array.from(this.selectedParcels).map(index => this.allParcels[index]);

            const confirmation = confirm(
                `Initiate outreach for ${this.selectedParcels.size} selected parcels?\n\n` +
                `This will prepare the parcels for CRM export and outreach management.`
            );

            if (!confirmation) return;

            try {
                this.showLoadingModal('Preparing parcels for outreach...');

                // Here you would call your CRM export functionality
                // For now, show a success message
                await new Promise(resolve => setTimeout(resolve, 2000)); // Simulate processing

                this.hideLoadingModal();

                this.showNotification(
                    `Successfully prepared ${this.selectedParcels.size} parcels for outreach! ` +
                    `Parcels have been added to your CRM for follow-up.`,
                    'success'
                );

            } catch (error) {
                this.hideLoadingModal();
                console.error('Outreach initiation error:', error);
                alert(`Failed to initiate outreach: ${error.message}`);
            }
        }

        async runIndividualAIAnalysis(index) {
            const parcel = this.allParcels[index];

            try {
                this.showLoadingModal(`Running detailed AI analysis for ${parcel.owner || 'Unknown Owner'}...`);

                // Call the new backend endpoint
                const response = await fetch('/api/individual-parcel-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        parcel_data: parcel,
                        county_name: this.currentAnalysis?.county || 'Unknown',
                        state: this.currentState,
                        project_type: this.currentProjectType
                    })
                });

                this.hideLoadingModal();

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Analysis failed');
                }

                // Show AI-powered results
                this.showAIPoweredResults(parcel, result.analysis);

            } catch (error) {
                this.hideLoadingModal();
                console.error('Individual AI analysis error:', error);

                // Fallback to detailed parcel info if API fails
                this.showDetailedParcelInfo(parcel);
            }
        }

        showAIPoweredResults(parcel, analysis) {
            const modalHtml = `
                <div class="modal fade" id="aiAnalysisModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-brain me-2"></i>
                                    AI-Powered Analysis: ${parcel.owner || 'Unknown Owner'}
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <!-- Quick Stats -->
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h3 class="text-primary">${parcel.suitability_score}/100</h3>
                                                <p class="mb-0">Suitability Score</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h3 class="text-success">${parcel.acreage}</h3>
                                                <p class="mb-0">Acres</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h3 class="text-info">${parcel.avg_slope}°</h3>
                                                <p class="mb-0">Average Slope</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- AI Analysis Content -->
                                <div class="card">
                                    <div class="card-header">
                                        <h6><i class="fas fa-robot me-2"></i>AI Development Analysis</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="ai-analysis-content" style="white-space: pre-wrap; line-height: 1.6;">
                                            ${analysis.detailed_analysis || 'Analysis content not available'}
                                        </div>
                                    </div>
                                </div>

                                <!-- Technical Details -->
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <h6>Parcel Details</h6>
                                        <table class="table table-sm">
                                            <tr><td><strong>Parcel ID:</strong></td><td>${parcel.parcel_id || 'N/A'}</td></tr>
                                            <tr><td><strong>Owner:</strong></td><td>${parcel.owner || 'N/A'}</td></tr>
                                            <tr><td><strong>Category:</strong></td><td>
                                                <span class="badge score-${(parcel.suitability_category || 'unknown').toLowerCase()}">
                                                    ${parcel.suitability_category || 'Unknown'}
                                                </span>
                                            </td></tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Infrastructure Metrics</h6>
                                        <table class="table table-sm">
                                            <tr><td><strong>TX Distance:</strong></td><td>${parcel.tx_distance || 'N/A'} miles</td></tr>
                                            <tr><td><strong>TX Voltage:</strong></td><td>${parcel.tx_voltage || 'N/A'} kV</td></tr>
                                            <tr><td><strong>Recommended:</strong></td><td>${parcel.recommended_for_outreach ? 'Yes' : 'No'}</td></tr>
                                        </table>
                                    </div>
                                </div>

                                <div class="alert alert-info mt-3">
                                    <small>
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Analysis Type:</strong> ${analysis.analysis_type || 'AI-Powered'} |
                                        <strong>Generated:</strong> ${new Date(analysis.generated_at || Date.now()).toLocaleString()}
                                    </small>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-success" onclick="window.bcf.addParcelToSelection(${this.allParcels.indexOf(parcel)})">
                                    <i class="fas fa-plus me-2"></i>Add to Selection
                                </button>
                                <button type="button" class="btn btn-primary" onclick="window.bcf.exportIndividualReport('${parcel.parcel_id}')">
                                    <i class="fas fa-file-pdf me-2"></i>Export Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('aiAnalysisModal'));
            modal.show();

            modal._element.addEventListener('hidden.bs.modal', () => {
                document.getElementById('aiAnalysisModal').remove();
            });
        }

        debugParcelData(parcels) {
            console.log('=== FRONTEND PARCEL DEBUG ===');
            if (parcels && parcels.length > 0) {
                const sample = parcels[0];
                console.log('Sample parcel:', sample);
                console.log('tx_distance_miles:', sample.tx_distance_miles);
                console.log('tx_voltage_kv:', sample.tx_voltage_kv);
                console.log('Available fields:', Object.keys(sample));

                // Test the formatting functions directly
                console.log('Formatted distance:', this.formatTransmissionDistance(sample.tx_distance_miles));
                console.log('Formatted voltage:', this.formatTransmissionVoltage(sample.tx_voltage_kv));
            }
            console.log('=============================');
        }

        exportIndividualReport(parcelId) {
            // Generate a simple report for the individual parcel
            const parcel = this.allParcels.find(p => p.parcel_id === parcelId);
            if (!parcel) return;

            const reportContent = `Parcel Analysis Report
Generated: ${new Date().toLocaleDateString()}

Parcel Information:
- ID: ${parcel.parcel_id}
- Owner: ${parcel.owner}
- Size: ${parcel.acreage} acres
- Suitability Score: ${parcel.suitability_score}/100
- Category: ${parcel.suitability_category}

Technical Metrics:
- Average Slope: ${parcel.avg_slope}°
- Transmission Distance: ${parcel.tx_distance} miles
- Transmission Voltage: ${parcel.tx_voltage} kV

Recommendation: ${parcel.recommended_for_outreach ? 'Recommended for outreach' : 'Not currently recommended'}
            `;

            // Download as text file
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `parcel_report_${parcelId}_${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            this.showNotification('Individual parcel report exported', 'success');
        }

        showDetailedParcelInfo(parcel) {
            // Fallback detailed view if backend API isn't ready
            const modalHtml = `
                <div class="modal fade" id="parcelDetailModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-info text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-map-marker-alt me-2"></i>
                                    Parcel Details: ${parcel.owner || 'Unknown Owner'}
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Basic Information</h6>
                                        <table class="table table-sm">
                                            <tr><td><strong>Parcel ID:</strong></td><td>${parcel.parcel_id || 'N/A'}</td></tr>
                                            <tr><td><strong>Owner:</strong></td><td>${parcel.owner || 'N/A'}</td></tr>
                                            <tr><td><strong>Acreage:</strong></td><td>${parcel.acreage || 'N/A'} acres</td></tr>
                                            <tr><td><strong>Suitability Score:</strong></td><td>${parcel.suitability_score || 'N/A'}/100</td></tr>
                                            <tr><td><strong>Category:</strong></td><td>
                                                <span class="badge score-${(parcel.suitability_category || 'unknown').toLowerCase()}">
                                                    ${parcel.suitability_category || 'Unknown'}
                                                </span>
                                            </td></tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Analysis Factors</h6>
                                        <table class="table table-sm">
                                            <tr><td><strong>Average Slope:</strong></td><td>${parcel.avg_slope || 'N/A'}°</td></tr>
                                            <tr><td><strong>TX Distance:</strong></td><td>${parcel.tx_distance || 'N/A'} miles</td></tr>
                                            <tr><td><strong>TX Voltage:</strong></td><td>${parcel.tx_voltage || 'N/A'} kV</td></tr>
                                            <tr><td><strong>Recommended:</strong></td><td>${parcel.recommended_for_outreach ? 'Yes' : 'No'}</td></tr>
                                        </table>
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <h6>Development Assessment</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <strong>Slope Suitability:</strong><br>
                                            <small>${this.getSlopeSuitability(parcel.avg_slope)}</small>
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Grid Access:</strong><br>
                                            <small>${this.getGridAccessRating(parcel.tx_distance)}</small>
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Project Scale:</strong><br>
                                            <small>${this.getProjectScale(parcel.acreage)} MW potential</small>
                                        </div>
                                    </div>
                                </div>

                                <div class="alert alert-info mt-3">
                                    <h6><i class="fas fa-info-circle me-2"></i>Analysis Note</h6>
                                    <p class="mb-0">This parcel has been analyzed using slope and transmission proximity data.
                                    For enhanced AI-powered analysis including market conditions, regulatory environment,
                                    and detailed development recommendations, the individual AI analysis API is being developed.</p>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-success" onclick="window.bcf.addParcelToSelection(${this.allParcels.indexOf(parcel)})">
                                    <i class="fas fa-plus me-2"></i>Add to Selection
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('parcelDetailModal'));
            modal.show();

            modal._element.addEventListener('hidden.bs.modal', () => {
                document.getElementById('parcelDetailModal').remove();
            });
        }

        getSlopeSuitability(slope) {
            if (!slope) return 'Unknown';
            if (slope <= 5) return 'Excellent (minimal grading)';
            if (slope <= 10) return 'Very Good (light grading)';
            if (slope <= 15) return 'Good (moderate grading)';
            if (slope <= 25) return 'Challenging (extensive grading)';
            return 'Poor (major earthwork required)';
        }

        getGridAccessRating(distance) {
            if (!distance) return 'Unknown';
            if (distance <= 0.5) return 'Excellent (< 0.5 mi)';
            if (distance <= 1) return 'Very Good (< 1 mi)';
            if (distance <= 2) return 'Good (< 2 mi)';
            if (distance <= 5) return 'Fair (< 5 mi)';
            return 'Poor (> 5 mi)';
        }

        addParcelToSelection(index) {
            const checkbox = document.querySelector(`[data-parcel-index="${index}"]`);
            if (checkbox && !checkbox.checked) {
                checkbox.checked = true;
                this.handleCheckboxChange(index, true);
                this.showNotification('Parcel added to selection', 'success');
            }

            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('parcelDetailModal'));
            if (modal) modal.hide();
        }

        exportParcelData() {
            if (!this.allParcels || this.allParcels.length === 0) {
                alert('No parcel data to export');
                return;
            }

            // Create CSV export
            const headers = ['parcel_id', 'owner', 'acreage', 'avg_slope', 'tx_distance', 'tx_voltage', 'suitability_score', 'suitability_category', 'recommended_for_outreach'];

            let csvContent = headers.join(',') + '\n';

            this.allParcels.forEach(parcel => {
                const row = headers.map(header => {
                    let value = parcel[header] || '';
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        value = '"' + value.replace(/"/g, '""') + '"';
                    }
                    return value;
                });
                csvContent += row.join(',') + '\n';
            });

            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `parcel_analysis_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            this.showNotification('Parcel data exported successfully!', 'success');
        }

        backToCountySelection() {
            const analysisContainer = document.getElementById('parcel-analysis-container');
            const countyScreen = document.getElementById('county-rankings-screen');

            if (analysisContainer) analysisContainer.style.display = 'none';
            if (countyScreen) countyScreen.style.display = 'block';
        }

        async downloadFile(filePath, fileName) {
            try {
                console.log(`Downloading file: ${fileName}`);

                // Create a temporary link to trigger download
                const link = document.createElement('a');
                link.href = `/api/download-file?path=${encodeURIComponent(filePath)}`;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Show success message
                this.showNotification(`Download started: ${fileName}`, 'success');

            } catch (error) {
                console.error('Download error:', error);
                alert(`Failed to download file: ${error.message}`);
            }
        }

        proceedWithExistingData(countyName) {
            const selectedFile = document.querySelector('input[name="selectedFile"]:checked');
            if (!selectedFile) {
                alert('Please select a file first');
                return;
            }

            const fileIndex = parseInt(selectedFile.value);
            console.log(`Proceeding with existing data for ${countyName}, file index: ${fileIndex}`);

            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('existingFilesModal'));
            if (modal) modal.hide();

            // Show success message
            this.showNotification(`Loading existing data for ${countyName}...`, 'info');

            // Here you would load the selected file and proceed to analysis
            // For now, show a placeholder
            setTimeout(() => {
                alert(`This would load the selected file and proceed to parcel analysis.\n\nFile selected: ${fileIndex}\nCounty: ${countyName}\n\nNext: Load CSV data and show analysis interface.`);
            }, 1500);
        }

        showNotification(message, type = 'info') {
            // Remove existing notifications
            document.querySelectorAll('.notification-toast').forEach(n => n.remove());

            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'warning': 'alert-warning',
                'info': 'alert-info'
            }[type] || 'alert-info';

            const notification = document.createElement('div');
            notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed notification-toast`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 350px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(notification);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
    }

    console.log('BCFWorkflow class defined successfully');

    function initBCF() {
        console.log('Creating BCFWorkflow instance...');
        try {
            bcf = new BCFWorkflow();
            window.bcf = bcf;

            // NEW: Verify the function is properly attached
            console.log('✅ BCF instance created');
            console.log('displayAIMarketAnalysisResults bound:', typeof bcf.displayAIMarketAnalysisResults);
            console.log('Available methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(bcf)).filter(name => typeof bcf[name] === 'function'));

            // Debug: Check if methods exist
            console.log('Methods check:', {
                analyzeExistingFile: typeof bcf.analyzeExistingFile,
                proceedWithExistingData: typeof bcf.proceedWithExistingData,
                showNotification: typeof bcf.showNotification
            });

            const form = document.getElementById('state-selection-form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();

                    const state = document.getElementById('target-state').value;
                    const projectType = document.getElementById('project-type-start').value;

                    if (!state || !projectType) {
                        alert('Please select both state and project type');
                        return;
                    }

                    console.log('Form submitted with:', { state, projectType });

                    // Set the current values immediately
                    bcf.currentState = state;
                    bcf.currentProjectType = projectType;

                    // Call with parameters
                    bcf.analyzeStateCounties(state, projectType);
                });
                console.log('Form handler attached');
            }

            const countySelect = document.getElementById('target-county');
            if (countySelect) {
                countySelect.addEventListener('change', function() {
                    const hasSelection = this.value !== '';
                    const findBtn = document.getElementById('find-parcels-btn-alt');
                    const researchBtn = document.getElementById('research-areas-btn-alt');

                    if (findBtn) findBtn.disabled = !hasSelection;
                    if (researchBtn) researchBtn.disabled = !hasSelection;
                });
            }

        } catch (error) {
            console.error('Error creating BCF instance:', error);
            console.error('Stack:', error.stack);
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initBCF);
    } else {
        initBCF();
    }

} catch (classError) {
    console.error('Error defining BCFWorkflow class:', classError);
    console.error('Class definition error stack:', classError.stack);
    alert('JavaScript class definition error: ' + classError.message);
}

console.log('Script completed');
</script>
</body>
</html>