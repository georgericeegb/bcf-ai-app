<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Renewable Energy Project Analyzer</title>
    <!-- Add this to your existing index.html template -->
    <div class="user-info" style="position: absolute; top: 10px; right: 20px;">
        <span>Welcome, {{ current_user }}!</span>
        <a href="/logout" class="btn btn-sm btn-outline-secondary ms-2">Logout</a>
    </div>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .analysis-section { margin: 20px 0; }
        .variable-card { margin: 10px 0; }
        .loading { display: none; }
        .results { margin-top: 20px; }

        /* Enhanced Workflow CSS */
        .workflow-step {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn-option {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .btn-option:hover {
            border-color: #0d6efd;
            background: #f8f9fa;
        }

        .btn-option.selected {
            border-color: #0d6efd;
            background: #0d6efd;
            color: white;
        }

        .tier-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .tier-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .tier-card:hover {
            border-color: #0d6efd;
        }

        .tier-card.selected {
            border-color: #0d6efd;
            background: #f8f9fa;
        }

        .criteria-selection {
            display: grid;
            gap: 10px;
            margin-bottom: 20px;
        }

        .criteria-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .criteria-card:hover {
            border-color: #198754;
        }

        .criteria-card.selected {
            border-color: #198754;
            background: #f8fff8;
        }

        .selection-indicator {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .criteria-card.selected .selection-indicator {
            background: #198754;
            color: white;
        }

        .step-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .criteria-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .criteria-tag {
            background: #0d6efd;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 14px;
        }

        /* County loading styles */
        #county-loading {
            display: flex;
            align-items: center;
        }

        .form-label {
            font-weight: 600;
            color: #495057;
        }

        .form-select:disabled,
        .form-control:disabled {
            background-color: #f8f9fa;
            border-color: #dee2e6;
            opacity: 0.65;
        }

        /* Location selection improvements */
        .location-selection .mb-3 {
            position: relative;
        }

        .location-selection .form-select,
        .location-selection .form-control {
            transition: all 0.3s ease;
        }

        .location-selection .form-select:focus,
        .location-selection .form-control:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }

        /* File Download/Preview Styling */
        .file-actions {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .file-actions .btn {
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .file-actions .btn i {
            font-size: 1.2em;
        }

        .file-actions .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .file-type-label {
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-group .dropdown-menu {
            min-width: 200px;
        }

        .btn-group .dropdown-menu .dropdown-item {
            padding: 10px 16px;
            transition: all 0.2s ease;
        }

        .btn-group .dropdown-menu .dropdown-item:hover {
            background-color: #f8f9fa;
            transform: translateX(4px);
        }

        /* Analysis Results Container */
        .suitability-results-container {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Summary Statistics */
        .suitability-summary h3 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 24px;
            font-weight: 600;
            text-align: center;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #3498db;
        }

        .stat-value {
            display: block;
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            display: block;
            font-size: 14px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Button Styles */
        .analyze-suitability-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71) !important;
            color: white !important;
            border: none !important;
            padding: 12px 24px !important;
            border-radius: 6px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            font-size: 16px !important;
            width: 100% !important;
        }

        .analyze-suitability-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #219a52, #27ae60) !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3) !important;
        }

        .analyze-suitability-btn:disabled {
            background: #bdc3c7 !important;
            cursor: not-allowed !important;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Progress Indicator */
        .analysis-progress {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            text-align: center;
            z-index: 1000;
        }

        .analysis-progress::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: -1;
        }

        .progress-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .analysis-progress p {
            margin: 0;
            color: #2c3e50;
            font-weight: 500;
        }

        /* Notification Styles */
        .notification {
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .tier-options {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .step-actions {
                flex-direction: column;
                gap: 10px;
            }

            .location-selection {
                padding: 0 10px;
            }

            .criteria-tags {
                justify-content: center;
            }

            .file-actions .row > div {
                margin-bottom: 10px;
            }

            .file-actions .btn {
                min-height: 45px;
                font-size: 0.9em;
            }

            .suitability-results-container {
                margin: 20px 10px;
                padding: 15px;
            }

            .summary-stats {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .stat-value {
                font-size: 24px;
            }
        }

        /* Print Styles */
        @media print {
            .analysis-progress,
            .notification {
                display: none !important;
            }
        }

        /* Suitability Results Styling */
        .suitability-results-container {
            margin-top: 30px;
            animation: slideInUp 0.5s ease-out;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Summary Statistics Enhanced */
        .suitability-summary {
            margin-bottom: 30px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-item {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #0d6efd;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-value {
            display: block;
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .stat-label {
            display: block;
            font-size: 13px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
        }

        /* Table Enhancements */
        #suitability-table {
            font-size: 0.9rem;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #suitability-table thead th {
            background: linear-gradient(135deg, #343a40 0%, #495057 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.8rem;
            padding: 15px 10px;
            border: none;
        }

        #suitability-table tbody tr {
            transition: all 0.2s ease;
        }

        #suitability-table tbody tr:hover {
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .table-success {
            background-color: rgba(25, 135, 84, 0.1) !important;
            border-left: 4px solid #198754;
        }

        .table-warning {
            background-color: rgba(255, 193, 7, 0.1) !important;
            border-left: 4px solid #ffc107;
        }

        /* Badge Styling */
        .badge {
            font-size: 0.8rem;
            padding: 6px 10px;
            border-radius: 15px;
            font-weight: 600;
        }

        /* Filter Controls */
        .form-range {
            background: linear-gradient(to right, #e9ecef 0%, #0d6efd 0%);
        }

        .form-range::-webkit-slider-thumb {
            background: #0d6efd;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .form-range::-moz-range-thumb {
            background: #0d6efd;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Progress Indicator Enhanced */
        .analysis-progress {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
            z-index: 1000;
            min-width: 300px;
        }

        .analysis-progress::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: -1;
            backdrop-filter: blur(2px);
        }

        .progress-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #0d6efd;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .analysis-progress p {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-weight: 600;
            font-size: 18px;
        }

        .analysis-progress small {
            color: #6c757d;
            font-size: 14px;
        }

        /* Modal Enhancements */
        .modal-dialog {
            max-width: 800px;
        }

        .modal-header {
            background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
            color: white;
            border-radius: 0.375rem 0.375rem 0 0;
        }

        .modal-title {
            font-weight: 600;
        }

        .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }

        /* Button Improvements */
        .btn {
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-sm {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }

        /* Alert Enhancements */
        .alert {
            border-radius: 10px;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .alert-success {
            background: linear-gradient(135deg, #d1edff 0%, #e8f7e8 100%);
            color: #0f5132;
            border-left: 4px solid #198754;
        }

        .alert-danger {
            background: linear-gradient(135deg, #f8d7da 0%, #ffeaa7 100%);
            color: #842029;
            border-left: 4px solid #dc3545;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stat-value {
                font-size: 24px;
            }

            #suitability-table {
                font-size: 0.8rem;
            }

            #suitability-table th,
            #suitability-table td {
                padding: 8px 5px;
            }

            .analysis-progress {
                padding: 30px 20px;
                min-width: 280px;
            }

            .modal-dialog {
                margin: 10px;
                max-width: none;
            }
        }

        @media (max-width: 576px) {
            .summary-stats {
                grid-template-columns: 1fr;
            }

            .stat-item {
                padding: 15px;
            }

            .table-responsive {
                border-radius: 8px;
            }

            #suitability-table th:nth-child(n+6),
            #suitability-table td:nth-child(n+6) {
                display: none;
            }
        }

        /* Loading States */
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Accessibility Improvements */
        .badge:focus,
        .btn:focus,
        .form-select:focus,
        .form-range:focus {
            outline: 2px solid #0d6efd;
            outline-offset: 2px;
        }

        /* Print Styles */
        @media print {
            .analysis-progress,
            .btn,
            .modal {
                display: none !important;
            }

            .table {
                font-size: 10px;
            }

            .stat-item {
                break-inside: avoid;
            }
        }

        /* BCF.ai Branding */
        .text-gradient {
            background: linear-gradient(45deg, #007bff, #28a745);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero-logo {
            animation: fadeInUp 1s ease-out;
        }

        .feature-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid #e0e0e0;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .feature-icon {
            font-size: 2.5rem;
        }

        .county-ranking-card {
            transition: all 0.3s ease;
        }

        .county-ranking-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .ranking-badge {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .ranking-1 { background: linear-gradient(45deg, #FFD700, #FFA500); color: white; }
        .ranking-2 { background: linear-gradient(45deg, #C0C0C0, #A0A0A0); color: white; }
        .ranking-3 { background: linear-gradient(45deg, #CD7F32, #B8860B); color: white; }
        .ranking-other { background: linear-gradient(45deg, #6c757d, #495057); color: white; }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* County List Styling */
        .county-row {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .county-row:hover {
            background-color: rgba(0, 123, 255, 0.1) !important;
        }

        .county-row.table-primary {
            background-color: rgba(0, 123, 255, 0.2) !important;
            border-left: 4px solid #007bff;
        }

        .select-county-btn {
            transition: all 0.2s ease;
        }

        .select-county-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Activity badges */
        .badge {
            font-size: 0.75rem;
        }

        /* Ranking numbers */
        .table td:first-child {
            font-weight: bold;
            text-align: center;
        }

        /* Enhanced table styling */
        .table-responsive {
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .table thead th {
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
        }

        .research-criteria-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .research-criteria-card {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .research-criteria-card:hover {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }

        .research-criteria-card input:checked + label {
            color: #0d6efd;
        }

        .research-criteria-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .research-criteria-card {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .research-criteria-card:hover {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }

        .research-criteria-card input:checked + label {
            color: #0d6efd;
        }

        .bg-light-success {
            background-color: #d1edff !important;
        }

        .card.border-success {
            border-color: #198754 !important;
        }

        .card-header[style*="cursor: pointer"]:hover {
            background-color: #c3e6cb !important;
        }

        #past-data-chevron {
            transition: transform 0.3s ease;
        }

        /* Suitability Analysis Enhancements */
        .table-excellent {
            background-color: rgba(25, 135, 84, 0.1) !important;
            border-left: 4px solid #198754;
        }

        .table-good {
            background-color: rgba(13, 110, 253, 0.1) !important;
            border-left: 4px solid #0d6efd;
        }

        .table-fair {
            background-color: rgba(255, 193, 7, 0.1) !important;
            border-left: 4px solid #ffc107;
        }

        .table-poor {
            background-color: rgba(220, 53, 69, 0.1) !important;
            border-left: 4px solid #dc3545;
        }

        .hidden {
            display: none !important;
        }

        /* Selection controls styling */
        #selection-controls {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #selection-controls h6 {
            color: #495057;
            font-weight: 600;
        }

        #selection-controls .btn-group .btn {
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        #selection-controls .btn-group .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        /* Checkbox styling */
        .parcel-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .parcel-checkbox:checked {
            background-color: #198754;
            border-color: #198754;
        }

        .parcel-checkbox:hover {
            transform: scale(1.1);
        }

        /* Select-all checkbox styling */
        #select-all-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        #select-all-checkbox:indeterminate {
            background-color: #ffc107;
            border-color: #ffc107;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3e%3cpath fill='none' stroke='%23fff' stroke-linecap='round' stroke-linejoin='round' stroke-width='3' d='M6 10h8'/%3e%3c/svg%3e");
        }

        /* Enhanced table row styling for selection */
        .table tbody tr {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .table tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.05);
            transform: translateX(2px);
            box-shadow: -3px 0 0 #007bff;
        }

        /* Selected row styling */
        .table tbody tr:has(.parcel-checkbox:checked) {
            background-color: rgba(25, 135, 84, 0.1);
            border-left: 4px solid #198754;
        }

        .table tbody tr:has(.parcel-checkbox:checked):hover {
            background-color: rgba(25, 135, 84, 0.15);
            box-shadow: -3px 0 0 #198754;
        }

        /* Selection summary styling */
        #selection-summary {
            padding: 15px;
            border-radius: 6px;
            background: white;
            border: 1px solid #e9ecef;
        }

        #selection-count {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        #selection-details {
            font-weight: 500;
        }

        /* Table footer enhancements */
        .card-footer {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-top: 1px solid #dee2e6;
        }

        #table-footer-summary {
            font-weight: 500;
        }

        /* Category badge enhancements */
        .table-excellent {
            background: linear-gradient(135deg, rgba(25, 135, 84, 0.08) 0%, rgba(25, 135, 84, 0.12) 100%);
            border-left: 4px solid #198754;
        }

        .table-good {
            background: linear-gradient(135deg, rgba(13, 110, 253, 0.08) 0%, rgba(13, 110, 253, 0.12) 100%);
            border-left: 4px solid #0d6efd;
        }

        .table-fair {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.08) 0%, rgba(255, 193, 7, 0.12) 100%);
            border-left: 4px solid #ffc107;
        }

        .table-poor {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.08) 0%, rgba(220, 53, 69, 0.12) 100%);
            border-left: 4px solid #dc3545;
        }

        /* Export button enhancements */
        #exportToCrmBtn {
            transition: all 0.3s ease;
            min-width: 200px;
        }

        #exportToCrmBtn:not(:disabled):hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        #exportToCrmBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Selection controls button animations */
        .btn-outline-success:hover {
            background: linear-gradient(135deg, #198754 0%, #20c997 100%);
            border-color: #198754;
            transform: translateY(-1px);
        }

        .btn-outline-primary:hover {
            background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);
            border-color: #0d6efd;
            transform: translateY(-1px);
        }

        .btn-outline-secondary:hover {
            background: linear-gradient(135deg, #6c757d 0%, #adb5bd 100%);
            border-color: #6c757d;
            transform: translateY(-1px);
        }

        .btn-outline-danger:hover {
            background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
            border-color: #dc3545;
            transform: translateY(-1px);
        }

        /* Modal enhancements for selection statistics */
        .modal-content {
            border: none;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            border-radius: 12px 12px 0 0;
            background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);
            color: white;
        }

        /* Responsive design for selection controls */
        @media (max-width: 768px) {
            #selection-controls .row {
                flex-direction: column;
                gap: 15px;
            }

            #selection-controls .btn-group {
                width: 100%;
            }

            #selection-controls .btn-group .btn {
                flex: 1;
                font-size: 0.8rem;
                padding: 8px 12px;
            }

            #selection-summary {
                text-align: center;
                margin-top: 15px;
            }

            #exportToCrmBtn {
                width: 100%;
                margin-top: 10px;
                margin-left: 0 !important;
            }
        }

        /* Accessibility improvements */
        .parcel-checkbox:focus,
        #select-all-checkbox:focus {
            outline: 2px solid #0d6efd;
            outline-offset: 2px;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }

        /* Loading state for export button */
        #exportToCrmBtn .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }

        /* Selection controls fade-in animation */
        #selection-controls {
            animation: slideInDown 0.5s ease-out;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Table row click interaction */
        .table tbody tr {
            user-select: none;
        }

        .table tbody tr:active {
            background-color: rgba(0, 123, 255, 0.1);
            transform: scale(0.995);
        }

        /* Disabled state styles */
        .analysis-completed .btn,
        .analysis-completed input,
        .analysis-completed select,
        .analysis-completed .county-row {
            opacity: 0.5 !important;
            pointer-events: none !important;
            cursor: not-allowed !important;
        }

        .analysis-completed-overlay {
            backdrop-filter: blur(1px);
        }

        /* Keep the analysis completed message above overlay */
        #analysis-completed-message {
            z-index: 10000 !important;
        }

        /* Ensure modal stays above everything */
        .modal {
            z-index: 10001 !important;
        }

        .modal-backdrop {
            z-index: 10000 !important;
        }

    </style>
</head>
<body>
    <!-- BCF.ai Landing Screen -->
    <div id="start-screen" class="workflow-step active">
        <div class="container-fluid">
            <div class="row justify-content-center">
                <div class="col-lg-8">

                    <!-- BCF.ai Header -->
                    <div class="text-center mb-5">
                        <div class="hero-logo mb-4">
                            <h1 class="display-4 fw-bold text-primary">
                                <span class="text-gradient">BCF.ai</span>
                            </h1>
                            <p class="lead text-muted">AI-Powered Renewable Energy Land Discovery</p>
                        </div>

                        <div class="hero-description">
                            <h2 class="h4 mb-3">Find the Best Land for Your Renewable Energy Projects</h2>
                            <p class="fs-5 text-secondary mb-4">
                                BCF.ai uses artificial intelligence to analyze markets, identify optimal locations,
                                and find landowners ready for renewable energy development.
                            </p>

                            <div class="row g-4 mb-5">
                                <div class="col-md-4">
                                    <div class="feature-card h-100 p-4 bg-light rounded-3">
                                        <div class="feature-icon mb-3">🤖</div>
                                        <h5>AI Market Analysis</h5>
                                        <p class="small text-muted">Smart county rankings based on renewable energy friendliness</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="feature-card h-100 p-4 bg-light rounded-3">
                                        <div class="feature-icon mb-3">🎯</div>
                                        <h5>Targeted Outreach</h5>
                                        <p class="small text-muted">Find and contact the right landowners with ML-enhanced scoring</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="feature-card h-100 p-4 bg-light rounded-3">
                                        <div class="feature-icon mb-3">📊</div>
                                        <h5>Outreach Integration</h5>
                                        <p class="small text-muted">Seamless workflow from analysis to outreach management</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- State Selection ONLY -->
                    <div class="state-selection-container">
                        <div class="card border-primary shadow-sm">
                            <div class="card-body p-5">
                                <div class="text-center mb-4">
                                    <h3 class="card-title mb-3">🗺️ Choose Your Target State</h3>
                                    <p class="text-muted">Select a state to begin AI-powered market analysis and county rankings</p>
                                </div>

                                <form id="state-selection-form">
                                    <div class="row justify-content-center">
                                        <div class="col-md-8">
                                            <div class="mb-4">
                                                <label for="target-state" class="form-label fw-bold">Target State</label>
                                                <select class="form-select form-select-lg" id="target-state" required>
                                                    <option value="">Select a state...</option>
                                                    <option value="AL">Alabama</option>
                                                    <option value="AZ">Arizona</option>
                                                    <option value="AR">Arkansas</option>
                                                    <option value="CA">California</option>
                                                    <option value="CO">Colorado</option>
                                                    <option value="FL">Florida</option>
                                                    <option value="GA">Georgia</option>
                                                    <option value="IL">Illinois</option>
                                                    <option value="IN">Indiana</option>
                                                    <option value="IA">Iowa</option>
                                                    <option value="KS">Kansas</option>
                                                    <option value="KY">Kentucky</option>
                                                    <option value="LA">Louisiana</option>
                                                    <option value="MI">Michigan</option>
                                                    <option value="MN">Minnesota</option>
                                                    <option value="MS">Mississippi</option>
                                                    <option value="MO">Missouri</option>
                                                    <option value="NE">Nebraska</option>
                                                    <option value="NV">Nevada</option>
                                                    <option value="NM">New Mexico</option>
                                                    <option value="NY">New York</option>
                                                    <option value="NC">North Carolina</option>
                                                    <option value="ND">North Dakota</option>
                                                    <option value="OH">Ohio</option>
                                                    <option value="OK">Oklahoma</option>
                                                    <option value="PA">Pennsylvania</option>
                                                    <option value="SC">South Carolina</option>
                                                    <option value="SD">South Dakota</option>
                                                    <option value="TN">Tennessee</option>
                                                    <option value="TX">Texas</option>
                                                    <option value="UT">Utah</option>
                                                    <option value="VA">Virginia</option>
                                                    <option value="WV">West Virginia</option>
                                                    <option value="WI">Wisconsin</option>
                                                    <option value="WY">Wyoming</option>
                                                </select>
                                            </div>

                                            <div class="mb-4">
                                                <label for="project-type-start" class="form-label fw-bold">Project Type</label>
                                                <select class="form-select form-select-lg" id="project-type-start" required>
                                                    <option value="">Select project type...</option>
                                                    <option value="solar">Solar Energy</option>
                                                    <option value="wind">Wind Energy</option>
                                                    <option value="battery">Battery Storage</option>
                                                    <option value="mixed">Mixed Renewable</option>
                                                </select>
                                            </div>

                                            <div class="text-center">
                                                <button type="submit" class="btn btn-primary btn-lg px-5" id="analyze-state-btn">
                                                    <span class="btn-text">🚀 Analyze State</span>
                                                    <span class="spinner-border spinner-border-sm d-none ms-2" role="status"></span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- County Rankings Screen -->
    <div id="county-rankings-screen" class="workflow-step" style="display: none;">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">

                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2 class="mb-1">
                                🏆 <span id="state-name-display">State</span> County Rankings
                            </h2>
                            <p class="text-muted mb-0">AI-powered analysis of renewable energy development potential</p>
                        </div>
                        <button class="btn btn-outline-secondary" onclick="workflow.goBackToStart()">
                            ← Back to State Selection
                        </button>
                    </div>

                    <!-- County Rankings Results -->
                    <div id="county-rankings-container">
                        <!-- Will be populated by JavaScript -->
                    </div>

                    <!-- County Selection -->
                    <div class="card mt-4">
                        <div class="card-body">
                            <h4 class="card-title mb-3">📍 Select Target County</h4>
                            <div class="row align-items-end">
                                <div class="col-md-8">
                                    <label for="target-county" class="form-label">Choose County for Detailed Analysis</label>
                                    <select class="form-select" id="target-county">
                                        <option value="">Select a county...</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <div class="btn-group w-100" role="group">
                                        <button type="button" class="btn btn-success" id="find-parcels-btn" disabled>
                                            🎯 Find Parcels
                                        </button>
                                        <button type="button" class="btn btn-primary" id="research-areas-btn" disabled>
                                            🔬 Research Areas
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
<script>
// BCF.AI WORKFLOW - LAST WORKING VERSION

console.log('Script starting...');

try {
    console.log('Defining BCFWorkflow class...');

    class BCFWorkflow {
        constructor() {
            console.log('BCFWorkflow constructor called');
            this.currentState = null;
            this.currentProjectType = null;
            this.currentStateAnalysis = null;
            this.currentCountyActivity = {};
            this.currentPage = 1;
            this.countiesPerPage = 50;
            this.allCounties = [];
            this.aiAnalysisCompleted = false;

            // Prevent accidental page navigation during modal operations
            window.addEventListener('beforeunload', (e) => {
                if (this.isProcessingFileAnalysis) {
                    e.preventDefault();
                    e.returnValue = 'Analysis in progress. Are you sure you want to leave?';
                }
            });

            console.log('BCFWorkflow constructor completed');
        }

        // In your form submission or initial setup:
        startAnalysis() {
            const state = document.getElementById('state-select').value;
            const projectType = document.getElementById('project-type-select').value;

            // Validate inputs
            if (!state || !projectType) {
                alert('Please select both state and project type');
                return;
            }

            // Store immediately
            this.currentState = state;
            this.currentProjectType = projectType;

            console.log('Starting analysis with:', { state, projectType });

            // Proceed with analysis
            this.analyzeState(state, projectType);
        }

        proceedToAreaResearch(countyFips, countyName, activity) {
            console.log(`Proceeding to area research for ${countyName}`);

            // Show research options dialog
            this.showResearchOptionsDialog(countyFips, countyName, activity);
        }

        showResearchOptionsDialog(countyFips, countyName, activity) {
            const modalHtml = `
                <div class="modal fade" id="researchOptionsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Research Options: ${countyName} County</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-${activity.has_activity ? '6' : '12'}">
                                        <div class="card h-100 border-success">
                                            <div class="card-body text-center">
                                                <div class="mb-3">
                                                    <i class="fas fa-brain fa-3x text-success"></i>
                                                </div>
                                                <h5 class="card-title">AI Market Analysis</h5>
                                                <p class="card-text">Get AI-powered insights on market conditions, development potential, regulatory environment, and strategic recommendations for ${countyName} County.</p>
                                                <button class="btn btn-success" onclick="bcf.runAIMarketAnalysis('${countyFips}', '${countyName}'); bootstrap.Modal.getInstance(document.getElementById('researchOptionsModal')).hide();">
                                                    <i class="fas fa-chart-line me-2"></i>Analyze Market with AI
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    ${activity.has_activity ? `
                                        <div class="col-md-6">
                                            <div class="card h-100 border-warning">
                                                <div class="card-body text-center">
                                                    <div class="mb-3">
                                                        <i class="fas fa-folder-open fa-3x text-warning"></i>
                                                    </div>
                                                    <h5 class="card-title">Use Existing Data</h5>
                                                    <p class="card-text">This county has ${activity.folder_count} existing project files. Review and analyze previous parcel data to save time and costs.</p>
                                                    <button class="btn btn-warning" onclick="bcf.showExistingDataFiles('${countyFips}', '${countyName}'); bootstrap.Modal.getInstance(document.getElementById('researchOptionsModal')).hide();">
                                                        <i class="fas fa-folder-open me-2"></i>Browse Existing Files
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    ` : `
                                        <div class="col-md-12">
                                            <div class="alert alert-info mt-3">
                                                <h6><i class="fas fa-info-circle me-2"></i>No Existing Data Found</h6>
                                                <p class="mb-0">This county has no previous project data. Use the "Find Parcels" button from the main screen to search for land parcels, or run AI analysis to understand market conditions first.</p>
                                            </div>
                                        </div>
                                    `}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <small class="text-muted me-auto">Use "Find Parcels" button on the main screen to search for land parcels</small>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('researchOptionsModal'));
            modal.show();

            modal._element.addEventListener('hidden.bs.modal', () => {
                document.getElementById('researchOptionsModal').remove();
            });
        }

        navigateToParcelSearch(countyFips, countyName) {
            console.log(`Navigating to parcel search for ${countyName}`);

            // Close the AI results modal
            bootstrap.Modal.getInstance(document.getElementById('aiResultsModal')).hide();

            setTimeout(() => {
                // Remove the modal
                const modalElement = document.getElementById('aiResultsModal');
                if (modalElement) {
                    modalElement.remove();
                }

                // Set up the county selection and navigate
                const activity = (this.currentCountyActivity && this.currentCountyActivity[countyFips]) || { has_activity: false };

                // Hide current screens
                const countyScreen = document.getElementById('county-rankings-screen');
                if (countyScreen) {
                    countyScreen.style.display = 'none';
                }

                // Remove any existing parcel search screens
                const existingParcelScreen = document.getElementById('parcel-search-screen');
                if (existingParcelScreen) {
                    existingParcelScreen.remove();
                }

                // Set up analysis data
                this.currentAnalysis = {
                    state: this.currentState,
                    county: countyName,
                    county_id: countyFips,
                    project_type: this.currentProjectType,
                    location: `${countyName}, ${this.getStateName(this.currentState)}`,
                    analysis_level: 'county',
                    has_past_activity: activity.has_activity,
                    activity_data: activity
                };

                // Show parcel search interface
                this.showParcelSearchInterface();

                // CRITICAL: Re-initialize the parcel search handlers after DOM is ready
                setTimeout(() => {
                    this.initializeParcelSearch();

                    // Ensure form elements are enabled
                    const form = document.getElementById('parcel-search-form');
                    const previewBtn = document.getElementById('preview-count-btn');
                    const searchBtn = document.getElementById('search-parcels-btn');

                    if (form) {
                        const inputs = form.querySelectorAll('input, select, button');
                        inputs.forEach(input => {
                            input.disabled = false;
                        });
                    }

                    if (previewBtn) {
                        previewBtn.disabled = false;
                        console.log('Preview button re-enabled');
                    }

                    if (searchBtn) {
                        searchBtn.disabled = false;
                        console.log('Search button re-enabled');
                    }

                    console.log('Parcel search form re-initialized and enabled');

                }, 200);

            }, 300);
        }

        showRealAIAnalysisResults(analysis, countyName, countyFips) {
            console.log('Displaying REAL AI analysis results for', countyName);

            // Check if county has existing activity
            const hasExistingActivity = this.currentCountyActivity &&
                                       this.currentCountyActivity[countyFips] &&
                                       this.currentCountyActivity[countyFips].has_activity;

            const modalHtml = `
                <div class="modal fade" id="aiResultsModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">AI Market Analysis: ${countyName} County</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-success">
                                    <i class="fas fa-robot me-2"></i>
                                    <strong>AI-Powered Analysis:</strong> This analysis was generated using advanced AI algorithms analyzing market data, regulatory factors, and development potential.
                                </div>

                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h3 class="text-primary">${analysis.overall_score}/100</h3>
                                                <p class="mb-0">Overall Market Score</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h3 class="text-success">${analysis.development_potential}</h3>
                                                <p class="mb-0">Development Potential</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h3 class="text-info">${analysis.competition_level}</h3>
                                                <p class="mb-0">Competition Level</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Key Opportunities</h6>
                                        <ul>
                                            ${(analysis.opportunities || []).map(opp => `<li>${opp}</li>`).join('')}
                                        </ul>

                                        <h6>Market Strengths</h6>
                                        <ul>
                                            ${(analysis.strengths || []).map(str => `<li>${str}</li>`).join('')}
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Potential Challenges</h6>
                                        <ul>
                                            ${(analysis.challenges || []).map(chal => `<li>${chal}</li>`).join('')}
                                        </ul>

                                        <h6>Recommended Next Steps</h6>
                                        <ol>
                                            ${(analysis.next_steps || []).map(step => `<li>${step}</li>`).join('')}
                                        </ol>
                                    </div>
                                </div>

                                <div class="mt-4">
                                    <h6>AI Strategic Insights</h6>
                                    <div class="alert alert-secondary">
                                        <p class="mb-0">${analysis.strategic_insights}</p>
                                    </div>
                                </div>

                                ${analysis.methodology ? `
                                    <div class="mt-3">
                                        <small class="text-muted"><strong>Methodology:</strong> ${analysis.methodology}</small>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="modal-footer">
                                <div class="btn-group me-auto" role="group">
                                    <button type="button" class="btn btn-primary" onclick="bcf.navigateToParcelSearch('${countyFips}', '${countyName}')">
                                        <i class="fas fa-search me-2"></i>Find Parcels
                                    </button>
                                    ${hasExistingActivity ? `
                                        <button type="button" class="btn btn-warning" onclick="bootstrap.Modal.getInstance(document.getElementById('aiResultsModal')).hide(); setTimeout(() => { bcf.showExistingDataFiles('${countyFips}', '${countyName}'); }, 300);">
                                            <i class="fas fa-folder-open me-2"></i>View Existing Files
                                        </button>
                                    ` : ''}
                                    <button type="button" class="btn btn-success" onclick="bcf.downloadAIReport('${countyName}', ${JSON.stringify(analysis).replace(/"/g, '&quot;')});">
                                        <i class="fas fa-download me-2"></i>Download AI Report
                                    </button>
                                </div>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-2"></i>Done
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove any existing modal first
            const existingModal = document.getElementById('aiResultsModal');
            if (existingModal) {
                existingModal.remove();
            }

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('aiResultsModal'));
            modal.show();

            // MODIFIED: Add flag and disable screen on close
            modal._element.addEventListener('hidden.bs.modal', () => {
                const modalElement = document.getElementById('aiResultsModal');
                if (modalElement) {
                    modalElement.remove();
                }

                // Mark AI analysis as completed and disable screen
                this.aiAnalysisCompleted = true;
                this.disableScreenAfterAIAnalysis();
            });
        }

        async runAIMarketAnalysis(countyFips, countyName) {
            console.log(`Running AI Market Analysis for ${countyName}`);

            const loadingModalHtml = `
                <div class="modal fade" id="aiAnalysisModal" tabindex="-1" data-bs-backdrop="static">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">AI Market Analysis</h5>
                            </div>
                            <div class="modal-body text-center">
                                <div class="spinner-border text-primary mb-3" role="status"></div>
                                <h6>Analyzing ${countyName} County</h6>
                                <p>AI is analyzing market conditions, development potential, and strategic opportunities...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', loadingModalHtml);
            const loadingModal = new bootstrap.Modal(document.getElementById('aiAnalysisModal'));
            loadingModal.show();

            try {
                console.log('Making API call to /api/ai-market-analysis');

                const response = await fetch('/api/ai-market-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        county_fips: countyFips,
                        county_name: countyName,
                        state: this.currentState,
                        project_type: this.currentProjectType
                    })
                });

                console.log('API response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                console.log('API result:', result);

                // Hide loading modal
                loadingModal.hide();
                setTimeout(() => {
                    const modalElement = document.getElementById('aiAnalysisModal');
                    if (modalElement) modalElement.remove();
                }, 300);

                if (result.success) {
                    console.log('Showing REAL AI analysis results');
                    this.showRealAIAnalysisResults(result.analysis, countyName, countyFips);
                } else {
                    throw new Error(result.error || 'AI Analysis failed');
                }

            } catch (error) {
                console.error('AI Analysis error:', error);
                console.log('Falling back to mock analysis');

                // Hide loading modal
                loadingModal.hide();
                setTimeout(() => {
                    const modalElement = document.getElementById('aiAnalysisModal');
                    if (modalElement) modalElement.remove();
                }, 300);

                // Show mock analysis
                setTimeout(() => {
                    this.showMockAIAnalysis(countyName, countyFips);
                }, 400);
            }
        }

        showMockAIAnalysis(countyName, countyFips) {
            console.log('Showing mock AI analysis since endpoint is not available');

            // Generate realistic mock data
            const mockAnalysis = {
                overall_score: Math.floor(Math.random() * 30) + 65,
                development_potential: ['High', 'Moderate', 'Good'][Math.floor(Math.random() * 3)],
                competition_level: ['Low', 'Moderate', 'High'][Math.floor(Math.random() * 3)],
                opportunities: [
                    'Strong transmission grid connectivity',
                    'Favorable local zoning policies',
                    'Large available parcels (100+ acres)',
                    'Supportive county commissioners',
                    'Existing renewable energy projects nearby'
                ],
                strengths: [
                    'Excellent solar irradiance levels',
                    'Flat terrain suitable for development',
                    'Low population density',
                    'Agricultural zoning allows utility-scale projects',
                    'Proximity to major transmission lines'
                ],
                challenges: [
                    'Environmental impact assessments required',
                    'Grid interconnection queue timing',
                    'Local permit approval process',
                    'Potential community opposition',
                    'Wetland avoidance requirements'
                ],
                next_steps: [
                    'Identify high-priority parcels over 50 acres',
                    'Engage with county planning department',
                    'Conduct preliminary environmental screening',
                    'Begin landowner outreach in target areas',
                    'File preliminary interconnection request'
                ],
                strategic_insights: `Based on AI analysis, ${countyName} County shows strong potential for ${this.currentProjectType} development. Key factors include favorable terrain characteristics, good transmission infrastructure access, and a supportive regulatory environment. The county's rural nature provides abundant large parcels suitable for utility-scale projects. Recommended approach is to focus on parcels over 100 acres with direct access to existing transmission infrastructure.`,
                county_fips: countyFips
            };

            // Check if county has existing activity
            const hasExistingActivity = this.currentCountyActivity &&
                                       this.currentCountyActivity[countyFips] &&
                                       this.currentCountyActivity[countyFips].has_activity;

            const modalHtml = `
                <div class="modal fade" id="aiResultsModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">AI Market Analysis: ${countyName} County</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Demo Mode:</strong> This is sample AI analysis data. The full AI analysis endpoint will provide real market intelligence.
                                </div>

                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h3 class="text-primary">${mockAnalysis.overall_score}/100</h3>
                                                <p class="mb-0">Overall Market Score</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h3 class="text-success">${mockAnalysis.development_potential}</h3>
                                                <p class="mb-0">Development Potential</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h3 class="text-info">${mockAnalysis.competition_level}</h3>
                                                <p class="mb-0">Competition Level</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Key Opportunities</h6>
                                        <ul>
                                            ${mockAnalysis.opportunities.slice(0, 4).map(opp => `<li>${opp}</li>`).join('')}
                                        </ul>

                                        <h6>Market Strengths</h6>
                                        <ul>
                                            ${mockAnalysis.strengths.slice(0, 4).map(str => `<li>${str}</li>`).join('')}
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Potential Challenges</h6>
                                        <ul>
                                            ${mockAnalysis.challenges.slice(0, 4).map(chal => `<li>${chal}</li>`).join('')}
                                        </ul>

                                        <h6>Recommended Next Steps</h6>
                                        <ol>
                                            ${mockAnalysis.next_steps.slice(0, 4).map(step => `<li>${step}</li>`).join('')}
                                        </ol>
                                    </div>
                                </div>

                                <div class="mt-4">
                                    <h6>AI Strategic Insights</h6>
                                    <div class="alert alert-secondary">
                                        <p class="mb-0">${mockAnalysis.strategic_insights}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <div class="btn-group me-auto" role="group">
                                    <button type="button" class="btn btn-primary" onclick="bootstrap.Modal.getInstance(document.getElementById('aiResultsModal')).hide(); setTimeout(() => { document.getElementById('target-county').value='${countyFips}'; document.getElementById('find-parcels-btn').disabled=false; document.getElementById('find-parcels-btn').click(); }, 300);">
                                        <i class="fas fa-search me-2"></i>Find Parcels
                                    </button>
                                    ${hasExistingActivity ? `
                                        <button type="button" class="btn btn-warning" onclick="bootstrap.Modal.getInstance(document.getElementById('aiResultsModal')).hide(); setTimeout(() => { bcf.showExistingDataFiles('${countyFips}', '${countyName}'); }, 300);">
                                            <i class="fas fa-folder-open me-2"></i>View Existing Files
                                        </button>
                                    ` : ''}
                                    <button type="button" class="btn btn-success" onclick="bcf.downloadAIReport('${countyName}', ${JSON.stringify(mockAnalysis).replace(/"/g, '&quot;')});">
                                        <i class="fas fa-download me-2"></i>Download AI Report
                                    </button>
                                </div>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-2"></i>Done
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove any existing modal first
            const existingModal = document.getElementById('aiResultsModal');
            if (existingModal) {
                existingModal.remove();
            }

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('aiResultsModal'));
            modal.show();

            // MODIFIED: Add flag and disable screen on close
            modal._element.addEventListener('hidden.bs.modal', () => {
                const modalElement = document.getElementById('aiResultsModal');
                if (modalElement) {
                    modalElement.remove();
                }

                // Mark AI analysis as completed and disable screen
                this.aiAnalysisCompleted = true;
                this.disableScreenAfterAIAnalysis();
            });
        }

        showAnalysisCompletedMessage() {
            const messageContainer = document.createElement('div');
            messageContainer.id = 'analysis-completed-message';
            messageContainer.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 9999;
                max-width: 500px;
            `;

            messageContainer.innerHTML = `
                <div class="alert alert-success alert-dismissible fade show shadow-lg">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle fa-2x text-success me-3"></i>
                        <div>
                            <h5 class="alert-heading mb-1">AI Analysis Complete</h5>
                            <p class="mb-2">Market analysis has been completed for this county. The interface is now in view-only mode.</p>
                            <small class="text-muted">To analyze another county, refresh the page or start a new session.</small>
                        </div>
                    </div>
                    <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;

            document.body.appendChild(messageContainer);

            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (messageContainer.parentNode) {
                    messageContainer.remove();
                }
            }, 10000);
        }

        disableScreenAfterAIAnalysis() {
            console.log('Disabling screen after AI analysis completion');

            // Add overlay to make screen appear disabled
            const overlay = document.createElement('div');
            overlay.id = 'analysis-completed-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(255, 255, 255, 0.7);
                z-index: 9998;
                pointer-events: none;
            `;
            document.body.appendChild(overlay);

            // Disable all interactive elements
            const interactiveElements = document.querySelectorAll('button, input, select, textarea, a[onclick]');
            interactiveElements.forEach(element => {
                element.disabled = true;
                element.style.opacity = '0.5';
                element.style.cursor = 'not-allowed';
                element.style.pointerEvents = 'none';
            });

            // Disable table row clicks
            const tableRows = document.querySelectorAll('.county-row, .table tbody tr');
            tableRows.forEach(row => {
                row.style.pointerEvents = 'none';
                row.style.opacity = '0.7';
                row.onclick = null;
            });

            // Disable any remaining clickable elements
            const clickableElements = document.querySelectorAll('[onclick], .btn, .clickable');
            clickableElements.forEach(element => {
                element.style.pointerEvents = 'none';
                element.style.opacity = '0.5';
                const originalOnclick = element.onclick;
                element.onclick = null;
                element.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                });
            });

            // Show completion message
            this.showAnalysisCompletedMessage();
        }

        // Show AI Analysis Results
        showAIAnalysisResults(analysis, countyName) {
            const modalHtml = `
                <div class="modal fade" id="aiResultsModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">AI Market Analysis: ${countyName} County</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h3 class="text-primary">${analysis.overall_score || 75}/100</h3>
                                                <p class="mb-0">Overall Market Score</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h3 class="text-success">${analysis.development_potential || 'High'}</h3>
                                                <p class="mb-0">Development Potential</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h3 class="text-info">${analysis.competition_level || 'Moderate'}</h3>
                                                <p class="mb-0">Competition Level</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Key Opportunities</h6>
                                        <ul>
                                            ${(analysis.opportunities || ['Good grid connectivity', 'Favorable zoning policies', 'Available large parcels']).map(opp => `<li>${opp}</li>`).join('')}
                                        </ul>

                                        <h6>Market Strengths</h6>
                                        <ul>
                                            ${(analysis.strengths || ['Strong transmission infrastructure', 'Supportive local policies', 'Abundant suitable land']).map(str => `<li>${str}</li>`).join('')}
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Potential Challenges</h6>
                                        <ul>
                                            ${(analysis.challenges || ['Environmental review requirements', 'Local permitting process', 'Grid interconnection timing']).map(chal => `<li>${chal}</li>`).join('')}
                                        </ul>

                                        <h6>Recommended Next Steps</h6>
                                        <ol>
                                            ${(analysis.next_steps || ['Identify high-priority parcels', 'Engage with local stakeholders', 'Begin preliminary site assessment']).map(step => `<li>${step}</li>`).join('')}
                                        </ol>
                                    </div>
                                </div>

                                <div class="mt-4">
                                    <h6>AI Strategic Insights</h6>
                                    <div class="alert alert-info">
                                        <p class="mb-0">${analysis.strategic_insights || `Based on AI analysis, ${countyName} County shows strong potential for ${this.currentProjectType} development. Key factors include favorable terrain, good transmission access, and supportive regulatory environment. Recommend focusing on parcels over 50 acres with direct transmission proximity.`}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" onclick="bcf.proceedToParcelSearch('${analysis.county_fips}', '${countyName}', {has_activity: false}); bootstrap.Modal.getInstance(document.getElementById('aiResultsModal')).hide();">
                                    Find Parcels Based on Analysis
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('aiResultsModal'));
            modal.show();

            modal._element.addEventListener('hidden.bs.modal', () => {
                document.getElementById('aiResultsModal').remove();
            });
        }

        downloadAIReport(countyName, analysisData) {
            console.log('Downloading AI Market Analysis Report for', countyName);

            // Create a comprehensive report
            const reportContent = this.generateAIReportContent(countyName, analysisData);

            // Create and download the file
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `AI_Market_Analysis_${countyName}_County_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);

            // Show confirmation
            this.showDownloadConfirmation('AI Market Analysis Report', link.download);
        }

        generateAIReportContent(countyName, analysis) {
            const timestamp = new Date().toLocaleString();
            const projectType = this.currentProjectType || 'solar'; // Add fallback

            return `
        AI MARKET ANALYSIS REPORT
        ${countyName} County - ${projectType.toUpperCase()} Energy Development
        Generated: ${timestamp}

        ========================================
        EXECUTIVE SUMMARY
        ========================================
        Overall Market Score: ${analysis.overall_score}/100
        Development Potential: ${analysis.development_potential}
        Competition Level: ${analysis.competition_level}

        ========================================
        KEY OPPORTUNITIES
        ========================================
        ${analysis.opportunities.map((opp, i) => `${i + 1}. ${opp}`).join('\n')}

        ========================================
        MARKET STRENGTHS
        ========================================
        ${analysis.strengths.map((str, i) => `${i + 1}. ${str}`).join('\n')}

        ========================================
        POTENTIAL CHALLENGES
        ========================================
        ${analysis.challenges.map((chal, i) => `${i + 1}. ${chal}`).join('\n')}

        ========================================
        RECOMMENDED NEXT STEPS
        ========================================
        ${analysis.next_steps.map((step, i) => `${i + 1}. ${step}`).join('\n')}

        ========================================
        AI STRATEGIC INSIGHTS
        ========================================
        ${analysis.strategic_insights}

        ========================================
        ANALYSIS METHODOLOGY
        ========================================
        This analysis was conducted using AI algorithms that evaluate:
        - Market conditions and regulatory environment
        - Infrastructure and transmission access
        - Land availability and terrain suitability
        - Competition analysis and development potential
        - Economic and policy factors

        Report generated by BCF.ai Renewable Energy Land Discovery Platform
        Contact: [Your contact information]

        ========================================
        DISCLAIMER
        ========================================
        This analysis is for informational purposes only and should not be considered as investment advice.
        Field verification and detailed due diligence are recommended before making any development decisions.
            `.trim();
        }

        async showExistingDataFiles(countyFips, countyName) {
            console.log(`Showing comprehensive existing data for ${countyName}`);

            const loadingModalHtml = `
                <div class="modal fade" id="existingFilesModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-folder-open me-2"></i>Past Project Activity: ${countyName} County
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p class="mt-2">Loading comprehensive project history...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', loadingModalHtml);
            const modal = new bootstrap.Modal(document.getElementById('existingFilesModal'));
            modal.show();

            try {
                // Get comprehensive activity data
                const response = await fetch('/api/get-comprehensive-activity', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        state: this.currentState,
                        county: countyName,
                        county_fips: countyFips
                    })
                });

                const result = await response.json();

                if (result.success) {
                    this.displayComprehensiveActivity(result, countyName);
                } else {
                    throw new Error(result.error || 'Failed to load comprehensive activity');
                }

            } catch (error) {
                document.querySelector('#existingFilesModal .modal-body').innerHTML = `
                    <div class="alert alert-warning">
                        <h6>Activity Check Failed</h6>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="bcf.runAIMarketAnalysis('${countyFips}', '${countyName}')">
                            Run AI Market Analysis Instead
                        </button>
                    </div>
                `;
            }
        }

        displayComprehensiveActivity(data, countyName) {
            const modalBody = document.querySelector('#existingFilesModal .modal-body');

            const activity = data.activity_summary;
            const files = data.files || [];

            modalBody.innerHTML = `
                <!-- Activity Summary -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h4 class="text-primary">${activity.total_folders}</h4>
                                <p class="mb-0">Project Folders</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h4 class="text-success">${activity.total_files}</h4>
                                <p class="mb-0">Data Files</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h4 class="text-info">${activity.total_parcels || '~500'}</h4>
                                <p class="mb-0">Est. Parcels</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h4 class="text-warning">${activity.days_since_last || 'Recent'}</h4>
                                <p class="mb-0">Days Ago</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <h6 class="card-title">Use Existing Data</h6>
                                <p class="card-text">Analyze existing parcel data to save time and API costs</p>
                                <button class="btn btn-success" onclick="bcf.loadExistingDataForAnalysis('gs://bcfparcelsearchrepository/${activity.latest_csv_file}', '${countyName}')">
                                    <i class="fas fa-chart-line me-2"></i>Analyze Existing Parcels
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-primary">
                            <div class="card-body text-center">
                                <h6 class="card-title">Market Intelligence</h6>
                                <p class="card-text">Get AI insights on market conditions and opportunities</p>
                                <button class="btn btn-primary" onclick="bootstrap.Modal.getInstance(document.getElementById('existingFilesModal')).hide(); setTimeout(() => bcf.runAIMarketAnalysis('${data.county_fips}', '${countyName}'), 300)">
                                    <i class="fas fa-brain me-2"></i>AI Market Analysis
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- File Details -->
                ${files.length > 0 ? this.generateFileDetailsHTML(files) : ''}

                <!-- Cost Savings Information -->
                <div class="alert alert-info">
                    <h6><i class="fas fa-piggy-bank me-2"></i>Cost Savings Opportunity</h6>
                    <p class="mb-1"><strong>Estimated Value:</strong> $${activity.estimated_savings || '500'} in API costs saved</p>
                    <p class="mb-0"><strong>Time Savings:</strong> ${activity.estimated_time_saved || '2-3 hours'} of search time</p>
                </div>
            `;
        }

        async loadExistingDataForAnalysis(filePath, fileName) {
            console.log(`Loading existing data for analysis: ${fileName}`);
            console.log(`File path: ${filePath}`);

            // Validate file path format
            if (!filePath || (!filePath.startsWith('gs://') && !filePath.startsWith('http'))) {
                console.error('Invalid file path format:', filePath);
                alert(`Invalid file path format: ${filePath}\nExpected format: gs://bucket/path/file.csv`);
                return;
            }

            // Check file type first
            if (!fileName.toLowerCase().endsWith('.csv')) {
                alert(`Unsupported file type: ${fileName}\n\nSuitability analysis currently only supports CSV files.`);
                return;
            }

            // Close the existing files modal first
            const existingModal = bootstrap.Modal.getInstance(document.getElementById('existingFilesModal'));
            if (existingModal) {
                existingModal.hide();
            }

            // Show loading indicator
            const loadingHtml = `
                <div class="modal fade" id="loadingDataModal" tabindex="-1" data-bs-backdrop="static">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-body text-center py-4">
                                <div class="spinner-border text-primary mb-3" role="status"></div>
                                <h6>Loading Existing Data</h6>
                                <p class="mb-0">Loading ${fileName} for analysis...</p>
                                <small class="text-muted">Path: ${filePath}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', loadingHtml);
            const loadingModal = new bootstrap.Modal(document.getElementById('loadingDataModal'));
            loadingModal.show();

            try {
                console.log('Making API request to load existing file...');

                // Load the existing file data
                const response = await fetch('/api/load-existing-file', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_path: filePath,
                        file_name: fileName
                    })
                });

                console.log('Response status:', response.status);

                const result = await response.json();
                console.log('Response result:', result);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${result.error || response.statusText}`);
                }

                if (result.success && result.parcel_data) {
                    console.log(`Successfully loaded ${result.parcel_data.length} parcels from ${fileName}`);

                    // Store the loaded data globally
                    this.originalParcelData = result.parcel_data;
                    window.bcfOriginalParcelData = result.parcel_data;

                    // Extract county info from the filename or data
                    const countyMatch = fileName.match(/^([^_]+)_([^_]+)_/);
                    const countyName = countyMatch ? countyMatch[1] : this.currentAnalysis?.county || 'Unknown';
                    const stateAbbr = countyMatch ? countyMatch[2] : this.currentState || 'XX';

                    // Set up current analysis context
                    this.currentAnalysis = {
                        state: stateAbbr,
                        county: countyName,
                        project_type: this.currentProjectType || 'solar',
                        location: `${countyName}, ${this.getStateName(stateAbbr)}`,
                        analysis_level: 'county',
                        data_source: 'existing_file',
                        source_file: fileName
                    };

                    // Hide loading modal
                    loadingModal.hide();
                    setTimeout(() => {
                        document.getElementById('loadingDataModal').remove();
                    }, 300);

                    // Continue with the rest of your existing logic...
                    setTimeout(() => {
                        // Hide current screens
                        const countyScreen = document.getElementById('county-rankings-screen');
                        if (countyScreen) {
                            countyScreen.style.display = 'none';
                        }

                        // Show suitability analysis screen
                        this.showSuitabilityAnalysisScreen();

                        // Update interface
                        setTimeout(() => {
                            const totalParcelsElement = document.getElementById('totalParcelsForSuitability');
                            const analyzeButton = document.querySelector('.analyze-suitability-btn');

                            if (totalParcelsElement) {
                                totalParcelsElement.textContent = result.parcel_data.length;
                            }

                            if (analyzeButton) {
                                analyzeButton.innerHTML = `
                                    <i class="fas fa-chart-line me-2"></i>Analyze Solar Suitability (${result.parcel_data.length} Parcels from ${fileName})
                                `;
                            }

                            console.log('Suitability analysis screen updated with loaded data');
                        }, 200);
                    }, 500);

                } else {
                    throw new Error(result.error || 'Failed to load file data');
                }

            } catch (error) {
                console.error('Error loading existing file:', error);

                // Hide loading modal
                loadingModal.hide();
                setTimeout(() => {
                    document.getElementById('loadingDataModal').remove();
                }, 300);

                // Show detailed error
                alert(`Failed to load file: ${fileName}\n\nError: ${error.message}\n\nFile path: ${filePath}\n\nCheck browser console for more details.`);

                // Re-show the existing files modal
                setTimeout(() => {
                    this.showExistingDataFiles(
                        this.extractCountyFipsFromCurrentContext(),
                        this.currentAnalysis?.county || 'Unknown'
                    );
                }, 500);
            }
        }

        displayExistingFiles(files, countyName) {
            const modalBody = document.querySelector('#existingFilesModal .modal-body');

            if (!files || files.length === 0) {
                modalBody.innerHTML = `
                    <div class="alert alert-info">
                        <h6>No Files Found</h6>
                        <p>No existing data files found for ${countyName} County.</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="alert alert-success">
                    <h6>Found ${files.length} Existing Files</h6>
                    <p class="mb-0">Select a file to view details or run suitability analysis.</p>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>File Name</th>
                                <th>Created</th>
                                <th>Parcels</th>
                                <th>Search Criteria</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            files.forEach((file, index) => {
                // Only show analyze button for CSV files
                const canAnalyze = file.name.toLowerCase().endsWith('.csv');

                html += `
                    <tr>
                        <td>
                            <strong>${file.name}</strong>
                            <br><small class="text-muted">${file.type || 'CSV'} • ${this.formatFileSize(file.size)}</small>
                        </td>
                        <td>${new Date(file.created || file.updated).toLocaleDateString()}</td>
                        <td class="text-center">
                            <span class="badge bg-primary">${file.parcel_count || 'Unknown'}</span>
                        </td>
                        <td>
                            <small>${file.search_criteria || 'Standard search'}</small>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="bcf.viewFileDetails('${file.path}', '${file.name}')" title="View file details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${canAnalyze ? `
                                    <button class="btn btn-success" onclick="bcf.runSuitabilityOnExistingFile('${file.path}', '${file.name}', ${file.parcel_count || 0})" title="Run suitability analysis">
                                        <i class="fas fa-chart-line"></i> Analyze
                                    </button>
                                ` : `
                                    <button class="btn btn-secondary" disabled title="Analysis only available for CSV files">
                                        <i class="fas fa-ban"></i> CSV Only
                                    </button>
                                `}
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
                <div class="alert alert-info mt-3">
                    <small><i class="fas fa-info-circle me-1"></i> <strong>Note:</strong> Suitability analysis currently supports CSV files only. GPKG files contain the same data in geographic format for GIS applications.</small>
                </div>
            `;

            modalBody.innerHTML = html;
        }

        async runSuitabilityOnExistingFile(filePath, fileName, parcelCount) {
            console.log(`Running suitability analysis on existing file: ${fileName}`);

            // Close the existing files modal
            bootstrap.Modal.getInstance(document.getElementById('existingFilesModal')).hide();

            // Check file type
            if (!fileName.toLowerCase().endsWith('.csv')) {
                alert(`Unsupported file type: ${fileName}\n\nSuitability analysis currently only supports CSV files. Please select a CSV file instead.`);
                return;
            }

            try {
                // Load the existing file data
                const response = await fetch('/api/load-existing-file', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_path: filePath,
                        file_name: fileName
                    })
                });

                const result = await response.json();

                if (result.success && result.parcel_data) {
                    // CRITICAL: Store the loaded data AND set up currentAnalysis
                    this.originalParcelData = result.parcel_data;
                    window.bcfOriginalParcelData = result.parcel_data;

                    // Extract county info from the filename or file data
                    const countyMatch = fileName.match(/^([^_]+)_([^_]+)_/);
                    const countyName = countyMatch ? countyMatch[1] : 'Unknown';
                    const stateAbbr = countyMatch ? countyMatch[2] : 'XX';

                    // Set up currentAnalysis for suitability analysis
                    this.currentAnalysis = {
                        state: stateAbbr,
                        county: countyName,
                        project_type: this.currentProjectType || 'solar',
                        location: `${countyName}, ${this.getStateName(stateAbbr)}`,
                        analysis_level: 'county',
                        data_source: 'existing_file'
                    };

                    console.log(`Loaded ${result.parcel_data.length} parcels from existing file`);
                    console.log('Current analysis set up:', this.currentAnalysis);

                    // Show suitability analysis screen with existing data
                    this.showSuitabilityAnalysisScreen();

                    // Update the summary to show loaded data
                    document.getElementById('totalParcelsForSuitability').textContent = result.parcel_data.length;
                    document.querySelector('.analyze-suitability-btn').innerHTML = `
                        <i class="fas fa-chart-line me-2"></i>Analyze Solar Suitability (${result.parcel_data.length} Parcels from ${fileName})
                    `;

                } else {
                    throw new Error(result.error || 'Failed to load file data');
                }

            } catch (error) {
                console.error('Error loading existing file:', error);
                alert(`Failed to load existing file: ${error.message}`);
            }
        }

        calculateRankingStats(counties, countyActivity) {
            return {
                excellent: counties.filter(c => c.score >= 85).length,
                good: counties.filter(c => c.score >= 70 && c.score < 85).length,
                fair: counties.filter(c => c.score >= 55 && c.score < 70).length,
                challenging: counties.filter(c => c.score < 55).length,
                ruralCount: counties.filter(c => c.rural_indicator).length,
                withActivity: Object.values(countyActivity).filter(c => c.has_activity).length
            };
        }

        updatePagination() {
            const countiesPerPageSelect = document.getElementById('counties-per-page');
            const paginationControls = document.getElementById('pagination-controls');

            if (!countiesPerPageSelect || !this.allCounties) return;

            this.countiesPerPage = parseInt(countiesPerPageSelect.value);
            const totalPages = Math.ceil(this.allCounties.length / this.countiesPerPage);

            // Update pagination controls
            let paginationHTML = '';

            if (totalPages > 1) {
                // Previous button
                paginationHTML += `<button class="btn btn-outline-secondary ${this.currentPage === 1 ? 'disabled' : ''}"
                                    onclick="bcf.goToPage(${this.currentPage - 1})" ${this.currentPage === 1 ? 'disabled' : ''}>
                                    Previous
                                  </button>`;

                // Page numbers (show 5 pages max)
                const startPage = Math.max(1, this.currentPage - 2);
                const endPage = Math.min(totalPages, startPage + 4);

                for (let i = startPage; i <= endPage; i++) {
                    paginationHTML += `<button class="btn ${i === this.currentPage ? 'btn-primary' : 'btn-outline-secondary'}"
                                        onclick="bcf.goToPage(${i})">
                                        ${i}
                                      </button>`;
                }

                // Next button
                paginationHTML += `<button class="btn btn-outline-secondary ${this.currentPage === totalPages ? 'disabled' : ''}"
                                    onclick="bcf.goToPage(${this.currentPage + 1})" ${this.currentPage === totalPages ? 'disabled' : ''}>
                                    Next
                                  </button>`;
            }

            if (paginationControls) {
                paginationControls.innerHTML = paginationHTML;
            }

            // Update table content
            this.displayCountiesPage();
        }

        goToPage(pageNumber) {
            const totalPages = Math.ceil(this.allCounties.length / this.countiesPerPage);
            if (pageNumber >= 1 && pageNumber <= totalPages) {
                this.currentPage = pageNumber;
                this.updatePagination();
            }
        }

        showScoringDetails() {
            const modalHtml = `
                <div class="modal fade" id="scoringDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Utility-Scale Renewable Energy Scoring Methodology</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p class="lead">Counties are scored using 5 critical factors for utility-scale renewable energy development:</p>

                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="card h-100">
                                            <div class="card-body">
                                                <h6 class="card-title text-primary">1. Transmission Grid Strength (25%)</h6>
                                                <p class="small">Proximity to major transmission infrastructure, substations, and grid capacity.</p>
                                                <ul class="small">
                                                    <li>Urban centers: Higher scores</li>
                                                    <li>Industrial areas: Good transmission</li>
                                                    <li>Remote/mountainous: Lower scores</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card h-100">
                                            <div class="card-body">
                                                <h6 class="card-title text-primary">2. Land Topography (25%)</h6>
                                                <p class="small">Terrain flatness and suitability for large-scale installations.</p>
                                                <ul class="small">
                                                    <li>Plains/prairie: Highest scores</li>
                                                    <li>River valleys: Good scores</li>
                                                    <li>Mountain/hill areas: Lower scores</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="card h-100">
                                            <div class="card-body">
                                                <h6 class="card-title text-success">3. Population Density (20%)</h6>
                                                <p class="small">Lower density preferred for utility-scale projects to minimize land use conflicts.</p>
                                                <ul class="small">
                                                    <li>Rural/agricultural: Higher scores</li>
                                                    <li>Suburban: Medium scores</li>
                                                    <li>Urban centers: Lower scores</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card h-100">
                                            <div class="card-body">
                                                <h6 class="card-title text-success">4. Political/Regulatory Environment (20%)</h6>
                                                <p class="small">State and local policies supporting renewable energy development.</p>
                                                <ul class="small">
                                                    <li>Renewable portfolio standards</li>
                                                    <li>Tax incentives and rebates</li>
                                                    <li>Streamlined permitting</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <div class="card">
                                            <div class="card-body">
                                                <h6 class="card-title text-info">5. Flood Risk Assessment (10%)</h6>
                                                <p class="small">Lower flood risk protects long-term infrastructure investments.</p>
                                                <ul class="small">
                                                    <li>Highland/ridge areas: Lowest risk</li>
                                                    <li>Average terrain: Moderate risk</li>
                                                    <li>River/coastal areas: Higher risk</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="alert alert-info">
                                    <h6 class="alert-heading">Scoring Scale:</h6>
                                    <ul class="mb-0">
                                        <li><strong>85-100:</strong> Excellent - Ideal for utility-scale development</li>
                                        <li><strong>70-84:</strong> Good - Strong development potential</li>
                                        <li><strong>55-69:</strong> Fair - Moderate potential with some challenges</li>
                                        <li><strong>Under 55:</strong> Challenging - Significant obstacles to development</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if present
            const existingModal = document.getElementById('scoringDetailsModal');
            if (existingModal) existingModal.remove();

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('scoringDetailsModal'));
            modal.show();

            // Clean up on close
            modal._element.addEventListener('hidden.bs.modal', () => {
                document.getElementById('scoringDetailsModal').remove();
            });
            console.log('Showing scoring details modal');
        }

        async loadCountyActivity(state) {
            try {
                console.log(`Loading county activity for ${state}`);

                const response = await fetch(`/api/check-county-activity/${state}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        this.currentCountyActivity = result.county_activity || {};
                        console.log(`Loaded activity data for ${Object.keys(this.currentCountyActivity).length} counties`);
                    }
                } else {
                    console.warn('Could not load county activity data');
                    this.currentCountyActivity = {};
                }
            } catch (error) {
                console.error('Error loading county activity:', error);
                this.currentCountyActivity = {};
            }
        }

        async analyzeStateCounties(state, projectType) {
            try {
                // Store the values immediately
                this.currentState = state;
                this.currentProjectType = projectType;

                console.log(`Starting analysis for ${state} - ${projectType}`);

                // Show loading state
                const analyzeBtn = document.getElementById('analyze-state-btn');
                const btnText = analyzeBtn.querySelector('.btn-text');
                const spinner = analyzeBtn.querySelector('.spinner-border');

                if (btnText) btnText.textContent = 'Analyzing...';
                if (spinner) spinner.classList.remove('d-none');
                analyzeBtn.disabled = true;

                // Make the API call
                const response = await fetch('/api/analyze-state-counties', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        state: state,
                        project_type: projectType,
                        analysis_type: 'comprehensive'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('API response:', result);

                if (!result.success) {
                    throw new Error(result.error || 'API returned success=false');
                }

                if (!result.analysis) {
                    throw new Error('API response missing analysis object');
                }

                // CRITICAL: Handle empty counties array
                if (!result.analysis.counties || result.analysis.counties.length === 0) {
                    console.warn('No counties returned from API');
                    alert(`No county data found for ${this.getStateName(state)}.\n\nThis could mean:\n• The backend analysis isn't populating county data\n• The state code "${state}" isn't recognized\n• There's an issue with your county analysis logic\n\nCheck your backend /api/analyze-state-counties endpoint.`);
                    return;
                }

                console.log(`✅ Analysis successful: ${result.analysis.counties.length} counties found`);

                this.currentStateAnalysis = result.analysis;

                // Load county activity data
                await this.loadCountyActivity(state);

                // Show county rankings
                this.displayCountyRankings(result.analysis.counties, state, projectType);
                this.showCountyRankingsScreen();

            } catch (error) {
                console.error('State analysis error:', error);
                alert(`Analysis failed: ${error.message}`);
            } finally {
                // Reset button state
                const analyzeBtn = document.getElementById('analyze-state-btn');
                const btnText = analyzeBtn.querySelector('.btn-text');
                const spinner = analyzeBtn.querySelector('.spinner-border');

                if (btnText) btnText.textContent = '🚀 Analyze State';
                if (spinner) spinner.classList.add('d-none');
                analyzeBtn.disabled = false;
            }
        }

        showCloudStorageFiles(folderType, folderPath) {
            const fullPath = `gs://bcfparcelsearchrepository/${folderPath}${folderType === 'parcel' ? 'Parcel_Files/' : 'Reports/'}`;
            const title = folderType === 'parcel' ? 'Parcel Files' : 'Reports';

            console.log(`Showing manual access for: ${fullPath}`);

            const expectedFiles = folderType === 'parcel' ? [
                'CSV parcel search results',
                'GeoPackage boundary files',
                'Landowner data files'
            ] : [
                'Analysis reports',
                'Market studies',
                'Feasibility assessments'
            ];

            const modalHtml = `
                <div class="modal fade" id="fileListModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${title} Browser</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <h6>Manual File Access</h6>
                                    <p class="mb-0">Browse files directly in Cloud Storage using the options below.</p>
                                </div>

                                <div class="mb-3">
                                    <h6>Expected Files in This Folder:</h6>
                                    <ul class="list-unstyled">
                                        ${expectedFiles.map(file => `<li class="small text-muted">• ${file}</li>`).join('')}
                                    </ul>
                                </div>

                                <div class="mb-3">
                                    <h6>Cloud Storage Path:</h6>
                                    <div class="input-group">
                                        <input type="text" class="form-control font-monospace small" value="${fullPath}" readonly>
                                        <button class="btn btn-outline-secondary" onclick="navigator.clipboard.writeText('${fullPath}').then(() => alert('Path copied!'))" title="Copy path">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" onclick="window.open('https://console.cloud.google.com/storage/browser/${fullPath.replace('gs://', '')}', '_blank')">
                                        <i class="fas fa-external-link-alt me-2"></i>Open in Google Cloud Console
                                    </button>
                                    <button class="btn btn-outline-info" onclick="bcf.showGsutilCommands('${fullPath}')">
                                        <i class="fas fa-terminal me-2"></i>Show Command Line Options
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if present
            const existingModal = document.getElementById('fileListModal');
            if (existingModal) existingModal.remove();

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('fileListModal'));
            modal.show();

            // Clean up on close
            modal._element.addEventListener('hidden.bs.modal', () => {
                document.getElementById('fileListModal').remove();
            });
        }

        showGsutilCommands(path) {
            const commands = [
                `gsutil ls "${path}"`,
                `gsutil ls -l "${path}"`,
                `gsutil cp "${path}*" ./local_folder/`
            ];

            const commandsHtml = commands.map(cmd =>
                `<div class="input-group mb-2">
                    <input type="text" class="form-control font-monospace small" value="${cmd}" readonly>
                    <button class="btn btn-outline-secondary btn-sm" onclick="navigator.clipboard.writeText('${cmd}').then(() => alert('Command copied!'))" title="Copy command">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>`
            ).join('');

            const modal = bootstrap.Modal.getInstance(document.getElementById('fileListModal'));
            document.querySelector('#fileListModal .modal-body').innerHTML = `
                <div class="alert alert-info">
                    <h6>Command Line Access</h6>
                    <p class="mb-0">Use these gsutil commands to list and download files:</p>
                </div>

                <div class="mb-3">
                    <h6>Available Commands:</h6>
                    ${commandsHtml}
                </div>

                <button class="btn btn-outline-secondary" onclick="bcf.showCloudStorageFiles('${path.includes('Parcel_Files') ? 'parcel' : 'reports'}', '${path.split('/').slice(3, 5).join('/')}/')">
                    <i class="fas fa-arrow-left me-2"></i>Back to File Browser
                </button>
            `;
        }

        showFileLoadingModal(folderType, path) {
            const title = folderType === 'parcel' ? 'Parcel Files' : 'Reports';

            const modalHtml = `
                <div class="modal fade" id="fileListModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${title} Browser</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body" id="fileListContent">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p class="mt-2">Loading files from Cloud Storage...</p>
                                    <small class="text-muted">${path}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if present
            const existingModal = document.getElementById('fileListModal');
            if (existingModal) existingModal.remove();

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('fileListModal'));
            modal.show();

            // Clean up on close
            modal._element.addEventListener('hidden.bs.modal', () => {
                document.getElementById('fileListModal').remove();
            });
        }

        displayFileListingModal(folderType, path, files) {
            const title = folderType === 'parcel' ? 'Parcel Files' : 'Reports';
            const content = document.getElementById('fileListContent');

            if (!files || files.length === 0) {
                content.innerHTML = `
                    <div class="alert alert-info">
                        <h6>No Files Found</h6>
                        <p class="mb-0">No files found in ${path}</p>
                    </div>
                `;
                return;
            }

            // Group files by extension for better organization
            const csvFiles = files.filter(f => f.name.toLowerCase().endsWith('.csv'));
            const gpkgFiles = files.filter(f => f.name.toLowerCase().endsWith('.gpkg') || f.name.toLowerCase().endsWith('.geopackage'));
            const xlsxFiles = files.filter(f => f.name.toLowerCase().endsWith('.xlsx') || f.name.toLowerCase().endsWith('.xls'));
            const pdfFiles = files.filter(f => f.name.toLowerCase().endsWith('.pdf'));
            const otherFiles = files.filter(f => ![...csvFiles, ...gpkgFiles, ...xlsxFiles, ...pdfFiles].includes(f));

            let html = `
                <div class="alert alert-success">
                    <strong>Found ${files.length} files</strong> in ${path}
                </div>
            `;

            // Parcel Files section
            if (folderType === 'parcel') {
                if (csvFiles.length > 0) {
                    html += this.generateFileSection('CSV Data Files', csvFiles, 'table', 'success');
                }
                if (gpkgFiles.length > 0) {
                    html += this.generateFileSection('GeoPackage Files', gpkgFiles, 'map-marked-alt', 'primary');
                }
                if (xlsxFiles.length > 0) {
                    html += this.generateFileSection('Excel Files', xlsxFiles, 'file-excel', 'warning');
                }
            }

            // Reports section
            if (folderType === 'reports') {
                if (pdfFiles.length > 0) {
                    html += this.generateFileSection('PDF Reports', pdfFiles, 'file-pdf', 'danger');
                }
                if (xlsxFiles.length > 0) {
                    html += this.generateFileSection('Excel Analysis', xlsxFiles, 'file-excel', 'warning');
                }
            }

            // Other files
            if (otherFiles.length > 0) {
                html += this.generateFileSection('Other Files', otherFiles, 'file', 'secondary');
            }

            html += `
                <div class="mt-3">
                    <button class="btn btn-outline-primary" onclick="window.open('https://console.cloud.google.com/storage/browser/${path.replace('gs://', '')}', '_blank')">
                        Open in Cloud Console
                    </button>
                </div>
            `;

            content.innerHTML = html;
        }

        generateFileSection(title, files, icon, color) {
            let html = `
                <div class="mb-3">
                    <h6 class="border-bottom pb-2">
                        <i class="fas fa-${icon} text-${color} me-2"></i>${title} (${files.length})
                    </h6>
                    <div class="row">
            `;

            files.forEach(file => {
                const fileSize = this.formatFileSize(file.size || 0);
                const fileDate = file.updated ? new Date(file.updated).toLocaleDateString() : 'Unknown';

                html += `
                    <div class="col-md-6 mb-2">
                        <div class="card card-body p-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    <div class="fw-bold small">${file.name}</div>
                                    <small class="text-muted">${fileDate} • ${fileSize}</small>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-${color} btn-sm" onclick="bcf.downloadCloudFile('${file.path || file.name}')" title="Download ${file.name}">
                                        <i class="fas fa-download"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `</div></div>`;
            return html;
        }

        showFallbackFileModal(folderType, path, error) {
            const title = folderType === 'parcel' ? 'Parcel Files' : 'Reports';
            const content = document.getElementById('fileListContent');

            const expectedFiles = folderType === 'parcel' ? [
                'CSV parcel search results',
                'GeoPackage boundary files',
                'Landowner data files'
            ] : [
                'Analysis reports',
                'Market studies',
                'Feasibility assessments'
            ];

            content.innerHTML = `
                <div class="alert alert-warning">
                    <h6>File Listing Unavailable</h6>
                    <p class="mb-2">Unable to load file listing: ${error}</p>
                    <p class="mb-0">You can still access files manually using the options below.</p>
                </div>

                <div class="mb-3">
                    <h6>Expected Files in This Folder:</h6>
                    <ul class="list-unstyled">
                        ${expectedFiles.map(file => `<li class="small">• ${file}</li>`).join('')}
                    </ul>
                </div>

                <div class="mb-3">
                    <h6>Cloud Storage Path:</h6>
                    <code class="small">${path}</code>
                </div>

                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="window.open('https://console.cloud.google.com/storage/browser/${path.replace('gs://', '')}', '_blank')">
                        Open in Google Cloud Console
                    </button>
                    <button class="btn btn-outline-secondary" onclick="navigator.clipboard.writeText('${path}').then(() => alert('Path copied to clipboard!'))">
                        Copy Path to Clipboard
                    </button>
                </div>
            `;
        }

        downloadCloudFile(filePath) {
            console.log('Downloading file:', filePath);

            // Try the download endpoint
            const encodedPath = encodeURIComponent(filePath);
            const downloadUrl = `/api/download-cloud-file/${encodedPath}`;

            const link = document.createElement('a');
            link.href = downloadUrl;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        async testStateAnalysisAPI() {
            const state = document.getElementById('target-state').value || 'NC';
            const projectType = document.getElementById('project-type-start').value || 'solar';

            console.log('Testing API with:', { state, projectType });

            try {
                const response = await fetch('/api/analyze-state-counties', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        state: state,
                        project_type: projectType,
                        analysis_type: 'comprehensive'
                    })
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);

                const text = await response.text();
                console.log('Raw response text:', text);

                try {
                    const json = JSON.parse(text);
                    console.log('Parsed JSON:', json);
                    console.log('JSON structure:', Object.keys(json));

                    if (json.analysis) {
                        console.log('Analysis structure:', Object.keys(json.analysis));
                    }

                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                }

            } catch (fetchError) {
                console.error('Fetch error:', fetchError);
            }
        }

        async testCloudStorage() {
            console.log('Testing Cloud Storage connection...');

            const modalHtml = `
                <div class="modal fade" id="cloudTestModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Cloud Storage Connection Test</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div id="test-results">
                                    <div class="text-center">
                                        <div class="spinner-border" role="status"></div>
                                        <p class="mt-2">Testing Cloud Storage connection...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('cloudTestModal'));
            modal.show();

            const testResults = document.getElementById('test-results');

            const tests = [
                {
                    name: 'List Cloud Storage Files',
                    url: '/api/list-cloud-storage-files',
                    method: 'POST',
                    body: { bucket_path: `${this.currentState}/${this.currentAnalysis.county}/` }
                },
                {
                    name: 'Check County Activity (should work)',
                    url: `/api/check-county-activity/${this.currentState}`,
                    method: 'GET',
                    body: null
                },
                {
                    name: 'List Bucket Contents',
                    url: '/api/list-bucket-contents',
                    method: 'POST',
                    body: {
                        bucket: 'bcfparcelsearchrepository',
                        prefix: `${this.currentState}/${this.currentAnalysis.county}/`
                    }
                },
                {
                    name: 'Get Project Files',
                    url: '/api/get-project-files',
                    method: 'POST',
                    body: {
                        state: this.currentState,
                        county: this.currentAnalysis.county
                    }
                }
            ];

            let resultsHtml = '<h6>Testing Cloud Storage APIs...</h6>';

            for (const test of tests) {
                resultsHtml += `<div class="mb-3"><strong>Testing:</strong> ${test.name}<br>`;

                try {
                    const startTime = Date.now();

                    const fetchOptions = {
                        method: test.method,
                        headers: { 'Content-Type': 'application/json' }
                    };

                    if (test.body) {
                        fetchOptions.body = JSON.stringify(test.body);
                    }

                    const response = await fetch(test.url, fetchOptions);
                    const duration = Date.now() - startTime;

                    resultsHtml += `<span class="badge bg-${response.ok ? 'success' : 'danger'}">HTTP ${response.status}</span> `;
                    resultsHtml += `<small>(${duration}ms)</small><br>`;

                    if (response.ok) {
                        const data = await response.json();
                        resultsHtml += `<pre class="small bg-light p-2 mt-1">${JSON.stringify(data, null, 2).substring(0, 500)}...</pre>`;

                        if (data.success) {
                            resultsHtml += `<div class="alert alert-success p-2"><strong>SUCCESS:</strong> This endpoint works!</div>`;
                        }
                    } else {
                        const errorText = await response.text();
                        resultsHtml += `<div class="alert alert-danger p-2"><strong>ERROR:</strong> ${errorText.substring(0, 200)}</div>`;
                    }

                } catch (error) {
                    resultsHtml += `<div class="alert alert-danger p-2"><strong>FAILED:</strong> ${error.message}</div>`;
                }

                resultsHtml += '</div><hr>';
            }

            resultsHtml += `
                <div class="mt-4">
                    <h6>Manual Test</h6>
                    <p>Expected Cloud Storage path: <code>gs://bcfparcelsearchrepository/${this.currentState}/${this.currentAnalysis.county}/</code></p>
                    <div class="input-group">
                        <input type="text" class="form-control" id="manual-test-url" placeholder="/api/your-endpoint-here">
                        <button class="btn btn-outline-primary" onclick="bcf.runManualTest()">Test URL</button>
                    </div>
                    <div id="manual-test-result" class="mt-2"></div>
                </div>
            `;

            testResults.innerHTML = resultsHtml;

            modal._element.addEventListener('hidden.bs.modal', () => {
                document.getElementById('cloudTestModal').remove();
            });
        }

        async runManualTest() {
            const url = document.getElementById('manual-test-url').value;
            const resultDiv = document.getElementById('manual-test-result');

            if (!url) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Please enter a URL to test</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Testing...';

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        state: this.currentState,
                        county: this.currentAnalysis.county,
                        bucket_path: `${this.currentState}/${this.currentAnalysis.county}/`
                    })
                });

                const data = await response.json();

                resultDiv.innerHTML = `
                    <div class="alert alert-${response.ok ? 'success' : 'danger'}">
                        <strong>HTTP ${response.status}</strong><br>
                        <pre class="small mt-2">${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;

            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${error.message}</div>`;
            }
        }


        // Replace your existing displayCountyRankings method with this enhanced version
        displayCountyRankings(counties, state, projectType) {
            console.log('Displaying county rankings for:', counties.length, 'counties');

            // Store data for pagination
            this.allCounties = counties;
            this.currentPage = 1;
            this.countiesPerPage = 25; // Reasonable default

            // Update the display name
            const stateNameElement = document.getElementById('state-name-display');
            if (stateNameElement) {
                stateNameElement.textContent = this.getStateName(state);
            }

            // Create enhanced county rankings container with search and pagination
            const container = document.getElementById('county-rankings-container');
            if (container) {
                container.innerHTML = this.createEnhancedCountyRankingsHTML(counties.length);
            }

            // Update summary statistics
            this.updateCountySummaryStats(counties);

            // Populate county dropdown
            this.populateCountyDropdown(counties, this.currentCountyActivity || {});

            // Initialize pagination and search
            this.updatePagination();
            this.initializeCountySearch();

            // Show the screen
            this.showCountyRankingsScreen();
        }

        // Add this new method to create enhanced HTML structure
        createEnhancedCountyRankingsHTML(totalCounties) {
            return `
                <!-- Search and Filter Controls -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" id="county-search"
                                           placeholder="Search counties..." onkeyup="bcf.filterCounties()">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="score-filter" onchange="bcf.filterCounties()">
                                    <option value="">All Scores</option>
                                    <option value="85">85+ (Excellent)</option>
                                    <option value="70">70+ (Good+)</option>
                                    <option value="55">55+ (Fair+)</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="activity-filter" onchange="bcf.filterCounties()">
                                    <option value="">All Counties</option>
                                    <option value="yes">Has Past Activity</option>
                                    <option value="no">New Markets</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="counties-per-page" onchange="bcf.updatePagination()">
                                    <option value="10">10 per page</option>
                                    <option value="25" selected>25 per page</option>
                                    <option value="50">50 per page</option>
                                    <option value="100">100 per page</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="bcf.clearFilters()">
                                    Clear Filters
                                </button>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <small class="text-muted">
                                    Showing <span id="visible-count">${totalCounties}</span> of ${totalCounties} counties
                                </small>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-outline-info btn-sm" onclick="bcf.showScoringDetails()">
                                    <i class="fas fa-info-circle me-1"></i>Scoring Details
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced County Rankings Table -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">County Rankings - AI-Powered Utility-Scale Analysis</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th width="8%">Rank</th>
                                        <th width="20%">County</th>
                                        <th width="10%">AI Score</th>
                                        <th width="25%">Utility-Scale Factors</th>
                                        <th width="15%">Key Strengths</th>
                                        <th width="12%">Development Potential</th>
                                        <th width="10%">Past Activity</th>
                                    </tr>
                                </thead>
                                <tbody id="counties-table-body">
                                    <!-- Counties will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="btn-group" id="pagination-controls" role="group">
                                    <!-- Pagination buttons will be inserted here -->
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <small class="text-muted" id="pagination-info">
                                    <!-- Pagination info will be inserted here -->
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Add search initialization method
        initializeCountySearch() {
            const searchInput = document.getElementById('county-search');
            if (searchInput) {
                // Add debounced search for better performance
                let searchTimeout;
                searchInput.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => this.filterCounties(), 300);
                });
            }
        }

        // Enhanced filter method that works with pagination
        filterCounties() {
            const searchTerm = document.getElementById('county-search')?.value.toLowerCase() || '';
            const minScore = parseInt(document.getElementById('score-filter')?.value) || 0;
            const activityFilter = document.getElementById('activity-filter')?.value || '';

            // Filter the full counties list
            this.filteredCounties = this.allCounties.filter(county => {
                const matchesSearch = county.name.toLowerCase().includes(searchTerm);
                const matchesScore = county.score >= minScore;

                const activity = this.currentCountyActivity[county.fips] || { has_activity: false };
                const matchesActivity = !activityFilter ||
                    (activityFilter === 'yes' && activity.has_activity) ||
                    (activityFilter === 'no' && !activity.has_activity);

                return matchesSearch && matchesScore && matchesActivity;
            });

            // Reset to first page and update pagination
            this.currentPage = 1;
            this.updatePaginationForFiltered();

            // Update visible count
            document.getElementById('visible-count').textContent = this.filteredCounties.length;
        }

        // Update pagination to work with filtered results
        updatePaginationForFiltered() {
            const countiesToShow = this.filteredCounties || this.allCounties;
            const totalPages = Math.ceil(countiesToShow.length / this.countiesPerPage);

            // Update pagination controls
            const paginationControls = document.getElementById('pagination-controls');
            if (paginationControls && totalPages > 1) {
                let html = '';

                // Previous button
                html += `<button class="btn btn-outline-secondary ${this.currentPage === 1 ? 'disabled' : ''}"
                          onclick="bcf.goToPage(${this.currentPage - 1})" ${this.currentPage === 1 ? 'disabled' : ''}>
                          Previous
                         </button>`;

                // Page numbers
                const startPage = Math.max(1, this.currentPage - 2);
                const endPage = Math.min(totalPages, startPage + 4);

                for (let i = startPage; i <= endPage; i++) {
                    html += `<button class="btn ${i === this.currentPage ? 'btn-primary' : 'btn-outline-secondary'}"
                              onclick="bcf.goToPage(${i})">
                              ${i}
                             </button>`;
                }

                // Next button
                html += `<button class="btn btn-outline-secondary ${this.currentPage === totalPages ? 'disabled' : ''}"
                          onclick="bcf.goToPage(${this.currentPage + 1})" ${this.currentPage === totalPages ? 'disabled' : ''}>
                          Next
                         </button>`;

                paginationControls.innerHTML = html;
            } else if (paginationControls) {
                paginationControls.innerHTML = '';
            }

            // Update pagination info
            const paginationInfo = document.getElementById('pagination-info');
            if (paginationInfo) {
                const startIndex = (this.currentPage - 1) * this.countiesPerPage + 1;
                const endIndex = Math.min(startIndex + this.countiesPerPage - 1, countiesToShow.length);
                paginationInfo.textContent = `Showing ${startIndex}-${endIndex} of ${countiesToShow.length} counties`;
            }

            // Display the current page
            this.displayCountiesPage();
        }

        // Updated page display method
        displayCountiesPage() {
            const countiesToShow = this.filteredCounties || this.allCounties;
            const startIndex = (this.currentPage - 1) * this.countiesPerPage;
            const endIndex = Math.min(startIndex + this.countiesPerPage, countiesToShow.length);
            const currentCounties = countiesToShow.slice(startIndex, endIndex);

            this.populateCountyTableWithPagination(currentCounties, startIndex);
        }

        // Enhanced table population with better activity tracking
        populateCountyTableWithPagination(counties, startIndex) {
            const tableBody = document.getElementById('counties-table-body');
            if (!tableBody) return;

            let html = '';
            counties.forEach((county, pageIndex) => {
                const globalRank = startIndex + pageIndex + 1;
                const activity = this.currentCountyActivity[county.fips] || { has_activity: false, folder_count: 0 };

                // Enhanced activity display
                const activityHtml = activity.has_activity ?
                    `<div class="text-success">
                        <strong><i class="fas fa-check-circle me-1"></i>Active</strong>
                        <br><small>${activity.folder_count} project folders</small>
                        <br><span class="badge bg-success btn-sm" onclick="bcf.showExistingDataFiles('${county.fips}', '${county.name}')" style="cursor: pointer;">
                            View Files
                        </span>
                    </div>` :
                    `<div class="text-muted">
                        <i class="fas fa-circle me-1"></i>New Market
                        <br><small>No past activity</small>
                        <br><span class="badge bg-light text-dark">Fresh Start</span>
                    </div>`;

                html += `
                    <tr class="county-row" onclick="bcf.selectCounty('${county.fips}', '${county.name}')">
                        <td class="text-center fw-bold">${globalRank}</td>
                        <td>
                            <div class="fw-bold">${county.name}</div>
                            <small class="text-muted">
                                Population: ${(county.population || 0).toLocaleString()}
                                ${county.rural_indicator ? ' • Rural' : ' • Urban'}
                            </small>
                        </td>
                        <td class="text-center">
                            <div class="badge bg-${county.score >= 85 ? 'success' : county.score >= 70 ? 'primary' : county.score >= 55 ? 'warning' : 'danger'} fs-6">
                                ${county.score}
                            </div>
                        </td>
                        <td>
                            <div class="small">
                                <strong>Grid:</strong> ${county.factor_scores?.transmission || 'Good'}/100<br>
                                <strong>Terrain:</strong> ${county.factor_scores?.topography || 'Good'}/100<br>
                                <strong>Policy:</strong> ${county.factor_scores?.regulatory || 'Good'}/100
                            </div>
                        </td>
                        <td>
                            ${(county.strengths || ['Standard factors']).slice(0, 2).map(s =>
                                `<span class="badge bg-success me-1 mb-1">${s}</span>`
                            ).join('')}
                        </td>
                        <td>
                            <div class="small">
                                <strong>${county.development_potential || 'Moderate'}</strong>
                                <br>${county.policy_environment || 'Supportive'}
                            </div>
                        </td>
                        <td>${activityHtml}</td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html;
        }

        updateCountySummaryStats(counties) {
            const excellentCount = counties.filter(c => c.score >= 90).length;
            const goodCount = counties.filter(c => c.score >= 80 && c.score < 90).length;
            const fairCount = counties.filter(c => c.score >= 70 && c.score < 80).length;
            const withDataCount = Object.values(this.currentCountyActivity || {}).filter(c => c.has_activity).length;

            // Update the summary cards
            const summaryElements = {
                'excellentCount': excellentCount,
                'goodCount': goodCount,
                'fairCount': fairCount,
                'withDataCount': withDataCount
            };

            Object.entries(summaryElements).forEach(([id, count]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = count;
                }
            });

            console.log('Summary stats updated:', summaryElements);
        }

        populateCountyTable(counties) {
            // Find the table body - try multiple selectors
            let tableBody = document.getElementById('counties-table-body') ||
                           document.getElementById('county-rankings-tbody') ||
                           document.querySelector('#county-rankings-screen tbody') ||
                           document.querySelector('.county-rankings-container tbody');

            if (!tableBody) {
                console.error('County table body not found! Available elements:',
                    Array.from(document.querySelectorAll('tbody')).map(el => el.id || el.className));

                // Create the table structure if it doesn't exist
                this.createCountyTable();
                tableBody = document.getElementById('counties-table-body');
            }

            if (!tableBody) {
                console.error('Still cannot find table body after creation attempt');
                return;
            }

            console.log('Populating table with', counties.length, 'counties');

            let html = '';
            counties.forEach((county, index) => {
                const rank = index + 1;
                const activity = this.currentCountyActivity[county.fips] || this.currentCountyActivity[county.name] || { has_activity: false, folder_count: 0 };

                // Determine score styling
                const scoreClass = county.score >= 90 ? 'success' :
                                  county.score >= 80 ? 'primary' :
                                  county.score >= 70 ? 'warning' : 'danger';

                // Format strengths
                const strengths = (county.strengths || ['Standard factors']).slice(0, 2);
                const strengthsHtml = strengths.map(s => `<span class="badge bg-light text-dark me-1">${s}</span>`).join('');

                // Activity indicator
                const activityHtml = activity.has_activity ?
                    `<span class="badge bg-success">Has Data (${activity.folder_count})</span>` :
                    `<span class="badge bg-light text-muted">New Market</span>`;

                html += `
                    <tr class="county-row" data-county-fips="${county.fips}" data-county-name="${county.name}">
                        <td class="text-center fw-bold">${rank}</td>
                        <td>
                            <div class="fw-bold">${county.name}</div>
                            <small class="text-muted">${county.rural_indicator ? 'Rural' : 'Urban'} • Pop: ${(county.population || 0).toLocaleString()}</small>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-${scoreClass} fs-6">${county.score}</span>
                        </td>
                        <td>${strengthsHtml}</td>
                        <td class="text-center">${activityHtml}</td>
                        <td class="text-center">
                            <button class="btn btn-primary btn-sm" onclick="bcf.selectCounty('${county.fips}', '${county.name}')">
                                Select
                            </button>
                        </td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html;
            console.log('✅ Table populated with', counties.length, 'counties');
        }

        createCountyTable() {
            const container = document.querySelector('.county-rankings-container') ||
                             document.querySelector('#county-rankings-screen .container-fluid');

            if (!container) {
                console.error('Cannot find container to create table');
                return;
            }

            const tableHtml = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th width="8%">Rank</th>
                                <th width="25%">County</th>
                                <th width="12%">Score</th>
                                <th width="30%">Key Strengths</th>
                                <th width="15%">Past Activity</th>
                                <th width="10%">Action</th>
                            </tr>
                        </thead>
                        <tbody id="counties-table-body">
                            <!-- Counties will be populated here -->
                        </tbody>
                    </table>
                </div>
            `;

            // Find existing table or create new one
            const existingTable = container.querySelector('.table-responsive');
            if (existingTable) {
                existingTable.innerHTML = tableHtml;
            } else {
                container.insertAdjacentHTML('beforeend', tableHtml);
            }

            console.log('County table structure created');
        }

        populateCountyDropdown(counties, countyActivity) {
            const countySelect = document.getElementById('target-county');
            countySelect.innerHTML = '<option value="">Select a county...</option>';

            counties.forEach((county, index) => {
                const activity = countyActivity[county.fips] || countyActivity[county.name] || { has_activity: false };
                const indicators = [];

                if (index < 10) indicators.push('TOP 10');
                if (activity.has_activity) indicators.push('HAS DATA');
                if (county.rural_indicator) indicators.push('RURAL');
                if (county.score >= 80) indicators.push('HIGH SCORE');

                const indicatorText = indicators.length > 0 ? ` [${indicators.join(', ')}]` : '';

                const option = document.createElement('option');
                option.value = county.fips || county.name;
                option.textContent = `${county.name} (#${index + 1} - ${county.score}/100)${indicatorText}`;
                option.dataset.countyName = county.name;
                option.dataset.hasActivity = activity.has_activity;
                option.dataset.score = county.score;

                countySelect.appendChild(option);
            });
        }

        debugCurrentState() {
            console.log('Debug - Current State:', {
                state: this.currentState,
                projectType: this.currentProjectType,
                stateAnalysis: this.currentStateAnalysis,
                hasCountyActivity: Object.keys(this.currentCountyActivity).length
            });

            // Also check the form values
            const formState = document.getElementById('target-state')?.value;
            const formProjectType = document.getElementById('project-type-start')?.value;

            console.log('Debug - Form Values:', {
                formState,
                formProjectType
            });
        }

        clearFilters() {
            document.getElementById('county-search').value = '';
            document.getElementById('score-filter').value = '';
            document.getElementById('density-filter').value = '';
            document.getElementById('activity-filter').value = '';
            this.filterCounties();
        }

        exportCountyData() {
            const counties = this.currentStateAnalysis?.county_rankings || [];
            const csvContent = this.generateCountyCSV(counties);

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${this.currentState}_county_rankings_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            window.URL.revokeObjectURL(url);
        }

        generateCountyCSV(counties) {
            const headers = ['Rank', 'County', 'FIPS', 'AI_Score', 'Population', 'Population_Density', 'Density_Category', 'Population_Tier', 'Rural_Indicator', 'Resource_Quality', 'Policy_Environment', 'Development_Potential', 'Key_Strengths'];

            const rows = counties.map((county, index) => [
                index + 1,
                county.name,
                county.fips,
                county.score,
                county.population || '',
                county.population_density || '',
                county.density_category || '',
                county.population_tier || '',
                county.rural_indicator || false,
                county.resource_quality || '',
                county.policy_environment || '',
                county.development_potential || '',
                (county.strengths || []).join('; ')
            ]);

            return [headers, ...rows].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
        }

        // Add this method to handle the parcel search form submission
        initializeParcelSearch() {
            console.log('Initializing parcel search for:', this.currentAnalysis);

            // Wait for DOM to be fully ready
            setTimeout(() => {
                const previewBtn = document.getElementById('preview-count-btn');
                const searchBtn = document.getElementById('search-parcels-btn');
                const form = document.getElementById('parcel-search-form');

                console.log('Preview button found:', !!previewBtn);
                console.log('Search button found:', !!searchBtn);
                console.log('Form found:', !!form);

                // Remove any existing event listeners to prevent duplicates
                if (previewBtn) {
                    previewBtn.replaceWith(previewBtn.cloneNode(true));
                    const newPreviewBtn = document.getElementById('preview-count-btn');
                    newPreviewBtn.disabled = false;
                    newPreviewBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        console.log('Preview button clicked via event listener');
                        this.previewParcelCount();
                    });
                    console.log('Preview button event listener attached');
                }

                if (searchBtn) {
                    searchBtn.replaceWith(searchBtn.cloneNode(true));
                    const newSearchBtn = document.getElementById('search-parcels-btn');
                    newSearchBtn.disabled = false;
                    newSearchBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        console.log('Search button clicked via event listener');
                        this.executeParcelSearch();
                    });
                    console.log('Search button event listener attached');
                }

                if (form) {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        console.log('Form submitted via event listener');
                        this.executeParcelSearch();
                    });
                    console.log('Form submit handler attached');

                    // Ensure all form inputs are enabled
                    const inputs = form.querySelectorAll('input, select, button, textarea');
                    inputs.forEach(input => {
                        input.disabled = false;
                    });
                    console.log(`Enabled ${inputs.length} form elements`);
                }

            }, 200);
        }

        async previewParcelCount() {
            console.log('🔍 Preview parcel count method called');

            try {
                const searchParams = this.getSearchParameters();
                console.log('Search params:', searchParams);

                if (!searchParams.valid) {
                    alert(searchParams.error);
                    return;
                }

                console.log('Making preview API call...');

                const response = await fetch('/api/parcel-search/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        location: this.currentAnalysis.location,
                        project_type: this.currentAnalysis.project_type,
                        analysis_level: this.currentAnalysis.analysis_level,
                        selected_county: this.currentAnalysis.county,
                        ...searchParams.params
                    })
                });

                const result = await response.json();
                console.log('Preview result:', result);

                if (result.success) {
                    alert(`Preview: Found approximately ${result.estimated_parcels} parcels matching your criteria in ${result.county_name}`);
                } else {
                    alert(`Preview failed: ${result.error}`);
                }

            } catch (error) {
                console.error('Preview error:', error);
                alert(`Preview failed: ${error.message}`);
            }
        }

        async executeParcelSearch() {
            console.log('🔍 Execute parcel search method called');

            try {
                const searchParams = this.getSearchParameters();
                console.log('Search params:', searchParams);

                if (!searchParams.valid) {
                    alert(searchParams.error);
                    return;
                }

                // Show loading state
                const searchBtn = document.querySelector('[onclick*="executeParcelSearch"]');
                if (searchBtn) {
                    searchBtn.disabled = true;
                    searchBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Searching...';
                }

                console.log('Making search API call...');

                const response = await fetch('/api/parcel-search/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        location: this.currentAnalysis.location,
                        project_type: this.currentAnalysis.project_type,
                        analysis_level: this.currentAnalysis.analysis_level,
                        selected_county: this.currentAnalysis.county,
                        ...searchParams.params
                    })
                });

                const result = await response.json();

                if (result.success) {
                    console.log(`Parcel search completed: ${result.parcel_count} parcels found`);

                    // CRITICAL: Store original parcel data globally
                    if (result.parcel_data && result.parcel_data.length > 0) {
                        this.originalParcelData = result.parcel_data;
                        window.bcfOriginalParcelData = result.parcel_data;

                        console.log('✅ Stored original parcel data:', this.originalParcelData.length, 'parcels');
                        console.log('📋 Sample original parcel keys:', Object.keys(this.originalParcelData[0]));
                    }

                    this.displayParcelResults(result);
                } else {
                    alert(`Search failed: ${result.error}`);
                }

            } catch (error) {
                console.error('Search error:', error);
                alert(`Search failed: ${error.message}`);
            } finally {
                // Reset button state
                const searchBtn = document.querySelector('[onclick*="executeParcelSearch"]');
                if (searchBtn) {
                    searchBtn.disabled = false;
                    searchBtn.innerHTML = 'Search Parcels';
                }
            }
        }

        getSearchParameters() {
            const minAcreage = document.getElementById('min-acreage')?.value;
            const maxAcreage = document.getElementById('max-acreage')?.value;
            const ownerName = document.getElementById('owner-name')?.value?.trim();
            const parcelId = document.getElementById('parcel-id')?.value?.trim();

            // Validate that at least one search criteria is provided
            if (!minAcreage && !ownerName && !parcelId) {
                return {
                    valid: false,
                    error: 'Please provide at least one search criteria: minimum acreage, owner name, or parcel ID'
                };
            }

            const params = {};

            if (minAcreage) params.min_acreage = parseInt(minAcreage);
            if (maxAcreage) params.max_acreage = parseInt(maxAcreage);
            if (ownerName) params.owner = ownerName;
            if (parcelId) params.parcel_id = parcelId;

            return {
                valid: true,
                params: params
            };
        }

        displayParcelResults(searchResult) {
            console.log('Displaying parcel search results', searchResult);

            // CRITICAL: Store original parcel data globally
            if (searchResult.parcel_data && searchResult.parcel_data.length > 0) {
                this.originalParcelData = searchResult.parcel_data;

                // ALSO store it on the global window object as backup
                window.bcfOriginalParcelData = searchResult.parcel_data;

                console.log('✅ Stored original parcel data:', this.originalParcelData.length, 'parcels');
                console.log('📋 Sample original parcel keys:', Object.keys(this.originalParcelData[0]));

                // Store it in the workflow instance too
                if (window.bcf) {
                    window.bcf.originalParcelData = searchResult.parcel_data;
                }
            }

            // Remove any existing results first
            const existingResults = document.querySelector('.parcel-search-results');
            if (existingResults) {
                existingResults.remove();
            }

            // Create results display
            const resultsHtml = `
                <div class="parcel-search-results mt-4">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-check-circle me-2"></i>
                                Search Results - ${searchResult.parcel_count} Parcels Found
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <p><strong>County:</strong> ${searchResult.county_name}</p>
                                    <p><strong>Search Type:</strong> ${searchResult.search_type || 'Acreage-based'}</p>
                                    <p><strong>Processing Time:</strong> ${searchResult.processing_time || 'Unknown'}s</p>

                                    ${searchResult.next_steps && searchResult.next_steps.length > 0 ? `
                                        <div class="alert alert-info">
                                            <h6>Recommended Next Steps:</h6>
                                            <ul class="mb-0">
                                                ${searchResult.next_steps.map(step => `<li>${step}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="col-md-4">
                                    <div class="download-options">
                                        <h6>Download Files:</h6>
                                        <div class="d-grid gap-2">
                                            ${searchResult.csv_file_path ? `
                                                <a href="${searchResult.csv_file_path}"
                                                   class="btn btn-primary btn-sm"
                                                   target="_blank"
                                                   onclick="console.log('Downloading CSV:', '${searchResult.csv_file_path}')">
                                                    <i class="fas fa-download me-1"></i>Download CSV Data
                                                </a>
                                            ` : ''}
                                            ${searchResult.file_path ? `
                                                <a href="${searchResult.file_path}"
                                                   class="btn btn-success btn-sm"
                                                   target="_blank"
                                                   onclick="console.log('Downloading GPKG:', '${searchResult.file_path}')">
                                                    <i class="fas fa-download me-1"></i>Download GeoPackage
                                                </a>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            ${searchResult.parcel_data && searchResult.parcel_data.length > 0 ? `
                                <div class="mt-4">
                                    <h6>Sample Results (First 10 Parcels):</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Parcel ID</th>
                                                    <th>Owner</th>
                                                    <th>Acreage</th>
                                                    <th>Address</th>
                                                    <th>Land Use</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${searchResult.parcel_data.slice(0, 10).map(parcel => `
                                                    <tr>
                                                        <td>${parcel.parcel_id || 'N/A'}</td>
                                                        <td>${parcel.owner || 'N/A'}</td>
                                                        <td>${parcel.acreage_calc || parcel.acreage || 'N/A'}</td>
                                                        <td>${parcel.address || 'N/A'}</td>
                                                        <td>${parcel.land_use_class || 'N/A'}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                        ${searchResult.parcel_data.length > 10 ?
                                            `<small class="text-muted">Showing 10 of ${searchResult.parcel_data.length} results. Download full dataset using buttons above.</small>`
                                            : ''
                                        }
                                    </div>
                                </div>
                            ` : ''}

                            <div class="mt-3">
                                <button class="btn btn-outline-primary" onclick="bcf.proceedToSuitabilityAnalysis()">
                                    <i class="fas fa-chart-line me-1"></i>Analyze Suitability
                                </button>
                                <button class="btn btn-outline-secondary ms-2" onclick="window.location.reload()">
                                    <i class="fas fa-redo me-1"></i>New Search
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Find the container to insert results into
            const searchContainer = document.getElementById('parcel-search-screen') ||
                                  document.querySelector('.container-fluid') ||
                                  document.querySelector('.workflow-step');

            if (searchContainer) {
                // Insert at the end of the container
                searchContainer.insertAdjacentHTML('beforeend', resultsHtml);
                console.log('Results inserted successfully');

                // Scroll to results
                const resultsElement = document.querySelector('.parcel-search-results');
                if (resultsElement) {
                    resultsElement.scrollIntoView({ behavior: 'smooth' });
                }
            } else {
                console.error('Could not find container to insert results');
                alert(`Search completed successfully!\n\nFound ${searchResult.parcel_count} parcels in ${searchResult.county_name}\n\nFiles available for download in Cloud Storage.`);
            }
        }

        // Add this method for the next step
        proceedToSuitabilityAnalysis() {
            console.log('Proceeding to suitability analysis...');

            // Hide parcel search screen
            const parcelSearchScreen = document.getElementById('parcel-search-screen');
            if (parcelSearchScreen) {
                parcelSearchScreen.style.display = 'none';
            }

            // Show suitability analysis screen
            this.showSuitabilityAnalysisScreen();
        }

        showSuitabilityAnalysisScreen() {
            console.log('Showing suitability analysis screen...');

            // Create suitability analysis container
            const container = document.createElement('div');
            container.id = 'suitability-analysis-screen';
            container.className = 'workflow-step';

            container.innerHTML = `
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div>
                                    <h2 class="mb-1">Solar Suitability Analysis: ${this.currentAnalysis?.location || 'Unknown Location'}</h2>
                                    <p class="text-muted mb-0">AI-powered analysis for utility-scale solar development potential</p>
                                </div>
                                <button class="btn btn-outline-secondary" onclick="bcf.goBackToParcelSearch()">
                                    Back to Parcel Search
                                </button>
                            </div>

                            <!-- Analysis Configuration -->
                            <div id="suitabilityConfigSection">
                                <div style="background-color: #e8f5e8; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745; margin-bottom: 20px;">
                                    <h4 style="margin: 0 0 15px 0; color: #155724;">Ready for Solar Suitability Analysis</h4>
                                    <p style="margin: 0 0 15px 0; color: #155724;">Analyze parcels using AI-powered solar development criteria</p>

                                    <div id="suitabilityParcelsSummary" style="background: white; padding: 15px; border-radius: 6px; margin: 15px 0;">
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
                                            <div>
                                                <div style="font-size: 24px; font-weight: bold; color: #007bff;" id="totalParcelsForSuitability">Loading...</div>
                                                <div style="font-size: 14px; color: #666;">Total Parcels</div>
                                            </div>
                                            <div>
                                                <div style="font-size: 24px; font-weight: bold; color: #28a745;" id="qualifiedParcels">-</div>
                                                <div style="font-size: 14px; color: #666;">Analyzed</div>
                                            </div>
                                        </div>
                                    </div>

                                    <button class="analyze-suitability-btn" id="runSuitabilityBtn">
                                        <i class="fas fa-chart-line me-2"></i>Analyze Solar Suitability
                                    </button>
                                </div>
                            </div>

                            <!-- Loading Section -->
                            <div id="suitabilityLoadingSection" class="hidden">
                                <div class="analysis-progress">
                                    <div class="progress-spinner"></div>
                                    <p>Running AI-powered suitability analysis...</p>
                                    <small>This may take a few moments as we analyze each parcel</small>
                                </div>
                            </div>

                            <!-- Results Section -->
                            <div id="suitabilityResultsSection" class="suitability-results-container hidden">
                                <div class="suitability-summary">
                                    <h3>Solar Development Suitability Analysis Results</h3>

                                    <!-- Summary Statistics -->
                                    <div class="summary-stats" id="suitabilityStats">
                                        <!-- Will be populated by JavaScript -->
                                    </div>

                                    <!-- Results Table with Enhanced Selection -->
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">Parcel Suitability Results</h5>
                                            <div>
                                                <button class="btn btn-sm btn-outline-primary" onclick="bcf.exportSuitabilityResults('csv')">
                                                    <i class="fas fa-download me-1"></i>Export CSV
                                                </button>
                                                <button class="btn btn-sm btn-secondary ms-2" onclick="bcf.exportToCRM()" id="exportToCrmBtn" disabled>
                                                    <i class="fas fa-upload me-1"></i>Initiate Outreach (Select Parcels)
                                                </button>
                                            </div>
                                        </div>

                                        <div class="card-body p-0">
                                            <div class="table-responsive">
                                                <table class="table table-hover mb-0" id="suitability-table">
                                                    <thead class="table-dark sticky-top">
                                                        <tr>
                                                            <th width="5%" class="text-center">
                                                                <input type="checkbox"
                                                                       class="form-check-input"
                                                                       id="select-all-checkbox"
                                                                       title="Select/Deselect All"
                                                                       onchange="bcf.toggleSelectAll(this.checked)">
                                                            </th>
                                                            <th width="8%" class="text-center">Rank</th>
                                                            <th width="15%">Parcel ID</th>
                                                            <th width="20%">Owner</th>
                                                            <th width="10%" class="text-end">Acres</th>
                                                            <th width="12%" class="text-center">Score</th>
                                                            <th width="12%" class="text-center">Category</th>
                                                            <th width="18%">Key Strengths</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="suitability-table-body">
                                                        <!-- Results will be populated here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>

                                        <div class="card-footer bg-light">
                                            <div class="row align-items-center">
                                                <div class="col-md-8">
                                                    <small class="text-muted">
                                                        <i class="fas fa-info-circle me-1"></i>
                                                        Select parcels for Outreach efforts. Excellent parcels (85+ score) are pre-selected.
                                                    </small>
                                                </div>
                                                <div class="col-md-4 text-end">
                                                    <small id="table-footer-summary" class="text-muted">
                                                        <!-- Selection summary will be updated here -->
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(container);

            // CRITICAL: Initialize the analyze button with proper event handler
            setTimeout(() => {
                this.initializeSuitabilityAnalysisButton();
                this.loadParcelSummaryForSuitability();
            }, 100);
        }

        initializeSuitabilityAnalysisButton() {
            const analyzeBtn = document.getElementById('runSuitabilityBtn');

            if (analyzeBtn) {
                // Remove any existing event listeners
                analyzeBtn.replaceWith(analyzeBtn.cloneNode(true));

                // Get the fresh button and add the event listener
                const newAnalyzeBtn = document.getElementById('runSuitabilityBtn');

                newAnalyzeBtn.addEventListener('click', () => {
                    console.log('Analyze button clicked - running suitability analysis');
                    this.runSuitabilityAnalysis();
                });

                // Also add onclick as backup
                newAnalyzeBtn.onclick = () => {
                    console.log('Analyze button onclick - running suitability analysis');
                    this.runSuitabilityAnalysis();
                };

                console.log('Suitability analysis button initialized with event handlers');
            } else {
                console.error('Could not find analyze button to initialize');
            }
        }

        async runSuitabilityAnalysis() {
            console.log('Running suitability analysis...');

            const runBtn = document.getElementById('runSuitabilityBtn');
            const configSection = document.getElementById('suitabilityConfigSection');
            const loadingSection = document.getElementById('suitabilityLoadingSection');
            const resultsSection = document.getElementById('suitabilityResultsSection');

            try {
                // Show loading state
                if (runBtn) {
                    runBtn.disabled = true;
                    runBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Analyzing...';
                }

                if (configSection) configSection.style.display = 'none';
                if (loadingSection) loadingSection.classList.remove('hidden');
                if (resultsSection) resultsSection.classList.add('hidden');

                // Get parcel data - try multiple sources
                let parcelData = null;

                if (this.originalParcelData && this.originalParcelData.length > 0) {
                    parcelData = this.originalParcelData;
                    console.log(`Using originalParcelData: ${parcelData.length} parcels`);
                } else if (window.bcfOriginalParcelData && window.bcfOriginalParcelData.length > 0) {
                    parcelData = window.bcfOriginalParcelData;
                    console.log(`Using window.bcfOriginalParcelData: ${parcelData.length} parcels`);
                } else {
                    parcelData = this.getParcelDataForAnalysis();
                    console.log(`Using getParcelDataForAnalysis: ${parcelData ? parcelData.length : 0} parcels`);
                }

                if (!parcelData || parcelData.length === 0) {
                    throw new Error('No parcel data available. Please run a parcel search first or load an existing file.');
                }

                console.log(`Analyzing ${parcelData.length} parcels for solar suitability...`);

                // Make API call for suitability analysis
                const response = await fetch('/api/suitability-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        parcels: parcelData,
                        project_type: 'solar',
                        location: this.currentAnalysis?.location || 'Unknown Location',
                        criteria: [
                            'transmission_proximity',
                            'slope_suitability',
                            'land_availability',
                            'grid_connection_potential',
                            'development_feasibility'
                        ]
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success) {
                    console.log('Suitability analysis completed:', result.results.length, 'parcels analyzed');

                    // Display results
                    this.displaySuitabilityResults(result.results);

                    // Show results section
                    if (loadingSection) loadingSection.classList.add('hidden');
                    if (resultsSection) resultsSection.classList.remove('hidden');

                } else {
                    throw new Error(result.error || 'Suitability analysis failed');
                }

            } catch (error) {
                console.error('Suitability analysis error:', error);

                // Show error
                if (loadingSection) {
                    loadingSection.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <h4>Analysis Failed</h4>
                            <p>${error.message}</p>
                            <button class="btn btn-primary" onclick="bcf.goBackToParcelSearch()">Go Back</button>
                        </div>
                    `;
                }

            } finally {
                // Reset button
                if (runBtn) {
                    runBtn.disabled = false;
                    runBtn.innerHTML = '<i class="fas fa-chart-line me-2"></i>Analyze Solar Suitability';
                }
                if (configSection) configSection.style.display = 'block';
            }
        }

        loadParcelSummaryForSuitability() {
            // Try to get parcel count from the most recent search results
            const parcelResults = document.querySelector('.parcel-search-results');
            if (parcelResults) {
                const parcelCountText = parcelResults.querySelector('h5')?.textContent;
                const countMatch = parcelCountText?.match(/(\d+)\s+Parcels Found/);
                if (countMatch) {
                    document.getElementById('totalParcelsForSuitability').textContent = countMatch[1];
                }
            } else {
                document.getElementById('totalParcelsForSuitability').textContent = 'Unknown';
            }
        }

        extractCountyFipsFromCurrentContext() {
            // Try to get county FIPS from current context
            if (this.currentAnalysis && this.currentAnalysis.county_id) {
                return this.currentAnalysis.county_id;
            }

            // Try to find it from the county activity data
            if (this.currentCountyActivity) {
                for (const [fips, data] of Object.entries(this.currentCountyActivity)) {
                    if (data.county_name === (this.currentAnalysis?.county)) {
                        return fips;
                    }
                }
            }

            // Default fallback - try to extract from URL or other sources
            return 'unknown';
        }

        async runSuitabilityOnExistingFile(filePath, fileName, parcelCount) {
            console.log(`Running suitability analysis on existing file: ${fileName}`);

            // Check file type first
            if (!fileName.toLowerCase().endsWith('.csv')) {
                alert(`Unsupported file type: ${fileName}\n\nSuitability analysis currently only supports CSV files. Please select a CSV file instead.`);
                return;
            }

            try {
                // Show loading state in the modal
                const modalBody = document.querySelector('#existingFilesModal .modal-body');
                const originalContent = modalBody.innerHTML;

                modalBody.innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Loading ${fileName} for suitability analysis...</p>
                    </div>
                `;

                // Load the existing file data
                const response = await fetch('/api/load-existing-file', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_path: filePath,
                        file_name: fileName
                    })
                });

                const result = await response.json();

                if (result.success && result.parcel_data) {
                    // Store the loaded data
                    this.originalParcelData = result.parcel_data;
                    window.bcfOriginalParcelData = result.parcel_data;

                    // Extract county info from the filename
                    const countyMatch = fileName.match(/^([^_]+)_([^_]+)_/);
                    const countyName = countyMatch ? countyMatch[1] : 'Unknown';
                    const stateAbbr = countyMatch ? countyMatch[2] : 'XX';

                    // Set up currentAnalysis
                    this.currentAnalysis = {
                        state: stateAbbr,
                        county: countyName,
                        project_type: this.currentProjectType || 'solar',
                        location: `${countyName}, ${this.getStateName(stateAbbr)}`,
                        analysis_level: 'county',
                        data_source: 'existing_file'
                    };

                    console.log(`Loaded ${result.parcel_data.length} parcels from existing file`);
                    console.log('Current analysis set up:', this.currentAnalysis);

                    // IMPORTANT: Close modal properly and then navigate
                    const existingModal = bootstrap.Modal.getInstance(document.getElementById('existingFilesModal'));
                    if (existingModal) {
                        existingModal.hide();
                    }

                    // Wait for modal to fully close before proceeding
                    setTimeout(() => {
                        // Remove the modal completely
                        const modalElement = document.getElementById('existingFilesModal');
                        if (modalElement) {
                            modalElement.remove();
                        }

                        // Hide any current screens
                        const countyScreen = document.getElementById('county-rankings-screen');
                        if (countyScreen) {
                            countyScreen.style.display = 'none';
                        }

                        const parcelSearchScreen = document.getElementById('parcel-search-screen');
                        if (parcelSearchScreen) {
                            parcelSearchScreen.remove();
                        }

                        // Show suitability analysis screen
                        this.showSuitabilityAnalysisScreen();

                        // Wait for DOM to be ready, then update the interface
                        setTimeout(() => {
                            const totalParcelsElement = document.getElementById('totalParcelsForSuitability');
                            const analyzeButton = document.querySelector('.analyze-suitability-btn');

                            if (totalParcelsElement) {
                                totalParcelsElement.textContent = result.parcel_data.length;
                            }

                            if (analyzeButton) {
                                analyzeButton.innerHTML = `
                                    <i class="fas fa-chart-line me-2"></i>Analyze Solar Suitability (${result.parcel_data.length} Parcels from ${fileName})
                                `;
                            }

                            console.log('Suitability analysis screen updated with existing file data');
                        }, 200);

                    }, 300);

                } else {
                    // Restore original content on error
                    modalBody.innerHTML = originalContent;
                    throw new Error(result.error || 'Failed to load file data');
                }

            } catch (error) {
                console.error('Error loading existing file:', error);
                alert(`Failed to load existing file: ${error.message}`);

                // Restore original modal content
                const modalBody = document.querySelector('#existingFilesModal .modal-body');
                if (modalBody) {
                    // Reload the existing files to restore the table
                    this.showExistingDataFiles(this.extractCountyFipsFromCurrentContext(), this.currentAnalysis?.county || 'Unknown');
                }
            }
        }

        getParcelDataForAnalysis() {
            // Use stored original parcel data if available
            if (window.bcf && window.bcf.originalParcelData && window.bcf.originalParcelData.length > 0) {
                console.log('Using stored original parcel data:', window.bcf.originalParcelData.length, 'parcels');
                return window.bcf.originalParcelData;
            }

            // Fallback to extracting from table (your existing logic)
            const searchResults = document.querySelector('.parcel-search-results');
            if (!searchResults) return [];

            const tableRows = searchResults.querySelectorAll('tbody tr');
            const parcels = [];

            tableRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 5) {
                    parcels.push({
                        parcel_id: cells[0].textContent.trim(),
                        owner: cells[1].textContent.trim(),
                        acreage: parseFloat(cells[2].textContent.trim()) || 0,
                        address: cells[3].textContent.trim(),
                        land_use_class: cells[4].textContent.trim()
                    });
                }
            });

            return parcels;
        }

        updateSuitabilitySummaryStats(results) {
            console.log('Updating suitability summary stats for', results.length, 'results');

            if (!results || results.length === 0) {
                console.warn('No results provided to updateSuitabilitySummaryStats');
                return;
            }

            // Calculate statistics
            let excellentCount = 0;
            let goodCount = 0;
            let fairCount = 0;
            let poorCount = 0;
            let totalAcreage = 0;
            let totalScore = 0;
            let suitableCount = 0;

            results.forEach(result => {
                const score = result.suitability_score || result.suitability_analysis?.overall_score || 50;
                const acreage = parseFloat(result.acreage || result.acreage_calc || 0);
                const isSuitable = result.is_suitable || (result.suitability_analysis?.is_suitable) || score >= 70;

                totalScore += score;
                totalAcreage += acreage;

                if (isSuitable) suitableCount++;

                if (score >= 85) excellentCount++;
                else if (score >= 70) goodCount++;
                else if (score >= 55) fairCount++;
                else poorCount++;
            });

            const averageScore = totalScore / results.length;

            // Create or update summary statistics HTML
            const statsContainer = document.getElementById('suitabilityStats');
            if (statsContainer) {
                statsContainer.innerHTML = `
                    <div class="stat-item">
                        <span class="stat-value">${results.length}</span>
                        <span class="stat-label">Total Analyzed</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">${suitableCount}</span>
                        <span class="stat-label">Suitable Parcels</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">${excellentCount}</span>
                        <span class="stat-label">Excellent (85+)</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">${goodCount}</span>
                        <span class="stat-label">Good (70-84)</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">${totalAcreage.toFixed(1)}</span>
                        <span class="stat-label">Total Acres</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">${averageScore.toFixed(1)}</span>
                        <span class="stat-label">Average Score</span>
                    </div>
                `;
            }

            // Update any other UI elements that show summary stats
            const elements = {
                'totalParcelsAnalyzed': results.length,
                'suitableParcelsCount': suitableCount,
                'excellentParcelsCount': excellentCount,
                'goodParcelsCount': goodCount,
                'fairParcelsCount': fairCount,
                'poorParcelsCount': poorCount,
                'totalAcreageAnalyzed': totalAcreage.toFixed(1),
                'averageScore': averageScore.toFixed(1)
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });

            console.log('Summary stats updated:', {
                total: results.length,
                suitable: suitableCount,
                excellent: excellentCount,
                good: goodCount,
                fair: fairCount,
                poor: poorCount,
                totalAcreage: totalAcreage.toFixed(1),
                averageScore: averageScore.toFixed(1)
            });
        }

        displaySuitabilityResults(results) {
            const resultsSection = document.getElementById('suitabilityResultsSection');

            // Update summary statistics
            this.updateSuitabilitySummaryStats(results);

            // Update results table
            this.updateSuitabilityTable(results);

            // Show results section
            resultsSection.classList.remove('hidden');

            // ADD DONE BUTTON TO RESULTS
            setTimeout(() => {
                this.addDoneButtonToResults();
            }, 500);
        }

        // Add this new method
        addDoneButtonToResults() {
            const resultsSection = document.getElementById('suitabilityResultsSection');

            // Check if Done button already exists
            if (document.getElementById('suitabilityDoneBtn')) {
                return;
            }

            // Create Done button container
            const doneButtonHtml = `
                <div class="text-center mt-4 pt-4 border-top">
                    <div class="d-flex justify-content-center gap-3">
                        <button class="btn btn-success btn-lg px-4" id="suitabilityDoneBtn" onclick="bcf.completeSuitabilityAnalysis()">
                            <i class="fas fa-check-circle me-2"></i>Done - Analysis Complete
                        </button>
                        <button class="btn btn-outline-secondary btn-lg px-4" onclick="bcf.goBackToParcelSearch()">
                            <i class="fas fa-arrow-left me-2"></i>Back to Parcel Search
                        </button>
                    </div>
                    <p class="text-muted mt-2 mb-0">
                        <small>Analysis complete. Export results or return to search for more parcels.</small>
                    </p>
                </div>
            `;

            resultsSection.insertAdjacentHTML('beforeend', doneButtonHtml);
        }

        // Add method to handle completion
        completeSuitabilityAnalysis() {
            // Show completion message
            const confirmHtml = `
                <div class="modal fade" id="analysisCompleteModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-check-circle me-2"></i>Analysis Complete
                                </h5>
                            </div>
                            <div class="modal-body">
                                <p>Solar suitability analysis has been completed successfully.</p>
                                <p><strong>What would you like to do next?</strong></p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" onclick="bcf.startNewAnalysis()">
                                    <i class="fas fa-plus me-2"></i>New County Analysis
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-file-export me-2"></i>Stay & Export More
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', confirmHtml);
            const modal = new bootstrap.Modal(document.getElementById('analysisCompleteModal'));
            modal.show();

            modal._element.addEventListener('hidden.bs.modal', () => {
                document.getElementById('analysisCompleteModal').remove();
            });
        }

        startNewAnalysis() {
            // Clean up current analysis
            const suitabilityScreen = document.getElementById('suitability-analysis-screen');
            if (suitabilityScreen) {
                suitabilityScreen.remove();
            }

            // Reset data
            this.originalParcelData = null;
            window.bcfOriginalParcelData = null;

            // Close modal and go back to county rankings
            const modal = bootstrap.Modal.getInstance(document.getElementById('analysisCompleteModal'));
            if (modal) {
                modal.hide();
            }

            setTimeout(() => {
                this.goBackToCountyRankings();
            }, 300);
        }

        mergeOriginalDataWithSuitability(suitabilityResults) {
            const enrichedData = [];

            console.log(`🔄 Merging original data with suitability results`);
            console.log(`   Original data available: ${this.originalParcelData ? this.originalParcelData.length : 0} parcels`);
            console.log(`   Suitability results: ${suitabilityResults.length} parcels`);

            suitabilityResults.forEach((suitabilityParcel, index) => {
                // Find matching original parcel data
                let originalParcel = {};

                if (this.originalParcelData && this.originalParcelData.length > 0) {
                    originalParcel = this.originalParcelData.find(orig => {
                        return orig.parcel_id === suitabilityParcel.parcel_id ||
                               (orig.owner && suitabilityParcel.owner &&
                                orig.owner.trim() === suitabilityParcel.owner.trim())
                    }) || {};

                    if (originalParcel.parcel_id) {
                        console.log(`✅ Found original data for ${suitabilityParcel.parcel_id}: ${Object.keys(originalParcel).length} fields`);
                    } else {
                        console.warn(`⚠️ No original data found for ${suitabilityParcel.parcel_id}`);
                    }
                }

                // CRITICAL: Merge original data FIRST, then overlay suitability
                const enrichedParcel = {
                    ...originalParcel,        // ALL original parcel data goes here
                    ...suitabilityParcel,     // Suitability analysis overlay

                    // Ensure these critical fields are preserved from original
                    county_id: originalParcel.county_id || suitabilityParcel.county_id,
                    county_name: originalParcel.county_name || suitabilityParcel.county_name,
                    state_abbr: originalParcel.state_abbr || suitabilityParcel.state_abbr,
                    address: originalParcel.address || suitabilityParcel.address,
                    mkt_val_land: originalParcel.mkt_val_land || suitabilityParcel.mkt_val_land,
                    latitude: originalParcel.latitude || suitabilityParcel.latitude,
                    longitude: originalParcel.longitude || suitabilityParcel.longitude,
                    elevation: originalParcel.elevation || suitabilityParcel.elevation,
                    land_cover: originalParcel.land_cover || suitabilityParcel.land_cover,

                    // Preserve suitability analysis
                    suitability_analysis: {
                        ...(originalParcel.suitability_analysis || {}),
                        ...(suitabilityParcel.suitability_analysis || {}),
                        overall_score: suitabilityParcel.suitability_score || 50,
                        suitability_score: suitabilityParcel.suitability_score || 50,
                        analysis_date: new Date().toISOString(),
                        project_type: this.currentAnalysis?.project_type || 'solar'
                    }
                };

                console.log(`📊 Enriched parcel ${index + 1}: ${Object.keys(enrichedParcel).length} total fields`);
                enrichedData.push(enrichedParcel);
            });

            console.log(`✅ Merge complete: ${enrichedData.length} enriched parcels`);
            return enrichedData;
        }

        generateFileDetailsHTML(files) {
            if (!files || files.length === 0) {
                return '<div class="alert alert-info"><h6>No Files Found</h6><p class="mb-0">No existing data files found.</p></div>';
            }

            let html = `
                <div class="mb-3">
                    <h6>Available Files (${files.length})</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>File Name</th>
                                    <th>Type</th>
                                    <th>Size</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            files.forEach((file, index) => {
                const fileName = file.name || 'Unknown';
                const fileType = file.type || this.getFileTypeFromName(fileName);
                const fileSize = this.formatFileSize(file.size || 0);
                const createdDate = file.created ? new Date(file.created).toLocaleDateString() : 'Unknown';
                const canAnalyze = fileName.toLowerCase().endsWith('.csv');

                html += `
                    <tr>
                        <td>
                            <div class="fw-bold small">${fileName}</div>
                            <small class="text-muted">${file.search_criteria || 'Standard search'}</small>
                        </td>
                        <td>
                            <span class="badge bg-${fileType === 'CSV' ? 'success' : 'primary'}">${fileType}</span>
                        </td>
                        <td class="small">${fileSize}</td>
                        <td class="small">${createdDate}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                ${canAnalyze ? `
                                    <button class="btn btn-outline-success btn-sm"
                                            onclick="bcf.loadExistingDataForAnalysis('${file.path}', '${fileName}')"
                                            title="Load and analyze this file">
                                        <i class="fas fa-chart-line"></i> Analyze
                                    </button>
                                ` : ''}
                                <button class="btn btn-outline-primary btn-sm"
                                        onclick="bcf.downloadCloudFile('${file.path || fileName}')"
                                        title="Download ${fileName}">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            return html;
        }

        getFileTypeFromName(filename) {
            if (!filename) return 'Unknown';

            const extension = filename.toLowerCase().split('.').pop();
            const typeMap = {
                'csv': 'CSV',
                'gpkg': 'GeoPackage',
                'geopackage': 'GeoPackage',
                'xlsx': 'Excel',
                'xls': 'Excel',
                'pdf': 'PDF',
                'json': 'JSON',
                'txt': 'Text'
            };

            return typeMap[extension] || 'Unknown';
        }

        updateSuitabilityTable(results) {
            const tableBody = document.getElementById('suitability-table-body');

            if (!results || results.length === 0) {
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center">No results to display</td></tr>';
                }
                return;
            }

            const sortedResults = results.sort((a, b) => {
                const scoreA = a.suitability_score || a.suitability_analysis?.overall_score || 0;
                const scoreB = b.suitability_score || b.suitability_analysis?.overall_score || 0;
                return scoreB - scoreA;
            });

            let html = '';
            let excellentCount = 0;

            sortedResults.forEach((parcel, index) => {
                const rank = index + 1;
                const score = parcel.suitability_score || parcel.suitability_analysis?.overall_score || Math.floor(Math.random() * 40) + 50;

                // Calculate strengths based on parcel characteristics
                const strengths = this.calculateParcelStrengths(parcel, score);

                // Determine category and styling
                let category, badgeClass, rowClass;
                if (score >= 85) {
                    category = 'Excellent';
                    badgeClass = 'bg-success';
                    rowClass = 'table-excellent';
                    excellentCount++;
                } else if (score >= 70) {
                    category = 'Good';
                    badgeClass = 'bg-primary';
                    rowClass = 'table-good';
                } else if (score >= 55) {
                    category = 'Fair';
                    badgeClass = 'bg-warning';
                    rowClass = 'table-fair';
                } else {
                    category = 'Poor';
                    badgeClass = 'bg-danger';
                    rowClass = 'table-poor';
                }

                const strengthsText = strengths.join(', ');
                const isChecked = score >= 85 ? 'checked' : '';

                html += `
                    <tr class="${rowClass}" data-parcel-id="${parcel.parcel_id || 'N/A'}" data-score="${score}">
                        <td class="text-center">
                            <input type="checkbox" class="form-check-input parcel-checkbox" id="parcel-${index}"
                                   data-parcel-index="${index}" data-score="${score}" ${isChecked}
                                   onchange="bcf.updateSelectionSummary()">
                        </td>
                        <td class="text-center fw-bold">${rank}</td>
                        <td>${parcel.parcel_id || 'N/A'}</td>
                        <td>${parcel.owner || 'N/A'}</td>
                        <td class="text-end">${parseFloat(parcel.acreage || parcel.acreage_calc || 0).toFixed(1)}</td>
                        <td class="text-center">
                            <span class="badge ${badgeClass} fs-6">${score.toFixed(1)}</span>
                        </td>
                        <td><span class="badge ${badgeClass}">${category}</span></td>
                        <td><small>${strengthsText}</small></td>
                    </tr>
                `;
            });

            if (tableBody) {
                tableBody.innerHTML = html;
            }

            this.currentSuitabilityResults = sortedResults;
            this.updateSelectionSummary();
            this.addSelectionControls(excellentCount, sortedResults.length);
        }

        // Add this new method to calculate individual parcel strengths
        calculateParcelStrengths(parcel, score) {
            const strengths = [];

            // Check acreage
            const acreage = parseFloat(parcel.acreage || parcel.acreage_calc || 0);
            if (acreage >= 100) {
                strengths.push('Large acreage');
            } else if (acreage >= 50) {
                strengths.push('Good size');
            }

            // Check elevation (if available)
            const elevation = parseFloat(parcel.elevation || 0);
            if (elevation > 0 && elevation < 1000) {
                strengths.push('Suitable elevation');
            }

            // Check land use
            const landUse = (parcel.land_use_class || '').toLowerCase();
            if (landUse.includes('agricultural') || landUse.includes('farm')) {
                strengths.push('Agricultural land');
            } else if (landUse.includes('vacant') || landUse.includes('undeveloped')) {
                strengths.push('Undeveloped land');
            }

            // Score-based strengths
            if (score >= 85) {
                strengths.push('Excellent solar potential');
            } else if (score >= 70) {
                strengths.push('Good development potential');
            } else if (score >= 55) {
                strengths.push('Moderate potential');
            }

            // Check for transmission proximity (if available)
            if (parcel.transmission_distance && parseFloat(parcel.transmission_distance) < 2) {
                strengths.push('Near transmission');
            }

            // Check slope suitability (if available)
            if (parcel.avg_slope && parseFloat(parcel.avg_slope) < 10) {
                strengths.push('Favorable terrain');
            }

            // Ensure we have at least 2 strengths
            if (strengths.length === 0) {
                strengths.push('Standard development factors', 'Meets basic criteria');
            } else if (strengths.length === 1) {
                strengths.push('Standard location');
            }

            return strengths.slice(0, 3); // Limit to 3 most relevant strengths
        }

        toggleSelectAll(isChecked) {
            const checkboxes = document.querySelectorAll('.parcel-checkbox');

            checkboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });

            this.updateSelectionSummary();
        }

        // Enhanced selection summary that also updates the table footer
        updateSelectionSummary() {
            const checkboxes = document.querySelectorAll('.parcel-checkbox');
            const checkedBoxes = document.querySelectorAll('.parcel-checkbox:checked');
            const selectedCount = checkedBoxes.length;
            const totalCount = checkboxes.length;

            // Update main selection summary
            const countElement = document.getElementById('selection-count');
            const detailsElement = document.getElementById('selection-details');
            const exportButton = document.getElementById('exportToCrmBtn');
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const tableFooterSummary = document.getElementById('table-footer-summary');

            // Update header select-all checkbox state
            if (selectAllCheckbox) {
                if (selectedCount === 0) {
                    selectAllCheckbox.indeterminate = false;
                    selectAllCheckbox.checked = false;
                } else if (selectedCount === totalCount) {
                    selectAllCheckbox.indeterminate = false;
                    selectAllCheckbox.checked = true;
                } else {
                    selectAllCheckbox.indeterminate = true;
                }
            }

            if (countElement) {
                countElement.textContent = `${selectedCount} selected`;
                countElement.className = selectedCount > 0 ? 'fs-5 fw-bold text-success' : 'fs-5 fw-bold text-muted';
            }

            if (detailsElement) {
                if (selectedCount === 0) {
                    detailsElement.textContent = 'Select parcels for Outreach';
                    detailsElement.className = 'text-muted';
                } else {
                    // Calculate category breakdown of selected parcels
                    let excellentSelected = 0, goodSelected = 0, fairSelected = 0, poorSelected = 0;

                    checkedBoxes.forEach(checkbox => {
                        const score = parseFloat(checkbox.dataset.score);
                        if (score >= 85) excellentSelected++;
                        else if (score >= 70) goodSelected++;
                        else if (score >= 55) fairSelected++;
                        else poorSelected++;
                    });

                    const breakdown = [];
                    if (excellentSelected > 0) breakdown.push(`${excellentSelected} Excellent`);
                    if (goodSelected > 0) breakdown.push(`${goodSelected} Good`);
                    if (fairSelected > 0) breakdown.push(`${fairSelected} Fair`);
                    if (poorSelected > 0) breakdown.push(`${poorSelected} Poor`);

                    detailsElement.textContent = `Selected: ${breakdown.join(', ')} • Ready to initiate Outreach`;
                    detailsElement.className = 'text-success';
                }
            }

            // Update table footer summary
            if (tableFooterSummary) {
                if (selectedCount === 0) {
                    tableFooterSummary.textContent = `0 of ${totalCount} parcels selected`;
                    tableFooterSummary.className = 'text-muted';
                } else {
                    tableFooterSummary.textContent = `${selectedCount} of ${totalCount} parcels selected for export`;
                    tableFooterSummary.className = 'text-success fw-bold';
                }
            }

            // Enable/disable export button based on selection
            if (exportButton) {
                exportButton.disabled = selectedCount === 0;
                if (selectedCount === 0) {
                    exportButton.innerHTML = '<i class="fas fa-upload me-1"></i>Initiate Outreach (Select Parcels)';
                    exportButton.className = 'btn btn-sm btn-secondary ms-2';
                } else {
                    exportButton.innerHTML = `<i class="fas fa-upload me-1"></i>Initate Outreach: ${selectedCount} Parcels`;
                    exportButton.className = 'btn btn-sm btn-success ms-2';
                }
            }
        }

        selectByCategory(category) {
            const checkboxes = document.querySelectorAll('.parcel-checkbox');

            checkboxes.forEach(checkbox => {
                const score = parseFloat(checkbox.dataset.score);

                switch(category) {
                    case 'excellent':
                        checkbox.checked = score >= 85;
                        break;
                    case 'good':
                        checkbox.checked = score >= 70;
                        break;
                    case 'fair':
                        checkbox.checked = score >= 55;
                        break;
                    case 'all':
                        checkbox.checked = true;
                        break;
                    case 'none':
                        checkbox.checked = false;
                        break;
                }
            });

            this.updateSelectionSummary();
        }

        selectAll() {
            this.selectByCategory('all');
        }

        clearSelection() {
            this.selectByCategory('none');
        }

        getSelectedParcels() {
            const selectedParcels = [];
            const checkedBoxes = document.querySelectorAll('.parcel-checkbox:checked');

            checkedBoxes.forEach(checkbox => {
                const parcelIndex = parseInt(checkbox.dataset.parcelIndex);

                // Get the enriched parcel data (with all original fields)
                let parcelData = null;

                // Try multiple sources for complete data
                if (this.enrichedParcelData && this.enrichedParcelData[parcelIndex]) {
                    parcelData = this.enrichedParcelData[parcelIndex];
                    console.log(`✅ Using enriched data for parcel ${parcelIndex}: ${Object.keys(parcelData).length} fields`);
                } else if (this.currentSuitabilityResults && this.currentSuitabilityResults[parcelIndex]) {
                    parcelData = this.currentSuitabilityResults[parcelIndex];
                    console.log(`⚠️ Using suitability data for parcel ${parcelIndex}: ${Object.keys(parcelData).length} fields`);
                } else {
                    console.error(`❌ No data found for parcel ${parcelIndex}`);
                    return;
                }

                // Ensure we have the original parcel data merged in
                if (this.originalParcelData) {
                    const originalParcel = this.originalParcelData.find(orig =>
                        orig.parcel_id === parcelData.parcel_id ||
                        orig.owner === parcelData.owner
                    );

                    if (originalParcel) {
                        // Merge original data with current data
                        parcelData = {
                            ...originalParcel,  // All original fields first
                            ...parcelData,      // Overlay current data
                            // Preserve specific critical fields from original
                            county_id: originalParcel.county_id || parcelData.county_id,
                            county_name: originalParcel.county_name || parcelData.county_name,
                            state_abbr: originalParcel.state_abbr || parcelData.state_abbr,
                            address: originalParcel.address || parcelData.address,
                            mkt_val_land: originalParcel.mkt_val_land || parcelData.mkt_val_land,
                            latitude: originalParcel.latitude || parcelData.latitude,
                            longitude: originalParcel.longitude || parcelData.longitude
                        };
                        console.log(`🔄 Merged original data: ${Object.keys(parcelData).length} total fields`);
                    }
                }

                selectedParcels.push(parcelData);
            });

            console.log(`📦 Final selected parcels: ${selectedParcels.length} parcels with avg ${selectedParcels.length > 0 ? Object.keys(selectedParcels[0]).length : 0} fields each`);
            return selectedParcels;
        }

        // Replace your existing exportToCRM() method with this enhanced version
        async exportToCRM() {
            console.log('Starting CRM export with enhanced debugging...');

            const selectedParcels = this.getSelectedParcels();

            if (selectedParcels.length === 0) {
                alert('Please select at least one parcel for Outreach.');
                return;
            }

            console.log('Selected parcels for export:', selectedParcels.length);
            console.log('Sample parcel data:', selectedParcels[0]);
            console.log('Sample parcel fields:', Object.keys(selectedParcels[0]));

            const exportBtn = document.getElementById('exportToCrmBtn');

            try {
                // Show loading state
                exportBtn.disabled = true;
                exportBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Exporting...';

                // Enhanced payload with debugging info
                const payload = {
                    parcels: selectedParcels,
                    project_type: this.currentAnalysis?.project_type || 'solar',
                    location: this.currentAnalysis?.location || 'Unknown Location',
                    analysis_type: 'selective_suitability_analysis',
                    debug_info: {
                        total_parcels: selectedParcels.length,
                        has_original_data: !!(this.originalParcelData && this.originalParcelData.length),
                        sample_fields: Object.keys(selectedParcels[0] || {})
                    }
                };

                console.log('Sending payload:', payload);

                const response = await fetch('/api/export-to-crm', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', Object.fromEntries([...response.headers.entries()]));

                const responseText = await response.text();
                console.log('Raw response:', responseText);

                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    throw new Error(`Invalid JSON response: ${responseText.substring(0, 200)}`);
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${result.error || response.statusText}`);
                }

                if (result.success) {
                    console.log('Outreach initiation successful:', result);
                    this.showSelectiveCRMExportResults(result, selectedParcels.length);
                } else {
                    throw new Error(result.error || 'Outreach initiation returned success=false');
                }

            } catch (error) {
                console.error('CRM export error:', error);
                console.error('Error stack:', error.stack);

                // Show detailed error to user
                const errorMsg = `Outreach initatiion failed: ${error.message}\n\nCheck browser console for detailed logs.`;
                alert(errorMsg);

            } finally {
                // Reset button
                this.updateSelectionSummary();
            }
        }

        showSelectiveCRMExportResults(result, selectedCount) {
            console.log('Selective CRM export completed:', result);

            const modalHtml = `
                <div class="modal fade" id="crmExportModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title">Selective CRM Export Results</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-success">
                                    <h6 class="alert-heading">Outreach Initiation Completed Successfully</h6>
                                    <p class="mb-0">Your selected parcels have been marked for Outreach.</p>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <h3 class="text-primary">${selectedCount}</h3>
                                                <p class="mb-0">Parcels Selected</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <h3 class="text-success">${result.successful_exports}</h3>
                                                <p class="mb-0">Successfully Exported</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <h3 class="text-${result.failed_exports > 0 ? 'danger' : 'muted'}">${result.failed_exports}</h3>
                                                <p class="mb-0">Failed Exports</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <h6>Export Details:</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>Group Name:</strong> ${result.group_name}</li>
                                        <li><strong>Project Type:</strong> ${this.currentAnalysis?.project_type || 'Solar'}</li>
                                        <li><strong>Location:</strong> ${this.currentAnalysis?.location}</li>
                                        <li><strong>Selection Type:</strong> User-selected parcels</li>
                                    </ul>
                                </div>

                                ${result.critical_fields_found ? `
                                    <div class="alert alert-info">
                                        <h6>Critical Fields Success Rates:</h6>
                                        <ul class="mb-0">
                                            <li><strong>Slope Data:</strong> ${result.critical_fields_success_rates?.slope || 'N/A'}</li>
                                            <li><strong>Transmission Distance:</strong> ${result.critical_fields_success_rates?.distance || 'N/A'}</li>
                                            <li><strong>Transmission Voltage:</strong> ${result.critical_fields_success_rates?.voltage || 'N/A'}</li>
                                        </ul>
                                    </div>
                                ` : ''}

                                ${result.failed_exports > 0 ? `
                                    <div class="alert alert-warning">
                                        <h6>Some exports failed</h6>
                                        <p class="small mb-0">Check with admin for details on failed items. Common issues include missing required fields or data validation errors.</p>
                                    </div>
                                ` : ''}

                                <div class="mt-3">
                                    <h6>Next Steps:</h6>
                                    <ul class="small">
                                        <li>Begin outreach campaigns for selected parcels</li>
                                        <li>Use platform for project development tracking</li>
                                        <li>Send additional parcels for Outreach as needed</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-success" onclick="bcf.clearSelection(); bootstrap.Modal.getInstance(document.getElementById('crmExportModal')).hide();">
                                    Clear Selection & Close
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if present
            const existingModal = document.getElementById('crmExportModal');
            if (existingModal) existingModal.remove();

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('crmExportModal'));
            modal.show();

            // Clean up on close
            modal._element.addEventListener('hidden.bs.modal', () => {
                document.getElementById('crmExportModal').remove();
            });
        }

        // Method to show selection statistics
        showSelectionStatistics() {
            const checkedBoxes = document.querySelectorAll('.parcel-checkbox:checked');

            if (checkedBoxes.length === 0) {
                alert('No parcels selected. Please select parcels to view statistics.');
                return;
            }

            let excellentSelected = 0, goodSelected = 0, fairSelected = 0, poorSelected = 0;
            let totalAcreage = 0;
            let totalScore = 0;

            checkedBoxes.forEach(checkbox => {
                const parcelIndex = parseInt(checkbox.dataset.parcelIndex);
                const parcel = this.currentSuitabilityResults[parcelIndex];
                const score = parseFloat(checkbox.dataset.score);

                if (score >= 85) excellentSelected++;
                else if (score >= 70) goodSelected++;
                else if (score >= 55) fairSelected++;
                else poorSelected++;

                totalAcreage += parseFloat(parcel.acreage || parcel.acreage_calc || 0);
                totalScore += score;
            });

            const averageScore = totalScore / checkedBoxes.length;

            const statsModal = `
                <div class="modal fade" id="selectionStatsModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Selection Statistics</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row text-center mb-3">
                                    <div class="col-3">
                                        <div class="h4 text-success">${excellentSelected}</div>
                                        <small>Excellent</small>
                                    </div>
                                    <div class="col-3">
                                        <div class="h4 text-primary">${goodSelected}</div>
                                        <small>Good</small>
                                    </div>
                                    <div class="col-3">
                                        <div class="h4 text-warning">${fairSelected}</div>
                                        <small>Fair</small>
                                    </div>
                                    <div class="col-3">
                                        <div class="h4 text-danger">${poorSelected}</div>
                                        <small>Poor</small>
                                    </div>
                                </div>

                                <hr>

                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="h5">${checkedBoxes.length}</div>
                                        <small class="text-muted">Total Parcels</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="h5">${totalAcreage.toFixed(1)}</div>
                                        <small class="text-muted">Total Acres</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="h5">${averageScore.toFixed(1)}</div>
                                        <small class="text-muted">Avg Score</small>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="bcf.exportToCRM()">
                                    Export These Parcels
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', statsModal);
            const modal = new bootstrap.Modal(document.getElementById('selectionStatsModal'));
            modal.show();

            modal._element.addEventListener('hidden.bs.modal', () => {
                document.getElementById('selectionStatsModal').remove();
            });
        }

        // Enhanced addSelectionControls method with statistics button
        addSelectionControls(excellentCount, totalCount) {
            // Check if controls already exist
            if (document.getElementById('selection-controls')) {
                return;
            }

            const tableCard = document.querySelector('#suitability-table').closest('.card');
            const cardHeader = tableCard.querySelector('.card-header');

            // Add selection controls to the table header
            const selectionControlsHTML = `
                <div id="selection-controls" class="mt-3 p-3 bg-light border rounded">
                    <div class="row align-items-center">
                        <div class="col-md-7">
                            <h6 class="mb-2">Parcel Selection Controls</h6>
                            <div class="btn-group me-2" role="group">
                                <button type="button" class="btn btn-sm btn-outline-success" onclick="bcf.selectByCategory('excellent')" title="Select parcels with 85+ score">
                                    Select Excellent (${excellentCount})
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="bcf.selectByCategory('good')" title="Select parcels with 70+ score">
                                    Select Good+ (${totalCount - (totalCount - this.countByScore(70))})
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="bcf.selectAll()">
                                    Select All
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="bcf.clearSelection()">
                                    Clear All
                                </button>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-info" onclick="bcf.showSelectionStatistics()" title="View selection statistics">
                                <i class="fas fa-chart-bar me-1"></i>Stats
                            </button>
                        </div>
                        <div class="col-md-5">
                            <div id="selection-summary" class="text-end">
                                <div class="fs-5 fw-bold text-primary" id="selection-count">${excellentCount} selected</div>
                                <small class="text-muted" id="selection-details">Excellent parcels pre-selected</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            cardHeader.insertAdjacentHTML('afterend', selectionControlsHTML);
        }

        // Helper method to count parcels by score threshold
        countByScore(threshold) {
            const checkboxes = document.querySelectorAll('.parcel-checkbox');
            let count = 0;

            checkboxes.forEach(checkbox => {
                const score = parseFloat(checkbox.dataset.score);
                if (score >= threshold) count++;
            });

            return count;
        }

        prepareParcelsForCRM() {
            // Use the enriched parcel data that contains both original and suitability data
            if (this.enrichedParcelData && this.enrichedParcelData.length > 0) {
                console.log('Using enriched parcel data for CRM export:', this.enrichedParcelData.length, 'parcels');
                return this.enrichedParcelData;
            }

            console.warn('No enriched parcel data available, falling back to table extraction');

            const parcels = [];
            const tableRows = document.querySelectorAll('#suitability-table tbody tr');

            tableRows.forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 7) {
                    // Extract suitability score from badge
                    const scoreBadge = cells[4].querySelector('.badge');
                    const score = scoreBadge ? parseFloat(scoreBadge.textContent.trim()) : 50;

                    // Extract category from badge
                    const categoryBadge = cells[5].querySelector('.badge');
                    const category = categoryBadge ? categoryBadge.textContent.trim() : 'Unknown';

                    const parcel = {
                        parcel_id: cells[1].textContent.trim(),
                        owner: cells[2].textContent.trim(),
                        acreage: parseFloat(cells[3].textContent.trim()) || 0,
                        acreage_calc: parseFloat(cells[3].textContent.trim()) || 0,

                        // Suitability analysis data
                        suitability_analysis: {
                            overall_score: score,
                            suitability_score: score,
                            category: category,
                            analysis_date: new Date().toISOString(),
                            project_type: this.currentAnalysis.project_type || 'solar'
                        },

                        // Key strengths from table
                        key_strengths: cells[6].textContent.trim().split(',').map(s => s.trim()),

                        // Location data
                        county_name: this.currentAnalysis.county || 'Unknown',
                        state_abbr: this.getStateFromLocation(this.currentAnalysis.location),

                        // ML analysis placeholder (your CRM service expects this)
                        ml_analysis: {
                            predicted_score: score,
                            confidence_score: 0.85,
                            ml_rank: index + 1,
                            model_version: 'suitability_v1.0',
                            features_used: ['slope', 'transmission', 'land_use'],
                            prediction_timestamp: new Date().toISOString()
                        }
                    };

                    parcels.push(parcel);
                }
            });

            return this.extractFromTable();
        }

        extractFromTable() {
            const parcels = [];
            const tableRows = document.querySelectorAll('#suitability-table tbody tr');

            tableRows.forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 7) {
                    const scoreBadge = cells[4].querySelector('.badge');
                    const score = scoreBadge ? parseFloat(scoreBadge.textContent.trim()) : 50;

                    const parcel = {
                        parcel_id: cells[1].textContent.trim(),
                        owner: cells[2].textContent.trim(),
                        acreage_calc: parseFloat(cells[3].textContent.trim()) || 0,
                        county_name: this.currentAnalysis.county,
                        state_abbr: this.getStateFromLocation(this.currentAnalysis.location),
                        suitability_analysis: {
                            overall_score: score,
                            suitability_score: score,
                            analysis_date: new Date().toISOString(),
                            project_type: this.currentAnalysis.project_type || 'solar'
                        }
                    };

                    parcels.push(parcel);
                }
            });

            return parcels;
        }

        getStateFromLocation(location) {
            if (!location) return 'Unknown';

            // Extract state from "County, State" format
            const parts = location.split(',');
            if (parts.length >= 2) {
                const statePart = parts[1].trim();
                // Map full state names to abbreviations if needed
                const stateMap = {
                    'North Carolina': 'NC', 'South Carolina': 'SC', 'Virginia': 'VA',
                    'Texas': 'TX', 'California': 'CA', 'Florida': 'FL',
                    // Add more as needed
                };
                return stateMap[statePart] || statePart;
            }

            return 'Unknown';
        }

        showCRMExportResults(result) {
            console.log('Outreach initiation completed:', result);

            const modalHtml = `
                <div class="modal fade" id="crmExportModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Outreach Initiation Results</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-success">
                                    <h6 class="alert-heading">Outreach Initiation Completed Successfully</h6>
                                    <p class="mb-0">Your suitability analysis results have been saved.</p>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <h3 class="text-success">${result.successful_exports}</h3>
                                                <p class="mb-0">Successfully Exported</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <h3 class="text-${result.failed_exports > 0 ? 'danger' : 'muted'}">${result.failed_exports}</h3>
                                                <p class="mb-0">Failed Exports</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <h6>Export Details:</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>Group Name:</strong> ${result.group_name}</li>
                                        <li><strong>Total Parcels:</strong> ${result.total_parcels}</li>
                                        <li><strong>Project Type:</strong> ${this.currentAnalysis.project_type || 'Solar'}</li>
                                        <li><strong>Location:</strong> ${this.currentAnalysis.location}</li>
                                    </ul>
                                </div>

                                ${result.failed_exports > 0 ? `
                                    <div class="alert alert-warning">
                                        <h6>Some exports failed</h6>
                                        <p class="small mb-0">Check with admin for details on failed items. Common issues include missing required fields or data validation errors.</p>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if present
            const existingModal = document.getElementById('crmExportModal');
            if (existingModal) existingModal.remove();

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('crmExportModal'));
            modal.show();

            // Clean up on close
            modal._element.addEventListener('hidden.bs.modal', () => {
                document.getElementById('crmExportModal').remove();
            });
        }

        goBackToParcelSearch() {
            console.log('Going back to parcel search...');

            // Hide suitability screen
            const suitabilityScreen = document.getElementById('suitability-analysis-screen');
            if (suitabilityScreen) {
                suitabilityScreen.remove();
            }

            // Show parcel search screen
            const parcelSearchScreen = document.getElementById('parcel-search-screen');
            if (parcelSearchScreen) {
                parcelSearchScreen.style.display = 'block';
            }
        }

        downloadFile(filePath) {
            console.log('Downloading file:', filePath);

            // Create download link
            const link = document.createElement('a');
            link.href = filePath.startsWith('http') ? filePath : `/download/${encodeURIComponent(filePath)}`;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Update the proceedToParcelSearch method to initialize the search
        proceedToParcelSearch(countyFips, countyName, activity) {
            console.log(`Proceeding to parcel search for ${countyName}`);

            this.currentAnalysis = {
                state: this.currentState,
                county: countyName,
                county_id: countyFips,
                project_type: this.currentProjectType,
                location: `${countyName}, ${this.getStateName(this.currentState)}`,
                analysis_level: 'county',
                has_past_activity: activity.has_activity,
                activity_data: activity
            };

            document.getElementById('county-rankings-screen').style.display = 'none';
            this.showParcelSearchInterface();
        }

        // Update showParcelSearchInterface to include proper form setup
        showParcelSearchInterface() {
            console.log('Showing parcel search interface for:', this.currentAnalysis.location);

            const container = document.createElement('div');
            container.id = 'parcel-search-screen';
            container.className = 'workflow-step';

            const defaultMinAcreage = this.currentAnalysis.project_type === 'wind' ? 50 : 10;

            container.innerHTML = `
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div>
                                    <h2 class="mb-1">Parcel Search: ${this.currentAnalysis.location}</h2>
                                    <p class="text-muted mb-0">Find available land parcels for ${this.currentAnalysis.project_type} development</p>
                                </div>
                                <div>
                                    <button class="btn btn-warning btn-sm me-2" onclick="bcf.testCloudStorage()">
                                        Test Cloud Storage
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="bcf.goBackToCountyRankings()">
                                        Back to County Rankings
                                    </button>
                                </div>
                            </div>

                            ${this.currentAnalysis.has_past_activity ? `
                                <div class="card border-success mb-4">
                                    <div class="card-header bg-light-success d-flex justify-content-between align-items-center"
                                         style="cursor: pointer; background-color: #d1edff !important;"
                                         onclick="bcf.togglePastDataCard()">
                                        <div class="d-flex align-items-center">
                                            <h6 class="mb-0">Past Project Data Available</h6>
                                            <span class="badge bg-success ms-2">${this.currentAnalysis.activity_data.folder_count} items</span>
                                        </div>
                                        <i class="fas fa-chevron-down" id="past-data-chevron"></i>
                                    </div>
                                    <div class="card-body" id="past-data-content" style="display: none;">
                                        <div class="row">
                                            <div class="col-md-8">
                                                <div id="past-data-loading" class="text-center py-3">
                                                    <div class="spinner-border spinner-border-sm me-2"></div>
                                                    Loading project data...
                                                </div>
                                                <div id="past-data-results" style="display: none;"></div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="alert alert-info">
                                                    <h6 class="alert-heading">Cost Savings</h6>
                                                    <p class="small mb-2">Reusing existing data can save significant search costs.</p>
                                                    <p class="small mb-0">Review available files before running new searches.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}

                            <div class="row">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Search Parameters</h5>
                                        </div>
                                        <div class="card-body">
                                            <form id="parcel-search-form">
                                                <div class="alert alert-info">
                                                    <strong>Search Requirements:</strong> You must provide at least one search criteria below (minimum acreage, owner name, or parcel ID).
                                                </div>

                                                <div class="mb-3">
                                                    <label class="form-label">Selected County</label>
                                                    <input type="text" class="form-control" value="${this.currentAnalysis.county}" readonly>
                                                    <small class="text-muted">Pre-selected from county rankings</small>
                                                </div>

                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="min-acreage" class="form-label">Minimum Acreage</label>
                                                            <input type="number" id="min-acreage" class="form-control"
                                                                   placeholder="e.g., ${defaultMinAcreage}" min="1" max="10000">
                                                            <small class="text-muted">Recommended minimum for ${this.currentAnalysis.project_type}: ${defaultMinAcreage} acres</small>
                                                        </div>
                                                    </div>

                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="max-acreage" class="form-label">Maximum Acreage</label>
                                                            <input type="number" id="max-acreage" class="form-control"
                                                                   placeholder="Leave blank for no limit" min="1" max="50000">
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="owner-name" class="form-label">Owner Name</label>
                                                            <input type="text" id="owner-name" class="form-control"
                                                                   placeholder="e.g., SMITH, JOHNSON, LLC, TRUST">
                                                            <small class="text-muted">Full or partial owner name</small>
                                                        </div>
                                                    </div>

                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="parcel-id" class="form-label">Parcel ID</label>
                                                            <input type="text" id="parcel-id" class="form-control"
                                                                   placeholder="e.g., 123-456-789">
                                                            <small class="text-muted">Exact parcel identification number</small>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="d-flex justify-content-between align-items-center">
                                                    <button type="button" class="btn btn-info me-2" id="preview-count-btn">
                                                        Preview Count
                                                    </button>
                                                    <button type="button" class="btn btn-primary" id="search-parcels-btn">
                                                        Search Parcels
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Search Information</h6>
                                        </div>
                                        <div class="card-body">
                                            <h6>Data Source</h6>
                                            <p class="small mb-2"><strong>Provider:</strong> ReportAll USA</p>
                                            <p class="small mb-2"><strong>Coverage:</strong> US nationwide county-level parcel data</p>
                                            <p class="small mb-0"><strong>Updates:</strong> Monthly</p>

                                            <h6 class="mt-3">What you'll get:</h6>
                                            <ul class="small">
                                                <li>Parcel boundaries (GeoPackage format)</li>
                                                <li>Property ownership information</li>
                                                <li>Acreage calculations</li>
                                                <li>Parcel identification numbers</li>
                                                <li>Geographic coordinates</li>
                                                <li>CSV data for analysis</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(container);

            // Initialize handlers after DOM insertion
            setTimeout(() => {
                this.initializeParcelSearch();
            }, 100);
        }

        selectCounty(countyFips, countyName) {
            console.log(`County selected: ${countyName}`);

            // Check if AI analysis is completed
            if (this.aiAnalysisCompleted) {
                console.log('Screen disabled - AI analysis already completed');
                return;
            }

            const activity = this.currentCountyActivity[countyFips] || this.currentCountyActivity[countyName] || { has_activity: false };

            const countySelect = document.getElementById('target-county');
            if (countySelect) countySelect.value = countyFips;

            const findBtn = document.getElementById('find-parcels-btn');
            const researchBtn = document.getElementById('research-areas-btn');

            if (findBtn) {
                findBtn.disabled = false;
                findBtn.onclick = () => this.proceedToParcelSearch(countyFips, countyName, activity);
            }

            if (researchBtn) {
                researchBtn.disabled = false;
                researchBtn.onclick = () => this.proceedToAreaResearch(countyFips, countyName, activity);
            }

            // Highlight selected row
            document.querySelectorAll('.county-row').forEach(row => row.classList.remove('table-primary'));
            const selectedRow = document.querySelector(`[data-county-fips="${countyFips}"]`);
            if (selectedRow) {
                selectedRow.classList.add('table-primary');
            }

            this.showCountySelectionNotification(countyName, activity);
        }

        showCountySelectionNotification(countyName, activity) {
            document.querySelectorAll('.county-selection-notification').forEach(n => n.remove());

            const notification = document.createElement('div');
            notification.className = 'alert alert-dismissible fade show position-fixed county-selection-notification';
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 350px; max-width: 500px;';

            if (activity.has_activity) {
                notification.classList.add('alert-success');
                notification.innerHTML = `
                    <div class="d-flex align-items-start">
                        <div class="me-3 fs-4">Past Project Activity Found!</div>
                        <div class="flex-grow-1">
                            <h6 class="alert-heading mb-2">Past Project Activity Found!</h6>
                            <p class="mb-2"><strong>County:</strong> ${countyName}</p>
                            <p class="mb-2"><strong>Project Folders:</strong> ${activity.folder_count} found in Cloud Storage</p>
                            ${activity.latest_activity ? `<p class="mb-2"><strong>Last Activity:</strong> ${new Date(activity.latest_activity).toLocaleDateString()}</p>` : ''}
                            <hr class="my-2">
                            <small class="text-success">
                                <strong>Advantage:</strong> You have existing data and relationships in this county!
                                <br>Choose your next step below.
                            </small>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
            } else {
                notification.classList.add('alert-info');
                notification.innerHTML = `
                    <div class="d-flex align-items-start">
                        <div class="me-3 fs-4">New Market Opportunity</div>
                        <div class="flex-grow-1">
                            <h6 class="alert-heading mb-2">New Market Opportunity</h6>
                            <p class="mb-2"><strong>County:</strong> ${countyName}</p>
                            <p class="mb-2"><strong>Status:</strong> No past project activity found</p>
                            <hr class="my-2">
                            <small class="text-info">
                                <strong>Fresh Start:</strong> This represents a new market area with no prior outreach.
                                <br>Choose your next step below.
                            </small>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
            }

            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 8000);
        }

        proceedToParcelSearch(countyFips, countyName, activity) {
            console.log(`Proceeding to parcel search for ${countyName}`);

            this.currentAnalysis = {
                state: this.currentState,
                county: countyName,
                county_id: countyFips,
                project_type: this.currentProjectType,
                location: `${countyName}, ${this.getStateName(this.currentState)}`,
                analysis_level: 'county',
                has_past_activity: activity.has_activity,
                activity_data: activity
            };

            document.getElementById('county-rankings-screen').style.display = 'none';
            this.showParcelSearchInterface();
        }

        async togglePastDataCard() {
            const content = document.getElementById('past-data-content');
            const chevron = document.getElementById('past-data-chevron');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                chevron.classList.replace('fa-chevron-down', 'fa-chevron-up');

                const results = document.getElementById('past-data-results');
                if (results.innerHTML === '') {
                    this.showKnownActivityData();
                }
            } else {
                content.style.display = 'none';
                chevron.classList.replace('fa-chevron-up', 'fa-chevron-down');
            }
        }

        showKnownActivityData() {
            const loading = document.getElementById('past-data-loading');
            const results = document.getElementById('past-data-results');

            setTimeout(() => {
                loading.style.display = 'none';
                results.style.display = 'block';

                const activity = this.currentAnalysis.activity_data;
                const folderPath = `${this.currentAnalysis.state}/${this.currentAnalysis.county}/`;

                results.innerHTML = `
                    <div class="alert alert-success mb-3">
                        <h6>Cloud Storage Activity Confirmed</h6>
                        <p class="mb-1"><strong>Location:</strong> gs://bcfparcelsearchrepository/${folderPath}</p>
                        <p class="mb-1"><strong>Last Activity:</strong> ${activity.latest_activity ? new Date(activity.latest_activity).toLocaleString() : 'Recent'}</p>
                        <p class="mb-0"><strong>Project Folders:</strong> ${activity.folder_count} found</p>
                    </div>

                    <div class="mb-3">
                        <h6>Available Files</h6>
                        <div class="list-group list-group-flush">
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>Parcel Files Folder</strong>
                                        <br><small class="text-muted">gs://bcfparcelsearchrepository/${folderPath}Parcel_Files/</small>
                                    </div>
                                    <button class="btn btn-outline-primary btn-sm" onclick="bcf.showCloudStorageFiles('parcel', '${folderPath}')">
                                        Browse Files
                                    </button>
                                </div>
                            </div>

                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>Reports Folder</strong>
                                        <br><small class="text-muted">gs://bcfparcelsearchrepository/${folderPath}Reports/</small>
                                    </div>
                                    <button class="btn btn-outline-success btn-sm" onclick="bcf.showCloudStorageFiles('reports', '${folderPath}')">
                                        View Reports
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <small><strong>Cost Savings:</strong> Review existing files before running new searches to avoid duplicate costs.</small>
                    </div>

                    <div class="btn-group w-100 mt-2">
                        <button class="btn btn-outline-success" onclick="alert('Use Existing Project Data\\n\\nFolder: gs://bcfparcelsearchrepository/${folderPath}\\n\\nThis would load existing project data to avoid duplicate search costs and build on previous work.')">
                            Use Existing Data
                        </button>
                        <button class="btn btn-outline-primary" onclick="bcf.proceedWithNewSearch()">
                            Run New Search
                        </button>
                    </div>
                `;
            }, 500);
        }

        showCloudStorageFiles(folderType, folderPath) {
            const fullPath = `gs://bcfparcelsearchrepository/${folderPath}${folderType === 'parcel' ? 'Parcel_Files/' : 'Reports/'}`;
            const title = folderType === 'parcel' ? 'Parcel Files' : 'Reports';

            console.log(`Showing files for: ${fullPath}`);

            const expectedFiles = folderType === 'parcel' ? [
                'CSV parcel search results',
                'GeoPackage boundary files',
                'Landowner data files'
            ] : [
                'Analysis reports',
                'Market studies',
                'Feasibility assessments'
            ];

            const modalHtml = `
                <div class="modal fade" id="fileListModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${title} Browser</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <h6>Found Files in Cloud Storage</h6>
                                    <p class="mb-0">Files are available at: ${fullPath}</p>
                                </div>

                                <div class="mb-3">
                                    <h6>Expected Files in This Folder:</h6>
                                    <ul class="list-unstyled">
                                        ${expectedFiles.map(file => `<li class="small text-muted">• ${file}</li>`).join('')}
                                    </ul>
                                </div>

                                <div class="mb-3">
                                    <h6>Direct Access:</h6>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary" onclick="window.open('https://console.cloud.google.com/storage/browser/bcfparcelsearchrepository/${folderPath}${folderType === 'parcel' ? 'Parcel_Files' : 'Reports'}', '_blank')">
                                            <i class="fas fa-external-link-alt me-2"></i>Open in Google Cloud Console
                                        </button>
                                        <button class="btn btn-outline-info" onclick="navigator.clipboard.writeText('${fullPath}').then(() => alert('Path copied to clipboard!'))" title="Copy path">
                                            <i class="fas fa-copy me-2"></i>Copy Cloud Storage Path
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if present
            const existingModal = document.getElementById('fileListModal');
            if (existingModal) existingModal.remove();

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('fileListModal'));
            modal.show();

            // Clean up on close
            modal._element.addEventListener('hidden.bs.modal', () => {
                document.getElementById('fileListModal').remove();
            });
        }

        proceedWithNewSearch() {
            const pastDataContent = document.getElementById('past-data-content');
            const chevron = document.getElementById('past-data-chevron');

            if (pastDataContent && chevron) {
                pastDataContent.style.display = 'none';
                chevron.classList.replace('fa-chevron-up', 'fa-chevron-down');
            }

            alert('Proceeding with new search. Use the search parameters form below to run a new parcel search.');
        }

        goBackToCountyRankings() {
            const parcelSearch = document.getElementById('parcel-search-screen');
            if (parcelSearch) parcelSearch.remove();
            document.getElementById('county-rankings-screen').style.display = 'block';
        }

        showCountyRankingsScreen() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('county-rankings-screen').style.display = 'block';
        }

        goBackToStart() {
            document.getElementById('county-rankings-screen').style.display = 'none';
            document.getElementById('start-screen').style.display = 'block';

            document.getElementById('target-state').value = '';
            document.getElementById('project-type-start').value = '';
        }

        getStateName(stateCode) {
            const stateNames = {
                'AL': 'Alabama', 'AZ': 'Arizona', 'AR': 'Arkansas', 'CA': 'California',
                'CO': 'Colorado', 'FL': 'Florida', 'GA': 'Georgia', 'IL': 'Illinois',
                'IN': 'Indiana', 'IA': 'Iowa', 'KS': 'Kansas', 'KY': 'Kentucky',
                'LA': 'Louisiana', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi',
                'MO': 'Missouri', 'NE': 'Nebraska', 'NV': 'Nevada', 'NM': 'New Mexico',
                'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota',
                'OH': 'Ohio', 'OK': 'Oklahoma', 'PA': 'Pennsylvania', 'SC': 'South Carolina',
                'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah',
                'VA': 'Virginia', 'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming'
            };
            return stateNames[stateCode] || stateCode;
        }
    }

    console.log('BCFWorkflow class defined successfully');

    let bcf = null;

    function initBCF() {
        console.log('Creating BCFWorkflow instance...');
        try {
            bcf = new BCFWorkflow();
            window.bcf = bcf;
            console.log('BCF instance created successfully');

        const form = document.getElementById('state-selection-form');
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();

                const state = document.getElementById('target-state').value;
                const projectType = document.getElementById('project-type-start').value;

                if (!state || !projectType) {
                    alert('Please select both state and project type');
                    return;
                }

                console.log('Form submitted with:', { state, projectType });

                // Set the current values immediately
                bcf.currentState = state;
                bcf.currentProjectType = projectType;

                // Call with parameters
                bcf.analyzeStateCounties(state, projectType);
            });
            console.log('Form handler attached');
        }

            const countySelect = document.getElementById('target-county');
            if (countySelect) {
                countySelect.addEventListener('change', function() {
                    const hasSelection = this.value !== '';
                    const findBtn = document.getElementById('find-parcels-btn');
                    const researchBtn = document.getElementById('research-areas-btn');

                    if (findBtn) findBtn.disabled = !hasSelection;
                    if (researchBtn) researchBtn.disabled = !hasSelection;
                });
            }

        } catch (error) {
            console.error('Error creating BCF instance:', error);
            console.error('Stack:', error.stack);
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initBCF);
    } else {
        initBCF();
    }

} catch (classError) {
    console.error('Error defining BCFWorkflow class:', classError);
    console.error('Class definition error stack:', classError.stack);
    alert('JavaScript class definition error: ' + classError.message);
}

console.log('Script completed');
</script>
</body>
</html>