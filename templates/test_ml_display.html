<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Results Display Test</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .debug-info { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .test-data { max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>üß† ML Results Display Test</h1>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üìÑ Test Data Loader</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="loadTestData()">Load Test ML Data</button>
                        <button class="btn btn-success ms-2" onclick="testDisplayFunction()">Test Display</button>

                        <div id="data-status" class="mt-3"></div>

                        <div class="test-data">
                            <h6>Test Data Preview:</h6>
                            <pre id="test-data-preview" class="small"></pre>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üîß Debug Controls</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-info btn-sm" onclick="debugDisplayMethod()">Debug Display Method</button>
                        <button class="btn btn-warning btn-sm" onclick="testTableGeneration()">Test Table Generation</button>
                        <button class="btn btn-secondary btn-sm" onclick="clearDisplay()">Clear Display</button>

                        <div class="debug-info mt-3">
                            <h6>Debug Output:</h6>
                            <div id="debug-output"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Display Area -->
        <div id="workflow-container" class="mt-4">
            <!-- ML results will be displayed here -->
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
        // Test data that matches your ML response format
        let testMLData = null;

        // Mock workflow object
        const workflow = {
            currentMLResults: null,

            truncateText: function(text, maxLength) {
                if (!text) return '';
                return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
            },

            escapeHtml: function(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            displayMLSuitabilityResults: function(data) {
                console.log('displayMLSuitabilityResults called with:', data);

                const container = document.getElementById('workflow-container');

                const resultDate = new Date().toLocaleDateString('en-US', {
                    year: 'numeric', month: 'long', day: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });

                const html = `
                    <div class="suitability-results-container">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h4>üß† ML-Enhanced Parcel Analysis Results</h4>
                                <small class="text-muted">Generated: ${resultDate}</small>
                            </div>
                            <div class="card-body">
                                <!-- Summary Statistics -->
                                <div class="suitability-summary">
                                    <h5>üìä ML Analysis Summary</h5>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h3 class="text-primary">${data.total_parcels}</h3>
                                                    <p class="card-text">Total Parcels</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h3 class="text-success">${data.suitable_parcels}</h3>
                                                    <p class="card-text">ML Recommended</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h3 class="text-info">${Math.round((data.suitable_parcels / data.total_parcels) * 100)}%</h3>
                                                    <p class="card-text">Recommendation Rate</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h3 class="text-warning">ML+Trad</h3>
                                                    <p class="card-text">Analysis Type</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Results Table -->
                                <div class="table-responsive mt-4">
                                    <table class="table table-striped table-hover" id="ml-suitability-table">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Parcel ID</th>
                                                <th>Owner</th>
                                                <th>Acres</th>
                                                <th>ML Score</th>
                                                <th>Traditional Score</th>
                                                <th>Combined Score</th>
                                                <th>Status</th>
                                                <th>Notes</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${this.generateMLTableRows(data.parcels || [])}
                                        </tbody>
                                    </table>
                                </div>

                                <div class="alert alert-success mt-3">
                                    <h6>‚úÖ Test Display Successful!</h6>
                                    <p>ML-enhanced results are displaying correctly. Scoring method: ${data.scoring_method}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                container.innerHTML = html;
                this.currentMLResults = data;

                console.log('‚úÖ ML results displayed successfully');
                return true;
            },

            generateMLTableRows: function(parcels) {
                if (!Array.isArray(parcels)) {
                    return '<tr><td colspan="8" class="text-center text-danger">No parcel data available</td></tr>';
                }

                return parcels.map(parcel => {
                    const analysis = parcel.suitability_analysis;

                    const mlScore = analysis.ml_score || 50;
                    const traditionalScore = analysis.traditional_score || 50;
                    const combinedScore = analysis.overall_score || 50;

                    const mlBadge = mlScore >= 70 ?
                        `<span class="badge bg-success">${mlScore}</span>` :
                        `<span class="badge bg-warning">${mlScore}</span>`;

                    const combinedBadge = combinedScore >= 70 ?
                        `<span class="badge bg-primary">${combinedScore}</span>` :
                        `<span class="badge bg-secondary">${combinedScore}</span>`;

                    const statusBadge = analysis.is_suitable ?
                        '<span class="badge bg-success">‚úì Recommended</span>' :
                        '<span class="badge bg-danger">‚úó Not Recommended</span>';

                    return `
                        <tr class="${analysis.is_suitable ? 'table-success' : ''}">
                            <td><strong>${parcel.parcel_id}</strong></td>
                            <td>${this.truncateText(parcel.owner, 20)}</td>
                            <td>${parseFloat(parcel.acreage || 0).toFixed(1)}</td>
                            <td>${mlBadge}</td>
                            <td><span class="badge bg-info">${traditionalScore}</span></td>
                            <td>${combinedBadge}</td>
                            <td>${statusBadge}</td>
                            <td><small>${this.truncateText(analysis.analysis_notes || '', 50)}</small></td>
                        </tr>
                    `;
                }).join('');
            }
        };

        async function loadTestData() {
            try {
                document.getElementById('data-status').innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Loading test data...';

                // Try to load from the test script output
                const response = await fetch('test_ml_response.json');
                if (response.ok) {
                    testMLData = await response.json();
                    document.getElementById('data-status').innerHTML = '<div class="alert alert-success">‚úÖ Test data loaded from file</div>';
                } else {
                    throw new Error('File not found, using fallback data');
                }
            } catch (error) {
                // Fallback test data
                testMLData = {
                    analysis_timestamp: new Date().toISOString(),
                    total_parcels: 2,
                    suitable_parcels: 1,
                    analysis_type: 'ml_enhanced',
                    scoring_method: '60% ML + 40% Traditional Analysis',
                    parcels: [
                        {
                            parcel_id: 'TEST_001',
                            owner: 'Test Owner 1',
                            acreage: 45.0,
                            county: 'Test County',
                            state_abbr: 'PA',
                            is_suitable: true,
                            suitability_analysis: {
                                is_suitable: true,
                                overall_score: 82.5,
                                ml_score: 88.0,
                                traditional_score: 75.0,
                                ml_rank: 1,
                                confidence_level: 'high',
                                slope_degrees: 8.5,
                                transmission_distance: 0.6,
                                transmission_voltage: 138.0,
                                analysis_notes: 'ML Score: 88.0, Traditional: 75.0, Combined: 82.5'
                            }
                        },
                        {
                            parcel_id: 'TEST_002',
                            owner: 'Test Owner 2',
                            acreage: 22.0,
                            county: 'Test County',
                            state_abbr: 'PA',
                            is_suitable: false,
                            suitability_analysis: {
                                is_suitable: false,
                                overall_score: 58.2,
                                ml_score: 62.0,
                                traditional_score: 52.0,
                                ml_rank: 2,
                                confidence_level: 'medium',
                                slope_degrees: 18.2,
                                transmission_distance: 2.1,
                                transmission_voltage: 69.0,
                                analysis_notes: 'ML Score: 62.0, Traditional: 52.0, Combined: 58.2'
                            }
                        }
                    ]
                };

                document.getElementById('data-status').innerHTML = '<div class="alert alert-info">‚ÑπÔ∏è Using fallback test data</div>';
            }

            // Show preview
            document.getElementById('test-data-preview').textContent = JSON.stringify(testMLData, null, 2);
        }

        function testDisplayFunction() {
            if (!testMLData) {
                alert('Please load test data first');
                return;
            }

            console.log('Testing display function with data:', testMLData);

            try {
                const success = workflow.displayMLSuitabilityResults(testMLData);

                if (success) {
                    document.getElementById('debug-output').innerHTML = '<div class="alert alert-success">‚úÖ Display function executed successfully</div>';
                } else {
                    document.getElementById('debug-output').innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Display function returned false</div>';
                }
            } catch (error) {
                console.error('Display function error:', error);
                document.getElementById('debug-output').innerHTML = `<div class="alert alert-danger">‚ùå Display function error: ${error.message}</div>`;
            }
        }

        function debugDisplayMethod() {
            console.log('Workflow object:', workflow);
            console.log('Display method exists:', typeof workflow.displayMLSuitabilityResults);
            console.log('Container exists:', !!document.getElementById('workflow-container'));

            document.getElementById('debug-output').innerHTML = `
                <div class="alert alert-info">
                    <strong>Debug Info:</strong><br>
                    - Display method: ${typeof workflow.displayMLSuitabilityResults}<br>
                    - Container: ${!!document.getElementById('workflow-container') ? 'Found' : 'Missing'}<br>
                    - Test data: ${testMLData ? 'Loaded' : 'Not loaded'}<br>
                    - Test data parcels: ${testMLData?.parcels?.length || 0}
                </div>
            `;
        }

        function testTableGeneration() {
            if (!testMLData) {
                alert('Please load test data first');
                return;
            }

            try {
                const tableHTML = workflow.generateMLTableRows(testMLData.parcels);
                console.log('Generated table HTML:', tableHTML);

                document.getElementById('debug-output').innerHTML = `
                    <div class="alert alert-success">‚úÖ Table generation successful</div>
                    <details class="mt-2">
                        <summary>View Generated HTML</summary>
                        <pre class="small mt-2">${workflow.escapeHtml(tableHTML)}</pre>
                    </details>
                `;
            } catch (error) {
                console.error('Table generation error:', error);
                document.getElementById('debug-output').innerHTML = `<div class="alert alert-danger">‚ùå Table generation error: ${error.message}</div>`;
            }
        }

        function clearDisplay() {
            document.getElementById('workflow-container').innerHTML = '<p class="text-muted">Display cleared - ready for testing</p>';
            document.getElementById('debug-output').innerHTML = '';
        }

        // Auto-load test data on page load
        window.onload = function() {
            loadTestData();
        };
    </script>
</body>
</html>